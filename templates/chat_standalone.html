<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Operative Assessment - GasConsult.ai</title>
    
    <meta name="description" content="AI-powered preoperative assessment with hybrid RAG + Agentic AI for evidence-based risk stratification.">
    
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html { -webkit-font-smoothing: antialiased; scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%; left: -20%;
        }

        .orb-2 {
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%; right: -20%;
            animation-delay: -7s; animation-duration: 25s;
        }

        .orb-3 {
            width: 250px; height: 250px;
            background: radial-gradient(circle, rgba(191, 219, 254, 0.15) 0%, transparent 70%);
            bottom: 10%; left: 30%;
            animation-delay: -14s; animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }

        .grain {
            position: fixed; inset: 0; z-index: 1;
            pointer-events: none; opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page { position: relative; z-index: 2; min-height: 100vh; display: flex; flex-direction: column; }

        /* Navigation */
        
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
            background: transparent;  /* CRITICAL: Keep nav container transparent */
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.65);  /* Reduced opacity from 0.7 to 0.65 */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);  /* Reduced border opacity from 0.8 to 0.4 */
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }


        /* Main Content */
        .main-content {
            flex: 1; padding: 88px 16px 32px;
            max-width: 900px; margin: 0 auto; width: 100%;
        }

        /* Header */
        .header { text-align: center; margin-bottom: 40px; animation: fadeIn 0.6s ease; }
        .header-title {
            font-size: 32px; font-weight: 800; letter-spacing: -1px;
            color: var(--gray-900); margin-bottom: 12px;
        }
        .header-subtitle {
            font-size: 16px; color: var(--gray-600); line-height: 1.6;
        }
        .blue { color: var(--blue-600); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Card */
        /* Form Card - Glassmorphism */
        .form-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06);
            animation: slideUp 0.6s cubic-bezier(0.16,1,0.3,1) 0.1s both;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 32px 0 20px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--blue-100);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .input-row {
            display: grid; grid-template-columns: 1fr;
            gap: 16px; margin-bottom: 20px;
        }

        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-label {
            font-size: 14px; font-weight: 600; color: var(--gray-700);
        }
        .required { color: var(--blue-600); }

        .form-input, .form-select {
            padding: 12px 16px; border-radius: 12px;
            border: 1px solid var(--gray-200);
            font-size: 15px; font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none; border-color: var(--blue-400);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 80px; resize: vertical;
        }

        .checkbox-group {
            display: grid; grid-template-columns: 1fr; gap: 10px;
        }

        .checkbox-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px; border-radius: 8px;
            transition: background 0.2s;
        }

        .checkbox-item:hover { background: var(--gray-50); }

        .checkbox-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer;
        }

        .checkbox-item label {
            font-size: 14px; color: var(--gray-700);
            cursor: pointer; user-select: none;
        }

        .submit-btn {
            width: 100%; padding: 16px; margin-top: 24px;
            font-size: 16px; font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            border: none; border-radius: 14px; cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .submit-btn:active { transform: translateY(0); }

        /* Results */
        .results-section {
            animation: fadeIn 0.8s ease;
        }

        /* Inline Mode Badge (Compact version in header) */
        .mode-badge-inline {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.1);
            backdrop-filter: blur(8px);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            font-size: 12px;
            font-weight: 600;
            color: var(--blue-700);
            transition: all 0.2s;
        }

        .mode-badge-inline.agentic {
            background: rgba(124, 58, 237, 0.1);
            border-color: rgba(124, 58, 237, 0.2);
            color: #7C3AED;
        }

        .mode-icon-inline {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        .mode-text-inline {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Agent Reasoning */
        .agent-reasoning {
            background: linear-gradient(135deg, #F0F9FF 0%, #EFF6FF 100%);
            border: 1px solid var(--blue-200);
            border-radius: 16px; padding: 20px; margin-bottom: 24px;
        }

        .agent-header {
            display: flex; align-items: center; gap: 10px;
            cursor: pointer; user-select: none;
        }

        .agent-icon { width: 24px; height: 24px; color: var(--blue-600); }
        .agent-title {
            font-size: 16px; font-weight: 600;
            color: var(--blue-900); flex: 1;
        }

        .toggle-icon {
            width: 20px; height: 20px; color: var(--blue-600);
            transition: transform 0.3s;
        }
        .toggle-icon.expanded { transform: rotate(180deg); }

        .agent-steps {
            display: none; margin-top: 16px; padding-top: 16px;
            border-top: 1px solid var(--blue-200);
        }
        .agent-steps.show { display: block; }

        .agent-step {
            padding: 8px 0; font-size: 14px; color: var(--gray-700);
            display: flex; align-items: center; gap: 8px;
        }
        .agent-step::before { content: "✓"; color: #10B981; font-weight: 700; }

        /* Assessment Card */
        /* Assessment Results - Polished */
        .assessment-card {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06);
            animation: slideUp 0.6s cubic-bezier(0.16,1,0.3,1) 0.2s both;
        }

        .assessment-content {
            font-size: 15px;
            line-height: 1.8;
            color: var(--gray-700);
        }

        .assessment-content h3 {
            font-size: 20px;
            font-weight: 800;
            color: var(--gray-900);
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--blue-100);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .assessment-content h3:first-child {
            margin-top: 0;
        }

        .assessment-content h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .assessment-content h3:first-child { margin-top: 0; }

        .assessment-content h4 {
            color: var(--gray-800); font-size: 16px; font-weight: 600;
            margin: 20px 0 12px 0;
        }

        .assessment-content p { margin-bottom: 14px; line-height: 1.7; }

        .assessment-content ul {
            margin: 0 0 16px 0; padding-left: 0; list-style: none;
        }

        .assessment-content li {
            margin-bottom: 10px; padding-left: 28px;
            position: relative; line-height: 1.6;
        }

        .assessment-content li::before {
            content: "✓"; position: absolute; left: 0;
            color: var(--blue-600); font-weight: 700; font-size: 16px;
        }

        .assessment-content strong {
            color: var(--gray-900); font-weight: 600;
            background: var(--blue-50); padding: 2px 6px; border-radius: 4px;
        }

        /* Follow-up Suggestions (Phase 1 Feature 2) */
        .followup-suggestions {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            border: 1px solid var(--blue-200);
            border-radius: 12px;
        }

        .followup-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .followup-title svg {
            color: var(--blue-500);
        }

        .followup-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        @media (min-width: 640px) {
            .followup-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .followup-chip {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 12px 16px;
            background: white;
            border: 1px solid var(--blue-200);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .followup-chip:hover {
            background: var(--blue-50);
            border-color: var(--blue-400);
            color: var(--blue-700);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.15);
        }

        .followup-chip:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
        }

        .followup-chip.selected {
            background: var(--blue-500);
            border-color: var(--blue-600);
            color: white;
            font-weight: 600;
        }

        /* Reasoning Trace Section (Phase 1 Feature 1) */
        .reasoning-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--gray-200);
        }

        .reasoning-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
        }

        .reasoning-toggle:hover {
            background: var(--gray-200);
            border-color: var(--gray-300);
            color: var(--gray-900);
        }

        .reasoning-toggle[aria-expanded="true"] svg {
            transform: rotate(90deg);
        }

        .reasoning-content {
            margin-top: 12px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .reasoning-timeline {
            position: relative;
            padding-left: 32px;
        }

        .reasoning-timeline::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: linear-gradient(180deg, var(--blue-300) 0%, var(--blue-200) 100%);
        }

        .reasoning-step {
            position: relative;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .reasoning-step:hover {
            background: white;
            border-color: var(--blue-200);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .step-indicator {
            position: absolute;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
            z-index: 1;
        }

        .step-text {
            font-size: 13px;
            color: var(--gray-700);
            line-height: 1.6;
        }

        /* References */
        /* References Section - Enhanced Modern Design */
        .references-section {
            margin-top: 48px;
            padding-top: 32px;
            border-top: 2px solid var(--gray-200);
        }

        .references-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 16px 20px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(147, 197, 253, 0.05) 100%);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .references-icon {
            width: 24px;
            height: 24px;
            color: var(--blue-600);
            flex-shrink: 0;
        }

        .references-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            flex: 1;
        }

        .references-count {
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
        }

        .reference-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px) saturate(180%);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .reference-card:hover {
            border-color: var(--blue-400);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.12);
            transform: translateY(-3px);
        }

        .reference-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--blue-600), #1D4ED8);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .reference-card:hover::before {
            opacity: 1;
        }

        .reference-number {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }

        .reference-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-900);
            line-height: 1.6;
            margin-bottom: 12px;
            padding-right: 56px;
        }

        .reference-meta {
            display: flex; flex-wrap: wrap; gap: 12px; align-items: center;
            font-size: 13px; color: var(--gray-600); margin-bottom: 12px;
        }

        .reference-authors { font-weight: 500; }
        .reference-journal { color: var(--gray-500); }
        .reference-year {
            padding: 2px 8px; background: var(--gray-100);
            border-radius: 6px; font-weight: 500;
        }

        .study-badge {
            display: inline-block; padding: 4px 10px; border-radius: 6px;
            font-size: 12px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.3px;
        }

        .pmid-link {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 12px; background: var(--gray-100);
            border-radius: 8px; color: var(--blue-600);
            text-decoration: none; font-size: 12px; font-weight: 600;
            transition: all 0.2s;
        }

        .pmid-link:hover {
            background: var(--blue-100); color: var(--blue-700);
        }

        /* Footer */
        .footer {
            padding: 32px 20px; border-top: 1px solid var(--gray-200);
            background: rgba(255, 255, 255, 0.5); margin-top: 60px;
        }

        .footer-inner {
            max-width: 1200px; margin: 0 auto;
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; text-align: center;
        }

        .footer-text { font-size: 13px; color: var(--gray-500); }

        .footer-links { display: flex; gap: 24px; }
        .footer-link {
            font-size: 13px; color: var(--gray-500);
            text-decoration: none; transition: color 0.2s;
        }
        .footer-link:hover { color: var(--gray-700); }

        .social-icons { display: flex; gap: 20px; }
        .social-icon {
            color: var(--gray-500); transition: all 0.2s;
        }
        .social-icon:hover {
            color: var(--gray-700); transform: translateY(-2px);
        }
        .social-icon svg { width: 24px; height: 24px; }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner-container {
            text-align: center;
            animation: fade-in 0.3s ease;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Assessment Results - Structured Display */
        .assessment-results {
            margin-top: 24px;
        }

        .assessment-results h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 32px 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--blue-100);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .assessment-results h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .assessment-results h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 24px 0 12px 0;
        }

        .assessment-results p {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 16px;
        }

        .assessment-results ul,
        .assessment-results ol {
            margin: 16px 0;
            padding-left: 24px;
        }

        .assessment-results li {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .assessment-results strong {
            color: var(--gray-900);
            font-weight: 600;
        }

        /* Risk Score Dashboard - Visual Charts */
        .risk-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin: 32px 0;
        }

        .risk-score-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        .risk-score-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--blue-600), #1D4ED8);
            transition: height 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .risk-score-card.risk-low::before {
            background: linear-gradient(90deg, #10B981, #059669);
        }

        .risk-score-card.risk-moderate::before {
            background: linear-gradient(90deg, #F59E0B, #D97706);
        }

        .risk-score-card.risk-high::before {
            background: linear-gradient(90deg, #EF4444, #DC2626);
        }

        .risk-score-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .risk-score-card:hover::before {
            height: 6px;
        }

        .risk-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .risk-card-icon {
            font-size: 28px;
            line-height: 1;
        }

        .risk-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-card-body {
            text-align: center;
        }

        .risk-score-value {
            font-size: 48px;
            font-weight: 700;
            color: var(--blue-600);
            line-height: 1;
            margin-bottom: 12px;
            animation: count-up 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .risk-score-card.risk-low .risk-score-value {
            color: #10B981;
        }

        .risk-score-card.risk-moderate .risk-score-value {
            color: #F59E0B;
        }

        .risk-score-card.risk-high .risk-score-value {
            color: #EF4444;
        }

        @keyframes count-up {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .risk-score-label {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        /* Circular Progress Indicator */
        .circular-progress {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            position: relative;
        }

        .circular-progress svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .circular-progress-bg {
            fill: none;
            stroke: var(--gray-200);
            stroke-width: 8;
        }

        .circular-progress-fill {
            fill: none;
            stroke: var(--blue-600);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .circular-progress-fill.risk-low {
            stroke: #10B981;
        }

        .circular-progress-fill.risk-moderate {
            stroke: #F59E0B;
        }

        .circular-progress-fill.risk-high {
            stroke: #EF4444;
        }

        .circular-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .circular-progress-subtext {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 20px);
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Risk Level Badge */
        .risk-level-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-level-badge.risk-low {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .risk-level-badge.risk-moderate {
            background: rgba(245, 158, 11, 0.1);
            color: #D97706;
        }

        .risk-level-badge.risk-high {
            background: rgba(239, 68, 68, 0.1);
            color: #DC2626;
        }

        .risk-level-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Visual Timeline */
        .visual-timeline {
            margin: 32px 0;
            padding-left: 24px;
            position: relative;
        }

        .visual-timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: linear-gradient(180deg, var(--blue-600), var(--blue-400));
        }

        .timeline-item {
            position: relative;
            margin-bottom: 32px;
            padding-left: 32px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--blue-600);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            z-index: 1;
        }

        .timeline-item.completed::before {
            background: var(--blue-600);
            border-color: var(--blue-600);
        }

        .timeline-phase {
            font-size: 12px;
            font-weight: 700;
            color: var(--blue-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .timeline-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .timeline-description {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-700);
        }

        .timeline-description ul {
            margin-top: 8px;
            padding-left: 20px;
        }

        .timeline-description li {
            font-size: 14px;
            margin-bottom: 6px;
        }

        /* Responsive */
        @media (min-width: 768px) {
            
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }


            .main-content { padding: 108px 32px 48px; }

            .header-title { font-size: 36px; }

            .form-card { padding: 32px; }

            .input-row { grid-template-columns: repeat(2, 1fr); }
            .checkbox-group { grid-template-columns: repeat(2, 1fr); }

            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
        }

        @media (min-width: 1024px) {
            
            .nav { padding: 16px 40px; }


            .main-content { max-width: 900px; }

            .header-title { font-size: 42px; }

            .form-card { padding: 40px; }

            .footer { padding: 48px 40px; }
        }

        /* ===== WIZARD STYLES ===== */
        /* ===================================================================
           WIZARD STYLES
           =================================================================== */
        
        .wizard-progress {
            margin-bottom: 40px;
            padding: 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-200);
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue-600) 0%, #1D4ED8 100%);
            border-radius: 999px;
            transition: width 0.4s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 0 8px rgba(37, 99, 235, 0.4);
        }

        .progress-text {
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .wizard-step {
            display: none;
        }
        
        .wizard-step[style*="display: block"] {
            animation: fadeIn 0.4s cubic-bezier(0.16,1,0.3,1);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .step-header {
            margin-bottom: 40px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .step-number {
            font-size: 12px;
            font-weight: 700;
            color: var(--blue-600);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .step-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .step-description {
            font-size: 15px;
            color: var(--gray-600);
            line-height: 1.6;
        }

        .subsection {
            margin-bottom: 24px;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 0;
        }

        .subsection-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 20px;
            padding-bottom: 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .subsection-title::before {
            content: '';
            width: 3px;
            height: 20px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            border-radius: 2px;
            flex-shrink: 0;
        }
        
        .conditional-section {
            margin-top: 16px;
            margin-left: 24px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.03);
            border-left: 3px solid var(--blue-400);
            border-radius: 8px;
        }
        
        .wizard-navigation {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 48px;
            padding-top: 32px;
            border-top: 2px solid var(--gray-200);
        }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 32px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-btn:hover::before {
            left: 100%;
        }

        .nav-btn-secondary {
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            color: var(--gray-700);
            border: 1px solid rgba(15, 23, 42, 0.08);
        }

        .nav-btn-secondary:hover {
            background: linear-gradient(135deg, #F1F5F9 0%, #E2E8F0 100%);
            border-color: rgba(15, 23, 42, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .nav-btn-primary {
            background: white;
            color: var(--gray-900);
            margin-left: auto;
            border: 1.5px solid rgba(15, 23, 42, 0.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        .nav-btn-primary:hover {
            background: white;
            border-color: rgba(15, 23, 42, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .nav-btn-submit {
            background: white;
            color: var(--gray-900);
            margin-left: auto;
            border: 1.5px solid rgba(15, 23, 42, 0.15);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
        }

        .nav-btn-submit:hover {
            background: white;
            border-color: rgba(15, 23, 42, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.08);
        }
        
        .btn-icon {
            width: 18px;
            height: 18px;
        }
        
        .input-with-unit {
            display: flex;
            gap: 8px;
        }
        
        .input-with-unit .form-input {
            flex: 1;
        }
        
        .form-select-small {
            width: 80px;
            padding: 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            background: white;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .form-select-small:hover {
            border-color: var(--blue-500);
        }
        
        .form-select-small:focus {
            outline: none;
            border-color: var(--blue-600);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: white;
            border: 1.5px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
            margin-bottom: 8px;
        }

        .checkbox-option:hover {
            border-color: var(--blue-400);
            background: rgba(59, 130, 246, 0.02);
            transform: translateX(2px);
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--blue-600);
        }

        .checkbox-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-800);
            cursor: pointer;
            line-height: 1.5;
        }
        
        .radio-group-inline {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .radio-option-inline {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border: 1.5px solid var(--gray-300);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
            min-width: 100px;
            justify-content: center;
        }

        .radio-option-inline:hover {
            border-color: var(--blue-400);
            background: rgba(59, 130, 246, 0.02);
        }

        .radio-option-inline:has(input[type="radio"]:checked) {
            border-color: var(--blue-600);
            background: var(--blue-50);
        }

        .radio-option-inline input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--blue-600);
        }

        .radio-option-inline input[type="radio"]:checked + span {
            color: var(--blue-700);
            font-weight: 600;
        }

        .question-card {
            padding: 24px;
            background: white;
            border: 1.5px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
        }

        .question-card:hover {
            border-color: var(--gray-300);
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }
        
        .question-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 12px;
            line-height: 1.5;
        }
        
        .question-text strong {
            color: var(--blue-600);
            font-weight: 700;
        }
        
        .score-display {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, var(--blue-50), #EFF6FF);
            border: 1px solid var(--blue-200);
            border-radius: 12px;
            text-align: center;
        }
        
        .score-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }
        
        .score-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--blue-600);
            margin-bottom: 8px;
        }
        
        .score-interpretation {
            font-size: 15px;
            color: var(--gray-600);
        }
        
        .allergy-entry {
            padding: 24px;
            background: white;
            border: 1.5px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 16px;
            transition: all 0.2s cubic-bezier(0.16,1,0.3,1);
        }

        .allergy-entry:hover {
            border-color: var(--gray-300);
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }

        .allergy-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        .allergy-header h4 {
            font-size: 15px;
            font-weight: 700;
            color: var(--gray-800);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-help {
            font-size: 13px;
            color: var(--gray-500);
            margin-top: 8px;
            line-height: 1.5;
        }

        .checkbox-group {
            display: grid;
            gap: 0;
        }
        
        .required {
            color: var(--red-600);
        }
        
        .error {
            border-color: var(--red-600) !important;
        }
        
        .error-message {
            color: var(--red-600);
            font-size: 13px;
            margin-top: 4px;
        }
        
        @media (max-width: 768px) {
            .wizard-navigation {
                flex-direction: column-reverse;
            }
        
            .nav-btn-primary,
            .nav-btn-submit {
                margin-left: 0;
            }
        
            .step-title {
                font-size: 20px;
            }
        
            .score-value {
                font-size: 28px;
            }
        
            .radio-group-inline {
                flex-direction: column;
                gap: 8px;
            }
        
            .radio-option-inline {
                width: 100%;
            }
        }
        

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">Generating Assessment...</div>
            <div class="loading-subtext">Analyzing patient data and searching medical literature</div>
        </div>
    </div>

    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/dose-calc" class="nav-link">Dose Calc</a>
                    <a href="/preop" class="nav-link active">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/dose-calc" class="mobile-menu-link">Dose Calc</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
            {% if not summary %}
            <!-- FORM SECTION -->
            <div class="header">
                <h1 class="header-title">Pre-Operative <span class="blue">Assessment</span></h1>
                <p class="header-subtitle">
                    Hybrid RAG + Agentic AI for evidence-based risk stratification and perioperative optimization.
                </p>
            </div>

            <form method="POST" class="form-card" id="preop-wizard-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                <!-- Progress Bar -->
                <div class="wizard-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 16.67%;"></div>
                    </div>
                    <div class="progress-text" id="progress-text">Step 1 of 6</div>
                </div>

                <!-- Wizard Steps -->
                <!-- STEP 1: Demographics & Basic Information -->
<div class="wizard-step" id="step-1" data-step="1">
    <div class="step-header">
        <div class="step-number">Step 1 of 6</div>
        <h2 class="step-title">Demographics & Basic Information</h2>
        <p class="step-description">Patient demographics and basic information.</p>
    </div>

    <!-- Patient History of Present Illness (HPI) -->
    <div class="subsection" style="margin-bottom: 32px; border: 2px dashed rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 24px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.03) 0%, rgba(147, 197, 253, 0.03) 100%);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="background: linear-gradient(135deg, var(--blue-600), #1D4ED8); border-radius: 10px; padding: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);">
                <svg fill="none" stroke="white" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h3 class="subsection-title" style="margin: 0;">Patient History of Present Illness (Optional)</h3>
        </div>
        <p class="form-help" style="margin-bottom: 16px; color: var(--gray-600); font-size: 14px; display: flex; align-items: flex-start; gap: 8px;">
            <span style="flex-shrink: 0; margin-top: 1px;">Copy relevant patient history from EHR to provide additional clinical context.</span>
        </p>
        <div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border-left: 3px solid var(--red-600); margin-bottom: 16px;">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: var(--red-600); flex-shrink: 0;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <strong style="color: var(--red-600); font-size: 14px;">Remove all identifiers (names, dates of birth, MRNs) for HIPAA compliance.</strong>
        </div>
        <textarea
            name="hpi"
            class="form-input"
            rows="6"
            placeholder="Example: Patient presenting for elective total knee arthroplasty. Chronic knee pain for 3 years, conservative management unsuccessful. Lives independently, able to climb one flight of stairs with difficulty. Recent echocardiogram shows preserved EF. Last stress test 6 months ago negative for ischemia."
            style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; font-size: 14px; line-height: 1.6; resize: vertical; width: 100%; min-height: 120px; box-sizing: border-box;"></textarea>
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px; padding: 10px; background: rgba(59, 130, 246, 0.05); border-radius: 8px;">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px; color: var(--blue-600); flex-shrink: 0;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
            </svg>
            <span style="font-size: 13px; color: var(--gray-600);">This field helps the AI provide more personalized and context-aware recommendations.</span>
        </div>
    </div>

    <div class="input-row">
        <div class="form-group">
            <label class="form-label">Age <span class="required">*</span></label>
            <input type="number" name="age" class="form-input" placeholder="65" min="0" max="120" required id="age-input">
        </div>
        <div class="form-group">
            <label class="form-label">Sex <span class="required">*</span></label>
            <select name="sex" class="form-select" required>
                <option value="">Select</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
            </select>
        </div>
    </div>

    <div class="input-row">
        <div class="form-group">
            <label class="form-label">Weight <span class="required">*</span></label>
            <div class="input-with-unit">
                <input type="number" name="weight" class="form-input" placeholder="70" min="20" max="300" step="0.1" required id="weight-input">
                <select name="weight_unit" class="form-select-small" id="weight-unit">
                    <option value="kg">kg</option>
                    <option value="lbs">lbs</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Height <span class="required">*</span></label>
            <div class="input-with-unit">
                <input type="number" name="height" class="form-input" placeholder="170" min="50" max="250" step="0.1" required id="height-input">
                <select name="height_unit" class="form-select-small" id="height-unit">
                    <option value="cm">cm</option>
                    <option value="inches">inches</option>
                </select>
            </div>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">BMI</label>
        <input type="text" class="form-input" id="bmi-display" readonly placeholder="Auto-calculated">
        <input type="hidden" name="bmi" id="bmi-value">
    </div>
</div>

                <!-- STEP 2: Medical History -->
<div class="wizard-step" id="step-2" data-step="2">
    <div class="step-header">
        <div class="step-number">Step 2 of 6</div>
        <h2 class="step-title">Medical History</h2>
        <p class="step-description">Medical history and comorbidities for anesthesia risk assessment.</p>
    </div>

    <!-- Cardiovascular -->
    <div class="subsection">
        <h3 class="subsection-title">Cardiovascular</h3>
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Hypertension" id="htn">
                <span class="checkbox-label">Hypertension (High Blood Pressure)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Coronary Artery Disease" id="cad" onchange="toggleConditional('cad-details')">
                <span class="checkbox-label">Coronary Artery Disease (CAD)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Prior MI" id="prior-mi">
                <span class="checkbox-label">Prior Heart Attack (MI)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Heart Failure" id="hf" onchange="toggleConditional('hf-details')">
                <span class="checkbox-label">Heart Failure</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Atrial Fibrillation" id="afib">
                <span class="checkbox-label">Atrial Fibrillation (AFib)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Valvular Disease" id="valvular">
                <span class="checkbox-label">Heart Valve Disease</span>
            </label>
        </div>

        <!-- Conditional: CAD Details -->
        <div class="conditional-section" id="cad-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">Prior Stent Placement?</label>
                    <select name="prior_stent" class="form-select" onchange="toggleConditional('stent-details', this.value === 'yes')">
                        <option value="">Select</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Prior CABG?</label>
                    <select name="prior_cabg" class="form-select" onchange="toggleConditional('cabg-details', this.value === 'yes')">
                        <option value="">Select</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
            </div>

            <div class="conditional-section" id="stent-details" style="display:none;">
                <div class="input-row">
                    <div class="form-group">
                        <label class="form-label">Stent Type</label>
                        <select name="stent_type" class="form-select">
                            <option value="">Select</option>
                            <option value="BMS">Bare Metal Stent (BMS)</option>
                            <option value="DES">Drug-Eluting Stent (DES)</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stent Date</label>
                        <input type="month" name="stent_date" class="form-input">
                    </div>
                </div>
            </div>

            <div class="conditional-section" id="cabg-details" style="display:none;">
                <div class="form-group">
                    <label class="form-label">CABG Date</label>
                    <input type="month" name="cabg_date" class="form-input">
                </div>
            </div>
        </div>

        <!-- Conditional: Heart Failure Details -->
        <div class="conditional-section" id="hf-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Ejection Fraction (EF%)</label>
                <input type="number" name="ef" class="form-input" placeholder="55" min="10" max="100">
                <p class="form-help">If known from recent echocardiogram</p>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Pacemaker or ICD?</label>
            <select name="cardiac_device" class="form-select" onchange="toggleConditional('device-details', this.value === 'yes')">
                <option value="">Select</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
            </select>
        </div>

        <div class="conditional-section" id="device-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">Device Type</label>
                    <select name="device_type" class="form-select">
                        <option value="">Select</option>
                        <option value="Pacemaker">Pacemaker</option>
                        <option value="ICD">ICD (Defibrillator)</option>
                        <option value="Biventricular">Biventricular (CRT)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Manufacturer</label>
                    <input type="text" name="device_manufacturer" class="form-input" placeholder="e.g., Medtronic, Boston Scientific">
                </div>
            </div>
        </div>
    </div>

    <!-- Respiratory -->
    <div class="subsection">
        <h3 class="subsection-title">Respiratory</h3>
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Asthma" id="asthma">
                <span class="checkbox-label">Asthma</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="COPD" id="copd" onchange="toggleConditional('copd-details')">
                <span class="checkbox-label">COPD</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Obstructive Sleep Apnea" id="osa">
                <span class="checkbox-label">Obstructive Sleep Apnea (OSA)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Pulmonary Hypertension" id="pulm-htn">
                <span class="checkbox-label">Pulmonary Hypertension</span>
            </label>
        </div>

        <div class="conditional-section" id="copd-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">On Home Oxygen?</label>
                    <select name="home_oxygen" class="form-select">
                        <option value="">Select</option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Recent Exacerbation (within 2 weeks)?</label>
                    <select name="recent_exacerbation" class="form-select">
                        <option value="">Select</option>
                        <option value="no">No</option>
                        <option value="yes">Yes</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Endocrine -->
    <div class="subsection">
        <h3 class="subsection-title">Endocrine</h3>
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Diabetes Mellitus" id="dm" onchange="toggleConditional('dm-details')">
                <span class="checkbox-label">Diabetes Mellitus</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Thyroid Disease" id="thyroid">
                <span class="checkbox-label">Thyroid Disease</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Adrenal Insufficiency" id="adrenal">
                <span class="checkbox-label">Adrenal Insufficiency / Chronic Steroid Use</span>
            </label>
        </div>

        <div class="conditional-section" id="dm-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">Diabetes Type</label>
                    <select name="dm_type" class="form-select">
                        <option value="">Select</option>
                        <option value="Type 1">Type 1</option>
                        <option value="Type 2">Type 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Management</label>
                    <select name="dm_management" class="form-select">
                        <option value="">Select</option>
                        <option value="Diet">Diet Only</option>
                        <option value="Oral">Oral Medications</option>
                        <option value="Insulin">Insulin</option>
                        <option value="Both">Oral + Insulin</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Most Recent HbA1c (%)</label>
                <input type="number" name="hba1c" class="form-input" placeholder="7.0" min="4" max="15" step="0.1">
            </div>
        </div>
    </div>

    <!-- Renal/Hepatic -->
    <div class="subsection">
        <h3 class="subsection-title">Renal & Hepatic</h3>
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Chronic Kidney Disease" id="ckd" onchange="toggleConditional('ckd-details')">
                <span class="checkbox-label">Chronic Kidney Disease (CKD)</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Liver Disease" id="liver">
                <span class="checkbox-label">Liver Disease / Cirrhosis</span>
            </label>
        </div>

        <div class="conditional-section" id="ckd-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">Baseline Creatinine (mg/dL)</label>
                    <input type="number" name="cr" class="form-input" placeholder="1.0" min="0.1" max="20" step="0.1">
                </div>
                <div class="form-group">
                    <label class="form-label">eGFR (mL/min/1.73m²)</label>
                    <input type="number" name="egfr" class="form-input" placeholder="90" min="1" max="150">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">On Dialysis?</label>
                <select name="dialysis" class="form-select">
                    <option value="">Select</option>
                    <option value="no">No</option>
                    <option value="hemodialysis">Hemodialysis</option>
                    <option value="peritoneal">Peritoneal Dialysis</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Neurologic -->
    <div class="subsection">
        <h3 class="subsection-title">Neurologic</h3>
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Stroke/TIA" id="stroke" onchange="toggleConditional('stroke-details')">
                <span class="checkbox-label">Stroke / TIA</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Seizure Disorder" id="seizure">
                <span class="checkbox-label">Seizure Disorder</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Myasthenia Gravis" id="myasthenia">
                <span class="checkbox-label">Myasthenia Gravis</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Peripheral Neuropathy" id="neuropathy">
                <span class="checkbox-label">Peripheral Neuropathy</span>
            </label>
        </div>

        <div class="conditional-section" id="stroke-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Date of Most Recent Event</label>
                <input type="month" name="stroke_date" class="form-input">
            </div>
            <div class="form-group">
                <label class="form-label">Residual Deficits?</label>
                <textarea name="stroke_deficits" class="form-input" rows="2" placeholder="Describe any weakness, speech issues, etc."></textarea>
            </div>
        </div>
    </div>

    <!-- Other -->
    <div class="subsection">
        <h3 class="subsection-title">Other Conditions</h3>
        <div class="checkbox-group">
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="GERD" id="gerd">
                <span class="checkbox-label">GERD / Hiatal Hernia</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Bleeding Disorder" id="bleeding">
                <span class="checkbox-label">Bleeding Disorder</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="Anemia" id="anemia">
                <span class="checkbox-label">Anemia</span>
            </label>
            <label class="checkbox-option">
                <input type="checkbox" name="comorbidities" value="DVT/PE History" id="vte">
                <span class="checkbox-label">History of Blood Clots (DVT/PE)</span>
            </label>
        </div>
    </div>

    <div class="form-group">
        <label class="form-label">Other Medical Conditions</label>
        <textarea name="other_conditions" class="form-input" rows="3" placeholder="Any other conditions not listed above"></textarea>
    </div>

    <!-- Imaging Studies -->
    <div class="subsection">
        <h3 class="subsection-title">Recent Imaging Studies</h3>
        <p class="form-help" style="margin-bottom: 20px;">Document recent imaging results relevant to anesthesia planning. Include key findings only.</p>

        <div class="form-group">
            <label class="form-label">Chest X-Ray</label>
            <select name="chest_xray_done" class="form-select" onchange="toggleConditional('chest-xray-details', this.value === 'yes')">
                <option value="">Not done / Not available</option>
                <option value="yes">Done - Enter findings</option>
                <option value="normal">Done - Normal/Clear</option>
            </select>
        </div>

        <div class="conditional-section" id="chest-xray-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Chest X-Ray Findings</label>
                <textarea name="chest_xray_findings" class="form-input" rows="2" placeholder="e.g., Cardiomegaly, pulmonary edema, infiltrates, pleural effusion"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Echocardiogram (Echo)</label>
            <select name="echo_done" class="form-select" onchange="toggleConditional('echo-details', this.value === 'yes')">
                <option value="">Not done / Not available</option>
                <option value="yes">Done - Enter findings</option>
                <option value="normal">Done - Normal</option>
            </select>
        </div>

        <div class="conditional-section" id="echo-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">Echo Date (approximate)</label>
                    <input type="month" name="echo_date" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Ejection Fraction (EF%)</label>
                    <input type="number" name="echo_ef" class="form-input" placeholder="55" min="10" max="100">
                    <p class="form-help">Normal: 50-70%</p>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Other Echo Findings</label>
                <textarea name="echo_findings" class="form-input" rows="2" placeholder="e.g., Valvular abnormalities, wall motion abnormalities, diastolic dysfunction"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Carotid Ultrasound / Doppler</label>
            <select name="carotid_done" class="form-select" onchange="toggleConditional('carotid-details', this.value === 'yes')">
                <option value="">Not done / Not available</option>
                <option value="yes">Done - Enter findings</option>
                <option value="normal">Done - Normal / No significant stenosis</option>
            </select>
        </div>

        <div class="conditional-section" id="carotid-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Carotid Findings</label>
                <textarea name="carotid_findings" class="form-input" rows="2" placeholder="e.g., Right ICA 70% stenosis, Left ICA 30% stenosis"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">CT / MRI Findings</label>
            <select name="ct_mri_done" class="form-select" onchange="toggleConditional('ct-mri-details', this.value === 'yes')">
                <option value="">Not done / Not available</option>
                <option value="yes">Enter findings</option>
            </select>
        </div>

        <div class="conditional-section" id="ct-mri-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">CT / MRI Type & Findings</label>
                <textarea name="ct_mri_findings" class="form-input" rows="3" placeholder="e.g., CT chest: Multiple pulmonary nodules. MRI brain: Old lacunar infarcts."></textarea>
                <p class="form-help">Include anatomical region (chest, abdomen, brain, spine) and key findings</p>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Other Imaging</label>
            <textarea name="other_imaging" class="form-input" rows="2" placeholder="e.g., Nuclear stress test, cardiac catheterization, pulmonary function tests"></textarea>
        </div>
    </div>
</div>

                <!-- STEP 3: Medications & Allergies -->
<div class="wizard-step" id="step-3" data-step="3">
    <div class="step-header">
        <div class="step-number">Step 3 of 6</div>
        <h2 class="step-title">Medications & Allergies</h2>
        <p class="step-description">Please list ALL medications including over-the-counter drugs and supplements.</p>
    </div>

    <div class="subsection">
        <h3 class="subsection-title">Current Medications</h3>
        <p class="form-help" style="margin-bottom: 16px;">Include prescription drugs, over-the-counter medications, vitamins, and herbal supplements.</p>

        <div class="form-group">
            <label class="form-label">Cardiac Medications</label>
            <textarea name="cardiac_meds" class="form-input" rows="3" placeholder="Example: Metoprolol 50mg twice daily, Lisinopril 10mg once daily"></textarea>
            <p class="form-help">Beta blockers, ACE inhibitors, ARBs, statins, aspirin, etc.</p>
        </div>

        <div class="form-group">
            <label class="form-label">Diabetes Medications</label>
            <textarea name="diabetes_meds" class="form-input" rows="3" placeholder="Example: Metformin 1000mg twice daily, Insulin glargine 30 units at bedtime"></textarea>
            <p class="form-help">Metformin, insulin, SGLT2 inhibitors (Jardiance, Farxiga), GLP-1 agonists (Ozempic, semaglutide)</p>
        </div>

        <div class="form-group">
            <label class="form-label">Anticoagulation / Antiplatelet</label>
            <textarea name="anticoag_meds" class="form-input" rows="3" placeholder="Example: Warfarin 5mg daily, Clopidogrel 75mg daily"></textarea>
            <p class="form-help">Warfarin, Eliquis, Xarelto, Pradaxa, aspirin, Plavix</p>
        </div>

        <div class="form-group">
            <label class="form-label">Pain Medications</label>
            <textarea name="pain_meds" class="form-input" rows="2" placeholder="Example: Ibuprofen 600mg as needed, Hydrocodone/acetaminophen 5/325mg as needed"></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">All Other Medications</label>
            <textarea name="other_meds" class="form-input" rows="4" placeholder="List all other medications with doses and frequency"></textarea>
        </div>
    </div>

    <div class="subsection">
        <h3 class="subsection-title">Drug Allergies</h3>
        <p class="form-help" style="margin-bottom: 16px;">It's critical we know about any drug allergies or adverse reactions.</p>

        <div class="form-group">
            <label class="form-label">Drug allergies</label>
            <select name="has_allergies" class="form-select" onchange="toggleConditional('allergy-details', this.value === 'yes')">
                <option value="">Select</option>
                <option value="no">No Known Drug Allergies</option>
                <option value="yes">Yes, I have drug allergies</option>
            </select>
        </div>

        <div class="conditional-section" id="allergy-details" style="display:none;">
            <div id="allergy-list">
                <!-- Allergy Entry 1 -->
                <div class="allergy-entry">
                    <div class="allergy-header">
                        <h4>Allergy #1</h4>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Drug Name</label>
                        <input type="text" name="allergy_drug_1" class="form-input" placeholder="e.g., Penicillin">
                    </div>
                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Reaction Type</label>
                            <select name="allergy_type_1" class="form-select">
                                <option value="">Select</option>
                                <option value="Rash">Rash / Hives</option>
                                <option value="Anaphylaxis">Anaphylaxis (severe allergic reaction)</option>
                                <option value="Swelling">Swelling (angioedema)</option>
                                <option value="Breathing">Breathing difficulty</option>
                                <option value="Nausea">Nausea / Vomiting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity</label>
                            <select name="allergy_severity_1" class="form-select">
                                <option value="">Select</option>
                                <option value="Mild">Mild</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Severe">Severe</option>
                                <option value="Life-threatening">Life-threatening</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description of Reaction</label>
                        <textarea name="allergy_description_1" class="form-input" rows="2" placeholder="Describe what happened"></textarea>
                    </div>
                </div>

                <!-- Allergy Entry 2 -->
                <div class="allergy-entry">
                    <div class="allergy-header">
                        <h4>Allergy #2 (optional)</h4>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Drug Name</label>
                        <input type="text" name="allergy_drug_2" class="form-input" placeholder="e.g., Codeine">
                    </div>
                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Reaction Type</label>
                            <select name="allergy_type_2" class="form-select">
                                <option value="">Select</option>
                                <option value="Rash">Rash / Hives</option>
                                <option value="Anaphylaxis">Anaphylaxis</option>
                                <option value="Swelling">Swelling</option>
                                <option value="Breathing">Breathing difficulty</option>
                                <option value="Nausea">Nausea / Vomiting</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Severity</label>
                            <select name="allergy_severity_2" class="form-select">
                                <option value="">Select</option>
                                <option value="Mild">Mild</option>
                                <option value="Moderate">Moderate</option>
                                <option value="Severe">Severe</option>
                                <option value="Life-threatening">Life-threatening</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Any other allergies?</label>
                <textarea name="other_allergies" class="form-input" rows="2" placeholder="List any additional drug allergies"></textarea>
            </div>

            <!-- Special Allergies -->
            <div class="form-group">
                <label class="form-label">Special Allergies (check all that apply)</label>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_allergies" value="Latex">
                        <span class="checkbox-label">Latex</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_allergies" value="Egg">
                        <span class="checkbox-label">Egg (may affect propofol use)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_allergies" value="Soy">
                        <span class="checkbox-label">Soy (may affect propofol use)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_allergies" value="Iodine/Shellfish">
                        <span class="checkbox-label">Iodine / Shellfish</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="subsection">
        <h3 class="subsection-title">Social History</h3>

        <div class="form-group">
            <label class="form-label">Tobacco Use</label>
            <select name="tobacco" class="form-select" onchange="toggleConditional('tobacco-details', ['current', 'former'].includes(this.value))">
                <option value="">Select</option>
                <option value="never">Never</option>
                <option value="current">Current Smoker</option>
                <option value="former">Former Smoker</option>
            </select>
        </div>

        <div class="conditional-section" id="tobacco-details" style="display:none;">
            <div class="input-row">
                <div class="form-group">
                    <label class="form-label">Packs per Day</label>
                    <input type="number" name="packs_per_day" class="form-input" placeholder="1" min="0" max="5" step="0.5">
                </div>
                <div class="form-group">
                    <label class="form-label">Years Smoked</label>
                    <input type="number" name="years_smoked" class="form-input" placeholder="20" min="0" max="100">
                </div>
            </div>
            <div class="form-group" id="quit-date-group" style="display:none;">
                <label class="form-label">Quit Date (if former smoker)</label>
                <input type="month" name="quit_date" class="form-input">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Alcohol Use</label>
            <select name="alcohol" class="form-select">
                <option value="">Select</option>
                <option value="none">None</option>
                <option value="occasional">Occasional (1-7 drinks/week)</option>
                <option value="moderate">Moderate (8-14 drinks/week)</option>
                <option value="heavy">Heavy (>14 drinks/week)</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Recreational Drug Use</label>
            <select name="drug_use" class="form-select" onchange="toggleConditional('drug-details', this.value === 'yes')">
                <option value="">Select</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
                <option value="prefer-not-to-answer">Prefer not to answer</option>
            </select>
            <p class="form-help">This information is confidential and helps us provide safer care.</p>
        </div>

        <div class="conditional-section" id="drug-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Type of Substance(s)</label>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="substances" value="Marijuana">
                        <span class="checkbox-label">Marijuana / THC</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="substances" value="Cocaine">
                        <span class="checkbox-label">Cocaine</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="substances" value="Methamphetamine">
                        <span class="checkbox-label">Methamphetamine</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="substances" value="Opioids">
                        <span class="checkbox-label">Opioids (non-prescribed)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="substances" value="Other">
                        <span class="checkbox-label">Other</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Last Use</label>
                <select name="last_use" class="form-select">
                    <option value="">Select</option>
                    <option value="within-24h">Within 24 hours</option>
                    <option value="1-7-days">1-7 days ago</option>
                    <option value="1-4-weeks">1-4 weeks ago</option>
                    <option value=">4-weeks">More than 4 weeks ago</option>
                </select>
            </div>
        </div>
    </div>
</div>

                <!-- STEP 4: Functional Assessment -->
<div class="wizard-step" id="step-4" data-step="4">
    <div class="step-header">
        <div class="step-number">Step 4 of 6</div>
        <h2 class="step-title">Functional Capacity Assessment</h2>
        <p class="step-description">Physical fitness assessment and sleep apnea screening.</p>
    </div>

    <!-- STOP-BANG Questionnaire -->
    <div class="subsection">
        <h3 class="subsection-title">STOP-BANG: Sleep Apnea Screening</h3>
        <p class="form-help" style="margin-bottom: 20px;">Answer YES or NO to each question. A score ≥3 suggests high risk for obstructive sleep apnea.</p>

        <div class="stopbang-questions">
            <div class="question-card">
                <div class="question-text">
                    <strong>S</strong>noring: Does the patient snore loudly (louder than talking or loud enough to be heard through closed doors)?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_snoring" value="yes" required>
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_snoring" value="no">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>T</strong>iredness: Does the patient often feel tired, fatigued, or sleepy during the daytime?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_tired" value="yes" required>
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_tired" value="no">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>O</strong>bserved: Has anyone observed the patient stop breathing during sleep?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_observed" value="yes" required>
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_observed" value="no">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>P</strong>ressure: Does the patient have or are they being treated for high blood pressure?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_pressure" value="yes" required>
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_pressure" value="no">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>B</strong>MI: Is the patient's BMI more than 35 kg/m²?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_bmi" value="yes" required id="stopbang-bmi-yes">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_bmi" value="no" id="stopbang-bmi-no">
                        <span>No</span>
                    </label>
                </div>
                <p class="form-help" style="margin-top: 8px;">Patient BMI: <span id="stopbang-bmi-value">--</span> kg/m² (auto-calculated)</p>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>A</strong>ge: Is the patient older than 50 years?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_age" value="yes" required id="stopbang-age-yes">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_age" value="no" id="stopbang-age-no">
                        <span>No</span>
                    </label>
                </div>
                <p class="form-help" style="margin-top: 8px;">Patient age: <span id="stopbang-age-value">--</span> years (auto-calculated)</p>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>N</strong>eck: Is the patient's neck circumference > 40 cm (16 inches)?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_neck" value="yes" required>
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_neck" value="no">
                        <span>No</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_neck" value="unknown">
                        <span>Don't know</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    <strong>G</strong>ender: Is the patient male?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_gender" value="yes" required id="stopbang-gender-yes">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="stopbang_gender" value="no" id="stopbang-gender-no">
                        <span>No</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="score-display" id="stopbang-score-display">
            <div class="score-label">STOP-BANG Score:</div>
            <div class="score-value" id="stopbang-score">0 / 8</div>
            <div class="score-interpretation" id="stopbang-interpretation">Complete all questions to see the score</div>
        </div>
    </div>

    <!-- DASI Questionnaire -->
    <div class="subsection">
        <h3 class="subsection-title">DASI: Functional Capacity</h3>
        <p class="form-help" style="margin-bottom: 20px;">Answer YES or NO to indicate whether the patient can perform each activity. This helps estimate functional capacity in METs.</p>

        <div class="dasi-questions">
            <div class="question-card">
                <div class="question-text">
                    1. Can the patient take care of themselves (eating, dressing, bathing, or using the toilet)?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_1" value="2.75" data-weight="2.75">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_1" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    2. Can the patient walk indoors?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_2" value="1.75" data-weight="1.75">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_2" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    3. Can the patient walk a block or two on level ground?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_3" value="2.75" data-weight="2.75">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_3" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    4. Can the patient climb a flight of stairs or walk up a hill?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_4" value="5.50" data-weight="5.50">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_4" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    5. Can the patient run a short distance?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_5" value="8.00" data-weight="8.00">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_5" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    6. Can the patient do light work around the house like dusting or washing dishes?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_6" value="2.70" data-weight="2.70">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_6" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    7. Can the patient do moderate work around the house like vacuuming, sweeping floors, or carrying groceries?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_7" value="3.50" data-weight="3.50">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_7" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    8. Can the patient do heavy work around the house like scrubbing floors or lifting/moving heavy furniture?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_8" value="8.00" data-weight="8.00">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_8" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    9. Can the patient do yard work like raking leaves, weeding, or pushing a power mower?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_9" value="4.50" data-weight="4.50">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_9" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    10. Can the patient have sexual relations?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_10" value="5.25" data-weight="5.25">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_10" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    11. Can the patient participate in moderate recreational activities like golf, bowling, dancing, doubles tennis, or throwing a baseball/football?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_11" value="6.00" data-weight="6.00">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_11" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>

            <div class="question-card">
                <div class="question-text">
                    12. Can the patient participate in strenuous sports like swimming, singles tennis, football, basketball, or skiing?
                </div>
                <div class="radio-group-inline">
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_12" value="7.50" data-weight="7.50">
                        <span>Yes</span>
                    </label>
                    <label class="radio-option-inline">
                        <input type="radio" name="dasi_12" value="0">
                        <span>No</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="score-display" id="dasi-score-display">
            <div class="score-label">DASI Score:</div>
            <div class="score-value" id="dasi-score">0.0 / 58.2</div>
            <div class="score-interpretation" id="dasi-interpretation">Estimated Functional Capacity: <span id="dasi-mets">--</span> METs</div>
        </div>
    </div>
</div>

                <!-- STEP 5: Airway Assessment & Surgical Details -->
<div class="wizard-step" id="step-5" data-step="5">
    <div class="step-header">
        <div class="step-number">Step 5 of 6</div>
        <h2 class="step-title">Airway Assessment & Surgical Details</h2>
        <p class="step-description">Surgical details and airway assessment information.</p>
    </div>

    <!-- Airway Assessment -->
    <div class="subsection">
        <h3 class="subsection-title">Airway Assessment</h3>
        <p class="form-help" style="margin-bottom: 20px;">These questions help predict potential airway challenges. Leave blank if unknown or unable to assess.</p>

        <div class="form-group">
            <label class="form-label">Previous Difficult Intubation?</label>
            <select name="difficult_intubation" class="form-select" onchange="toggleConditional('difficult-intubation-details', this.value === 'yes')">
                <option value="">Select</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
                <option value="unknown">Unknown / Never intubated</option>
            </select>
        </div>

        <div class="conditional-section" id="difficult-intubation-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Details of Previous Difficult Intubation</label>
                <textarea name="difficult_intubation_details" class="form-input" rows="3" placeholder="Describe what happened (e.g., needed fiberoptic intubation, multiple attempts, told by anesthesiologist)"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Mallampati Classification</label>
            <select name="mallampati" class="form-select">
                <option value="">Select if known</option>
                <option value="I">Class I - Full visibility of tonsils, uvula, and soft palate</option>
                <option value="II">Class II - Visibility of hard and soft palate, upper portion of tonsils and uvula</option>
                <option value="III">Class III - Soft and hard palate and base of uvula visible</option>
                <option value="IV">Class IV - Only hard palate visible</option>
                <option value="unknown">Unknown / Never assessed</option>
            </select>
            <p class="form-help">Patient opens mouth wide and sticks out tongue. Higher class = potentially more difficult airway.</p>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label class="form-label">Mouth Opening (interincisor distance)</label>
                <select name="mouth_opening" class="form-select">
                    <option value="">Select if known</option>
                    <option value=">4cm">&gt;4 cm (normal - 3+ finger widths)</option>
                    <option value="3-4cm">3-4 cm (2-3 finger widths)</option>
                    <option value="<3cm">&lt;3 cm (limited - <2 finger widths)</option>
                    <option value="unknown">Unknown</option>
                </select>
                <p class="form-help">How wide can the patient open their mouth?</p>
            </div>
            <div class="form-group">
                <label class="form-label">Thyromental Distance</label>
                <select name="thyromental_distance" class="form-select">
                    <option value="">Select if known</option>
                    <option value=">6.5cm">&gt;6.5 cm (normal - 3+ finger widths)</option>
                    <option value="6-6.5cm">6-6.5 cm (borderline)</option>
                    <option value="<6cm">&lt;6 cm (short - <3 finger widths)</option>
                    <option value="unknown">Unknown</option>
                </select>
                <p class="form-help">Distance from chin to thyroid cartilage (Adam's apple)</p>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Neck Mobility</label>
            <select name="neck_mobility" class="form-select">
                <option value="">Select</option>
                <option value="normal">Normal - Can touch chin to chest and look straight up</option>
                <option value="limited">Limited - Restricted neck movement</option>
                <option value="severely-limited">Severely Limited - Minimal neck movement (arthritis, fusion, trauma)</option>
            </select>
        </div>

        <div class="form-group">
            <label class="form-label">Dentition</label>
            <div class="checkbox-group">
                <label class="checkbox-option">
                    <input type="checkbox" name="dentition" value="Loose teeth">
                    <span class="checkbox-label">Loose teeth</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="dentition" value="Dentures (full or partial)">
                    <span class="checkbox-label">Dentures (full or partial)</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="dentition" value="Caps/crowns/bridges">
                    <span class="checkbox-label">Caps / Crowns / Bridges</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="dentition" value="Chipped/broken teeth">
                    <span class="checkbox-label">Chipped or broken teeth</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" name="dentition" value="None - Normal dentition">
                    <span class="checkbox-label">None - Normal dentition</span>
                </label>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Facial Hair (for mask ventilation assessment)</label>
            <select name="facial_hair" class="form-select">
                <option value="">Select</option>
                <option value="none">None</option>
                <option value="clean-shaven">Clean-shaven</option>
                <option value="stubble">Stubble</option>
                <option value="beard-short">Short beard</option>
                <option value="beard-full">Full beard</option>
            </select>
            <p class="form-help">Heavy beards can make mask ventilation challenging</p>
        </div>
    </div>

    <!-- Family History of Anesthesia Complications -->
    <div class="subsection">
        <h3 class="subsection-title">Family History of Anesthesia Complications</h3>
        <p class="form-help" style="margin-bottom: 16px;">Critical for identifying genetic risks like malignant hyperthermia.</p>

        <div class="form-group">
            <label class="form-label">Family History of Malignant Hyperthermia?</label>
            <select name="family_mh" class="form-select" onchange="toggleConditional('family-mh-details', this.value === 'yes')">
                <option value="">Select</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
                <option value="unknown">Unknown</option>
            </select>
            <p class="form-help">Rare genetic disorder causing life-threatening reaction to certain anesthetics</p>
        </div>

        <div class="conditional-section" id="family-mh-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Which Family Member(s)?</label>
                <input type="text" name="family_mh_relation" class="form-input" placeholder="e.g., Father, Brother, Uncle">
            </div>
            <div class="form-group">
                <label class="form-label">Details of Incident</label>
                <textarea name="family_mh_details" class="form-input" rows="2" placeholder="Describe what happened"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Family History of Unexpected Death During/After Anesthesia?</label>
            <select name="family_anesthesia_death" class="form-select" onchange="toggleConditional('family-death-details', this.value === 'yes')">
                <option value="">Select</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
                <option value="unknown">Unknown</option>
            </select>
        </div>

        <div class="conditional-section" id="family-death-details" style="display:none;">
            <div class="form-group">
                <label class="form-label">Details</label>
                <textarea name="family_death_details" class="form-input" rows="2" placeholder="Which family member(s) and approximate circumstances"></textarea>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Family History of Pseudocholinesterase Deficiency?</label>
            <select name="family_pseudocholinesterase" class="form-select">
                <option value="">Select</option>
                <option value="no">No</option>
                <option value="yes">Yes</option>
                <option value="unknown">Unknown</option>
            </select>
            <p class="form-help">Genetic condition causing prolonged paralysis after succinylcholine</p>
        </div>
    </div>

    <!-- Surgical Details -->
    <div class="subsection">
        <h3 class="subsection-title">Surgical Details</h3>

        <div class="form-group">
            <label class="form-label">Planned Surgical Procedure <span class="required">*</span></label>
            <input type="text" name="procedure" class="form-input" placeholder="e.g., Laparoscopic cholecystectomy, Total knee replacement" required>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label class="form-label">Surgical Specialty</label>
                <select name="surgical_specialty" class="form-select">
                    <option value="">Select</option>
                    <option value="General Surgery">General Surgery</option>
                    <option value="Orthopedic">Orthopedic</option>
                    <option value="Cardiac">Cardiac</option>
                    <option value="Vascular">Vascular</option>
                    <option value="Neurosurgery">Neurosurgery</option>
                    <option value="Urology">Urology</option>
                    <option value="Gynecology">Gynecology</option>
                    <option value="ENT">ENT (Ear, Nose, Throat)</option>
                    <option value="Ophthalmology">Ophthalmology</option>
                    <option value="Plastic Surgery">Plastic Surgery</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Surgical Risk Classification <span class="required">*</span></label>
                <select name="surgery_risk" class="form-select" required>
                    <option value="">Select</option>
                    <option value="low">Low Risk - Superficial, breast, dental, eye, endoscopy</option>
                    <option value="intermediate">Intermediate Risk - Orthopedic, gynecologic, urologic</option>
                    <option value="high">High Risk - Vascular, cardiac, major abdominal, neurosurgery</option>
                </select>
            </div>
        </div>

        <div class="input-row">
            <div class="form-group">
                <label class="form-label">Surgery Urgency <span class="required">*</span></label>
                <select name="urgency" class="form-select" required>
                    <option value="">Select</option>
                    <option value="elective">Elective</option>
                    <option value="urgent">Urgent (within days)</option>
                    <option value="emergency">Emergency (within hours)</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Expected Blood Loss</label>
                <select name="expected_blood_loss" class="form-select">
                    <option value="">Select</option>
                    <option value="minimal">Minimal (&lt;100 mL)</option>
                    <option value="low">Low (100-500 mL)</option>
                    <option value="moderate">Moderate (500-1000 mL)</option>
                    <option value="high">High (&gt;1000 mL)</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Surgeon Name</label>
            <input type="text" name="surgeon_name" class="form-input" placeholder="Dr. Smith">
        </div>

        <div class="form-group">
            <label class="form-label">Planned Surgery Date</label>
            <input type="date" name="surgery_date" class="form-input" min="{{ today_date }}">
        </div>

        <div class="form-group">
            <label class="form-label">Additional Surgical Information</label>
            <textarea name="additional_surgical_info" class="form-input" rows="3" placeholder="Any other details we should know about the planned surgery"></textarea>
        </div>
    </div>
</div>

                <!-- STEP 6: Review & Submit -->
<div class="wizard-step" id="step-6" data-step="6">
    <div class="step-header">
        <div class="step-number">Step 6 of 6</div>
        <h2 class="step-title">Review & Submit</h2>
        <p class="step-description">Review patient information before submitting.</p>
    </div>

    <!-- Automated Risk Summary Cards -->
    <div class="subsection">
        <h3 class="subsection-title">Calculated Risk Scores</h3>
        <p class="form-help" style="margin-bottom: 20px;">These scores are auto-calculated based on responses.</p>

        <div class="risk-summary-grid">
            <div class="risk-card">
                <div class="risk-card-header">
                    <div class="risk-card-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 28px; height: 28px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                        </svg>
                    </div>
                    <div class="risk-card-title">RCRI Score</div>
                </div>
                <div class="risk-card-value" id="review-rcri-score">--</div>
                <div class="risk-card-interpretation" id="review-rcri-interpretation">Revised Cardiac Risk Index</div>
            </div>

            <div class="risk-card">
                <div class="risk-card-header">
                    <div class="risk-card-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 28px; height: 28px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </div>
                    <div class="risk-card-title">STOP-BANG</div>
                </div>
                <div class="risk-card-value" id="review-stopbang-score">--</div>
                <div class="risk-card-interpretation" id="review-stopbang-interpretation">Sleep Apnea Risk</div>
            </div>

            <div class="risk-card">
                <div class="risk-card-header">
                    <div class="risk-card-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 28px; height: 28px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div class="risk-card-title">DASI / METs</div>
                </div>
                <div class="risk-card-value" id="review-dasi-mets">--</div>
                <div class="risk-card-interpretation" id="review-dasi-interpretation">Functional Capacity</div>
            </div>

            <div class="risk-card">
                <div class="risk-card-header">
                    <div class="risk-card-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 28px; height: 28px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                    </div>
                    <div class="risk-card-title">ASA Class</div>
                </div>
                <div class="risk-card-value" id="review-asa-class">--</div>
                <div class="risk-card-interpretation" id="review-asa-interpretation">Physical Status</div>
            </div>
        </div>
    </div>

    <!-- Red Flags Section -->
    <div class="subsection" id="red-flags-section" style="display:none;">
        <h3 class="subsection-title" style="color: var(--red-600); display: flex; align-items: center; gap: 10px;">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Red Flags Detected
        </h3>
        <div id="red-flags-list">
            <!-- Auto-populated by JavaScript -->
        </div>
    </div>

    <!-- Review Sections (Collapsible) -->
    <div class="subsection">
        <h3 class="subsection-title">Patient Information Summary</h3>
        <p class="form-help" style="margin-bottom: 20px;">Click any section to expand and review. Click "Edit" to go back and make changes.</p>

        <!-- Demographics Summary -->
        <div class="review-section">
            <div class="review-section-header" onclick="toggleReviewSection('demo')">
                <div class="review-section-title">
                    <span class="review-section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    Demographics & Basic Information
                </div>
                <div class="review-section-actions">
                    <button type="button" class="review-edit-btn" onclick="goToStep(1); event.stopPropagation();">Edit</button>
                    <span class="review-toggle-icon">▼</span>
                </div>
            </div>
            <div class="review-section-content" id="review-demo" style="display:none;">
                <div class="review-item">
                    <span class="review-label">Age:</span>
                    <span class="review-value" id="review-age">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Weight:</span>
                    <span class="review-value" id="review-weight">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Height:</span>
                    <span class="review-value" id="review-height">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">BMI:</span>
                    <span class="review-value" id="review-bmi">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Sex:</span>
                    <span class="review-value" id="review-sex">--</span>
                </div>
            </div>
        </div>

        <!-- Medical History Summary -->
        <div class="review-section">
            <div class="review-section-header" onclick="toggleReviewSection('medical')">
                <div class="review-section-title">
                    <span class="review-section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </span>
                    Medical History
                </div>
                <div class="review-section-actions">
                    <button type="button" class="review-edit-btn" onclick="goToStep(2); event.stopPropagation();">Edit</button>
                    <span class="review-toggle-icon">▼</span>
                </div>
            </div>
            <div class="review-section-content" id="review-medical" style="display:none;">
                <div class="review-item" id="review-hpi-item" style="display:none;">
                    <span class="review-label">History of Present Illness:</span>
                    <span class="review-value" id="review-hpi" style="white-space: pre-wrap; display: block; margin-top: 8px; padding: 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border-left: 3px solid var(--blue-600); font-size: 14px; line-height: 1.6;"></span>
                </div>
                <div class="review-item">
                    <span class="review-label">Comorbidities:</span>
                    <span class="review-value" id="review-comorbidities">None reported</span>
                </div>
            </div>
        </div>

        <!-- Medications & Allergies Summary -->
        <div class="review-section">
            <div class="review-section-header" onclick="toggleReviewSection('meds')">
                <div class="review-section-title">
                    <span class="review-section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                    </span>
                    Medications & Allergies
                </div>
                <div class="review-section-actions">
                    <button type="button" class="review-edit-btn" onclick="goToStep(3); event.stopPropagation();">Edit</button>
                    <span class="review-toggle-icon">▼</span>
                </div>
            </div>
            <div class="review-section-content" id="review-meds" style="display:none;">
                <div class="review-item">
                    <span class="review-label">Cardiac Medications:</span>
                    <span class="review-value" id="review-cardiac-meds">None</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Drug Allergies:</span>
                    <span class="review-value" id="review-allergies">None</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Tobacco Use:</span>
                    <span class="review-value" id="review-tobacco">--</span>
                </div>
            </div>
        </div>

        <!-- Functional Assessment Summary -->
        <div class="review-section">
            <div class="review-section-header" onclick="toggleReviewSection('functional')">
                <div class="review-section-title">
                    <span class="review-section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </span>
                    Functional Capacity Assessment
                </div>
                <div class="review-section-actions">
                    <button type="button" class="review-edit-btn" onclick="goToStep(4); event.stopPropagation();">Edit</button>
                    <span class="review-toggle-icon">▼</span>
                </div>
            </div>
            <div class="review-section-content" id="review-functional" style="display:none;">
                <div class="review-item">
                    <span class="review-label">STOP-BANG Score:</span>
                    <span class="review-value" id="review-sb-full">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">DASI Score:</span>
                    <span class="review-value" id="review-dasi-full">--</span>
                </div>
            </div>
        </div>

        <!-- Airway & Surgical Summary -->
        <div class="review-section">
            <div class="review-section-header" onclick="toggleReviewSection('surgical')">
                <div class="review-section-title">
                    <span class="review-section-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                    Airway & Surgical Details
                </div>
                <div class="review-section-actions">
                    <button type="button" class="review-edit-btn" onclick="goToStep(5); event.stopPropagation();">Edit</button>
                    <span class="review-toggle-icon">▼</span>
                </div>
            </div>
            <div class="review-section-content" id="review-surgical" style="display:none;">
                <div class="review-item">
                    <span class="review-label">Procedure:</span>
                    <span class="review-value" id="review-procedure">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Surgery Risk:</span>
                    <span class="review-value" id="review-surgery-risk">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Urgency:</span>
                    <span class="review-value" id="review-urgency">--</span>
                </div>
                <div class="review-item">
                    <span class="review-label">Difficult Airway History:</span>
                    <span class="review-value" id="review-airway">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Consent & Accuracy Statement -->
    <div class="subsection">
        <h3 class="subsection-title">Consent & Accuracy</h3>

        <div class="consent-box">
            <div class="form-group">
                <label class="checkbox-option" style="align-items: flex-start;">
                    <input type="checkbox" name="accuracy_confirmed" id="accuracy-checkbox" required>
                    <span class="checkbox-label" style="font-size: 14px; line-height: 1.6;">
                        <strong>I confirm that all information provided is accurate and complete to the best of my knowledge.</strong>
                        I understand that inaccurate or incomplete information may affect my anesthesia care and surgical outcome.
                    </span>
                </label>
            </div>

            <div class="form-group">
                <label class="checkbox-option" style="align-items: flex-start;">
                    <input type="checkbox" name="understand_disclaimer" id="disclaimer-checkbox" required>
                    <span class="checkbox-label" style="font-size: 14px; line-height: 1.6;">
                        <strong>I understand this is an educational tool only.</strong>
                        This assessment does not replace a formal preoperative evaluation by an anesthesiologist.
                        All recommendations must be verified by a qualified healthcare provider.
                    </span>
                </label>
            </div>
        </div>
    </div>

    <!-- Additional Comments -->
    <div class="subsection">
        <h3 class="subsection-title">Additional Comments (Optional)</h3>
        <div class="form-group">
            <label class="form-label">Anything else we should know?</label>
            <textarea name="additional_comments" class="form-input" rows="4" placeholder="Any additional concerns, questions, or pertinent information for the anesthesia team"></textarea>
        </div>
    </div>

    <!-- Submit Button Styling -->
    <style>
        .risk-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .risk-card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        }

        .risk-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        .risk-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .risk-card-icon {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue-600);
        }

        .risk-card-icon svg {
            width: 28px;
            height: 28px;
        }

        .risk-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .risk-card-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--blue-600);
            margin-bottom: 8px;
        }

        .risk-card-interpretation {
            font-size: 13px;
            color: var(--gray-600);
        }

        .review-section {
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.16,1,0.3,1);
        }

        .review-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .review-section-header:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .review-section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .review-section-icon {
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--blue-600);
        }

        .review-section-icon svg {
            width: 20px;
            height: 20px;
        }

        .review-section-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .review-edit-btn {
            padding: 6px 12px;
            background: var(--blue-600);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .review-edit-btn:hover {
            background: var(--blue-700);
            transform: translateY(-1px);
        }

        .review-toggle-icon {
            color: var(--gray-500);
            transition: transform 0.3s;
        }

        .review-section-content {
            padding: 0 20px 16px 20px;
            border-top: 1px solid var(--gray-200);
        }

        .review-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            min-width: 180px;
        }

        .review-value {
            font-size: 14px;
            color: var(--gray-900);
            flex: 1;
        }

        .consent-box {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid var(--blue-200);
            border-radius: 12px;
            padding: 20px;
        }

        .red-flag-alert {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--red-600);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
        }

        .red-flag-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .red-flag-content {
            flex: 1;
        }

        .red-flag-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--red-700);
            margin-bottom: 4px;
        }

        .red-flag-description {
            font-size: 14px;
            color: var(--red-600);
        }
    </style>
</div>


                <!-- Navigation Buttons -->
                <div class="wizard-navigation">
                    <button type="button" class="nav-btn nav-btn-secondary" id="prev-btn" onclick="previousStep()" style="display:none;">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                        Previous
                    </button>
                    <button type="button" class="nav-btn nav-btn-primary" id="next-btn" onclick="nextStep()">
                        Next
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                    <button type="submit" class="nav-btn nav-btn-submit" id="submit-btn" style="display:none;">
                        <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Submit Assessment
                    </button>
                </div>
            </form>


            {% else %}
            <!-- RESULTS SECTION -->
            <div class="results-section">
                <div class="header">
                    <h1 class="header-title">Pre-Operative <span class="blue">Assessment</span></h1>
                    <p class="header-subtitle" style="display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap;">
                        <span>Evidence-based risk stratification and perioperative recommendations</span>
                        {% if mode %}
                        <span class="mode-badge-inline {% if mode == 'agentic' %}agentic{% endif %}">
                            <svg class="mode-icon-inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                {% if mode == 'agentic' %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                                {% else %}
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                {% endif %}
                            </svg>
                            <span class="mode-text-inline">
                                {% if mode == 'agentic' %}
                                Agentic AI
                                {% else %}
                                Fast RAG
                                {% endif %}
                            </span>
                        </span>
                        {% endif %}
                    </p>
                </div>

                <!-- Agent Reasoning Trace -->
                {% if reasoning_trace %}
                <div class="agent-reasoning">
                    <div class="agent-header" onclick="toggleAgentReasoning()">
                        <svg class="agent-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        <div class="agent-title">Agent Reasoning Trace</div>
                        <svg class="toggle-icon" id="toggleIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                    <div class="agent-steps" id="agentSteps">
                        {% for step in reasoning_trace %}
                        <div class="agent-step">{{ step }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Assessment Results (Structured Display) -->
                <div class="assessment-results">
                    {{ summary|safe }}
                </div>

                <!-- References Section -->
                {% if references %}
                <div class="references-section">
                    <div class="references-header">
                        <svg class="references-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        <div class="references-title">References</div>
                        <div class="references-count">{{ references|length }}</div>
                    </div>

                    {% for ref in references %}
                    <div class="reference-card">
                        <div class="reference-number">{{ loop.index }}</div>
                        <div class="reference-title">{{ ref.title }}</div>
                        <div class="reference-meta">
                            <span class="reference-authors">{{ ref.authors }}</span>
                            <span class="reference-journal">{{ ref.journal }}</span>
                            <span class="reference-year">{{ ref.year }}</span>
                        </div>
                        {% if ref.study_badge %}
                        <span class="study-badge" style="background-color: {{ ref.study_color }}; color: white;">
                            {{ ref.study_badge }}
                        </span>
                        {% endif %}
                        <a href="https://pubmed.ncbi.nlm.nih.gov/{{ ref.pmid }}/" target="_blank" rel="noopener" class="pmid-link">
                            PMID: {{ ref.pmid }}
                            <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div style="margin-top: 48px; text-align: center;">
                    <a href="/preop" style="display: inline-flex; align-items: center; gap: 10px; padding: 16px 32px; background: rgba(59, 130, 246, 0.9); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%); color: white; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; font-size: 15px; font-weight: 600; text-decoration: none; transition: all 0.3s cubic-bezier(0.16,1,0.3,1); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        New Assessment
                    </a>
                </div>
            </div>
            {% endif %}
        </main>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('show');
        }

        // Nav dropdown toggle
        function toggleNavDropdown(event) {
            event.stopPropagation();
            const menu = event.target.nextElementSibling;
            menu.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const dropdowns = document.querySelectorAll('.nav-dropdown-menu');
            dropdowns.forEach(dropdown => {
                if (!dropdown.parentElement.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });


        // Agent reasoning toggle
        function toggleAgentReasoning() {
            const steps = document.getElementById('agentSteps');
            const icon = document.getElementById('toggleIcon');
            if (steps && icon) {
                steps.classList.toggle('show');
                icon.classList.toggle('expanded');
            }
        }
    </script>
        <script>
// ===================================================================
// ROLLS ROYCE PREOPERATIVE WIZARD - JAVASCRIPT
// ===================================================================

// Global state
let currentStep = 1;
const totalSteps = 6;
let formData = {};

// ===================================================================
// INITIALIZATION
// ===================================================================

document.addEventListener('DOMContentLoaded', function() {
    initializeWizard();
    attachEventListeners();
    calculateBMI(); // Initial BMI calculation
    updateStopBangAge(); // Initial STOP-BANG age auto-population

    // Form submit loading overlay
    const form = document.getElementById('preop-wizard-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('show');
            }
        });
    }
});

function initializeWizard() {
    showStep(1);
    updateProgressBar();
}

// ===================================================================
// WIZARD NAVIGATION
// ===================================================================

function showStep(stepNumber) {
    // Hide all steps
    const steps = document.querySelectorAll('.wizard-step');
    steps.forEach(step => {
        step.style.display = 'none';
    });

    // Show target step
    const targetStep = document.querySelector(`[data-step="${stepNumber}"]`);
    if (targetStep) {
        targetStep.style.display = 'block';
        currentStep = stepNumber;
        updateProgressBar();
        updateNavigationButtons();

        // Special handling for review step
        if (stepNumber === 6) {
            populateReviewPage();
        }

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function goToStep(stepNumber) {
    if (stepNumber >= 1 && stepNumber <= totalSteps) {
        showStep(stepNumber);
    }
}

function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < totalSteps) {
            showStep(currentStep + 1);
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        showStep(currentStep - 1);
    }
}

function updateProgressBar() {
    const progressFill = document.getElementById('progress-fill');
    const progressText = document.getElementById('progress-text');
    const percentage = (currentStep / totalSteps) * 100;

    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
    if (progressText) {
        progressText.textContent = `Step ${currentStep} of ${totalSteps}`;
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');

    if (prevBtn) {
        prevBtn.style.display = currentStep === 1 ? 'none' : 'inline-flex';
    }

    if (nextBtn) {
        nextBtn.style.display = currentStep === totalSteps ? 'none' : 'inline-flex';
        nextBtn.textContent = currentStep === totalSteps - 1 ? 'Review' : 'Next';
    }

    if (submitBtn) {
        submitBtn.style.display = currentStep === totalSteps ? 'inline-flex' : 'none';
    }
}

// ===================================================================
// FORM VALIDATION
// ===================================================================

function validateCurrentStep() {
    const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
    if (!currentStepElement) return true;

    const requiredFields = currentStepElement.querySelectorAll('[required]');
    let isValid = true;

    requiredFields.forEach(field => {
        if (!field.value || field.value.trim() === '') {
            isValid = false;
            field.classList.add('error');

            // Show error message
            let errorMsg = field.parentElement.querySelector('.error-message');
            if (!errorMsg) {
                errorMsg = document.createElement('p');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'This field is required';
                errorMsg.style.color = 'var(--red-600)';
                errorMsg.style.fontSize = '13px';
                errorMsg.style.marginTop = '4px';
                field.parentElement.appendChild(errorMsg);
            }
        } else {
            field.classList.remove('error');
            const errorMsg = field.parentElement.querySelector('.error-message');
            if (errorMsg) {
                errorMsg.remove();
            }
        }
    });

    if (!isValid) {
        alert('Please fill in all required fields before continuing.');
    }

    return isValid;
}

// ===================================================================
// EVENT LISTENERS
// ===================================================================

function attachEventListeners() {
    // Weight/Height change for BMI calculation
    const weightInput = document.getElementById('weight-input');
    const heightInput = document.getElementById('height-input');
    const weightUnit = document.getElementById('weight-unit');
    const heightUnit = document.getElementById('height-unit');

    if (weightInput) weightInput.addEventListener('input', calculateBMI);
    if (heightInput) heightInput.addEventListener('input', calculateBMI);
    if (weightUnit) weightUnit.addEventListener('change', calculateBMI);
    if (heightUnit) heightUnit.addEventListener('change', calculateBMI);

    // Age input for STOP-BANG auto-population
    const ageInput = document.getElementById('age-input');
    if (ageInput) ageInput.addEventListener('input', updateStopBangAge);

    // STOP-BANG questions
    document.querySelectorAll('input[name^="stopbang_"]').forEach(input => {
        input.addEventListener('change', calculateStopBangScore);
    });

    // DASI questions
    document.querySelectorAll('input[name^="dasi_"]').forEach(input => {
        input.addEventListener('change', calculateDASIScore);
    });
}

// ===================================================================
// BMI CALCULATOR
// ===================================================================

function calculateBMI() {
    const weightInput = document.getElementById('weight-input');
    const heightInput = document.getElementById('height-input');
    const weightUnit = document.getElementById('weight-unit');
    const heightUnit = document.getElementById('height-unit');
    const bmiDisplay = document.getElementById('bmi-display');
    const bmiValue = document.getElementById('bmi-value');

    if (!weightInput || !heightInput || !bmiDisplay) return;

    const weight = parseFloat(weightInput.value);
    const height = parseFloat(heightInput.value);

    if (!weight || !height || weight <= 0 || height <= 0) {
        bmiDisplay.value = '';
        if (bmiValue) bmiValue.value = '';
        return;
    }

    // Convert to metric (kg and meters)
    let weightKg = weight;
    let heightM = height / 100; // cm to meters

    if (weightUnit && weightUnit.value === 'lbs') {
        weightKg = weight * 0.453592; // lbs to kg
    }

    if (heightUnit && heightUnit.value === 'inches') {
        heightM = height * 0.0254; // inches to meters
    }

    const bmi = weightKg / (heightM * heightM);

    bmiDisplay.value = bmi.toFixed(1) + ' kg/m²';
    if (bmiValue) bmiValue.value = bmi.toFixed(1);

    // Update STOP-BANG BMI question
    updateStopBangBMI(bmi);
}

function updateStopBangBMI(bmi) {
    const bmiValueSpan = document.getElementById('stopbang-bmi-value');
    const bmiYes = document.getElementById('stopbang-bmi-yes');
    const bmiNo = document.getElementById('stopbang-bmi-no');

    if (bmiValueSpan) {
        bmiValueSpan.textContent = bmi.toFixed(1);
    }

    // Auto-select based on BMI > 35
    if (bmi > 35) {
        if (bmiYes) bmiYes.checked = true;
    } else {
        if (bmiNo) bmiNo.checked = true;
    }

    calculateStopBangScore();
}

// ===================================================================
// STOP-BANG AGE AUTO-POPULATION
// ===================================================================

function updateStopBangAge() {
    const ageInput = document.getElementById('age-input');
    if (!ageInput || !ageInput.value) return;

    const age = parseInt(ageInput.value);
    if (isNaN(age)) return;

    const ageValueSpan = document.getElementById('stopbang-age-value');
    const ageYes = document.getElementById('stopbang-age-yes');
    const ageNo = document.getElementById('stopbang-age-no');

    if (ageValueSpan) {
        ageValueSpan.textContent = age;
    }

    // Auto-select based on age > 50
    if (age > 50) {
        if (ageYes) ageYes.checked = true;
    } else {
        if (ageNo) ageNo.checked = true;
    }

    calculateStopBangScore();
}

// ===================================================================
// STOP-BANG CALCULATOR
// ===================================================================

function calculateStopBangScore() {
    const questions = [
        'stopbang_snoring',
        'stopbang_tired',
        'stopbang_observed',
        'stopbang_pressure',
        'stopbang_bmi',
        'stopbang_age',
        'stopbang_neck',
        'stopbang_gender'
    ];

    let score = 0;
    let answeredCount = 0;

    questions.forEach(name => {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        if (selected) {
            answeredCount++;
            if (selected.value === 'yes') {
                score++;
            }
        }
    });

    const scoreDisplay = document.getElementById('stopbang-score');
    const interpretation = document.getElementById('stopbang-interpretation');

    if (scoreDisplay) {
        scoreDisplay.textContent = `${score} / 8`;
    }

    if (interpretation && answeredCount === 8) {
        let riskLevel = '';
        let color = '';

        if (score >= 5) {
            riskLevel = 'High Risk for severe OSA';
            color = 'var(--red-600)';
        } else if (score >= 3) {
            riskLevel = 'High Risk for OSA';
            color = 'var(--orange-600)';
        } else {
            riskLevel = 'Low Risk for OSA';
            color = 'var(--green-600)';
        }

        interpretation.innerHTML = `<span style="color: ${color}; font-weight: 600;">${riskLevel}</span>`;
    } else if (interpretation) {
        interpretation.textContent = 'Complete all questions to see your score';
    }

    return score;
}

// ===================================================================
// DASI CALCULATOR
// ===================================================================

function calculateDASIScore() {
    const questions = [
        'dasi_1', 'dasi_2', 'dasi_3', 'dasi_4', 'dasi_5', 'dasi_6',
        'dasi_7', 'dasi_8', 'dasi_9', 'dasi_10', 'dasi_11', 'dasi_12'
    ];

    let totalScore = 0;
    let answeredCount = 0;

    questions.forEach(name => {
        const selected = document.querySelector(`input[name="${name}"]:checked`);
        if (selected) {
            answeredCount++;
            totalScore += parseFloat(selected.value);
        }
    });

    const scoreDisplay = document.getElementById('dasi-score');
    const interpretation = document.getElementById('dasi-interpretation');
    const metsSpan = document.getElementById('dasi-mets');

    if (scoreDisplay) {
        scoreDisplay.textContent = `${totalScore.toFixed(1)} / 58.2`;
    }

    if (answeredCount === 12 && interpretation && metsSpan) {
        // Calculate METs using formula: VO2 max = 0.43 × DASI + 9.6
        const vo2max = (0.43 * totalScore) + 9.6;
        const mets = vo2max / 3.5; // Convert to METs

        metsSpan.textContent = mets.toFixed(1);

        let capacity = '';
        let color = '';

        if (mets >= 10) {
            capacity = 'Excellent';
            color = 'var(--green-600)';
        } else if (mets >= 7) {
            capacity = 'Good';
            color = 'var(--blue-600)';
        } else if (mets >= 4) {
            capacity = 'Moderate';
            color = 'var(--orange-600)';
        } else {
            capacity = 'Poor';
            color = 'var(--red-600)';
        }

        interpretation.innerHTML = `Estimated Functional Capacity: <span style="color: ${color}; font-weight: 600;">${mets.toFixed(1)} METs (${capacity})</span>`;
    } else if (interpretation) {
        interpretation.innerHTML = 'Estimated Functional Capacity: <span id="dasi-mets">--</span> METs';
    }

    return totalScore;
}

// ===================================================================
// RCRI CALCULATOR
// ===================================================================

function calculateRCRI() {
    let score = 0;

    // High-risk surgery
    const surgeryRisk = document.querySelector('select[name="surgery_risk"]');
    if (surgeryRisk && surgeryRisk.value === 'high') {
        score++;
    }

    // Ischemic heart disease (CAD or Prior MI)
    const cad = document.getElementById('cad');
    const priorMI = document.getElementById('prior-mi');
    if ((cad && cad.checked) || (priorMI && priorMI.checked)) {
        score++;
    }

    // Heart failure
    const hf = document.getElementById('hf');
    if (hf && hf.checked) {
        score++;
    }

    // Cerebrovascular disease (Stroke/TIA)
    const stroke = document.getElementById('stroke');
    if (stroke && stroke.checked) {
        score++;
    }

    // Diabetes mellitus (on insulin)
    const dm = document.getElementById('dm');
    const dmManagement = document.querySelector('select[name="dm_management"]');
    if (dm && dm.checked && dmManagement && (dmManagement.value === 'Insulin' || dmManagement.value === 'Both')) {
        score++;
    }

    // Creatinine > 2.0 mg/dL
    const crInput = document.querySelector('input[name="cr"]');
    if (crInput && parseFloat(crInput.value) > 2.0) {
        score++;
    }

    return score;
}

// ===================================================================
// ASA CLASSIFICATION ESTIMATOR
// ===================================================================

function estimateASAClass() {
    const comorbidities = document.querySelectorAll('input[name="comorbidities"]:checked');
    const urgency = document.querySelector('select[name="urgency"]');

    // Emergency surgery → add "E" suffix
    const isEmergency = urgency && urgency.value === 'emergency';

    if (comorbidities.length === 0) {
        return isEmergency ? 'I E' : 'I';
    }

    // Check for severe disease
    const hf = document.getElementById('hf');
    const ckd = document.getElementById('ckd');
    const dialysis = document.querySelector('select[name="dialysis"]');
    const liver = document.getElementById('liver');
    const pulmonaryHtn = document.getElementById('pulm-htn');

    const hasSevereDisease = (hf && hf.checked) ||
                             (ckd && ckd.checked && dialysis && dialysis.value !== 'no') ||
                             (liver && liver.checked) ||
                             (pulmonaryHtn && pulmonaryHtn.checked);

    if (hasSevereDisease) {
        return isEmergency ? 'IV E' : 'IV';
    }

    if (comorbidities.length >= 3) {
        return isEmergency ? 'III E' : 'III';
    }

    if (comorbidities.length >= 1) {
        return isEmergency ? 'II E' : 'II';
    }

    return isEmergency ? 'I E' : 'I';
}

// ===================================================================
// RED FLAGS DETECTION
// ===================================================================

function detectRedFlags() {
    const flags = [];

    // Malignant hyperthermia family history
    const familyMH = document.querySelector('select[name="family_mh"]');
    if (familyMH && familyMH.value === 'yes') {
        flags.push({
            icon: '🔥',
            title: 'MALIGNANT HYPERTHERMIA FAMILY HISTORY',
            description: 'Avoid triggering agents (succinylcholine, volatile anesthetics). Use total IV anesthesia (TIVA).'
        });
    }

    // Difficult airway history
    const difficultIntubation = document.querySelector('select[name="difficult_intubation"]');
    if (difficultIntubation && difficultIntubation.value === 'yes') {
        flags.push({
            icon: '⚠️',
            title: 'DIFFICULT AIRWAY HISTORY',
            description: 'Prepare advanced airway equipment. Consider awake fiberoptic intubation. Anesthesiologist consultation required.'
        });
    }

    // Anticoagulation management
    const anticoagMeds = document.querySelector('textarea[name="anticoag_meds"]');
    if (anticoagMeds && anticoagMeds.value.trim() !== '') {
        flags.push({
            icon: '💊',
            title: 'ANTICOAGULATION MANAGEMENT NEEDED',
            description: 'Plan warfarin/DOAC holding times. Consider bridging based on thrombotic risk and procedure.'
        });
    }

    // ACEI + metformin + CKD interaction
    const cardiacMeds = document.querySelector('textarea[name="cardiac_meds"]');
    const diabetesMeds = document.querySelector('textarea[name="diabetes_meds"]');
    const ckd = document.getElementById('ckd');

    const hasACEI = cardiacMeds && (cardiacMeds.value.toLowerCase().includes('lisinopril') ||
                                    cardiacMeds.value.toLowerCase().includes('enalapril') ||
                                    cardiacMeds.value.toLowerCase().includes('losartan'));
    const hasMetformin = diabetesMeds && diabetesMeds.value.toLowerCase().includes('metformin');
    const hasCKD = ckd && ckd.checked;

    if (hasACEI && hasMetformin && hasCKD) {
        flags.push({
            icon: '⚡',
            title: 'DRUG INTERACTION: ACEI + METFORMIN + CKD',
            description: 'Hold ACEI morning of surgery (hypotension risk). Hold metformin 48hr pre-op (lactic acidosis risk).'
        });
    }

    // STOP-BANG high risk
    const stopBangScore = calculateStopBangScore();
    if (stopBangScore >= 5) {
        flags.push({
            icon: '😴',
            title: 'SEVERE OSA RISK (STOP-BANG ≥5)',
            description: 'Consider monitored setting for recovery. Minimize opioids. CPAP available postoperatively.'
        });
    }

    // Poor functional capacity
    const dasiScore = calculateDASIScore();
    const vo2max = (0.43 * dasiScore) + 9.6;
    const mets = vo2max / 3.5;

    if (mets < 4) {
        flags.push({
            icon: '🏃',
            title: 'POOR FUNCTIONAL CAPACITY (<4 METs)',
            description: 'Increased perioperative cardiac risk. Consider preoperative cardiac evaluation per ACC/AHA guidelines.'
        });
    }

    // High RCRI score
    const rcriScore = calculateRCRI();
    if (rcriScore >= 3) {
        flags.push({
            icon: '❤️',
            title: 'HIGH CARDIAC RISK (RCRI ≥3)',
            description: 'Cardiac event risk >5%. Cardiology consultation recommended. Optimize medical therapy.'
        });
    }

    return flags;
}

// ===================================================================
// CONDITIONAL SECTIONS TOGGLE
// ===================================================================

function toggleConditional(sectionId, condition = null) {
    const section = document.getElementById(sectionId);
    if (!section) return;

    if (condition === null) {
        // Toggle
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    } else {
        // Set explicit state
        section.style.display = condition ? 'block' : 'none';
    }
}

// ===================================================================
// REVIEW PAGE POPULATION
// ===================================================================

function populateReviewPage() {
    // Calculate all scores
    const rcriScore = calculateRCRI();
    const stopBangScore = calculateStopBangScore();
    const dasiScore = calculateDASIScore();
    const asaClass = estimateASAClass();
    const redFlags = detectRedFlags();

    // Populate risk cards
    document.getElementById('review-rcri-score').textContent = rcriScore;
    document.getElementById('review-rcri-interpretation').textContent =
        rcriScore >= 3 ? 'High Risk (>5% cardiac event)' :
        rcriScore >= 2 ? 'Moderate Risk' : 'Low Risk';

    document.getElementById('review-stopbang-score').textContent = `${stopBangScore} / 8`;
    document.getElementById('review-stopbang-interpretation').textContent =
        stopBangScore >= 5 ? 'High Risk (severe OSA)' :
        stopBangScore >= 3 ? 'High Risk' : 'Low Risk';

    const vo2max = (0.43 * dasiScore) + 9.6;
    const mets = vo2max / 3.5;
    document.getElementById('review-dasi-mets').textContent = mets.toFixed(1);
    document.getElementById('review-dasi-interpretation').textContent =
        mets >= 10 ? 'Excellent' :
        mets >= 7 ? 'Good' :
        mets >= 4 ? 'Moderate' : 'Poor';

    document.getElementById('review-asa-class').textContent = asaClass;
    document.getElementById('review-asa-interpretation').textContent = 'Physical Status';

    // Show red flags
    const redFlagsSection = document.getElementById('red-flags-section');
    const redFlagsList = document.getElementById('red-flags-list');

    if (redFlags.length > 0) {
        redFlagsSection.style.display = 'block';
        redFlagsList.innerHTML = redFlags.map(flag => `
            <div class="red-flag-alert">
                <div class="red-flag-icon">${flag.icon}</div>
                <div class="red-flag-content">
                    <div class="red-flag-title">${flag.title}</div>
                    <div class="red-flag-description">${flag.description}</div>
                </div>
            </div>
        `).join('');
    } else {
        redFlagsSection.style.display = 'none';
    }

    // Populate demographics
    const ageInput = document.getElementById('age-input');
    const age = ageInput ? parseInt(ageInput.value) : null;
    document.getElementById('review-age').textContent = age ? `${age} years` : '--';

    const weightInput = document.getElementById('weight-input');
    const weightUnit = document.getElementById('weight-unit');
    if (weightInput && weightUnit) {
        document.getElementById('review-weight').textContent =
            `${weightInput.value} ${weightUnit.value}`;
    }

    const heightInput = document.getElementById('height-input');
    const heightUnit = document.getElementById('height-unit');
    if (heightInput && heightUnit) {
        document.getElementById('review-height').textContent =
            `${heightInput.value} ${heightUnit.value}`;
    }

    const bmiDisplay = document.getElementById('bmi-display');
    if (bmiDisplay) {
        document.getElementById('review-bmi').textContent = bmiDisplay.value || '--';
    }

    const sex = document.querySelector('select[name="sex"]');
    if (sex) {
        document.getElementById('review-sex').textContent =
            sex.value === 'M' ? 'Male' : sex.value === 'F' ? 'Female' : '--';
    }

    // Populate comorbidities
    const comorbidities = Array.from(document.querySelectorAll('input[name="comorbidities"]:checked'))
        .map(cb => cb.value);
    document.getElementById('review-comorbidities').textContent =
        comorbidities.length > 0 ? comorbidities.join(', ') : 'None reported';

    // Populate HPI
    const hpi = document.querySelector('textarea[name="hpi"]');
    const hpiItem = document.getElementById('review-hpi-item');
    const hpiValue = document.getElementById('review-hpi');
    if (hpi && hpi.value.trim()) {
        hpiValue.textContent = hpi.value.trim();
        hpiItem.style.display = 'block';
    } else {
        hpiItem.style.display = 'none';
    }

    // Populate medications
    const cardiacMeds = document.querySelector('textarea[name="cardiac_meds"]');
    if (cardiacMeds) {
        document.getElementById('review-cardiac-meds').textContent =
            cardiacMeds.value.trim() || 'None';
    }

    // Populate allergies
    const hasAllergies = document.querySelector('select[name="has_allergies"]');
    if (hasAllergies && hasAllergies.value === 'yes') {
        const allergyDrug1 = document.querySelector('input[name="allergy_drug_1"]');
        document.getElementById('review-allergies').textContent =
            allergyDrug1 && allergyDrug1.value ? allergyDrug1.value : 'See form';
    } else {
        document.getElementById('review-allergies').textContent = 'No known drug allergies';
    }

    // Populate tobacco
    const tobacco = document.querySelector('select[name="tobacco"]');
    if (tobacco) {
        document.getElementById('review-tobacco').textContent =
            tobacco.options[tobacco.selectedIndex]?.text || '--';
    }

    // Populate STOP-BANG/DASI
    document.getElementById('review-sb-full').textContent =
        `${stopBangScore} / 8 (${stopBangScore >= 3 ? 'High Risk' : 'Low Risk'})`;
    document.getElementById('review-dasi-full').textContent =
        `${dasiScore.toFixed(1)} / 58.2 (${mets.toFixed(1)} METs)`;

    // Populate surgical details
    const procedure = document.querySelector('input[name="procedure"]');
    if (procedure) {
        document.getElementById('review-procedure').textContent = procedure.value || '--';
    }

    const surgeryRisk = document.querySelector('select[name="surgery_risk"]');
    if (surgeryRisk) {
        document.getElementById('review-surgery-risk').textContent =
            surgeryRisk.options[surgeryRisk.selectedIndex]?.text || '--';
    }

    const urgency = document.querySelector('select[name="urgency"]');
    if (urgency) {
        document.getElementById('review-urgency').textContent =
            urgency.options[urgency.selectedIndex]?.text || '--';
    }

    const difficultIntubation = document.querySelector('select[name="difficult_intubation"]');
    if (difficultIntubation) {
        document.getElementById('review-airway').textContent =
            difficultIntubation.value === 'yes' ? 'Yes - Difficult Airway History' :
            difficultIntubation.value === 'no' ? 'No' : 'Unknown';
    }
}

function toggleReviewSection(sectionId) {
    const content = document.getElementById(`review-${sectionId}`);
    const header = content.previousElementSibling;
    const icon = header.querySelector('.review-toggle-icon');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▲';
    } else {
        content.style.display = 'none';
        icon.textContent = '▼';
    }
}

        </script>

</body>
</html>
