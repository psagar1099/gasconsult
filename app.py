from flask import Flask, request, render_template_string, session, redirect, url_for, Response, stream_with_context, jsonify, make_response, flash
from flask_session import Session
from flask_limiter import Limiter
from flask_limiter.util import get_remote_address
from flask_wtf.csrf import CSRFProtect, CSRFError
from flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user
from flask_bcrypt import Bcrypt
from flask_mail import Mail, Message
from authlib.integrations.flask_client import OAuth
from werkzeug.exceptions import HTTPException, NotFound
from Bio import Entrez
import openai
import os
import re
import secrets
import uuid
import json
import bleach
import redis
import hashlib
import datetime
import logging
import tempfile
from dotenv import load_dotenv

# Import database module for persistent chat history (Phase 1)
try:
    import database
    DATABASE_AVAILABLE = True
except ImportError as e:
    DATABASE_AVAILABLE = False
    import logging
    logging.warning(f"Database module not available: {e}")

# Import IOH model classes for pickle deserialization
try:
    import ioh_models
    IOH_MODELS_AVAILABLE = True
except ImportError as e:
    IOH_MODELS_AVAILABLE = False
    import logging
    logging.warning(f"IOH models module not available: {e}")

# Load environment variables from .env file
load_dotenv()

app = Flask(__name__)
app.secret_key = os.getenv('FLASK_SECRET_KEY', secrets.token_hex(32))

# Security: Limit request size to prevent DoS attacks (16MB default)
app.config['MAX_CONTENT_LENGTH'] = int(os.getenv('MAX_CONTENT_LENGTH', 16777216))

# Initialize Flask-Bcrypt for password hashing
bcrypt = Bcrypt(app)

# Initialize Flask-Mail for email verification
app.config['MAIL_SERVER'] = os.getenv('MAIL_SERVER', 'smtp.gmail.com')
app.config['MAIL_PORT'] = int(os.getenv('MAIL_PORT', 587))
app.config['MAIL_USE_TLS'] = os.getenv('MAIL_USE_TLS', 'true').lower() == 'true'
app.config['MAIL_USERNAME'] = os.getenv('MAIL_USERNAME', '')
app.config['MAIL_PASSWORD'] = os.getenv('MAIL_PASSWORD', '')
app.config['MAIL_DEFAULT_SENDER'] = os.getenv('MAIL_DEFAULT_SENDER', os.getenv('MAIL_USERNAME', 'noreply@gasconsult.ai'))
mail = Mail(app)

# Check if email is configured
EMAIL_CONFIGURED = bool(os.getenv('MAIL_USERNAME') and os.getenv('MAIL_PASSWORD'))
if not EMAIL_CONFIGURED:
    import logging
    logging.info("Email not configured - verification emails will not be sent (users will be auto-verified)")

# Initialize OAuth for Google and Apple Sign In
oauth = OAuth(app)

# Google OAuth Configuration
google = oauth.register(
    name='google',
    client_id=os.getenv('GOOGLE_CLIENT_ID'),
    client_secret=os.getenv('GOOGLE_CLIENT_SECRET'),
    server_metadata_url='https://accounts.google.com/.well-known/openid-configuration',
    client_kwargs={
        'scope': 'openid email profile'
    }
)

# Apple OAuth Configuration
apple = oauth.register(
    name='apple',
    client_id=os.getenv('APPLE_CLIENT_ID'),
    client_secret=os.getenv('APPLE_CLIENT_SECRET'),
    server_metadata_url='https://appleid.apple.com/.well-known/openid-configuration',
    client_kwargs={
        'scope': 'name email'
    }
)

# Check if OAuth is configured
GOOGLE_OAUTH_CONFIGURED = bool(os.getenv('GOOGLE_CLIENT_ID') and os.getenv('GOOGLE_CLIENT_SECRET'))
APPLE_OAUTH_CONFIGURED = bool(os.getenv('APPLE_CLIENT_ID') and os.getenv('APPLE_CLIENT_SECRET'))

if not GOOGLE_OAUTH_CONFIGURED:
    import logging
    logging.info("Google OAuth not configured - Google Sign In will be disabled")

if not APPLE_OAUTH_CONFIGURED:
    import logging
    logging.info("Apple OAuth not configured - Apple Sign In will be disabled")

# Initialize Flask-Login for user session management
login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = 'login'
login_manager.login_message = 'Please log in to access this page.'
login_manager.login_message_category = 'info'

# Configure server-side sessions with Redis backend (production-grade, multi-worker safe)
# Falls back to localhost Redis if REDIS_URL not set (for local development)
redis_url = os.getenv('REDIS_URL', 'redis://localhost:6379')
try:
    # Initialize Redis connection
    redis_client = redis.from_url(
        redis_url,
        decode_responses=False,  # Keep binary for Flask-Session compatibility
        socket_connect_timeout=5,
        socket_keepalive=True,
        health_check_interval=30
    )
    # Test connection
    redis_client.ping()
    import logging
    logging.info(f"Successfully connected to Redis at {redis_url.split('@')[-1]}")  # Hide credentials in logs

    app.config['SESSION_TYPE'] = 'redis'
    app.config['SESSION_REDIS'] = redis_client
except (redis.ConnectionError, redis.TimeoutError) as e:
    import logging
    logging.warning(f"Redis connection failed: {e}")
    logging.warning("Falling back to filesystem sessions (not recommended for production)")
    # Fallback to filesystem sessions for development
    app.config['SESSION_TYPE'] = 'filesystem'
    app.config['SESSION_FILE_DIR'] = tempfile.gettempdir()

app.config['SESSION_PERMANENT'] = True
app.config['PERMANENT_SESSION_LIFETIME'] = 3600  # 1 hour
app.config['SESSION_USE_SIGNER'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SECURE'] = os.getenv('FLASK_ENV') == 'production' and os.getenv('FORCE_HTTPS', 'false').lower() == 'true'
Session(app)

# Initialize CSRF protection
csrf = CSRFProtect(app)
app.config['WTF_CSRF_TIME_LIMIT'] = None  # Don't expire CSRF tokens
app.config['WTF_CSRF_SSL_STRICT'] = False  # Allow CSRF on HTTP (behind reverse proxy)

# Initialize rate limiter with Redis backend (multi-worker safe)
# Falls back to memory if Redis unavailable
try:
    limiter_storage_uri = redis_url if 'redis_client' in locals() and redis_client else "memory://"
    # If we successfully connected to Redis earlier, use it for rate limiting
    if app.config.get('SESSION_TYPE') == 'redis':
        limiter_storage_uri = redis_url
        import logging
        logging.info("Rate limiter using Redis backend (multi-worker safe)")
    else:
        limiter_storage_uri = "memory://"
        import logging
        logging.warning("Rate limiter using in-memory storage (not recommended for multiple workers)")
except Exception as e:
    limiter_storage_uri = "memory://"
    import logging
    logging.warning(f"Rate limiter falling back to in-memory storage: {e}")

limiter = Limiter(
    app=app,
    key_func=get_remote_address,
    default_limits=[os.getenv("RATE_LIMIT", "60 per minute")],
    storage_uri=limiter_storage_uri
)

Entrez.email = os.getenv("ENTREZ_EMAIL", "your-email@example.com")
Entrez.api_key = os.getenv("ENTREZ_API_KEY", "")

openai_client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

# ====== Database Initialization ======
# Initialize database for user accounts and chat history (both mandatory)
# This is completely non-breaking - if database fails, app continues with limited functionality
DATABASE_INITIALIZED = False

# CRITICAL: Always initialize database if available (needed for user accounts and chat history)
if DATABASE_AVAILABLE:
    try:
        import logging
        logging.info("Initializing database for user accounts and chat history...")
        if database.init_db():
            DATABASE_INITIALIZED = True
            logging.info(f"✓ Database initialized successfully at {database.DB_PATH}")

            # Run OAuth migration for existing databases
            logging.info("Running OAuth database migration (if needed)...")
            if database.migrate_database_for_oauth():
                logging.info("✓ OAuth migration completed successfully")
            else:
                logging.warning("⚠️  OAuth migration failed - some features may not work")

            # Log database stats
            stats = database.get_database_stats()
            logging.info(f"✓ Database stats: {stats.get('total_conversations', 0)} conversations, "
                  f"{stats.get('total_messages', 0)} messages")
            logging.info("✓ Chat history enabled - all messages will be saved to database")
        else:
            logging.error("✗ Database initialization failed!")
            logging.warning("User registration and chat history will not work until database is initialized")
    except Exception as e:
        logging.error(f"✗ Database initialization error: {e}")
        logging.warning("User registration and chat history unavailable - database error")
        DATABASE_INITIALIZED = False
else:
    import logging
    logging.warning("⚠️  Database module not available - user registration and chat history disabled")

# ====== User Authentication (Flask-Login) ======

class User(UserMixin):
    """
    User class for Flask-Login.
    Represents an authenticated user with subscription info.
    """
    def __init__(self, user_id, email, full_name=None, subscription_tier='free', subscription_status='active', is_verified=True):
        self.id = user_id
        self.email = email
        self.full_name = full_name
        self.subscription_tier = subscription_tier
        self.subscription_status = subscription_status
        self.is_verified = is_verified

    @property
    def is_pro_user(self):
        """Check if user has pro subscription"""
        return self.subscription_tier in ['pro', 'team'] and self.subscription_status == 'active'

    @property
    def is_team_user(self):
        """Check if user has team subscription"""
        return self.subscription_tier == 'team' and self.subscription_status == 'active'

    @property
    def display_name(self):
        """Get user's display name (full name or email)"""
        return self.full_name if self.full_name else self.email.split('@')[0]


@login_manager.user_loader
def load_user(user_id):
    """
    Flask-Login user loader callback.
    Loads user from database for each request.
    """
    if not DATABASE_INITIALIZED:
        return None

    try:
        user_data = database.get_user_by_id(user_id)
        if user_data:
            return User(
                user_id=user_data['id'],
                email=user_data['email'],
                full_name=user_data.get('full_name'),
                subscription_tier=user_data.get('subscription_tier', 'free'),
                subscription_status=user_data.get('subscription_status', 'active'),
                is_verified=user_data.get('is_verified', True)
            )
    except Exception as e:
        logger.error(f"Error loading user {user_id}: {e}")

    return None


def generate_navbar_html(active_page=''):
    """
    Generate navbar HTML with user authentication state.
    Returns HTML string for navbar with login/signup or user dropdown.
    """
    # Auth buttons for logged-out users
    auth_buttons = ''
    if current_user.is_authenticated:
        # User dropdown for logged-in users
        subscription_badge = ''
        if current_user.is_pro_user:
            subscription_badge = '<span style="font-size: 10px; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">PRO</span>'
        elif current_user.is_team_user:
            subscription_badge = '<span style="font-size: 10px; background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 4px;">TEAM</span>'

        # Check if user is admin
        admin_emails = os.getenv('ADMIN_EMAILS', '').split(',')
        admin_emails = [email.strip().lower() for email in admin_emails if email.strip()]
        is_admin = current_user.email.lower() in admin_emails

        admin_link = ''
        if is_admin:
            admin_link = '''
                <a href="/admin" class="nav-dropdown-link" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1)); border: 1px solid rgba(239, 68, 68, 0.2);">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px; color: #ef4444;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span style="color: #ef4444; font-weight: 600;">Admin Dashboard</span>
                </a>
            '''

        auth_buttons = f'''
            <div class="nav-dropdown user-dropdown">
                <button class="nav-link nav-dropdown-toggle user-menu-toggle" onclick="toggleNavDropdown(event)" style="cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 8px; pointer-events: none;">
                        <div class="user-avatar">{current_user.display_name[0].upper()}</div>
                        <span>{current_user.display_name}</span>
                        {subscription_badge}
                    </div>
                </button>
                <div class="nav-dropdown-menu user-dropdown-menu" style="pointer-events: auto;">
                    <div class="user-dropdown-header">
                        <div class="user-dropdown-email">{current_user.email}</div>
                        <div class="user-dropdown-tier">{'Member' if current_user.subscription_tier == 'free' else current_user.subscription_tier.capitalize() + ' Plan'}</div>
                    </div>
                    <!-- Soft Launch: Hiding Upgrade Plan link
                    <a href="/pricing" class="nav-dropdown-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                        Upgrade Plan
                    </a>
                    -->
                    <a href="/library" class="nav-dropdown-link {'active' if active_page == 'library' else ''}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                        </svg>
                        My Library
                    </a>
                    {admin_link}
                    <div class="nav-dropdown-divider"></div>
                    <a href="/logout" class="nav-dropdown-link">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Log Out
                    </a>
                </div>
            </div>
        '''
    else:
        # Login and Sign up buttons for logged-out users
        auth_buttons = '''
            <a href="/login" class="nav-link">Log In</a>
            <a href="/register" class="nav-btn-primary">Sign Up</a>
        '''

    return auth_buttons


def generate_verification_banner_html():
    """
    Generate verification reminder banner for unverified users.
    Returns HTML string for verification banner or empty string if user is verified.
    """
    if not current_user.is_authenticated:
        return ''

    if current_user.is_verified:
        return ''

    # Only show for email/password users (not OAuth users who should be auto-verified)
    if not EMAIL_CONFIGURED:
        return ''

    banner_html = '''
    <div class="verification-banner" id="verificationBanner" style="
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(245, 158, 11, 0.15));
        border-bottom: 1px solid rgba(251, 191, 36, 0.3);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        position: relative;
        z-index: 1000;
    ">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 20px; height: 20px; color: #f59e0b; flex-shrink: 0;">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </svg>
        <div style="flex: 1; max-width: 800px;">
            <span style="color: #92400e; font-size: 14px;">
                <strong>Email not verified.</strong> Please check your inbox or
                <a href="/resend-verification" style="color: #d97706; text-decoration: underline; font-weight: 600;">resend verification email</a>.
            </span>
        </div>
        <button onclick="document.getElementById('verificationBanner').style.display='none'" style="
            background: transparent;
            border: none;
            color: #92400e;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            opacity: 0.7;
            transition: opacity 0.2s;
        " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 18px; height: 18px;">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
        </button>
    </div>
    '''

    return banner_html


@app.context_processor
def inject_navbar_html():
    """Make generate_navbar_html and generate_verification_banner_html available to all templates"""
    return dict(
        generate_navbar_html=generate_navbar_html,
        generate_verification_banner_html=generate_verification_banner_html
    )


# ====== Email Verification Helper Functions ======
def send_verification_email(user_email, user_name, verification_token):
    """
    Send email verification link to user.
    Returns True if sent successfully, False otherwise.
    """
    if not EMAIL_CONFIGURED:
        logger.warning(f"Cannot send verification email to {user_email} - email not configured")
        return False

    try:
        verification_url = url_for('verify_email', token=verification_token, _external=True)

        msg = Message(
            subject='Verify Your GasConsult.ai Account',
            recipients=[user_email],
            html=f'''
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #1F2937; }}
                    .container {{ max-width: 600px; margin: 0 auto; padding: 40px 20px; }}
                    .header {{ text-align: center; margin-bottom: 40px; }}
                    .logo {{ font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #3B82F6, #2563EB); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }}
                    .content {{ background: #F9FAFB; border-radius: 16px; padding: 32px; margin-bottom: 24px; }}
                    .button {{ display: inline-block; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; padding: 14px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; margin: 24px 0; }}
                    .footer {{ text-align: center; color: #6B7280; font-size: 14px; }}
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <div class="logo">GasConsult.ai</div>
                    </div>
                    <div class="content">
                        <h2 style="margin-top: 0; color: #1F2937;">Welcome{', ' + user_name if user_name else ''}!</h2>
                        <p>Thank you for signing up for GasConsult.ai. To complete your registration and start accessing evidence-based anesthesiology answers, please verify your email address.</p>
                        <div style="text-align: center;">
                            <a href="{verification_url}" class="button">Verify Email Address</a>
                        </div>
                        <p style="margin-bottom: 0;">This link will expire in 24 hours. If you didn't create an account with GasConsult.ai, you can safely ignore this email.</p>
                    </div>
                    <div class="footer">
                        <p>© 2024 GasConsult.ai - Evidence-Based Anesthesiology</p>
                        <p>Questions? Contact us at support@gasconsult.ai</p>
                    </div>
                </div>
            </body>
            </html>
            '''
        )

        mail.send(msg)
        logger.info(f"Verification email sent to {user_email}")
        return True
    except Exception as e:
        logger.error(f"Failed to send verification email to {user_email}: {e}")
        return False


def send_password_reset_email(user_email, user_name, reset_token):
    """
    Send password reset link to user.
    Returns True if sent successfully, False otherwise.
    """
    if not EMAIL_CONFIGURED:
        logger.warning(f"Cannot send password reset email to {user_email} - email not configured")
        return False

    try:
        reset_url = url_for('reset_password', token=reset_token, _external=True)

        msg = Message(
            subject='Reset Your GasConsult.ai Password',
            recipients=[user_email],
            html=f'''
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; color: #1F2937; }}
                    .container {{ max-width: 600px; margin: 0 auto; padding: 40px 20px; }}
                    .header {{ text-align: center; margin-bottom: 40px; }}
                    .logo {{ font-size: 32px; font-weight: 800; background: linear-gradient(135deg, #3B82F6, #2563EB); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }}
                    .content {{ background: #F9FAFB; border-radius: 16px; padding: 32px; margin-bottom: 24px; }}
                    .button {{ display: inline-block; background: linear-gradient(135deg, #3B82F6, #2563EB); color: white; padding: 14px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; margin: 24px 0; }}
                    .footer {{ text-align: center; color: #6B7280; font-size: 14px; }}
                    .warning {{ background: #FEF3C7; border-left: 4px solid #F59E0B; padding: 12px; margin: 16px 0; border-radius: 4px; }}
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <div class="logo">GasConsult.ai</div>
                    </div>
                    <div class="content">
                        <h2 style="margin-top: 0; color: #1F2937;">Reset Your Password</h2>
                        <p>Hi{' ' + user_name if user_name else ''},</p>
                        <p>We received a request to reset your password for your GasConsult.ai account. Click the button below to create a new password:</p>
                        <div style="text-align: center;">
                            <a href="{reset_url}" class="button">Reset Password</a>
                        </div>
                        <div class="warning">
                            <strong>Security Notice:</strong> This link will expire in 1 hour. If you didn't request a password reset, please ignore this email and your password will remain unchanged.
                        </div>
                        <p style="margin-bottom: 0;">For security reasons, we recommend using a strong, unique password.</p>
                    </div>
                    <div class="footer">
                        <p>© 2024 GasConsult.ai - Evidence-Based Anesthesiology</p>
                        <p>Questions? Contact us at support@gasconsult.ai</p>
                    </div>
                </div>
            </body>
            </html>
            '''
        )

        mail.send(msg)
        logger.info(f"Password reset email sent to {user_email}")
        return True
    except Exception as e:
        logger.error(f"Failed to send password reset email to {user_email}: {e}")
        return False


# ====== Data Storage ======
# Simple in-memory storage for bookmarks and shared links
# In production, replace with database (Redis, PostgreSQL, etc.)
BOOKMARKS_STORAGE = {}  # {user_session_id: [{id, query, answer, references, timestamp}]}
SHARED_LINKS_STORAGE = {}  # {share_id: {query, answer, references, timestamp, expires}}

# In-memory cache for stream data (backup for session issues)
# This helps when session state isn't shared properly between requests
# WARNING: This won't work with multiple Gunicorn workers unless using sticky sessions
STREAM_DATA_CACHE = {}  # {request_id: {data, expires_at}}
STREAM_CACHE_TTL = 300  # 5 minutes

def store_stream_data(request_id, data):
    """Store stream data in both session and cache"""
    STREAM_DATA_CACHE[request_id] = {
        'data': data,
        'expires_at': datetime.now() + timedelta(seconds=STREAM_CACHE_TTL)
    }
    # Clean up expired entries
    now = datetime.now()
    expired = [k for k, v in STREAM_DATA_CACHE.items() if v['expires_at'] < now]
    for k in expired:
        del STREAM_DATA_CACHE[k]

def get_stream_data(request_id):
    """Get stream data from cache (fallback for session issues)"""
    if request_id in STREAM_DATA_CACHE:
        entry = STREAM_DATA_CACHE[request_id]
        if entry['expires_at'] > datetime.now():
            return entry['data']
        else:
            del STREAM_DATA_CACHE[request_id]
    return None

def strip_markdown_code_fences(content):
    """Remove markdown code fences (```html ... ```) from content"""
    if not content:
        return content
    # Remove opening code fence with language specifier (```html, ```HTML, etc.)
    content = re.sub(r'^```\w*\s*\n?', '', content, flags=re.IGNORECASE)
    # Remove closing code fence
    content = re.sub(r'\n?```\s*$', '', content)
    return content

# ====== Chat History Helper Functions (Phase 2) ======

def safe_db_save_conversation(conversation_id, user_session_id, title):
    """
    Safely save a conversation to the database.
    If database is not initialized or save fails, logs error but doesn't break app.

    Returns:
        bool: True if saved successfully, False otherwise
    """
    if not DATABASE_INITIALIZED:
        return False

    try:
        return database.save_conversation(conversation_id, user_session_id, title)
    except Exception as e:
        logger.error(f"Failed to save conversation to database: {e}")
        return False


def safe_db_save_message(conversation_id, role, content, references=None, num_papers=0, evidence_strength=None):
    """
    Safely save a message to the database.
    If database is not initialized or save fails, logs error but doesn't break app.

    Returns:
        bool: True if saved successfully, False otherwise
    """
    if not DATABASE_INITIALIZED:
        return False

    try:
        return database.save_message(
            conversation_id=conversation_id,
            role=role,
            content=content,
            references=references,
            num_papers=num_papers,
            evidence_strength=evidence_strength
        )
    except Exception as e:
        logger.error(f"Failed to save message to database: {e}")
        return False


def get_or_create_conversation_id():
    """
    Get existing conversation ID from session, or create a new one.
    Also ensures user has a persistent session ID for tracking.

    Returns:
        tuple: (conversation_id, is_new_conversation)
    """
    # Ensure user has a persistent session ID (for associating conversations)
    if 'persistent_session_id' not in session:
        session['persistent_session_id'] = str(uuid.uuid4())
        session.modified = True

    # Check if conversation already exists in session
    if 'conversation_id' in session:
        return session['conversation_id'], False

    # Create new conversation ID
    conversation_id = str(uuid.uuid4())
    session['conversation_id'] = conversation_id
    session.modified = True

    return conversation_id, True

from datetime import datetime, timedelta

# ====== Security Functions ======

def sanitize_input(text, strip_tags=False):
    """
    Sanitize user input to prevent XSS attacks.

    Args:
        text: Input text to sanitize
        strip_tags: If True, strip all HTML tags. If False, allow safe HTML tags.

    Returns:
        Sanitized text safe for display
    """
    if not text:
        return ""

    if strip_tags:
        # Strip all HTML tags for plain text input
        return bleach.clean(text, tags=[], strip=True)
    else:
        # Allow safe HTML tags (for GPT-generated content)
        allowed_tags = [
            'p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
            'ul', 'ol', 'li', 'a', 'blockquote', 'code', 'pre', 'hr', 'div', 'span',
            'table', 'thead', 'tbody', 'tr', 'th', 'td', 'sup', 'sub'
        ]
        allowed_attributes = {
            'a': ['href', 'title', 'target', 'rel'],
            'div': ['class', 'style'],
            'span': ['class', 'style'],
            'p': ['class', 'style'],
            'td': ['colspan', 'rowspan'],
            'th': ['colspan', 'rowspan']
        }
        allowed_protocols = ['http', 'https', 'mailto']

        return bleach.clean(
            text,
            tags=allowed_tags,
            attributes=allowed_attributes,
            protocols=allowed_protocols,
            strip=True
        )

def sanitize_user_query(query):
    """Sanitize user query input - strip all HTML tags."""
    return sanitize_input(query, strip_tags=True)

# ====== Logging Configuration ======

import logging
from logging.handlers import RotatingFileHandler
import sys

def setup_logging():
    """Configure comprehensive logging for the application"""
    log_level = os.getenv("LOG_LEVEL", "INFO").upper()
    log_file = os.getenv("LOG_FILE", "")

    # Create logger
    logger = logging.getLogger("gasconsult")
    logger.setLevel(getattr(logging, log_level, logging.INFO))

    # Create formatter
    formatter = logging.Formatter(
        '[%(asctime)s] %(levelname)s in %(module)s: %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )

    # Console handler (always enabled)
    console_handler = logging.StreamHandler(sys.stdout)
    console_handler.setFormatter(formatter)
    logger.addHandler(console_handler)

    # File handler (optional)
    if log_file:
        file_handler = RotatingFileHandler(
            log_file,
            maxBytes=10485760,  # 10MB
            backupCount=5
        )
        file_handler.setFormatter(formatter)
        logger.addHandler(file_handler)

    # Configure Flask app logger
    app.logger.handlers = logger.handlers
    app.logger.setLevel(logger.level)

    return logger

# Initialize logging
logger = setup_logging()

# Log startup information
logger.info("=" * 60)
logger.info("GasConsult.ai Application Starting")
logger.info(f"Environment: {os.getenv('FLASK_ENV', 'production')}")
logger.info(f"Log Level: {os.getenv('LOG_LEVEL', 'INFO')}")
logger.info(f"Rate Limit: {os.getenv('RATE_LIMIT', '60 per minute')}")
logger.info("=" * 60)

# ====== Optional: Sentry Error Tracking ======
# Uncomment and configure if you want error monitoring
# To enable: pip install sentry-sdk[flask] and set SENTRY_DSN environment variable
SENTRY_DSN = os.getenv('SENTRY_DSN')
if SENTRY_DSN:
    try:
        import sentry_sdk
        from sentry_sdk.integrations.flask import FlaskIntegration
        from sentry_sdk.integrations.logging import LoggingIntegration

        sentry_sdk.init(
            dsn=SENTRY_DSN,
            integrations=[
                FlaskIntegration(),
                LoggingIntegration(
                    level=logging.INFO,        # Capture info and above as breadcrumbs
                    event_level=logging.ERROR  # Send errors as events
                ),
            ],
            environment=os.getenv('FLASK_ENV', 'production'),
            # Set traces_sample_rate to 1.0 to capture 100% of transactions for performance monitoring.
            # Adjust this value in production to reduce overhead
            traces_sample_rate=float(os.getenv('SENTRY_TRACES_SAMPLE_RATE', '0.1')),
            # Set profiles_sample_rate to 1.0 to profile 100% of sampled transactions.
            # Adjust this value in production
            profiles_sample_rate=float(os.getenv('SENTRY_PROFILES_SAMPLE_RATE', '0.1')),
        )
        logger.info("Sentry error tracking initialized")
    except ImportError:
        logger.warning("SENTRY_DSN set but sentry-sdk not installed. Install with: pip install sentry-sdk[flask]")
    except Exception as e:
        logger.error(f"Failed to initialize Sentry: {e}")
else:
    logger.info("Sentry error tracking disabled (SENTRY_DSN not set)")

# Request logging middleware
@app.before_request
def log_request():
    """Log incoming requests"""
    logger.info(f"{request.method} {request.path} from {request.remote_addr}")

@app.after_request
def log_response(response):
    """Log outgoing responses"""
    logger.info(f"{request.method} {request.path} - Status: {response.status_code}")
    return response

@app.after_request
def add_security_headers(response):
    """Add security headers to all responses"""
    # Content Security Policy - helps prevent XSS attacks
    # Note: 'unsafe-inline' is needed for inline styles in our single-file app
    # In production, consider moving to external CSS and removing 'unsafe-inline'
    response.headers['Content-Security-Policy'] = (
        "default-src 'self'; "
        "script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; "
        "style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; "
        "font-src 'self' https://fonts.gstatic.com; "
        "img-src 'self' data: https:; "
        "connect-src 'self'; "
        "frame-ancestors 'none';"
    )

    # Prevent clickjacking
    response.headers['X-Frame-Options'] = 'DENY'

    # Prevent MIME type sniffing
    response.headers['X-Content-Type-Options'] = 'nosniff'

    # Enable browser XSS protection
    response.headers['X-XSS-Protection'] = '1; mode=block'

    # Referrer policy - don't leak URLs to external sites
    response.headers['Referrer-Policy'] = 'strict-origin-when-cross-origin'

    # Permissions policy - restrict access to sensitive features
    response.headers['Permissions-Policy'] = 'geolocation=(), microphone=(), camera=()'

    return response

@app.errorhandler(CSRFError)
def handle_csrf_error(e):
    """Handle CSRF token errors with helpful message"""
    logger.warning(f"CSRF error: {str(e)}")

    # For AJAX requests, return JSON error instead of redirect
    is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest'
    if is_ajax:
        return jsonify({
            "status": "error",
            "message": "Your session has expired. Please reload the page and try again.",
            "error_type": "csrf"
        }), 400

    # For regular requests, redirect to homepage to regenerate session/CSRF token
    return redirect(url_for('index'))

@app.errorhandler(404)
def handle_not_found(e):
    """Handle 404 errors - log at WARNING level to avoid log noise from scanners"""
    logger.warning(f"404 Not Found: {request.method} {request.path} from {get_remote_address()}")
    return jsonify({
        "error": "The requested resource was not found.",
        "status": "not_found"
    }), 404

@app.errorhandler(HTTPException)
def handle_http_exception(e):
    """Handle other HTTP exceptions (400, 403, 405, etc.) without logging as errors"""
    logger.info(f"HTTP {e.code}: {request.method} {request.path}")
    return jsonify({
        "error": e.description,
        "status": "http_error"
    }), e.code

@app.errorhandler(Exception)
def log_exception(e):
    """Log unhandled non-HTTP exceptions only"""
    # Don't catch HTTPException here - it's handled above
    if isinstance(e, HTTPException):
        raise e

    logger.error(f"Unhandled exception: {str(e)}", exc_info=True)
    return jsonify({
        "error": "An internal error occurred. Please try again later.",
        "status": "error"
    }), 500

def clean_query(query):
    """Strip conversational filler from user queries to extract the core medical topic."""
    q = query.lower().strip()

    # Remove trailing question marks FIRST so other patterns can match
    q = re.sub(r"[?!.]+$", "", q).strip()

    # Remove common conversational phrases
    filler_phrases = [
        r"^(can you |could you |please |pls )",
        r"^(tell me about |tell me |explain |describe )",
        r"^(what is |what's |what are |whats |what about )",
        r"^(what do you know about |what does the evidence say about )",
        r"^(what's the evidence for |what is the evidence for |evidence for )",
        r"^(i want to know about |i'd like to know about |i need to know about )",
        r"^(give me info on |give me information on |info on )",
        r"^(how does |how do |how is |how are |how about )",
        r"^(why does |why do |why is |why are )",
        r"^(search for |look up |find |show me )",
        r"^(help me understand |help me with )",
        r"(indications to use |indications for |indication for |when to use )",
        r"\s+(instead|as well|also|too)\s*$",  # Match with whitespace
    ]

    # Apply each pattern repeatedly until no more matches
    for pattern in filler_phrases:
        q = re.sub(pattern, "", q, flags=re.IGNORECASE).strip()

    # Remove extra whitespace
    q = re.sub(r"\s+", " ", q).strip()

    return q if q else query  # Return original if cleaning removed everything

def detect_question_type(query):
    """Identify what kind of clinical question this is to customize search and response"""
    q = query.lower()

    # Dosing questions - need guidelines more than RCTs
    if any(word in q for word in ['dose', 'dosing', 'how much', 'mg/kg', 'mcg/kg', 'ml/kg', 'dosage', 'loading dose', 'maintenance dose']):
        return 'dosing'

    # Safety/complications - need case reports too
    if any(word in q for word in ['safe', 'risk', 'complication', 'side effect', 'adverse', 'contraindication', 'warning', 'precaution', 'toxicity']):
        return 'safety'

    # Comparison questions - need head-to-head trials
    if any(word in q for word in [' or ', ' vs ', 'versus', 'compared', 'better', 'prefer', 'which', 'choice between']):
        return 'comparison'

    # Mechanism questions - need reviews
    if any(word in q for word in ['how does', 'mechanism', 'why does', 'works by', 'action of', 'pharmacology']):
        return 'mechanism'

    # Management/protocol questions - need guidelines
    if any(word in q for word in ['management', 'protocol', 'algorithm', 'approach', 'treat', 'handle', 'manage', 'strategy']):
        return 'management'

    return 'general'

def handle_negations(query):
    """Detect and properly handle negative/contraindication questions"""
    q = query.lower()

    is_negative = any(word in q for word in [
        'not ', 'avoid', 'never', 'contraindication', 'when to stop',
        'should not', 'shouldn\'t', 'don\'t use', 'do not use', 'when not to'
    ])

    if is_negative:
        # Add contraindication terms to search
        search_modifier = ' AND (contraindications[sh] OR adverse effects[sh] OR safety[ti])'

        # Update GPT prompt to focus on negatives
        prompt_modifier = "\n\nIMPORTANT: The user is asking about CONTRAINDICATIONS, AVOIDING, or WHEN NOT TO USE something. Focus your answer on safety concerns, contraindications, and situations where this is inappropriate or dangerous."

        return search_modifier, prompt_modifier

    return '', ''

def resolve_references(query, conversation_history):
    """Replace pronouns/vague references with actual terms from context"""
    if not conversation_history or len(conversation_history) < 2:
        return query

    q = query.lower()

    # Get last 2-3 user+assistant turns
    recent_messages = conversation_history[-6:] if len(conversation_history) >= 6 else conversation_history

    # Extract key medical terms from recent conversation (drugs, procedures, conditions, broad concepts)
    medical_entities = []
    for msg in recent_messages:
        content = msg.get('content', '').lower()

        # Find broader concepts first (multi-word phrases)
        broad_concepts = re.findall(
            r'\b(difficult airway management|difficult airway|airway management|'
            r'fiberoptic intubation|awake fiberoptic intubation|awake intubation|'
            r'rapid sequence induction|rapid sequence intubation|'
            r'neuraxial anesthesia|regional anesthesia|general anesthesia|'
            r'cardiac surgery|neurosurgery|spine surgery|orthopedic surgery|'
            r'video laryngoscopy|direct laryngoscopy|'
            r'spinal anesthesia|epidural anesthesia|combined spinal epidural|'
            r'peripheral nerve block|nerve block technique|'
            r'ultrasound guided block|landmark technique|'
            r'postoperative pain management|acute pain management|chronic pain|'
            r'preoperative optimization|preoperative assessment|'
            r'hemodynamic management|fluid management|blood management|'
            r'neuromuscular blockade|neuromuscular monitoring|'
            r'depth of anesthesia monitoring|bispectral index|'
            r'postoperative nausea|nausea prophylaxis|antiemetic strategy|'
            r'enhanced recovery|eras protocol|fast track surgery|'
            r'transfusion management|blood conservation|cell saver|'
            r'malignant hyperthermia crisis|local anesthetic toxicity crisis|'
            r'obstetric anesthesia|pediatric anesthesia|geriatric anesthesia|'
            r'liver transplant|kidney transplant|cardiac transplant|'
            r'one lung ventilation|lung isolation|double lumen tube|'
            r'airway exchange catheter|bougie|glidescope)\b',
            content
        )
        medical_entities.extend(broad_concepts)

        # Find single-word drugs, procedures, conditions
        entities = re.findall(
            r'\b(propofol|etomidate|ketamine|fentanyl|remifentanil|sufentanil|alfentanil|'
            r'rocuronium|vecuronium|succinylcholine|cisatracurium|'
            r'sevoflurane|desflurane|isoflurane|'
            r'midazolam|dexmedetomidine|precedex|'
            r'phenylephrine|ephedrine|epinephrine|norepinephrine|vasopressin|'
            r'tranexamic acid|txa|aminocaproic acid|'
            r'intubation|extubation|induction|emergence|'
            r'epidural|spinal|neuraxial|'
            r'ponv|hypotension|hypertension|bronchospasm|laryngospasm|'
            r'sugammadex|neostigmine|glycopyrrolate|atropine|'
            r'ondansetron|metoclopramide|dexamethasone|'
            r'naloxone|flumazenil|dantrolene|intralipid)\b',
            content
        )
        medical_entities.extend(entities)

    # Remove duplicates while preserving order
    seen = set()
    unique_entities = []
    for entity in reversed(medical_entities):  # Reverse to get most recent first
        if entity not in seen:
            unique_entities.append(entity)
            seen.add(entity)
    unique_entities.reverse()

    # Replace vague references if we have context
    if unique_entities and any(word in q for word in ['it', 'this', 'that', 'the drug', 'the medication', 'the technique', 'the procedure', 'the approach']):
        most_recent = unique_entities[-1]  # Last mentioned entity
        q = re.sub(r'\bit\b', most_recent, q)
        q = re.sub(r'\bthis\b', most_recent, q)
        q = re.sub(r'\bthat\b', most_recent, q)
        q = q.replace('the drug', most_recent)
        q = q.replace('the medication', most_recent)
        q = q.replace('the technique', most_recent)
        q = q.replace('the procedure', most_recent)
        q = q.replace('the approach', most_recent)
        logger.debug(f"Resolved reference: '{query}' → '{q}'")

    # Handle "what about..." questions
    if q.startswith('what about') and unique_entities:
        # Extract the modifier (e.g., "pediatrics", "elderly", "renal failure")
        modifier = q.replace('what about', '').strip().rstrip('?').strip()
        main_topic = unique_entities[-1]
        q = f'{main_topic} in {modifier}'
        logger.debug(f"Expanded 'what about': '{query}' → '{q}'")

    # Handle "how about..." questions similarly
    if q.startswith('how about') and unique_entities:
        modifier = q.replace('how about', '').strip().rstrip('?').strip()
        main_topic = unique_entities[-1]
        q = f'{main_topic} {modifier}'
        logger.debug(f"Expanded 'how about': '{query}' → '{q}'")

    # Handle "can you" or "can I" questions that might be follow-ups
    if unique_entities and (q.startswith('can you') or q.startswith('can i') or q.startswith('should i') or q.startswith('should you')):
        # Check if the query contains specific techniques that should be added to context
        has_specific_technique = any(term in q for term in ['fiberoptic', 'video', 'laryngoscopy', 'intubate', 'block', 'epidural', 'spinal'])
        if has_specific_technique:
            # Prepend the context topic
            main_topic = unique_entities[-1]
            q = f'{main_topic} {q}'
            logger.debug(f"Added context to technique question: '{query}' → '{q}'")

    return q if q != query.lower() else query

def detect_multipart(query):
    """Detect if user is asking multiple questions"""
    # Look for "and" connecting questions
    patterns = [
        r'(.*?)\s+and\s+(what|how|when|why|is|are|does|should|can)',
        r'(.*?)\s*\?\s*(what|how|when|why)',  # Multiple question marks
        r'(.*?)\s+(also|additionally)\s+(what|how|when|why)',
    ]

    for pattern in patterns:
        match = re.search(pattern, query, re.IGNORECASE)
        if match:
            return True

    return False

def build_smart_context(messages, current_query):
    """Build context that includes relevant history, not just recent"""
    if not messages or len(messages) == 0:
        return "New conversation."

    context = ""

    # Always include last 2 turns (most recent) - up to 6 messages
    recent = messages[-6:] if len(messages) >= 6 else messages

    # Also search for turns that mention same entities as current query (if conversation is longer)
    query_terms = set(re.findall(r'\b\w{4,}\b', current_query.lower()))
    relevant_earlier = []

    if len(messages) > 6:
        for i in range(0, len(messages) - 6, 2):  # Skip the recent ones we already have
            if i < len(messages):
                user_msg = messages[i].get('content', '').lower()
                terms = set(re.findall(r'\b\w{4,}\b', user_msg))
                overlap = len(query_terms & terms)
                if overlap >= 2:  # At least 2 shared terms
                    # Include Q&A pair
                    pair = messages[i:min(i+2, len(messages))]
                    relevant_earlier.append(pair)

    # Build context: relevant earlier + recent
    for pair in relevant_earlier[-2:]:  # Max 2 earlier relevant turns
        for msg in pair:
            role = "User" if msg['role'] == 'user' else "Assistant"
            content = re.sub('<[^<]+?>', '', msg.get('content', ''))
            context += f"{role}: {content[:200]}...\n"

    for msg in recent:
        role = "User" if msg['role'] == 'user' else "Assistant"
        content = re.sub('<[^<]+?>', '', msg.get('content', ''))
        max_len = 300 if msg['role'] == 'user' else 150
        if len(content) > max_len:
            context += f"{role}: {content[:max_len]}...\n"
        else:
            context += f"{role}: {content}\n"

    return context

def expand_medical_abbreviations(query):
    """Comprehensive medical abbreviation and synonym expansion"""
    q = query.lower()

    # Comparison operators
    q = q.replace(" versus ", " OR ")
    q = q.replace(" vs ", " OR ")
    q = q.replace(" vs. ", " OR ")
    q = q.replace(" over ", " OR ")
    q = q.replace(" compared to ", " OR ")
    q = q.replace(" compared with ", " OR ")

    # Common abbreviations and drugs - ORIGINAL ONES
    q = q.replace("txa", '"tranexamic acid" OR TXA')
    q = q.replace("blood loss", '"blood loss" OR hemorrhage OR transfusion')
    q = q.replace("spine surgery", '"spine surgery" OR "spinal fusion" OR scoliosis')
    q = q.replace("peds", 'pediatric OR children OR peds')
    q = q.replace("pediatric", 'pediatric OR children OR peds')
    q = q.replace("ponv", 'PONV OR "postoperative nausea"')
    q = q.replace("propofol", '"propofol"[MeSH Terms] OR propofol')
    q = q.replace("etomidate", '"etomidate"[MeSH Terms] OR etomidate')
    q = q.replace("barbiturates", '"barbiturates"[MeSH Terms] OR barbiturates OR thiopental')
    q = q.replace("barbs", '"barbiturates"[MeSH Terms] OR barbiturates OR thiopental')
    q = q.replace("ketamine", '"ketamine"[MeSH Terms] OR ketamine')
    q = q.replace("induction", '"anesthesia induction" OR induction OR "induction agent"')

    # NEW ADDITIONS - Neuromuscular blockers
    q = q.replace(" roc ", ' ("rocuronium"[MeSH Terms] OR rocuronium OR "neuromuscular blockade") ')
    q = q.replace(" vec ", ' ("vecuronium"[MeSH Terms] OR vecuronium) ')
    q = q.replace(" sux ", ' ("succinylcholine"[MeSH Terms] OR succinylcholine OR "muscle relaxant") ')
    q = q.replace("cisatracurium", '"cisatracurium"[MeSH Terms] OR cisatracurium OR nimbex')
    q = q.replace("rocuronium", '"rocuronium"[MeSH Terms] OR rocuronium')
    q = q.replace("vecuronium", '"vecuronium"[MeSH Terms] OR vecuronium')
    q = q.replace("succinylcholine", '"succinylcholine"[MeSH Terms] OR succinylcholine OR suxamethonium')

    # Opioids
    q = q.replace("fentanyl", '"fentanyl"[MeSH Terms] OR fentanyl OR opioid')
    q = q.replace(" remi ", ' ("remifentanil"[MeSH Terms] OR remifentanil) ')
    q = q.replace("remifentanil", '"remifentanil"[MeSH Terms] OR remifentanil')
    q = q.replace("sufentanil", '"sufentanil"[MeSH Terms] OR sufentanil')
    q = q.replace("alfentanil", '"alfentanil"[MeSH Terms] OR alfentanil')
    q = q.replace("morphine", '"morphine"[MeSH Terms] OR morphine')
    q = q.replace("hydromorphone", '"hydromorphone"[MeSH Terms] OR hydromorphone OR dilaudid')

    # Benzodiazepines and sedatives
    q = q.replace(" dex ", ' ("dexmedetomidine"[MeSH Terms] OR dexmedetomidine OR precedex) ')
    q = q.replace("dexmedetomidine", '"dexmedetomidine"[MeSH Terms] OR dexmedetomidine OR precedex')
    q = q.replace("versed", '"midazolam"[MeSH Terms] OR midazolam OR versed')
    q = q.replace("midazolam", '"midazolam"[MeSH Terms] OR midazolam OR versed')

    # Vasopressors and inotropes
    q = q.replace(" neo ", ' ("phenylephrine"[MeSH Terms] OR phenylephrine OR neosynephrine) ')
    q = q.replace("phenylephrine", '"phenylephrine"[MeSH Terms] OR phenylephrine OR neosynephrine')
    q = q.replace(" epi ", ' ("epinephrine"[MeSH Terms] OR epinephrine OR adrenaline) ')
    q = q.replace("epinephrine", '"epinephrine"[MeSH Terms] OR epinephrine OR adrenaline')
    q = q.replace("ephedrine", '"ephedrine"[MeSH Terms] OR ephedrine')
    q = q.replace("norepinephrine", '"norepinephrine"[MeSH Terms] OR norepinephrine OR levophed')
    q = q.replace("vasopressin", '"vasopressin"[MeSH Terms] OR vasopressin OR pitressin')

    # Common procedures
    # Fix RSI - handle both standalone and embedded (order matters - do specific before general)
    q = re.sub(r'\brsi\b', '("rapid sequence induction" OR RSI OR "rapid sequence intubation" OR "airway management")', q, flags=re.IGNORECASE)
    q = q.replace("rapid sequence", '"rapid sequence induction" OR RSI OR "rapid sequence intubation"')
    q = q.replace("awake intubation", '"awake intubation" OR "fiberoptic intubation" OR "difficult airway"')
    q = q.replace("awake fiberoptic", '"awake intubation" OR "fiberoptic intubation" OR "difficult airway"')
    q = re.sub(r'\bcabg\b', '("coronary artery bypass" OR CABG OR "cardiac surgery")', q, flags=re.IGNORECASE)
    q = q.replace("coronary artery bypass", '"coronary artery bypass" OR CABG OR "cardiac surgery"')
    q = re.sub(r'\btavr\b', '("transcatheter aortic valve" OR TAVR OR "structural heart")', q, flags=re.IGNORECASE)
    q = q.replace("transcatheter aortic", '"transcatheter aortic valve" OR TAVR')

    # Common complications
    # LAST - keep space-based to avoid matching "last" in "the last time"
    q = q.replace(" last ", ' ("local anesthetic systemic toxicity" OR LAST OR "lipid emulsion" OR "intralipid") ')
    q = q.replace("local anesthetic toxicity", '"local anesthetic systemic toxicity" OR LAST OR "lipid emulsion"')
    # PRIS - use word boundary (less likely to be a common word)
    q = re.sub(r'\bpris\b', '("propofol infusion syndrome" OR PRIS)', q, flags=re.IGNORECASE)
    q = q.replace("propofol infusion syndrome", '"propofol infusion syndrome" OR PRIS')
    # MH - Expand abbreviation to malignant hyperthermia AND exclude psychiatric papers
    # Use word boundary to avoid matching "smith" or other words containing "mh"
    # SIMPLIFIED: Use MeSH term only with exclusions - don't add synonyms that complicate the query
    q = re.sub(r'\bmh\b', '("malignant hyperthermia"[MeSH Terms] NOT (mental[ti] OR psychiatric[ti] OR psychology[ti] OR depression[ti]))', q, flags=re.IGNORECASE)
    # Expand full term "malignant hyperthermia" to use MeSH for better indexing
    # Use negative lookbehind/lookahead to avoid double-quoting already expanded terms
    q = re.sub(r'(?<!")malignant hyperthermia(?!")', '"malignant hyperthermia"[MeSH Terms]', q, flags=re.IGNORECASE)

    # Common scenarios
    q = q.replace("full stomach", '"aspiration"[MeSH Terms] OR "rapid sequence" OR RSI OR "aspiration risk"')
    q = q.replace("difficult airway", '"difficult airway"[MeSH Terms] OR "airway management" OR intubation OR "difficult intubation"')
    q = q.replace("anticipated difficult", '"difficult airway"[MeSH Terms] OR "airway management" OR "awake intubation"')

    # Regional anesthesia
    q = q.replace("nerve block", '"nerve block"[MeSH Terms] OR "regional anesthesia" OR "peripheral nerve block"')
    q = q.replace("epidural", '"epidural"[MeSH Terms] OR "epidural anesthesia" OR "neuraxial"')
    q = q.replace("spinal", '"spinal anesthesia"[MeSH Terms] OR "subarachnoid" OR "neuraxial"')

    # Other common anesthesia abbreviations that might be ambiguous
    q = re.sub(r'\bosa\b', '("obstructive sleep apnea" OR OSA OR "sleep apnea")', q, flags=re.IGNORECASE)
    q = re.sub(r'\bcopd\b', '("chronic obstructive pulmonary disease" OR COPD OR "obstructive lung disease")', q, flags=re.IGNORECASE)
    q = re.sub(r'\bchf\b', '("congestive heart failure" OR CHF OR "heart failure")', q, flags=re.IGNORECASE)
    q = re.sub(r'\bcad\b', '("coronary artery disease" OR CAD OR "ischemic heart disease")', q, flags=re.IGNORECASE)
    q = re.sub(r'\bckd\b', '("chronic kidney disease" OR CKD OR "renal insufficiency")', q, flags=re.IGNORECASE)
    # PE - exclude physical exam papers
    q = re.sub(r'\bpe\b', '(("pulmonary embolism"[MeSH Terms] OR "pulmonary embolus" OR thromboembolic) NOT "physical exam"[ti])', q, flags=re.IGNORECASE)
    # GA - general anesthesia (exclude genetic analysis)
    q = re.sub(r'\bga\b', '(("general anesthesia"[MeSH Terms] OR "general anaesthesia") NOT genetic[ti])', q, flags=re.IGNORECASE)
    # MAC - anesthesia context (both meanings are anesthesia-related, so just expand)
    q = re.sub(r'\bmac\b', '("monitored anesthesia care" OR "minimum alveolar concentration" OR MAC)', q, flags=re.IGNORECASE)

    # NOTE: DO NOT expand common words like "protocol", "crisis", "management"
    # These generic expansions create overly broad queries that return wrong papers
    # Let them remain as-is so PubMed can properly combine them with the medical terms

    return q

def detect_query_intent(query):
    """
    Classify query as 'casual' (greetings, small talk) or 'medical' (clinical questions)

    Returns:
        'casual': Non-medical queries that should get conversational responses without PubMed
        'medical': Medical/scientific queries that need PubMed-backed answers
    """
    query_lower = query.lower().strip()

    # Casual conversation patterns
    casual_patterns = [
        # Greetings
        r'^(hi|hello|hey|greetings|good morning|good afternoon|good evening|howdy)[\s\.,!?]*$',
        r'^(hi|hello|hey)\s+(there|claude|gpt|ai|assistant)[\s\.,!?]*$',

        # How are you variations
        r'^(how are you|how\'re you|hows it going|how is it going|whats up|what\'s up)[\s\.,!?]*$',
        r'^(how do you do|nice to meet you)[\s\.,!?]*$',

        # Gratitude
        r'^(thanks|thank you|thx|appreciate it)[\s\.,!?]*$',

        # Goodbyes
        r'^(bye|goodbye|see you|take care|cya|later)[\s\.,!?]*$',

        # Simple acknowledgments
        r'^(ok|okay|got it|i see|understood|cool|nice|great)[\s\.,!?]*$',

        # Jokes and casual requests
        r'^(tell me a joke|make me laugh|entertain me|chat with me)[\s\.,!?]*$',
    ]

    # Check casual patterns
    for pattern in casual_patterns:
        if re.match(pattern, query_lower):
            return 'casual'

    # Medical keywords that indicate a medical query
    medical_keywords = [
        # Anesthesia-specific
        'anesthesia', 'anesthetic', 'intubation', 'airway', 'induction', 'emergence',
        'propofol', 'sevoflurane', 'desflurane', 'isoflurane', 'etomidate', 'ketamine',
        'rocuronium', 'vecuronium', 'succinylcholine', 'neostigmine', 'sugammadex',
        'fentanyl', 'remifentanil', 'sufentanil', 'morphine', 'hydromorphone',
        'epidural', 'spinal', 'regional', 'nerve block', 'ultrasound guided',
        'mac', 'asa', 'preoperative', 'postoperative', 'perioperative', 'intraoperative',

        # Medical terms
        'surgery', 'surgical', 'patient', 'dose', 'dosing', 'medication', 'drug',
        'treatment', 'therapy', 'protocol', 'guideline', 'contraindication',
        'side effect', 'adverse', 'complication', 'risk', 'management',
        'diagnosis', 'symptom', 'condition', 'disease', 'syndrome',
        'hemodynamic', 'cardiac', 'respiratory', 'blood pressure', 'heart rate',
        'icu', 'critical care', 'emergency', 'resuscitation', 'trauma',

        # Common abbreviations
        'rsi', 'ponv', 'last', 'mh', 'txa', 'cabg', 'tavr', 'pris',
        'bp', 'hr', 'spo2', 'etco2', 'map',

        # Question indicators (medical context)
        'what is the', 'how do i', 'when should', 'is it safe',
        'can i use', 'should i give', 'contraindicated',
        'vs', 'versus', 'compared to', 'better than',
    ]

    # Check for medical keywords
    for keyword in medical_keywords:
        if keyword in query_lower:
            return 'medical'

    # Question words suggest potentially medical query if not matched casual pattern
    question_words = ['what', 'how', 'when', 'where', 'why', 'which', 'who', 'can', 'should', 'is', 'are', 'does', 'do']
    if any(query_lower.startswith(qw) for qw in question_words):
        # Default to medical for questions unless matched casual pattern above
        return 'medical'

    # Default: if unclear and short (< 20 chars), treat as casual
    # If longer and didn't match medical keywords, still treat as potentially medical
    if len(query) < 20:
        return 'casual'

    return 'medical'

def generate_casual_response(query, conversation_history):
    """
    Generate a friendly, conversational response without PubMed search
    Uses GPT-4o in casual mode for greetings, small talk, etc.
    """
    # Build minimal context (last 3 messages)
    context = ""
    if conversation_history:
        recent = conversation_history[-3:]
        for msg in recent:
            if msg['role'] == 'user':
                context += f"User: {msg['content']}\n"
            else:
                # Strip HTML and truncate
                content_text = re.sub('<[^<]+?>', '', msg.get('content', ''))
                context += f"Assistant: {content_text[:200]}\n"

    prompt = f"""You are gasconsult.ai, a friendly AI assistant specialized in anesthesiology. The user just sent a casual message (greeting, small talk, or non-medical question).

Previous conversation:
{context if context else "New conversation."}

User's message: {query}

Respond naturally and warmly as a helpful assistant. Keep it brief (2-3 sentences max). If appropriate, gently remind them that you specialize in anesthesiology questions but are happy to chat.

Use HTML formatting: <p> for paragraphs, <strong> for emphasis.

CRITICAL: Return ONLY the HTML content - do NOT wrap your response in markdown code fences (```html or ```)."""

    try:
        response = openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7,  # Higher temperature for natural conversation
            max_tokens=200    # Keep responses brief
        )

        casual_response = response.choices[0].message.content.strip()

        # Clean markdown code fences if GPT added them
        casual_response = strip_markdown_code_fences(casual_response)

        return casual_response

    except Exception as e:
        logger.error(f"Failed to generate casual response: {e}")
        return "<p>Hello! I'm here to help with anesthesiology questions. What would you like to know?</p>"

def detect_and_calculate(query, context_hint=None):
    """Detect calculation requests and perform medical calculations."""
    q = query.lower()

    # If context_hint provided, include it in detection
    if context_hint:
        q = context_hint + " " + q

    # Extract all numbers from the query
    numbers = re.findall(r'\d+\.?\d*', query)

    # Maximum Allowable Blood Loss (MABL)
    if any(term in q for term in ['mabl', 'maximum allowable blood loss', 'max blood loss']):
        if len(numbers) >= 3:
            try:
                ebv = float(numbers[0])  # Estimated blood volume (mL)
                hi = float(numbers[1])   # Initial Hct/Hgb
                hf = float(numbers[2])   # Final Hct/Hgb
                mabl = ebv * (hi - hf) / hi
                return f"""
                <h3>Maximum Allowable Blood Loss (MABL) Calculation</h3>
                <p><strong>Formula:</strong> MABL = EBV × (Hi - Hf) / Hi</p>
                <p><strong>Given:</strong></p>
                <ul>
                    <li>Estimated Blood Volume (EBV): {ebv:.0f} mL</li>
                    <li>Initial Hematocrit/Hemoglobin: {hi:.1f}</li>
                    <li>Final (acceptable) Hematocrit/Hemoglobin: {hf:.1f}</li>
                </ul>
                <p><strong>Result: MABL = {mabl:.0f} mL</strong></p>
                <p><em>Note: This is an estimate. Clinical judgment and patient condition should guide transfusion decisions.</em></p>
                """
            except:
                pass
        else:
            # Not enough numbers provided
            return f"""
            <h3>Maximum Allowable Blood Loss (MABL) Calculator</h3>
            <p>To calculate MABL, I need three values:</p>
            <ol>
                <li><strong>Estimated Blood Volume (EBV)</strong> in mL</li>
                <li><strong>Initial Hematocrit/Hemoglobin</strong> (e.g., 42 for Hct or 14 for Hgb)</li>
                <li><strong>Final/Acceptable Hematocrit/Hemoglobin</strong> (e.g., 30 for Hct or 10 for Hgb)</li>
            </ol>
            <p><strong>Example query:</strong> "Calculate MABL for 5000 mL blood volume, 42 initial Hct, 30 final Hct"</p>
            <p><em>You provided {len(numbers)} number(s). Please provide all three values.</em></p>
            """

    # Ideal Body Weight (IBW)
    if any(term in q for term in ['ibw', 'ideal body weight', 'ideal weight']):
        if len(numbers) >= 1:
            try:
                height_cm = float(numbers[0])
                is_male = any(word in q for word in ['male', 'man', 'm,'])
                is_female = any(word in q for word in ['female', 'woman', 'f,'])

                if is_male:
                    ibw = 50 + 0.91 * (height_cm - 152.4)
                    sex = "Male"
                elif is_female:
                    ibw = 45.5 + 0.91 * (height_cm - 152.4)
                    sex = "Female"
                else:
                    ibw_m = 50 + 0.91 * (height_cm - 152.4)
                    ibw_f = 45.5 + 0.91 * (height_cm - 152.4)
                    return f"""
                    <h3>Ideal Body Weight (IBW) Calculation</h3>
                    <p><strong>Height:</strong> {height_cm:.1f} cm</p>
                    <p><strong>Results:</strong></p>
                    <ul>
                        <li>Male IBW: {ibw_m:.1f} kg</li>
                        <li>Female IBW: {ibw_f:.1f} kg</li>
                    </ul>
                    <p><em>Tip: Specify sex (male/female) for a more specific result.</em></p>
                    """

                return f"""
                <h3>Ideal Body Weight (IBW) Calculation</h3>
                <p><strong>Formula ({sex}):</strong> {sex} formula using Devine equation</p>
                <p><strong>Height:</strong> {height_cm:.1f} cm</p>
                <p><strong>Result: IBW = {ibw:.1f} kg</strong></p>
                """
            except:
                pass
        else:
            return f"""
            <h3>Ideal Body Weight (IBW) Calculator</h3>
            <p>To calculate IBW, I need:</p>
            <ol>
                <li><strong>Height</strong> in cm</li>
                <li><strong>Sex</strong> (male or female) - optional, will show both if not specified</li>
            </ol>
            <p><strong>Example queries:</strong></p>
            <ul>
                <li>"Calculate IBW for 175 cm male"</li>
                <li>"Ideal body weight 165 cm female"</li>
            </ul>
            """

    # Body Surface Area (BSA)
    if any(term in q for term in ['bsa', 'body surface area', 'surface area']):
        if len(numbers) >= 2:
            try:
                weight = float(numbers[0])
                height = float(numbers[1])
                # Mosteller formula
                bsa = ((weight * height) / 3600) ** 0.5
                return f"""
                <h3>Body Surface Area (BSA) Calculation</h3>
                <p><strong>Formula:</strong> Mosteller formula: √((weight × height) / 3600)</p>
                <p><strong>Given:</strong></p>
                <ul>
                    <li>Weight: {weight:.1f} kg</li>
                    <li>Height: {height:.1f} cm</li>
                </ul>
                <p><strong>Result: BSA = {bsa:.2f} m²</strong></p>
                """
            except:
                pass
        else:
            return f"""
            <h3>Body Surface Area (BSA) Calculator</h3>
            <p>To calculate BSA, I need two values:</p>
            <ol>
                <li><strong>Weight</strong> in kg</li>
                <li><strong>Height</strong> in cm</li>
            </ol>
            <p><strong>Example query:</strong> "Calculate BSA for 70 kg and 175 cm"</p>
            <p><em>You provided {len(numbers)} number(s). Please provide both weight and height.</em></p>
            """

    # Maintenance Fluids (4-2-1 rule)
    if any(term in q for term in ['maintenance fluid', 'fluid requirement', '4-2-1', 'hourly fluid']):
        if len(numbers) >= 1:
            try:
                weight = float(numbers[0])
                if weight <= 10:
                    rate = weight * 4
                elif weight <= 20:
                    rate = 40 + (weight - 10) * 2
                else:
                    rate = 60 + (weight - 20) * 1

                return f"""
                <h3>Maintenance Fluid Requirement (4-2-1 Rule)</h3>
                <p><strong>Weight:</strong> {weight:.1f} kg</p>
                <p><strong>Calculation:</strong></p>
                <ul>
                    <li>First 10 kg: 4 mL/kg/hr</li>
                    <li>Second 10 kg: 2 mL/kg/hr</li>
                    <li>Each kg above 20: 1 mL/kg/hr</li>
                </ul>
                <p><strong>Result: {rate:.0f} mL/hr</strong></p>
                <p><strong>Daily requirement: {rate * 24:.0f} mL/day</strong></p>
                """
            except:
                pass
        else:
            return f"""
            <h3>Maintenance Fluid Requirement Calculator</h3>
            <p>To calculate maintenance fluids using the 4-2-1 rule, I need:</p>
            <ol>
                <li><strong>Patient weight</strong> in kg</li>
            </ol>
            <p><strong>Example queries:</strong></p>
            <ul>
                <li>"Maintenance fluids for 25 kg"</li>
                <li>"Calculate hourly fluid requirement for 70 kg patient"</li>
            </ul>
            """

    # QTc (Corrected QT interval)
    if any(term in q for term in ['qtc', 'corrected qt', 'qt interval']):
        if len(numbers) >= 2:
            try:
                qt = float(numbers[0])
                rr = float(numbers[1])
                # Bazett's formula
                qtc = qt / (rr ** 0.5)
                interpretation = "Normal" if qtc < 450 else "Prolonged (>450ms - risk of arrhythmia)"

                return f"""
                <h3>QTc (Corrected QT Interval) Calculation</h3>
                <p><strong>Formula:</strong> Bazett's formula: QTc = QT / √RR</p>
                <p><strong>Given:</strong></p>
                <ul>
                    <li>QT interval: {qt:.0f} ms</li>
                    <li>RR interval: {rr:.0f} ms</li>
                </ul>
                <p><strong>Result: QTc = {qtc:.0f} ms</strong></p>
                <p><strong>Interpretation:</strong> {interpretation}</p>
                """
            except:
                pass
        else:
            return f"""
            <h3>QTc (Corrected QT Interval) Calculator</h3>
            <p>To calculate QTc using Bazett's formula, I need:</p>
            <ol>
                <li><strong>QT interval</strong> in milliseconds</li>
                <li><strong>RR interval</strong> in milliseconds</li>
            </ol>
            <p><strong>Example query:</strong> "Calculate QTc for QT 400 and RR 800"</p>
            <p><em>You provided {len(numbers)} number(s). Please provide both QT and RR intervals.</em></p>
            """

    return None  # No calculation detected

PREOP_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Operative Assessment - gasconsult.ai</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="AI-powered pre-operative assessment tool combining evidence-based protocols with patient-specific factors for comprehensive anesthesia planning.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gasconsult.ai/preop">
    <meta property="og:title" content="Pre-Operative Assessment - gasconsult.ai">
    <meta property="og:description" content="AI-powered pre-operative assessment tool for comprehensive anesthesia planning.">
    <meta property="og:image" content="https://gasconsult.ai/static/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://gasconsult.ai/preop">
    <meta property="twitter:title" content="Pre-Operative Assessment - gasconsult.ai">
    <meta property="twitter:description" content="AI-powered pre-operative assessment tool for comprehensive anesthesia planning.">
    <meta property="twitter:image" content="https://gasconsult.ai/static/logo.png">

    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Canvas */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active { display: flex; }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 88px 16px 32px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
            animation: fade-up 0.6s ease forwards;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .header-title .blue { color: var(--blue-600); }

        .header-subtitle {
            font-size: 15px;
            color: var(--gray-500);
            line-height: 1.6;
        }

        /* Form Card */
        .form-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06);
            animation: fade-up 0.6s 0.1s ease forwards;
            opacity: 0;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-label .required {
            color: #EF4444;
            margin-left: 2px;
        }

        /* Input Styles */
        .form-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 15px;
            font-family: inherit;
            color: var(--gray-800);
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input::placeholder {
            color: var(--gray-400);
        }

        /* Input Row for Multiple Fields */
        .input-row {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
        }

        /* Radio Buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            position: relative;
            display: flex;
            align-items: center;
            padding: 14px 16px;
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            border-color: var(--blue-300);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.08);
        }

        .radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .radio-option input[type="radio"]:checked + .radio-visual {
            background: var(--blue-600);
            border-color: var(--blue-600);
        }

        .radio-option input[type="radio"]:checked + .radio-visual::after {
            opacity: 1;
        }

        .radio-option input[type="radio"]:checked ~ .radio-label {
            font-weight: 600;
            color: var(--blue-600);
        }

        .radio-option.selected {
            background: var(--blue-50);
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
        }

        .radio-visual {
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            flex-shrink: 0;
            position: relative;
            transition: all 0.2s ease;
            margin-right: 12px;
        }

        .radio-visual::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .radio-label {
            font-size: 14px;
            color: var(--gray-700);
            flex: 1;
            transition: all 0.2s ease;
        }

        /* Checkboxes */
        .checkbox-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-option:hover {
            border-color: var(--blue-300);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.06);
        }

        .checkbox-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: var(--blue-600);
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--gray-700);
            cursor: pointer;
            flex: 1;
        }

        /* Textarea */
        textarea.form-input {
            resize: vertical;
            min-height: 80px;
        }

        /* Section Divider */
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--gray-200) 50%, transparent 100%);
            margin: 32px 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(37,99,235,0.3), 0 8px 24px rgba(37,99,235,0.2);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.4), 0 12px 32px rgba(37,99,235,0.25);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Results State */
        .results-container {
            animation: fade-up 0.6s ease forwards;
        }

        .results-header {
            text-align: center;
            padding: 40px 32px;
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border-radius: 24px;
            margin-bottom: 32px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(37,99,235,0.08);
        }

        .results-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            background: var(--blue-600);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .results-icon svg {
            width: 28px;
            height: 28px;
            stroke: white;
        }

        .results-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .results-subtitle {
            font-size: 14px;
            color: var(--gray-600);
        }

        .results-card {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06);
        }

        .results-content {
            font-size: 15px;
            line-height: 1.8;
            color: var(--gray-700);
        }

        /* Assessment Content Typography */
        .results-content h3 {
            font-size: 20px;
            font-weight: 800;
            color: var(--gray-900);
            margin-top: 32px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--blue-100);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-content h3:first-child {
            margin-top: 0;
        }

        .results-content h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            border-radius: 2px;
            flex-shrink: 0;
        }

        .results-content h4 {
            font-size: 17px;
            font-weight: 700;
            color: var(--gray-800);
            margin-top: 24px;
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        .results-content p {
            margin-bottom: 16px;
            line-height: 1.8;
        }

        .results-content p:last-child {
            margin-bottom: 0;
        }

        .results-content strong {
            font-weight: 700;
            color: var(--gray-900);
        }

        .results-content ul,
        .results-content ol {
            margin: 16px 0;
            padding-left: 0;
            list-style: none;
        }

        .results-content ul li,
        .results-content ol li {
            position: relative;
            padding-left: 32px;
            margin-bottom: 12px;
            line-height: 1.8;
        }

        .results-content ul li::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 11px;
            width: 6px;
            height: 6px;
            background: var(--blue-500);
            border-radius: 50%;
        }

        .results-content ol {
            counter-reset: item;
        }

        .results-content ol li {
            counter-increment: item;
        }

        .results-content ol li::before {
            content: counter(item);
            position: absolute;
            left: 0;
            top: 0;
            width: 24px;
            height: 24px;
            background: var(--blue-50);
            color: var(--blue-600);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Info boxes within assessment */
        .results-content blockquote {
            margin: 20px 0;
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--blue-50) 0%, rgba(239, 246, 255, 0.5) 100%);
            border-left: 4px solid var(--blue-500);
            border-radius: 12px;
            font-style: normal;
        }

        /* Citation styling */
        .results-content a {
            color: var(--blue-600);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .results-content a:hover {
            color: var(--blue-700);
            text-decoration: underline;
        }

        /* Code/monospace elements */
        .results-content code {
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: var(--gray-800);
        }

        /* References */
        .references-card {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06);
        }

        .references-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 20px;
        }

        .references-title svg {
            width: 20px;
            height: 20px;
            stroke: var(--blue-600);
        }

        .reference-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .reference-item:last-child {
            border-bottom: none;
        }

        .reference-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: var(--blue-50);
            color: var(--blue-600);
            border-radius: 8px;
            text-align: center;
            line-height: 32px;
            font-size: 13px;
            font-weight: 700;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .reference-link {
            color: var(--blue-600);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.5;
        }

        .reference-link:hover {
            text-decoration: underline;
        }

        .reference-meta {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 6px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 14px 20px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            border: none;
            box-shadow: 0 2px 8px rgba(37,99,235,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        /* Footer */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        /* Tablet & Desktop */
        @media (min-width: 640px) {
            .input-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .checkbox-group {
                grid-template-columns: repeat(2, 1fr);
            }

            .radio-group {
                flex-direction: row;
                flex-wrap: wrap;
            }

            .radio-option {
                flex: 1;
                min-width: calc(50% - 5px);
            }
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }

            .main-content {
                padding: 108px 32px 48px;
            }

            .header-title {
                font-size: 36px;
            }

            .form-card {
                padding: 32px;
            }

            .action-buttons {
                flex-direction: row;
            }

            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }

            .main-content {
                max-width: 900px;
            }

            .header-title {
                font-size: 42px;
            }

            .form-card,
            .results-card,
            .references-card {
                padding: 40px;
            }

            .results-header {
                padding: 48px 40px;
            }
        }

        /* Mobile-specific adjustments */
        @media (max-width: 639px) {
            .results-card,
            .references-card {
                padding: 20px;
                border-radius: 20px;
            }

            .results-header {
                padding: 24px 20px;
                border-radius: 20px;
            }

            .results-content h3 {
                font-size: 18px;
            }

            .results-content h4 {
                font-size: 16px;
            }

            .results-title {
                font-size: 20px;
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 20px;
            padding: 32px 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
        }

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Generating Assessment...</div>
        </div>
    </div>

    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <!-- Navigation -->
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link active">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <!-- Main Content -->
        <main class="main-content">
            {% if not summary %}
            <!-- Form State -->
            <div class="header">
                <h1 class="header-title"><span class="blue">Pre-Operative</span> Assessment</h1>
                <p class="header-subtitle">Evidence-based risk stratification with personalized recommendations</p>
            </div>

            <div class="form-card">
                <form method="POST" action="/preop">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <!-- Patient Demographics -->
                    <div class="section-title">Patient Information</div>
                    
                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Age<span class="required">*</span></label>
                            <input type="number" name="age" class="form-input" placeholder="65" required min="0" max="120">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Weight (kg)<span class="required">*</span></label>
                            <input type="number" name="weight" class="form-input" placeholder="70" required min="1" max="300" step="0.1">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Height (cm)<span class="required">*</span></label>
                            <input type="number" name="height" class="form-input" placeholder="170" required min="50" max="250">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sex<span class="required">*</span></label>
                            <select name="sex" class="form-input" required>
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Functional Capacity -->
                    <div class="section-title">Functional Capacity</div>
                    <div class="form-group">
                        <label class="form-label">METs Capacity<span class="required">*</span></label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="mets" value="<4 METs" required>
                                <div class="radio-visual"></div>
                                <span class="radio-label">&lt;4 METs - Poor</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="mets" value="4-10 METs" required>
                                <div class="radio-visual"></div>
                                <span class="radio-label">4-10 METs - Moderate</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="mets" value=">10 METs" required>
                                <div class="radio-visual"></div>
                                <span class="radio-label">&gt;10 METs - Excellent</span>
                            </label>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Comorbidities -->
                    <div class="section-title">Comorbidities</div>
                    <div class="form-group">
                        <label class="form-label">Select all that apply</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Hypertension">
                                <span class="checkbox-label">Hypertension</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Diabetes Mellitus">
                                <span class="checkbox-label">Diabetes</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Coronary Artery Disease">
                                <span class="checkbox-label">CAD</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Heart Failure">
                                <span class="checkbox-label">Heart Failure</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Chronic Kidney Disease">
                                <span class="checkbox-label">CKD</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Obstructive Sleep Apnea">
                                <span class="checkbox-label">OSA</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="COPD">
                                <span class="checkbox-label">COPD</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="comorbidities" value="Prior Stroke">
                                <span class="checkbox-label">Prior Stroke</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Other Comorbidities</label>
                        <input type="text" name="other_comorbidities" class="form-input" placeholder="Enter any other conditions...">
                    </div>

                    <div class="section-divider"></div>

                    <!-- Medications -->
                    <div class="section-title">Medications & Allergies</div>
                    <div class="form-group">
                        <label class="form-label">Current Medications</label>
                        <textarea name="medications" class="form-input" placeholder="List medications (e.g., aspirin, metoprolol, lisinopril...)"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Allergies</label>
                        <input type="text" name="allergies" class="form-input" placeholder="Drug allergies and reactions...">
                    </div>

                    <div class="section-divider"></div>

                    <!-- Procedure Details -->
                    <div class="section-title">Surgical Procedure</div>
                    <div class="form-group">
                        <label class="form-label">Planned Procedure<span class="required">*</span></label>
                        <input type="text" name="procedure" class="form-input" placeholder="e.g., Total hip arthroplasty" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Surgery Risk Category<span class="required">*</span></label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="surgery_risk" value="low" required>
                                <div class="radio-visual"></div>
                                <span class="radio-label">Low Risk</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="surgery_risk" value="intermediate" required>
                                <div class="radio-visual"></div>
                                <span class="radio-label">Intermediate</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="surgery_risk" value="high" required>
                                <div class="radio-visual"></div>
                                <span class="radio-label">High Risk</span>
                            </label>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Additional Details -->
                    <div class="section-title">Additional Information (Optional)</div>
                    
                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Hemoglobin (g/dL)</label>
                            <input type="text" name="hgb" class="form-input" placeholder="12.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Creatinine (mg/dL)</label>
                            <input type="text" name="cr" class="form-input" placeholder="1.0">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Platelets (×10³/µL)</label>
                            <input type="text" name="plt" class="form-input" placeholder="250">
                        </div>
                        <div class="form-group">
                            <label class="form-label">INR</label>
                            <input type="text" name="inr" class="form-input" placeholder="1.0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ejection Fraction (%)</label>
                        <input type="text" name="ef" class="form-input" placeholder="55-60%">
                    </div>

                    <div class="form-group">
                        <label class="form-label">EKG Findings</label>
                        <input type="text" name="ekg" class="form-input" placeholder="Normal sinus rhythm">
                    </div>

                    <div class="form-group">
                        <label class="form-label">NPO Status</label>
                        <input type="text" name="npo" class="form-input" placeholder="NPO after midnight">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Previous Anesthesia Issues</label>
                        <textarea name="previous_anesthesia" class="form-input" placeholder="Any prior anesthesia complications, difficult airway, PONV history..."></textarea>
                    </div>

                    <button type="submit" class="submit-btn">Generate Assessment</button>
                </form>
            </div>

            {% else %}
            <!-- Results State -->
            <div class="results-container">
                <div class="results-header">
                    <div class="results-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h1 class="results-title"><span style="color: var(--blue-600);">Pre-Operative</span> Assessment Complete</h1>
                    <p class="results-subtitle">Evidence-based risk stratification and optimization recommendations</p>
                </div>

                <div class="results-card">
                    <div class="results-content">
                        {{ summary|safe }}
                    </div>
                </div>

                {% if references %}
                <div class="references-card">
                    <div class="references-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        <span>Evidence-Based References</span>
                    </div>
                    {% for ref in references %}
                    <div class="reference-item">
                        <span class="reference-number">[{{ loop.index }}]</span>
                        <a href="https://pubmed.ncbi.nlm.nih.gov/{{ ref.pmid }}/" target="_blank" rel="noopener noreferrer" class="reference-link">
                            {{ ref.title }}
                        </a>
                        <div class="reference-meta">{{ ref.authors }} - {{ ref.journal }}, {{ ref.year }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="action-buttons">
                    <a href="/preop" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Assessment
                    </a>
                    <button onclick="window.print()" class="btn btn-secondary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Print/Save PDF
                    </button>
                </div>
            </div>
            {% endif %}
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const menu = e.target.nextElementSibling;
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('show'));
        });

        // Radio button selection handler
        document.querySelectorAll('.radio-option').forEach(option => {
            option.addEventListener('click', function() {
                const radio = this.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                    // Remove selected class from siblings
                    const name = radio.getAttribute('name');
                    document.querySelectorAll(`input[name="${name}"]`).forEach(r => {
                        r.closest('.radio-option').classList.remove('selected');
                    });
                    // Add selected class to clicked option
                    this.classList.add('selected');
                }
            });
        });

        // Show loading overlay when form is submitted
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[method="POST"]');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (form && loadingOverlay) {
                form.addEventListener('submit', function(e) {
                    // Validate required fields before showing loading
                    const procedure = form.querySelector('input[name="procedure"]');
                    const surgeryRisk = form.querySelector('input[name="surgery_risk"]:checked');

                    // Only show loading if all required fields are filled
                    if (procedure && procedure.value.trim() !== '' &&
                        surgeryRisk) {
                        loadingOverlay.classList.add('active');
                    }
                });
            }
        });
    </script>
</body>
</html>
"""

# ====== Premium Feature Functions ======

def format_citation_vancouver(ref, index):
    """Format a single reference in Vancouver style"""
    authors = ref.get('authors', 'Unknown')
    title = ref.get('title', 'Unknown title')
    journal = ref.get('journal', 'Unknown journal')
    year = ref.get('year', 'Unknown')
    pmid = ref.get('pmid', '')

    # Truncate authors if too long
    if len(authors) > 100:
        authors = authors[:97] + '...'

    return f"{index}. {authors}. {title}. {journal}. {year}. PMID: {pmid}"

def generate_bibtex(references):
    """Generate BibTeX format for citation managers"""
    bibtex_entries = []

    for i, ref in enumerate(references, 1):
        authors = ref.get('authors', 'Unknown').replace(' and ', ' and ')
        title = ref.get('title', 'Unknown title')
        journal = ref.get('journal', 'Unknown journal')
        year = ref.get('year', 'Unknown')
        pmid = ref.get('pmid', '')

        entry = f"""@article{{ref{i},
  author = {{{authors}}},
  title = {{{title}}},
  journal = {{{journal}}},
  year = {{{year}}},
  note = {{PMID: {pmid}}}
}}"""
        bibtex_entries.append(entry)

    return '\n\n'.join(bibtex_entries)

def generate_ris(references):
    """Generate RIS format for citation managers (Zotero, Mendeley, EndNote)"""
    ris_entries = []

    for ref in references:
        authors = ref.get('authors', 'Unknown')
        title = ref.get('title', 'Unknown title')
        journal = ref.get('journal', 'Unknown journal')
        year = ref.get('year', 'Unknown')
        pmid = ref.get('pmid', '')

        # Split authors
        author_list = authors.split(', ')
        author_lines = '\n'.join([f"AU  - {author}" for author in author_list[:5]])  # First 5 authors

        entry = f"""TY  - JOUR
{author_lines}
TI  - {title}
JO  - {journal}
PY  - {year}
N1  - PMID: {pmid}
ER  - """
        ris_entries.append(entry)

    return '\n\n'.join(ris_entries)

def classify_study_type(title, journal):
    """
    Classify a single study based on its title and journal.
    Returns dict with study_type, quality_score, badge_text, and badge_color.

    Study types ranked by evidence quality (highest to lowest):
    1. Guideline/Consensus
    2. Meta-analysis
    3. Systematic Review
    4. RCT
    5. Observational Study
    6. Review Article
    7. Case Report/Series
    """
    title_lower = title.lower()
    journal_lower = journal.lower()

    # Check for guidelines/consensus (highest quality)
    if any(keyword in title_lower or keyword in journal_lower for keyword in
           ['guideline', 'guidelines', 'consensus', 'recommendation', 'practice parameter',
            'practice guideline', 'clinical practice', 'society statement']):
        return {
            'type': 'Guideline',
            'score': 4,
            'badge_text': 'Guideline',
            'badge_color': '#7C3AED',  # Purple
            'sort_priority': 1
        }

    # Check for meta-analysis
    if any(keyword in title_lower or keyword in journal_lower for keyword in
           ['meta-analysis', 'metaanalysis', 'meta analysis', 'pooled analysis',
            'network meta-analysis', 'meta-regression']):
        return {
            'type': 'Meta-analysis',
            'score': 3,
            'badge_text': 'Meta-analysis',
            'badge_color': '#059669',  # Green
            'sort_priority': 2
        }

    # Check for systematic review (separate from meta-analysis)
    if any(keyword in title_lower or keyword in journal_lower for keyword in
           ['systematic review', 'cochrane review', 'systematic literature review']):
        return {
            'type': 'Systematic Review',
            'score': 2.5,
            'badge_text': 'Systematic Review',
            'badge_color': '#0891B2',  # Teal
            'sort_priority': 3
        }

    # Check for RCT
    if any(keyword in title_lower for keyword in
           ['randomized', 'randomised', ' rct', 'randomized controlled trial',
            'randomised controlled trial', 'double-blind', 'double blind',
            'placebo-controlled', 'placebo controlled', 'controlled clinical trial']):
        return {
            'type': 'RCT',
            'score': 2,
            'badge_text': 'RCT',
            'badge_color': '#2563EB',  # Blue
            'sort_priority': 4
        }

    # Check for observational studies
    if any(keyword in title_lower for keyword in
           ['cohort study', 'cohort analysis', 'case-control', 'case control',
            'observational study', 'prospective study', 'retrospective study',
            'retrospective analysis', 'database analysis', 'registry']):
        return {
            'type': 'Observational',
            'score': 1,
            'badge_text': 'Observational',
            'badge_color': '#F59E0B',  # Amber
            'sort_priority': 5
        }

    # Check for case reports (lowest quality)
    if any(keyword in title_lower for keyword in
           ['case report', 'case series', 'case study']):
        return {
            'type': 'Case Report',
            'score': 0.5,
            'badge_text': 'Case Report',
            'badge_color': '#DC2626',  # Red
            'sort_priority': 7
        }

    # Check for review articles (general)
    if 'review' in title_lower:
        return {
            'type': 'Review',
            'score': 1,
            'badge_text': 'Review',
            'badge_color': '#6B7280',  # Gray
            'sort_priority': 6
        }

    # Default: unclassified
    return {
        'type': 'Study',
        'score': 0.5,
        'badge_text': 'Study',
        'badge_color': '#9CA3AF',  # Light gray
        'sort_priority': 8
    }

def get_evidence_strength(num_papers, references):
    """
    Analyze evidence strength and return classification based on study quality hierarchy.

    Evidence Hierarchy (points assigned):
    - Guidelines/Consensus: 4 points
    - Meta-analysis: 3 points
    - Systematic Review: 2.5 points
    - RCT: 2 points
    - Observational Study: 1 point
    - Review Article: 1 point
    - Case Report/Series: 0.5 points

    Confidence Levels:
    - High: score ≥8 OR 2+ meta-analyses OR (1+ guideline AND 1+ meta-analysis)
    - Moderate: score ≥4 OR 1+ meta-analysis OR 2+ RCTs OR 1+ guideline
    - Low: everything else
    """
    if not num_papers or num_papers == 0:
        return {
            'level': 'Low',
            'color': '#EF4444',
            'description': 'No evidence found',
            'score': 0,
            'breakdown': {
                'guidelines': 0,
                'meta_analyses': 0,
                'systematic_reviews': 0,
                'rcts': 0,
                'observational': 0,
                'reviews': 0,
                'case_reports': 0,
                'total': 0,
                'recent_count': 0
            }
        }

    # Initialize counters
    guideline_count = 0
    meta_analysis_count = 0
    systematic_review_count = 0
    rct_count = 0
    observational_count = 0
    review_count = 0
    case_report_count = 0
    recent_count = 0  # Papers from last 5 years

    quality_score = 0
    current_year = 2025

    # Analyze each paper for multiple study type indicators
    for ref in references:
        title = ref.get('title', '').lower()
        journal = ref.get('journal', '').lower()
        year = ref.get('year', '')

        # Track recency (papers from last 5 years)
        try:
            paper_year = int(year) if year else 0
            if current_year - paper_year <= 5:
                recent_count += 1
        except (ValueError, TypeError):
            pass

        # Check for guidelines/consensus (highest quality)
        if any(keyword in title or keyword in journal for keyword in
               ['guideline', 'guidelines', 'consensus', 'recommendation', 'practice parameter',
                'practice guideline', 'clinical practice', 'society statement', 'expert consensus',
                'position statement', 'standards of care', 'best practice', 'clinical pathway']):
            guideline_count += 1
            quality_score += 4

        # Check for meta-analysis
        if any(keyword in title or keyword in journal for keyword in
               ['meta-analysis', 'metaanalysis', 'meta analysis', 'pooled analysis',
                'network meta-analysis', 'meta-regression', 'systematic review and meta-analysis',
                'quantitative synthesis', 'evidence synthesis']):
            meta_analysis_count += 1
            quality_score += 3

        # Check for systematic review (separate from meta-analysis)
        elif any(keyword in title or keyword in journal for keyword in
                 ['systematic review', 'cochrane review', 'systematic literature review',
                  'evidence-based review', 'integrative review', 'scoping review',
                  'umbrella review', 'critical review']):
            systematic_review_count += 1
            quality_score += 2.5

        # Check for RCT
        elif any(keyword in title for keyword in
                 ['randomized', 'randomised', ' rct', 'randomized controlled trial',
                  'randomised controlled trial', 'double-blind', 'double blind',
                  'placebo-controlled', 'placebo controlled', 'controlled clinical trial']):
            rct_count += 1
            quality_score += 2

        # Check for observational studies
        elif any(keyword in title for keyword in
                 ['cohort study', 'cohort analysis', 'case-control', 'case control',
                  'observational study', 'prospective study', 'retrospective study',
                  'retrospective analysis', 'database analysis', 'registry']):
            observational_count += 1
            quality_score += 1

        # Check for case reports (lowest quality)
        elif any(keyword in title for keyword in
                 ['case report', 'case series', 'case study']):
            case_report_count += 1
            quality_score += 0.5

        # Check for review articles (general) - increased value since they're clinically useful
        elif any(keyword in title for keyword in ['review', 'update', 'overview', 'state of the art',
                                                   'current concepts', 'advances in', 'recent advances']):
            review_count += 1
            quality_score += 1.5  # Increased from 1.0 since reviews are still valuable

    # Add recency bonus (5% boost for recent evidence)
    recency_bonus = (recent_count / num_papers) * 0.5 if num_papers > 0 else 0
    total_score = quality_score + recency_bonus

    # Build breakdown object
    breakdown = {
        'guidelines': guideline_count,
        'meta_analyses': meta_analysis_count,
        'systematic_reviews': systematic_review_count,
        'rcts': rct_count,
        'observational': observational_count,
        'reviews': review_count,
        'case_reports': case_report_count,
        'total': num_papers,
        'recent_count': recent_count
    }

    # Determine confidence level based on refined criteria
    # HIGH CONFIDENCE: Strong evidence from multiple high-quality sources
    # Adjusted thresholds to be more realistic while maintaining quality standards
    if (total_score >= 6 or  # Lowered from 8 (e.g., 1 guideline + 1 systematic review)
        meta_analysis_count >= 2 or
        (guideline_count >= 1 and meta_analysis_count >= 1) or
        (guideline_count >= 1 and rct_count >= 2) or
        (systematic_review_count >= 2 and num_papers >= 5) or  # 2+ systematic reviews with good paper count
        (meta_analysis_count >= 1 and systematic_review_count >= 1) or  # 1 meta + 1 systematic
        (num_papers >= 8 and total_score >= 4)):  # Many papers with decent quality

        # Build description highlighting strongest evidence
        desc_parts = []
        if guideline_count > 0:
            desc_parts.append(f"{guideline_count} guideline{'s' if guideline_count != 1 else ''}")
        if meta_analysis_count > 0:
            desc_parts.append(f"{meta_analysis_count} meta-analysis/analyses")
        if systematic_review_count > 0:
            desc_parts.append(f"{systematic_review_count} systematic review{'s' if systematic_review_count != 1 else ''}")
        if rct_count > 0:
            desc_parts.append(f"{rct_count} RCT{'s' if rct_count != 1 else ''}")

        description = f"{num_papers} papers: {', '.join(desc_parts) if desc_parts else 'high-quality evidence'}"

        return {
            'level': 'High',
            'color': '#10B981',
            'description': description,
            'score': total_score,
            'breakdown': breakdown
        }

    # MODERATE CONFIDENCE: Some high-quality evidence or multiple moderate-quality sources
    # More lenient thresholds to avoid "Low Confidence" for good answers
    elif (total_score >= 2.5 or  # Lowered from 4 (e.g., 1 systematic review OR 1 RCT + 1 observational)
          meta_analysis_count >= 1 or
          systematic_review_count >= 1 or
          rct_count >= 2 or
          rct_count >= 1 and num_papers >= 4 or  # 1 RCT + multiple supporting papers
          guideline_count >= 1 or
          num_papers >= 5 and total_score >= 1.5):  # 5+ papers with some quality

        # Build description
        desc_parts = []
        if guideline_count > 0:
            desc_parts.append(f"{guideline_count} guideline{'s' if guideline_count != 1 else ''}")
        if meta_analysis_count > 0:
            desc_parts.append(f"{meta_analysis_count} meta-analysis/analyses")
        if systematic_review_count > 0:
            desc_parts.append(f"{systematic_review_count} systematic review{'s' if systematic_review_count != 1 else ''}")
        if rct_count > 0:
            desc_parts.append(f"{rct_count} RCT{'s' if rct_count != 1 else ''}")
        if observational_count > 0:
            desc_parts.append(f"{observational_count} observational")

        description = f"{num_papers} papers: {', '.join(desc_parts) if desc_parts else 'moderate-quality evidence'}"

        return {
            'level': 'Moderate',
            'color': '#FBBF24',
            'description': description,
            'score': total_score,
            'breakdown': breakdown
        }

    # LOW CONFIDENCE: Limited or low-quality evidence
    else:
        # Build description
        desc_parts = []
        if observational_count > 0:
            desc_parts.append(f"{observational_count} observational")
        if review_count > 0:
            desc_parts.append(f"{review_count} review{'s' if review_count != 1 else ''}")
        if case_report_count > 0:
            desc_parts.append(f"{case_report_count} case report{'s' if case_report_count != 1 else ''}")

        description = f"Limited evidence ({num_papers} papers): {', '.join(desc_parts) if desc_parts else 'low-quality studies'}"

        return {
            'level': 'Low',
            'color': '#EF4444',
            'description': description,
            'score': total_score,
            'breakdown': breakdown
        }

# ============================================================================
# HYBRID RAG + AGENTIC AI FOR PREOPERATIVE ASSESSMENT
# ============================================================================

def calculate_rcri(age, comorbidities, cr, surgery_risk, procedure):
    """
    Calculate Revised Cardiac Risk Index (RCRI) score.

    RCRI Components (1 point each):
    1. High-risk surgery
    2. History of ischemic heart disease
    3. History of congestive heart failure
    4. History of cerebrovascular disease
    5. Diabetes mellitus requiring insulin
    6. Preoperative creatinine > 2.0 mg/dL

    Risk of major cardiac complications:
    - 0 points: 0.4%
    - 1 point: 0.9%
    - 2 points: 6.6%
    - ≥3 points: 11%
    """
    score = 0
    components = []

    # 1. High-risk surgery (intraperitoneal, intrathoracic, suprainguinal vascular)
    high_risk_keywords = [
        'abdominal', 'laparotomy', 'bowel', 'colon', 'liver', 'pancreas',
        'thoracic', 'lung', 'esophageal', 'chest',
        'vascular', 'aortic', 'carotid', 'femoral'
    ]
    procedure_lower = procedure.lower()
    if surgery_risk.lower() == 'high' or any(keyword in procedure_lower for keyword in high_risk_keywords):
        score += 1
        components.append("High-risk surgery")

    # 2. Ischemic heart disease (CAD, prior MI, PCI, CABG)
    cad_conditions = ["Coronary Artery Disease", "Prior MI", "Prior PCI", "Prior CABG"]
    if any(cond in comorbidities for cond in cad_conditions):
        score += 1
        components.append("Ischemic heart disease")

    # 3. Congestive heart failure
    if "Heart Failure" in comorbidities or "CHF" in comorbidities:
        score += 1
        components.append("Heart failure")

    # 4. Cerebrovascular disease
    if "Prior Stroke" in comorbidities or "TIA" in comorbidities or "Cerebrovascular Disease" in comorbidities:
        score += 1
        components.append("Cerebrovascular disease")

    # 5. Diabetes requiring insulin (cannot determine from form, assume if DM present - conservative)
    if "Diabetes Mellitus" in comorbidities:
        score += 1
        components.append("Diabetes mellitus")

    # 6. Creatinine > 2.0 mg/dL
    try:
        cr_value = float(cr) if cr else 0
        if cr_value > 2.0:
            score += 1
            components.append(f"Creatinine > 2.0 mg/dL ({cr_value})")
    except (ValueError, TypeError):
        pass

    # Risk categorization
    if score == 0:
        risk_category = "Very Low"
        cardiac_event_risk = 0.4
    elif score == 1:
        risk_category = "Low"
        cardiac_event_risk = 0.9
    elif score == 2:
        risk_category = "Moderate"
        cardiac_event_risk = 6.6
    else:  # ≥3
        risk_category = "High"
        cardiac_event_risk = 11.0

    return {
        'score': score,
        'components': components,
        'risk_category': risk_category,
        'cardiac_event_risk': cardiac_event_risk
    }


def classify_preop_complexity(patient_data):
    """
    Classify preoperative assessment complexity to determine routing:
    - 'fast_rag': Simple cases (ASA I-II, low-risk surgery, <3 comorbidities)
    - 'agentic': Complex cases (ASA III-IV, high-risk surgery, multiple comorbidities, drug interactions)

    Returns: 'fast_rag' or 'agentic'
    """
    complexity_score = 0
    reasoning = []

    # Age factor
    age = patient_data.get('age', 0)
    if age > 75:
        complexity_score += 2
        reasoning.append(f"Age > 75 years ({age})")
    elif age > 65:
        complexity_score += 1
        reasoning.append(f"Age > 65 years ({age})")

    # Comorbidity count
    comorbidities = patient_data.get('comorbidities', [])
    num_comorbidities = len(comorbidities)
    if num_comorbidities >= 3:
        complexity_score += 3
        reasoning.append(f"Multiple comorbidities (n={num_comorbidities})")
    elif num_comorbidities >= 2:
        complexity_score += 2
        reasoning.append(f"Multiple comorbidities (n={num_comorbidities})")

    # High-risk comorbidities
    high_risk_conditions = [
        "Heart Failure", "Coronary Artery Disease", "Prior MI",
        "Chronic Kidney Disease", "Liver Disease", "Pulmonary Hypertension"
    ]
    if any(cond in comorbidities for cond in high_risk_conditions):
        complexity_score += 2
        reasoning.append("High-risk cardiac/renal/hepatic disease")

    # Surgery risk
    surgery_risk = patient_data.get('surgery_risk', '').lower()
    if 'high' in surgery_risk:
        complexity_score += 3
        reasoning.append("High-risk surgery")
    elif 'intermediate' in surgery_risk or 'moderate' in surgery_risk:
        complexity_score += 1
        reasoning.append("Intermediate-risk surgery")

    # Anticoagulation (complex medication management)
    medications = patient_data.get('medications', '').lower()
    anticoag_drugs = ['warfarin', 'coumadin', 'apixaban', 'eliquis', 'rivaroxaban', 'xarelto', 'dabigatran', 'pradaxa', 'edoxaban']
    if any(drug in medications for drug in anticoag_drugs):
        complexity_score += 3
        reasoning.append("Anticoagulation requiring bridging assessment")

    # Insulin/complex diabetes
    if 'insulin' in medications or 'lantus' in medications or 'humalog' in medications or 'novolog' in medications:
        complexity_score += 2
        reasoning.append("Insulin-dependent diabetes")

    # Abnormal labs
    try:
        cr = float(patient_data.get('cr', 0))
        if cr > 1.5:
            complexity_score += 2
            reasoning.append(f"Elevated creatinine ({cr} mg/dL)")
    except (ValueError, TypeError):
        pass

    try:
        ef_str = patient_data.get('ef', '').lower()
        # Try to extract numeric value
        ef_numeric = None
        for part in ef_str.split():
            try:
                ef_numeric = float(''.join(filter(lambda x: x.isdigit() or x == '.', part)))
                break
            except:
                pass

        if ef_numeric and ef_numeric < 40:
            complexity_score += 3
            reasoning.append(f"Reduced ejection fraction ({ef_numeric}%)")
        elif any(term in ef_str for term in ['reduced', 'low', 'decreased', 'hfref']):
            complexity_score += 3
            reasoning.append("Reduced ejection fraction")
    except:
        pass

    # Emergency surgery
    if patient_data.get('emergency', False):
        complexity_score += 3
        reasoning.append("Emergency surgery")

    # Decision threshold
    mode = 'agentic' if complexity_score >= 5 else 'fast_rag'

    return {
        'mode': mode,
        'complexity_score': complexity_score,
        'reasoning': reasoning
    }


class PreopAgent:
    """
    Agentic AI for preoperative optimization planning.

    Implements 7-step workflow:
    1. Risk Stratification (RCRI, estimated NSQIP risks)
    2. Identify Critical Issues (anticoagulation, cardiac, diabetes, renal)
    3. Adaptive Literature Search (multi-round with self-verification)
    4. Guideline Cross-Check (ASA, ACC/AHA)
    5. Drug Interaction Check
    6. Optimization Plan Generator (timeline-based)
    7. Final Synthesis with Reasoning Trace
    """

    def __init__(self, patient_data):
        self.patient = patient_data
        self.findings = {}
        self.recommendations = {}
        self.evidence = []
        self.reasoning_trace = []
        self.search_count = 0

    def run(self):
        """Orchestrate full agentic workflow"""
        try:
            # STEP 1: Risk Stratification
            self.reasoning_trace.append("✓ Step 1: Risk Stratification")
            self.findings['risk'] = self.assess_baseline_risk()

            # STEP 2: Identify Critical Issues
            self.reasoning_trace.append("✓ Step 2: Identifying Critical Issues")
            critical_issues = self.identify_critical_issues()

            # STEP 3: Adaptive Literature Search
            self.reasoning_trace.append(f"✓ Step 3: Adaptive Literature Search ({len(critical_issues)} issues)")
            for issue in critical_issues[:5]:  # Limit to 5 issues to avoid overwhelming
                evidence = self.deep_search(issue)
                if evidence and evidence.get('papers'):
                    self.evidence.append(evidence)

            # STEP 4: Guideline Cross-Check
            self.reasoning_trace.append("✓ Step 4: Guideline Cross-Check")
            guideline_evidence = self.check_guidelines()
            if guideline_evidence:
                self.evidence.extend(guideline_evidence)

            # STEP 5: Drug Interaction Check
            self.reasoning_trace.append("✓ Step 5: Drug Interaction Analysis")
            self.findings['interactions'] = self.check_drug_interactions()

            # STEP 6: Optimization Plan
            self.reasoning_trace.append("✓ Step 6: Generating Optimization Plan")
            self.recommendations = self.generate_optimization_plan()

            # STEP 7: Final Synthesis
            self.reasoning_trace.append("✓ Step 7: Final Synthesis")
            return self.synthesize_final_report()

        except Exception as e:
            logging.error(f"PreopAgent error: {str(e)}")
            return None

    def assess_baseline_risk(self):
        """Step 1: Calculate RCRI and estimate complication risks"""
        rcri = calculate_rcri(
            age=self.patient['age'],
            comorbidities=self.patient['comorbidities'],
            cr=self.patient.get('cr', ''),
            surgery_risk=self.patient['surgery_risk'],
            procedure=self.patient['procedure']
        )

        # Simple NSQIP risk estimates based on RCRI + age + comorbidities
        # (In production, would use actual NSQIP calculator or API)
        base_risk = rcri['cardiac_event_risk']

        # Age adjustment
        age = self.patient['age']
        age_factor = 1.0
        if age > 75:
            age_factor = 1.5
        elif age > 65:
            age_factor = 1.2

        # Comorbidity adjustment
        num_comorbidities = len(self.patient.get('comorbidities', []))
        comorbid_factor = 1.0 + (num_comorbidities * 0.15)

        cardiac_risk = min(base_risk * age_factor * comorbid_factor, 25.0)  # Cap at 25%
        respiratory_risk = min(2.0 * age_factor * comorbid_factor, 15.0) if age > 60 or "COPD" in self.patient.get('comorbidities', []) else 1.0
        aki_risk = 5.0 if "Chronic Kidney Disease" in self.patient.get('comorbidities', []) else 1.0
        mortality_risk = min(0.5 * rcri['score'] * age_factor, 10.0)

        return {
            'rcri': rcri,
            'cardiac_risk': round(cardiac_risk, 1),
            'respiratory_risk': round(respiratory_risk, 1),
            'aki_risk': round(aki_risk, 1),
            'mortality_risk': round(mortality_risk, 1)
        }

    def identify_critical_issues(self):
        """Step 2: Agent identifies what needs investigation"""
        issues = []

        # Anticoagulation management
        medications = self.patient.get('medications', '').lower()
        anticoag_drugs = {
            'warfarin': 'warfarin', 'coumadin': 'warfarin',
            'apixaban': 'apixaban (Eliquis)', 'eliquis': 'apixaban (Eliquis)',
            'rivaroxaban': 'rivaroxaban (Xarelto)', 'xarelto': 'rivaroxaban (Xarelto)',
            'dabigatran': 'dabigatran (Pradaxa)', 'pradaxa': 'dabigatran (Pradaxa)'
        }

        detected_anticoag = None
        for drug_key, drug_name in anticoag_drugs.items():
            if drug_key in medications:
                detected_anticoag = drug_name
                break

        if detected_anticoag:
            issues.append({
                'category': 'anticoagulation',
                'query': f"perioperative {detected_anticoag} management bridging {self.patient['procedure']}",
                'priority': 'critical',
                'follow_up_needed': True,
                'description': f"Anticoagulation bridging protocol for {detected_anticoag}"
            })

        # High cardiac risk
        if self.findings['risk']['rcri']['score'] >= 2:
            issues.append({
                'category': 'cardiac',
                'query': f"perioperative cardiac risk optimization RCRI {self.patient['procedure']}",
                'priority': 'critical',
                'follow_up_needed': True,
                'description': f"Cardiac risk optimization (RCRI = {self.findings['risk']['rcri']['score']})"
            })

        # Diabetes management (distinguish insulin vs oral)
        if 'Diabetes Mellitus' in self.patient.get('comorbidities', []):
            insulin_user = any(drug in medications for drug in ['insulin', 'lantus', 'novolog', 'humalog', 'levemir'])
            diabetes_type = 'insulin' if insulin_user else 'oral hypoglycemic'
            issues.append({
                'category': 'diabetes',
                'query': f"perioperative {diabetes_type} management glycemic control",
                'priority': 'high',
                'follow_up_needed': insulin_user,
                'description': f"Perioperative glycemic management ({diabetes_type})"
            })

        # CKD + nephrotoxic procedures
        if 'Chronic Kidney Disease' in self.patient.get('comorbidities', []):
            procedure_lower = self.patient['procedure'].lower()
            nephrotoxic_keywords = ['contrast', 'cardiac', 'vascular', 'bypass']
            if any(keyword in procedure_lower for keyword in nephrotoxic_keywords):
                issues.append({
                    'category': 'renal',
                    'query': 'perioperative renal protection AKI prevention chronic kidney disease',
                    'priority': 'high',
                    'follow_up_needed': True,
                    'description': 'Renal protection for CKD patient'
                })

        # Reduced EF
        ef_str = self.patient.get('ef', '').lower()
        if ef_str and (any(term in ef_str for term in ['reduced', 'low', 'hfref']) or '<40' in ef_str):
            issues.append({
                'category': 'cardiac',
                'query': f"reduced ejection fraction heart failure perioperative management {self.patient['procedure']}",
                'priority': 'high',
                'follow_up_needed': True,
                'description': 'Reduced ejection fraction management'
            })

        # Sort by priority
        priority_order = {'critical': 0, 'high': 1, 'medium': 2}
        issues.sort(key=lambda x: priority_order.get(x['priority'], 3))

        return issues

    def deep_search(self, issue):
        """Step 3: Multi-round adaptive search with self-verification"""
        try:
            # Round 1: High-quality evidence (guidelines, meta-analyses, systematic reviews)
            q_expanded = issue['query'].replace(" ", " AND ")
            search_term = (
                f'({q_expanded}) AND '
                f'(systematic review[pt] OR meta-analysis[pt] OR guideline[pt]) AND '
                f'("2015/01/01"[PDAT] : "3000"[PDAT])'
            )

            handle = Entrez.esearch(db="pubmed", term=search_term, retmax=5, sort="relevance")
            result = Entrez.read(handle)
            ids = result.get("IdList", [])

            papers = []
            if ids:
                handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
                fetched_papers = Entrez.read(handle).get("PubmedArticle", [])

                for p in fetched_papers:
                    try:
                        art = p["MedlineCitation"]["Article"]
                        title = str(art.get("ArticleTitle", "No title"))
                        abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                        authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])
                        journal = str(art["Journal"].get("Title", "Unknown"))
                        year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                        pmid = str(p["MedlineCitation"]["PMID"])

                        study_classification = classify_study_type(title, journal)

                        papers.append({
                            "title": title,
                            "abstract": abstract,
                            "authors": authors,
                            "journal": journal,
                            "year": year,
                            "pmid": pmid,
                            "study_type": study_classification['type'],
                            "study_badge": study_classification['badge_text'],
                            "study_color": study_classification['badge_color'],
                            "study_score": study_classification['score'],
                            "sort_priority": study_classification['sort_priority']
                        })
                    except:
                        continue

            self.search_count += 1

            # Self-verification: Is evidence sufficient?
            if issue['follow_up_needed'] and len(papers) < 3:
                # Round 2: Broaden to RCTs
                search_term = (
                    f'({q_expanded}) AND '
                    f'("randomized controlled trial"[pt]) AND '
                    f'("2015/01/01"[PDAT] : "3000"[PDAT])'
                )

                handle = Entrez.esearch(db="pubmed", term=search_term, retmax=3, sort="relevance")
                result = Entrez.read(handle)
                ids = result.get("IdList", [])

                if ids:
                    handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
                    fetched_papers = Entrez.read(handle).get("PubmedArticle", [])

                    for p in fetched_papers:
                        try:
                            art = p["MedlineCitation"]["Article"]
                            title = str(art.get("ArticleTitle", "No title"))
                            abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                            authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])
                            journal = str(art["Journal"].get("Title", "Unknown"))
                            year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                            pmid = str(p["MedlineCitation"]["PMID"])

                            study_classification = classify_study_type(title, journal)

                            papers.append({
                                "title": title,
                                "abstract": abstract,
                                "authors": authors,
                                "journal": journal,
                                "year": year,
                                "pmid": pmid,
                                "study_type": study_classification['type'],
                                "study_badge": study_classification['badge_text'],
                                "study_color": study_classification['badge_color'],
                                "study_score": study_classification['score'],
                                "sort_priority": study_classification['sort_priority']
                            })
                        except:
                            continue

                self.search_count += 1

            return {
                'issue': issue,
                'papers': papers,
                'evidence_strength': 'high' if len(papers) >= 3 else 'moderate' if len(papers) >= 1 else 'low'
            }

        except Exception as e:
            logging.error(f"Deep search error: {str(e)}")
            return None

    def check_guidelines(self):
        """Step 4: Search for specific guidelines"""
        guideline_evidence = []

        try:
            # ACC/AHA perioperative guidelines if cardiac risk present
            if self.findings['risk']['rcri']['score'] >= 1:
                search_term = '"ACC AHA" AND (perioperative OR noncardiac surgery) AND guideline[pt]'
                handle = Entrez.esearch(db="pubmed", term=search_term, retmax=2, sort="relevance")
                result = Entrez.read(handle)
                ids = result.get("IdList", [])

                if ids:
                    papers = self._fetch_papers(ids)
                    if papers:
                        guideline_evidence.append({
                            'issue': {'category': 'guideline', 'description': 'ACC/AHA perioperative guidelines'},
                            'papers': papers,
                            'evidence_strength': 'high'
                        })
                        self.search_count += 1

            # ASA guidelines for specific scenarios
            if "Obstructive Sleep Apnea" in self.patient.get('comorbidities', []):
                search_term = '"American Society of Anesthesiologists" AND "obstructive sleep apnea" AND guideline[pt]'
                handle = Entrez.esearch(db="pubmed", term=search_term, retmax=1, sort="relevance")
                result = Entrez.read(handle)
                ids = result.get("IdList", [])

                if ids:
                    papers = self._fetch_papers(ids)
                    if papers:
                        guideline_evidence.append({
                            'issue': {'category': 'guideline', 'description': 'ASA OSA guidelines'},
                            'papers': papers,
                            'evidence_strength': 'high'
                        })
                        self.search_count += 1

        except Exception as e:
            logging.error(f"Guideline check error: {str(e)}")

        return guideline_evidence

    def _fetch_papers(self, ids):
        """Helper to fetch and format papers"""
        papers = []
        try:
            handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
            fetched_papers = Entrez.read(handle).get("PubmedArticle", [])

            for p in fetched_papers:
                try:
                    art = p["MedlineCitation"]["Article"]
                    title = str(art.get("ArticleTitle", "No title"))
                    abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                    authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])
                    journal = str(art["Journal"].get("Title", "Unknown"))
                    year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                    pmid = str(p["MedlineCitation"]["PMID"])

                    study_classification = classify_study_type(title, journal)

                    papers.append({
                        "title": title,
                        "abstract": abstract,
                        "authors": authors,
                        "journal": journal,
                        "year": year,
                        "pmid": pmid,
                        "study_type": study_classification['type'],
                        "study_badge": study_classification['badge_text'],
                        "study_color": study_classification['badge_color'],
                        "study_score": study_classification['score'],
                        "sort_priority": study_classification['sort_priority']
                    })
                except:
                    continue
        except Exception as e:
            logging.error(f"Fetch papers error: {str(e)}")

        return papers

    def check_drug_interactions(self):
        """Step 5: Check for critical drug interactions"""
        interactions = []
        medications = self.patient.get('medications', '').lower()

        # ACEI/ARB on morning of surgery
        acei_arb_drugs = ['lisinopril', 'enalapril', 'losartan', 'valsartan', 'ramipril', 'perindopril']
        if any(drug in medications for drug in acei_arb_drugs):
            interactions.append({
                'drugs': 'ACEI/ARB',
                'issue': 'Intraoperative hypotension risk',
                'recommendation': 'Consider holding on morning of surgery (controversial - discuss risks/benefits)',
                'evidence_query': 'perioperative ACEI ARB hypotension management',
                'severity': 'moderate'
            })

        # SGLT2 inhibitors + ketoacidosis risk
        sglt2_drugs = ['jardiance', 'farxiga', 'empagliflozin', 'dapagliflozin', 'canagliflozin', 'invokana']
        if any(drug in medications for drug in sglt2_drugs):
            interactions.append({
                'drugs': 'SGLT2 inhibitor',
                'issue': 'Euglycemic DKA risk',
                'recommendation': 'Hold 3-4 days preoperatively for major surgery',
                'evidence_query': 'SGLT2 inhibitor perioperative ketoacidosis',
                'severity': 'high'
            })

        # Metformin + lactic acidosis
        if 'metformin' in medications:
            cr_value = 0
            try:
                cr_value = float(self.patient.get('cr', 0))
            except:
                pass

            if cr_value > 1.5 or 'Chronic Kidney Disease' in self.patient.get('comorbidities', []):
                interactions.append({
                    'drugs': 'Metformin',
                    'issue': 'Lactic acidosis risk with CKD',
                    'recommendation': 'Hold 48 hours preoperatively, resume when renal function stable',
                    'evidence_query': 'metformin perioperative lactic acidosis',
                    'severity': 'high'
                })

        return interactions

    def generate_optimization_plan(self):
        """Step 6: Generate timeline-based optimization recommendations"""
        plan = {
            'immediate': [],  # Day of surgery
            'short_term': [],  # 1-7 days pre-op
            'long_term': [],  # >7 days pre-op
            'intraoperative': [],
            'postoperative': []
        }

        # Drug interaction recommendations
        for interaction in self.findings.get('interactions', []):
            if interaction['severity'] == 'high':
                if '3-4 days' in interaction['recommendation']:
                    plan['short_term'].append({
                        'action': interaction['recommendation'],
                        'rationale': interaction['issue'],
                        'category': 'medication'
                    })
                elif '48 hours' in interaction['recommendation']:
                    plan['short_term'].append({
                        'action': interaction['recommendation'],
                        'rationale': interaction['issue'],
                        'category': 'medication'
                    })
            else:
                plan['immediate'].append({
                    'action': interaction['recommendation'],
                    'rationale': interaction['issue'],
                    'category': 'medication'
                })

        # Cardiac optimization
        rcri_score = self.findings['risk']['rcri']['score']
        if rcri_score >= 2:
            plan['long_term'].append({
                'action': f'Consider cardiology consultation (RCRI = {rcri_score})',
                'rationale': f'Moderate-high cardiac risk ({self.findings["risk"]["cardiac_risk"]}% major cardiac event)',
                'category': 'cardiac'
            })

        # Renal protection
        if 'Chronic Kidney Disease' in self.patient.get('comorbidities', []):
            plan['immediate'].append({
                'action': 'Perioperative IV fluid hydration (0.9% NS 1-1.5 mL/kg/hr)',
                'rationale': 'Renal protection for CKD patient',
                'category': 'renal'
            })

        # Diabetes management
        if 'Diabetes Mellitus' in self.patient.get('comorbidities', []):
            plan['immediate'].append({
                'action': 'NPO insulin protocol (50% long-acting insulin, hold short-acting)',
                'rationale': 'Perioperative glycemic control',
                'category': 'endocrine'
            })

        return plan

    def synthesize_final_report(self):
        """Step 7: Generate comprehensive report with all evidence"""
        # Collect all papers
        all_papers = []
        for evidence_group in self.evidence:
            if evidence_group and 'papers' in evidence_group:
                all_papers.extend(evidence_group['papers'])

        # Remove duplicates by PMID
        seen_pmids = set()
        unique_papers = []
        for paper in all_papers:
            if paper['pmid'] not in seen_pmids:
                seen_pmids.add(paper['pmid'])
                unique_papers.append(paper)

        # Sort by quality
        unique_papers.sort(key=lambda x: x.get('sort_priority', 99))

        # Build context for GPT
        ref_list = ""
        all_context = ""
        for i, ref in enumerate(unique_papers, 1):
            ref_list += f"[{i}] {ref['title']} - {ref['authors']} ({ref['year']}) PMID: {ref['pmid']}\n"
            all_context += f"Title: {ref['title']}\nAbstract: {ref.get('abstract', '')}\nAuthors: {ref['authors']}\nJournal: {ref['journal']} ({ref['year']})\nPMID: {ref['pmid']}\n\n"

        # Build patient summary
        comorbidities_str = ', '.join(self.patient.get('comorbidities', [])) if self.patient.get('comorbidities') else 'None'
        other_comorbidities = self.patient.get('other_comorbidities', '')
        if other_comorbidities:
            comorbidities_str += f"; {other_comorbidities}"

        # Calculate BMI and IBW
        weight = self.patient.get('weight', 0)
        height = self.patient.get('height', 0)
        bmi = round(weight / ((height / 100) ** 2), 1) if weight and height else None

        sex = self.patient.get('sex', 'male')
        if sex == 'male':
            ibw = round(50 + 0.91 * (height - 152.4), 1) if height else None
        else:
            ibw = round(45.5 + 0.91 * (height - 152.4), 1) if height else None

        patient_data = f"""
Patient Demographics:
- Age: {self.patient.get('age', 'N/A')} years
- Weight: {weight} kg
- Height: {height} cm
- Sex: {sex}
- BMI: {bmi} kg/m²
- IBW: {ibw} kg

Comorbidities: {comorbidities_str}

Functional Status:
- METs: {self.patient.get('mets', 'Not specified')}

Previous Anesthesia: {self.patient.get('previous_anesthesia', 'None reported')}

Medications: {self.patient.get('medications', 'None reported')}

Laboratory Values:
- Hemoglobin: {self.patient.get('hgb', 'N/A')} g/dL
- Platelets: {self.patient.get('plt', 'N/A')} ×10³/μL
- Creatinine: {self.patient.get('cr', 'N/A')} mg/dL
- INR: {self.patient.get('inr', 'N/A')}

Cardiac Assessment:
- Ejection Fraction: {self.patient.get('ef', 'Not available')}
- EKG: {self.patient.get('ekg', 'Not available')}

Procedure: {self.patient.get('procedure', 'Not specified')}
Surgery Risk: {self.patient.get('surgery_risk', 'Not specified')}

NPO Status: {self.patient.get('npo', 'Not specified')}
Allergies: {self.patient.get('allergies', 'NKDA')}
"""

        # Build optimization timeline summary
        optimization_summary = ""
        if self.recommendations.get('long_term'):
            optimization_summary += "\n**Long-term (>7 days pre-op):**\n"
            for rec in self.recommendations['long_term']:
                optimization_summary += f"- {rec['action']} ({rec['rationale']})\n"

        if self.recommendations.get('short_term'):
            optimization_summary += "\n**Short-term (1-7 days pre-op):**\n"
            for rec in self.recommendations['short_term']:
                optimization_summary += f"- {rec['action']} ({rec['rationale']})\n"

        if self.recommendations.get('immediate'):
            optimization_summary += "\n**Day of surgery:**\n"
            for rec in self.recommendations['immediate']:
                optimization_summary += f"- {rec['action']} ({rec['rationale']})\n"

        # Generate GPT prompt
        prompt = f"""You are an expert anesthesiologist using an AI-powered decision support system. This assessment was generated using AGENTIC AI that performed multi-step reasoning, adaptive literature search, and guideline cross-checking.

AGENT ANALYSIS RESULTS:

**Risk Stratification:**
- RCRI Score: {self.findings['risk']['rcri']['score']} ({', '.join(self.findings['risk']['rcri']['components']) if self.findings['risk']['rcri']['components'] else 'No risk factors'})
- Risk Category: {self.findings['risk']['rcri']['risk_category']}
- Estimated 30-day Risks:
  * Major cardiac event: {self.findings['risk']['cardiac_risk']}%
  * Respiratory complication: {self.findings['risk']['respiratory_risk']}%
  * Acute kidney injury: {self.findings['risk']['aki_risk']}%
  * Mortality: {self.findings['risk']['mortality_risk']}%

**Critical Issues Identified by AI Agent:**
{chr(10).join([f"- {issue['description']} (Priority: {issue['priority']})" for issue in self.identify_critical_issues()[:5]])}

**Literature Searches Performed:** {self.search_count} adaptive PubMed searches

**Drug Interactions Detected:** {len(self.findings.get('interactions', []))}

**Optimization Timeline:**
{optimization_summary}

PATIENT INFORMATION:
{patient_data}

AVAILABLE EVIDENCE (use numbered citations [1], [2], etc.):
{ref_list}

PAPER DETAILS:
{all_context}

Generate a comprehensive pre-operative assessment with these sections:

1. **ASA Physical Status Classification**
   - Assign ASA class (I-V) with detailed justification

2. **Cardiac Risk Assessment**
   - RCRI Score: {self.findings['risk']['rcri']['score']} - explain what this means
   - Estimated cardiac event risk: {self.findings['risk']['cardiac_risk']}%
   - Risk mitigation strategies

3. **Preoperative Optimization Plan** (TIMELINE-BASED)
   - Long-term (>7 days): What should be done now if surgery can be delayed
   - Short-term (1-7 days): Actions in the week before surgery
   - Day of surgery: Medication management, NPO protocols

4. **Anesthetic Recommendations**
   - Preferred technique (general vs regional vs combined) with rationale
   - Drug selection and dosing adjustments
   - Monitoring (standard vs advanced)

5. **Postoperative Planning**
   - Disposition (PACU vs ICU) with justification
   - Pain management strategy
   - Complication monitoring

Use HTML formatting with <h3>, <h4>, <p>, <strong>, <ul>, <li> tags.
Use inline citations [1], [2], [3] throughout.

CRITICAL: Make this assessment SPECIFIC to THIS patient. Reference their exact RCRI score, estimated risks, comorbidities, and medications. This is an agentic AI-powered assessment - show the depth of analysis."""

        try:
            response = openai_client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.1
            ).choices[0].message.content

            return {
                'assessment': response,
                'references': unique_papers,
                'risk_scores': self.findings['risk'],
                'reasoning_trace': self.reasoning_trace,
                'search_count': self.search_count,
                'mode': 'agentic'
            }

        except Exception as e:
            logging.error(f"GPT synthesis error: {str(e)}")
            return None


HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasConsult.ai - AI-Powered Anesthesiology Assistant</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Evidence-based anesthesiology AI consultant combining PubMed research with GPT-4o for hallucination-free, citation-backed clinical answers.">
    <meta name="keywords" content="anesthesiology, anesthesia, medical AI, PubMed, clinical guidelines, evidence-based medicine, GPT-4o, systematic reviews">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gasconsult.ai/">
    <meta property="og:title" content="GasConsult.ai - Evidence-Based Anesthesiology AI">
    <meta property="og:description" content="Get hallucination-free anesthesiology answers backed by PubMed research. GPT-4o + systematic reviews, RCTs, and clinical guidelines.">
    <meta property="og:image" content="https://gasconsult.ai/static/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://gasconsult.ai/">
    <meta property="twitter:title" content="GasConsult.ai - Evidence-Based Anesthesiology AI">
    <meta property="twitter:description" content="Get hallucination-free anesthesiology answers backed by PubMed research.">
    <meta property="twitter:image" content="https://gasconsult.ai/static/logo.png">

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "MedicalWebPage",
      "name": "GasConsult.ai",
      "description": "Evidence-based anesthesiology AI consultant combining PubMed research with GPT-4o",
      "specialty": "Anesthesiology",
      "audience": {
        "@type": "MedicalAudience",
        "audienceType": "Healthcare Professional"
      }
    }
    </script>

    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Skip to Content Link for Accessibility */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--blue-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
            font-weight: 600;
            transition: top 0.2s;
        }

        .skip-to-content:focus {
            top: 0;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .hero {
            padding: 120px 20px 60px;
            text-align: center;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 8px 16px 8px 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) forwards;
            opacity: 0;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--blue-500);
            border-radius: 50%;
            position: relative;
        }

        .badge-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: var(--blue-400);
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .badge-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .hero-title {
            font-size: 40px;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -2px;
            color: var(--gray-900);
            margin-bottom: 20px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.1s forwards;
            opacity: 0;
        }

        .hero-title .gradient { color: var(--blue-600); }

        .hero-subtitle {
            font-size: 16px;
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-500);
            max-width: 560px;
            margin: 0 auto 40px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.2s forwards;
            opacity: 0;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-container {
            max-width: 720px;
            margin: 0 auto 60px;
            padding: 0 16px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.3s forwards;
            opacity: 0;
        }

        .chat-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .chat-card:focus-within {
            box-shadow: 0 0 0 4px rgba(59,130,246,0.1), 0 1px 2px rgba(0,0,0,0.02), 0 8px 24px rgba(37,99,235,0.08), 0 32px 100px rgba(37,99,235,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
            border-color: rgba(59,130,246,0.3);
        }

        .chat-inner {
            background: var(--white);
            border-radius: 14px;
            padding: 3px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,1);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 0 12px;
            font-size: 15px;
            font-family: inherit;
            color: var(--gray-800);
            background: transparent;
            resize: none;
            height: 36px;
            max-height: 110px;
            line-height: 36px;
        }

        .chat-input::placeholder {
            color: var(--gray-400);
            line-height: 36px;
        }

        .chat-send {
            width: 36px;
            height: 36px;
            background: var(--blue-600);
            border: none;
            border-radius: 10px;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(37,99,235,0.2), 0 4px 16px rgba(37,99,235,0.2), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
            flex-shrink: 0;
            margin: 3px;
        }

        .chat-send:hover {
            background: var(--blue-700);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(37,99,235,0.2), 0 12px 40px rgba(37,99,235,0.3), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
        }

        .chat-send:active { transform: translateY(0); }
        .chat-send svg { width: 18px; height: 18px; }

        .chat-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px 8px 6px;
        }

        .hint-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hint-chip:hover {
            background: var(--white);
            border-color: var(--blue-200);
            color: var(--blue-600);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.1);
        }

        .hint-chip svg { width: 14px; height: 14px; opacity: 0.5; }
        .hint-chip:hover svg { opacity: 1; color: var(--blue-500); }

        .features { padding: 60px 20px 80px; }

        .features-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .features-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--blue-600);
            margin-bottom: 12px;
        }

        .features-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
            margin-bottom: 12px;
        }

        .features-subtitle {
            font-size: 16px;
            color: var(--gray-500);
            max-width: 480px;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04);
            cursor: pointer;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.04), 0 24px 64px rgba(0,0,0,0.08);
            border-color: rgba(59,130,246,0.2);
        }

        .feature-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .feature-card:hover .feature-icon { transform: scale(1.05); }
        .feature-icon svg { width: 24px; height: 24px; }

        .feature-icon.blue {
            background: var(--blue-50);
            border: 1px solid var(--blue-100);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.blue svg { color: var(--blue-600); }

        .feature-icon.emerald {
            background: #ECFDF5;
            border: 1px solid #D1FAE5;
            box-shadow: 0 4px 16px rgba(16,185,129,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.emerald svg { color: #059669; }

        .feature-icon.violet {
            background: #F5F3FF;
            border: 1px solid #EDE9FE;
            box-shadow: 0 4px 16px rgba(139,92,246,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.violet svg { color: #7C3AED; }

        .feature-icon.rose {
            background: #FFF1F2;
            border: 1px solid #FFE4E6;
            box-shadow: 0 4px 16px rgba(244,63,94,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.rose svg { color: #E11D48; }

        .feature-icon.cyan {
            background: #ECFEFF;
            border: 1px solid #CFFAFE;
            box-shadow: 0 4px 16px rgba(6,182,212,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.cyan svg { color: #0891B2; }

        .feature-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }

        .feature-desc {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .feature-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--blue-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .feature-link:hover { gap: 10px; }
        .feature-link svg { width: 16px; height: 16px; transition: transform 0.2s ease; }
        .feature-link:hover svg { transform: translateX(4px); }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover { color: var(--gray-700); }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            .hero { padding: 160px 32px 80px; }
            .hero-badge { padding: 10px 20px 10px 14px; margin-bottom: 32px; }
            .badge-dot { width: 10px; height: 10px; }
            .badge-text { font-size: 13px; }
            .hero-title { font-size: 56px; letter-spacing: -2.5px; margin-bottom: 24px; }
            .hero-subtitle { font-size: 18px; margin-bottom: 48px; }
            .chat-container { padding: 0 24px; margin-bottom: 80px; }
            .chat-card { border-radius: 24px; padding: 10px; }
            .chat-inner { border-radius: 16px; padding: 4px; }
            .chat-input { padding: 10px 14px; min-height: 40px; }
            .chat-send { width: 44px; height: 44px; border-radius: 12px; }
            .chat-hints { gap: 10px; padding: 18px 10px 8px; }
            .hint-chip { padding: 12px 18px; font-size: 13px; }
            .hint-chip svg { width: 16px; height: 16px; }
            .features { padding: 80px 32px 100px; }
            .features-header { margin-bottom: 56px; }
            .features-label { font-size: 12px; margin-bottom: 16px; }
            .features-title { font-size: 36px; letter-spacing: -1.5px; }
            .features-subtitle { font-size: 18px; }
            .features-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .feature-card { padding: 36px; border-radius: 24px; }
            .feature-card:hover { transform: translateY(-6px); }
            .feature-icon { width: 60px; height: 60px; border-radius: 18px; margin-bottom: 24px; }
            .feature-icon svg { width: 26px; height: 26px; }
            .feature-title { font-size: 20px; margin-bottom: 12px; }
            .feature-desc { font-size: 15px; line-height: 1.7; margin-bottom: 24px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
            .orb-1 { width: 600px; height: 600px; left: -10%; }
            .orb-2 { width: 450px; height: 450px; right: -10%; }
            .orb-3 { width: 400px; height: 400px; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .hero { padding: 180px 40px 80px; }
            .hero-title { font-size: 72px; letter-spacing: -3px; margin-bottom: 28px; }
            .hero-subtitle { font-size: 20px; margin-bottom: 56px; }
            .chat-container { margin-bottom: 100px; }
            .chat-card { border-radius: 28px; }
            .chat-inner { border-radius: 18px; }
            .chat-input { padding: 12px 16px; min-height: 44px; max-height: 160px; }
            .chat-send { width: 48px; height: 48px; border-radius: 14px; margin: 6px; }
            .chat-send svg { width: 20px; height: 20px; }
            .chat-hints { padding: 20px 12px 8px; }
            .hint-chip { padding: 12px 20px; }
            .features { padding: 80px 40px 120px; }
            .features-header { margin-bottom: 64px; }
            .features-title { font-size: 40px; }
            .features-grid { grid-template-columns: repeat(3, 1fr); gap: 24px; }
            .feature-card { padding: 40px; border-radius: 28px; }
            .feature-card:hover { transform: translateY(-8px); }
            .feature-icon { width: 64px; height: 64px; border-radius: 20px; margin-bottom: 28px; }
            .feature-icon svg { width: 28px; height: 28px; }
            .footer { padding: 48px 40px; }
            .orb-1 { width: 800px; height: 800px; top: -20%; left: -10%; }
            .orb-2 { width: 600px; height: 600px; right: -15%; }
            .orb-3 { width: 500px; height: 500px; }
        }

        @media (min-width: 1280px) {
            .hero-title { font-size: 80px; }
        }

        /* Chat Interface Styles */
        .chat-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 80px;
            min-height: 100vh;
            background: var(--gray-50);
            position: relative;
            z-index: 10;
        }

        .messages-container {
            flex: 1;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 16px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 32px;
            animation: fade-up 0.4s ease;
        }

        /* User Message - Clean, No Bubble Design */
        .user-message {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            width: 100%;
        }

        .user-message .message-bubble {
            background: transparent;
            color: var(--gray-900);
            padding: 0 0 20px 0;
            border-radius: 0;
            max-width: 100%;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: none;
            position: relative;
            width: 100%;
            text-align: right;
        }

        .user-message .message-bubble::before {
            content: 'You';
            display: block;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
            margin-bottom: 8px;
        }

        .user-message .message-bubble::after {
            content: '';
            display: block;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--gray-200) 50%, transparent 100%);
            margin-top: 16px;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* AI Message - Full Width Glass Card, No Bubble */
        .ai-message {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            width: 100%;
        }

        .ai-message .message-bubble {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            padding: 24px;
            border-radius: 12px;
            max-width: 100%;
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-800);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .ai-message .message-bubble h1,
        .ai-message .message-bubble h2,
        .ai-message .message-bubble h3 {
            color: var(--gray-900);
            margin: 16px 0 12px 0;
            font-weight: 700;
        }

        .ai-message .message-bubble h1 { font-size: 20px; }
        .ai-message .message-bubble h2 { font-size: 18px; }
        .ai-message .message-bubble h3 { font-size: 16px; }

        .ai-message .message-bubble ul,
        .ai-message .message-bubble ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .ai-message .message-bubble li {
            margin: 6px 0;
        }

        .ai-message .message-bubble p {
            margin: 12px 0;
        }

        .ai-message .message-bubble strong {
            color: var(--gray-900);
            font-weight: 600;
        }

        .ai-message .message-bubble code {
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        .evidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            cursor: help;
            transition: all 0.2s ease;
        }

        .evidence-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .evidence-badge.high {
            background: #ECFDF5;
            color: #059669;
            border: 1px solid #D1FAE5;
        }

        .evidence-badge.moderate {
            background: #FEF3C7;
            color: #D97706;
            border: 1px solid #FDE68A;
        }

        .evidence-badge.low {
            background: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FECACA;
        }

        .evidence-explanation {
            display: block;
            font-size: 10px;
            opacity: 0.85;
            font-weight: 500;
            margin-top: 2px;
            text-transform: none;
            letter-spacing: 0px;
        }

        /* Evidence Quality Badge - Sleek Modern Design */
        .evidence-quality-badge {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
            border: 1px solid rgba(229, 231, 235, 0.8);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(0, 0, 0, 0.02);
            transition: all 0.2s ease;
        }

        .evidence-quality-badge:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .confidence-level {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
            transition: all 0.2s ease;
        }

        .confidence-level strong {
            font-weight: 700;
            margin-right: 4px;
        }

        .confidence-level.high {
            background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%);
            color: #047857;
            border: 1.5px solid #10B981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.1);
        }

        .confidence-level.moderate {
            background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
            color: #B45309;
            border: 1.5px solid #F59E0B;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.1);
        }

        .confidence-level.low {
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            color: #B91C1C;
            border: 1.5px solid #EF4444;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.1);
        }

        .evidence-details {
            font-size: 12px;
            color: #6B7280;
            line-height: 1.6;
            padding: 4px 0;
            font-weight: 500;
        }

        .evidence-details::before {
            content: '';
            display: inline-block;
            width: 3px;
            height: 3px;
            background: #9CA3AF;
            border-radius: 50%;
            margin: 0 8px 2px 0;
        }

        .references-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .references-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .references-title svg {
            width: 16px;
            height: 16px;
            color: var(--blue-600);
        }

        .reference-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 12px 14px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .reference-item:hover {
            background: var(--blue-50);
            border-color: var(--blue-200);
        }

        .reference-link {
            color: var(--blue-600);
            text-decoration: none;
            font-size: 14px;
            line-height: 1.5;
            font-weight: 500;
            display: block;
        }

        .reference-link:hover {
            text-decoration: underline;
        }

        .reference-meta {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 4px;
        }

        .study-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 6px;
            color: white;
        }

        .reference-header {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 4px;
        }

        .reference-link-container {
            flex: 1;
        }

        .reference-number {
            font-size: 13px;
            font-weight: 700;
            color: var(--blue-600);
            min-width: 32px;
            flex-shrink: 0;
            padding-top: 1px;
        }

        .streaming-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--blue-600);
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }

        .streaming-dots {
            display: flex;
            gap: 4px;
        }

        .streaming-dots span {
            width: 6px;
            height: 6px;
            background: var(--blue-600);
            border-radius: 50%;
            animation: pulse-dot 1.4s ease-in-out infinite;
        }

        .streaming-dots span:nth-child(2) { animation-delay: 0.2s; }
        .streaming-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse-dot {
            0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); }
            40% { opacity: 1; transform: scale(1); }
        }

        /* Skeleton Loader */
        .skeleton-loader {
            padding: 24px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .skeleton-line {
            height: 14px;
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            border-radius: 4px;
            animation: skeleton-pulse 1.5s ease-in-out infinite;
            margin-bottom: 10px;
        }

        .skeleton-line:last-child {
            margin-bottom: 0;
            width: 70%;
        }

        @keyframes skeleton-pulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .progress-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gray-600);
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .progress-indicator .progress-icon {
            width: 14px;
            height: 14px;
            border: 2px solid var(--blue-600);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chat-input-area {
            position: sticky;
            bottom: 0;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            padding: 6px;
            z-index: 10;
        }

        .chat-input-wrapper {
            max-width: 100%;
            margin: 0 auto;
        }

        #chat-form.chat-card {
            margin: 0;
        }

        .new-chat-btn {
            position: fixed;
            top: 84px;
            left: 68px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            height: 40px;
            padding: 0 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--blue-600);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            line-height: 1;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1),
                        0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .new-chat-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(37, 99, 235, 0.2);
            color: var(--blue-700);
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15),
                        0 4px 8px rgba(0, 0, 0, 0.08);
        }

        .new-chat-btn:active {
            transform: translateY(0);
        }

        .new-chat-btn svg {
            width: 15px;
            height: 15px;
            transition: transform 0.3s ease;
        }

        .new-chat-btn:hover svg {
            transform: scale(1.05);
        }

        .new-chat-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
        }

        .error-message {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        @media (min-width: 768px) {
            .new-chat-btn {
                height: 44px;
                left: 72px;
                top: 88px;
                padding: 0 16px;
                font-size: 14px;
            }

            .new-chat-btn svg {
                width: 16px;
                height: 16px;
            }

            .messages-container {
                padding: 32px 24px;
            }

            .message {
                margin-bottom: 40px;
            }

            .user-message .message-bubble {
                padding: 0 0 24px 0;
                font-size: 16px;
            }

            .ai-message .message-bubble {
                padding: 28px 32px;
                font-size: 16px;
                border-radius: 14px;
            }

            .chat-input-area {
                padding: 8px 20px;
            }

            .chat-input-wrapper {
                max-width: 680px;
            }

            .chat-card {
                padding: 5px;
            }

            .chat-input {
                font-size: 15px;
                padding: 0 14px;
                height: 38px;
                line-height: 38px;
            }

            .chat-input::placeholder {
                line-height: 38px;
            }

            .chat-send {
                width: 38px;
                height: 38px;
            }

            .chat-send svg {
                width: 19px;
                height: 19px;
            }
        }

        @media (min-width: 1024px) {
            .messages-container {
                padding: 40px 32px 60px;
            }

            .message {
                margin-bottom: 48px;
            }

            .user-message .message-bubble {
                font-size: 17px;
            }

            .ai-message .message-bubble {
                padding: 32px 36px;
                font-size: 17px;
                border-radius: 16px;
            }

            .chat-input-area {
                padding: 10px 32px;
            }

            .chat-input-wrapper {
                max-width: 640px;
            }

            .chat-card {
                padding: 4px;
                border-radius: 18px;
            }

            .chat-inner {
                border-radius: 13px;
                padding: 2px;
            }

            .chat-input {
                font-size: 14.5px;
                padding: 0 16px;
                height: 40px;
                line-height: 40px;
            }

            .chat-input::placeholder {
                line-height: 40px;
            }

            .chat-send {
                width: 40px;
                height: 40px;
            }

            .chat-send svg {
                width: 19px;
                height: 19px;
            }
        }

        @media (min-width: 1280px) {
            .chat-input-wrapper {
                max-width: 600px;
            }

            .chat-input {
                font-size: 14.5px;
            }
        }

        /* Markdown Content Styling */
        .message-content {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-800);
        }

        .message-content h1 {
            font-size: 24px;
            font-weight: 800;
            color: var(--gray-900);
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--blue-100);
        }

        .message-content h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 20px 0 12px 0;
        }

        .message-content h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--gray-900);
            margin: 16px 0 10px 0;
        }

        .message-content h4 {
            font-size: 15px;
            font-weight: 700;
            color: var(--gray-800);
            margin: 14px 0 8px 0;
        }

        .message-content p {
            margin: 12px 0;
            line-height: 1.7;
        }

        .message-content ul,
        .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 6px 0;
            line-height: 1.6;
        }

        .message-content ul li {
            list-style-type: disc;
        }

        .message-content ol li {
            list-style-type: decimal;
        }

        .message-content ul ul,
        .message-content ol ul,
        .message-content ul ol,
        .message-content ol ol {
            margin: 4px 0;
        }

        .message-content strong {
            font-weight: 700;
            color: var(--gray-900);
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: var(--gray-100);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: #E11D48;
        }

        .message-content pre {
            background: var(--gray-900);
            color: var(--gray-50);
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: var(--gray-50);
            border-radius: 0;
        }

        .message-content blockquote {
            border-left: 4px solid var(--blue-500);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--gray-700);
            font-style: italic;
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--gray-200);
            margin: 24px 0;
        }

        .message-content a {
            color: var(--blue-600);
            text-decoration: none;
            border-bottom: 1px solid var(--blue-200);
            transition: all 0.2s ease;
        }

        .message-content a:hover {
            color: var(--blue-700);
            border-bottom-color: var(--blue-500);
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }

        .message-content th,
        .message-content td {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid var(--gray-200);
        }

        .message-content th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-900);
        }

        .message-content tr:nth-child(even) {
            background: var(--gray-50);
        }

        /* First paragraph no top margin */
        .message-content > p:first-child,
        .message-content > h1:first-child,
        .message-content > h2:first-child,
        .message-content > h3:first-child {
            margin-top: 0;
        }

        /* Last element no bottom margin */
        .message-content > *:last-child {
            margin-bottom: 0;
        }

        /* Save to Library Button */
        .save-to-library-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            background: var(--white);
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-to-library-btn:hover {
            color: var(--blue-600);
            background: var(--blue-50);
            border-color: var(--blue-300);
            transform: translateY(-1px);
        }

        .save-to-library-btn.saved {
            color: var(--blue-600);
            background: var(--blue-50);
            border-color: var(--blue-300);
        }

        .save-to-library-btn.saved svg {
            fill: var(--blue-600);
        }

        /* ====== Toast Notifications ====== */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .toast-notification {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 10000;
            background: var(--white);
            color: var(--gray-900);
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            font-weight: 500;
            max-width: 350px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--gray-200);
        }

        .toast-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast-notification.toast-success {
            border-left: 4px solid #10B981;
            background: linear-gradient(to right, rgba(16, 185, 129, 0.05), var(--white));
        }

        .toast-notification.toast-error {
            border-left: 4px solid #EF4444;
            background: linear-gradient(to right, rgba(239, 68, 68, 0.05), var(--white));
        }

        .toast-notification.toast-info {
            border-left: 4px solid var(--blue-500);
            background: linear-gradient(to right, rgba(59, 130, 246, 0.05), var(--white));
        }

        /* ====== Chat History Sidebar (Phase 4 - Glassmorphism) ====== */
        .history-toggle {
            position: fixed;
            top: 84px;
            left: 16px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1),
                        0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-toggle:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15),
                        0 4px 8px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
            border-color: rgba(37, 99, 235, 0.2);
        }

        .history-toggle:active {
            transform: translateY(0);
        }

        .history-toggle svg {
            width: 20px;
            height: 20px;
            color: var(--blue-600);
            transition: transform 0.3s ease;
        }

        .history-toggle:hover svg {
            transform: scale(1.1);
        }

        /* Hide toggle button when sidebar is open */
        .history-toggle.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-20px);
        }

        .history-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 360px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.08);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .history-sidebar.open {
            transform: translateX(0);
        }

        .history-sidebar-header {
            padding: 20px 16px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(248, 250, 252, 0.5);
            backdrop-filter: blur(8px);
        }

        .history-sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            letter-spacing: -0.01em;
        }

        .history-close-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(226, 232, 240, 0.6);
            border-radius: 8px;
            cursor: pointer;
            padding: 6px;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .history-close-btn:hover {
            background: rgba(248, 250, 252, 1);
            color: var(--gray-900);
            border-color: var(--gray-300);
            transform: rotate(90deg);
        }

        .history-close-btn svg {
            width: 16px;
            height: 16px;
        }

        .history-conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            scrollbar-width: thin;
            scrollbar-color: rgba(203, 213, 225, 0.5) transparent;
        }

        .history-conversations-list::-webkit-scrollbar {
            width: 6px;
        }

        .history-conversations-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .history-conversations-list::-webkit-scrollbar-thumb {
            background: rgba(203, 213, 225, 0.5);
            border-radius: 3px;
        }

        .history-conversations-list::-webkit-scrollbar-thumb:hover {
            background: rgba(203, 213, 225, 0.7);
        }

        .history-conversation-item {
            padding: 14px 12px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(226, 232, 240, 0.4);
            position: relative;
            overflow: hidden;
        }

        .history-conversation-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, var(--blue-500), var(--blue-600));
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        .history-conversation-item:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(37, 99, 235, 0.3);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.08);
        }

        .history-conversation-item:hover::before {
            opacity: 1;
        }

        .history-conversation-item.active {
            background: rgba(239, 246, 255, 0.8);
            border-color: rgba(37, 99, 235, 0.4);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .history-conversation-item.active::before {
            opacity: 1;
        }

        .history-conversation-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-900);
            margin-bottom: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            line-height: 1.4;
            letter-spacing: -0.01em;
        }

        .history-conversation-meta {
            font-size: 11px;
            color: var(--gray-500);
            display: flex;
            gap: 8px;
            align-items: center;
            font-weight: 400;
        }

        .history-conversation-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-empty-state {
            padding: 60px 24px;
            text-align: center;
            color: var(--gray-500);
        }

        .history-empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.4;
        }

        .history-empty-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 6px;
        }

        .history-empty-subtext {
            font-size: 12px;
            color: var(--gray-400);
            line-height: 1.5;
        }

        .history-loading {
            padding: 60px 24px;
            text-align: center;
            color: var(--gray-500);
            font-size: 13px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .history-loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(37, 99, 235, 0.1);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .history-sidebar-footer {
            margin-top: auto;
            padding: 16px;
            border-top: 1px solid rgba(226, 232, 240, 0.6);
            background: rgba(248, 250, 252, 0.5);
            backdrop-filter: blur(8px);
        }

        .clear-history-btn {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-radius: 10px;
            color: var(--gray-700);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .clear-history-btn:hover {
            background: rgba(255, 255, 255, 1);
            border-color: var(--gray-300);
            color: var(--gray-900);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .clear-history-btn:active {
            transform: scale(0.98);
        }

        .clear-history-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Overlay when sidebar is open */
        .history-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(2px);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .history-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        /* Mobile-first responsive design */
        @media (min-width: 480px) {
            .history-sidebar {
                max-width: 380px;
            }
        }

        @media (min-width: 768px) {
            .history-toggle {
                top: 88px;
                left: 20px;
                width: 44px;
                height: 44px;
            }

            .history-toggle svg {
                width: 22px;
                height: 22px;
            }

            .history-sidebar {
                max-width: 400px;
            }

            .history-sidebar-header {
                padding: 24px 20px;
            }

            .history-sidebar-title {
                font-size: 17px;
            }

            .history-conversations-list {
                padding: 16px;
            }

            .history-conversation-item {
                padding: 16px 14px;
                margin-bottom: 8px;
            }

            .history-conversation-title {
                font-size: 14px;
            }

            .history-conversation-meta {
                font-size: 12px;
            }
        }

    </style>

    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- [PHASE 4] Chat History Sidebar - Glassmorphism Design -->
    <button class="history-toggle" id="historyToggle" aria-label="Toggle chat history" title="Chat History">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z" />
        </svg>
    </button>

    <div class="history-overlay" id="historyOverlay"></div>

    <aside class="history-sidebar" id="historySidebar" role="complementary" aria-label="Chat history">
        <div class="history-sidebar-header">
            <h2 class="history-sidebar-title">History</h2>
            <button class="history-close-btn" id="historyClose" aria-label="Close history">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="history-conversations-list" id="conversationsList">
            <div class="history-loading">
                <div class="history-loading-spinner"></div>
                <span>Loading...</span>
            </div>
        </div>
        <div class="history-sidebar-footer">
            <button class="clear-history-btn" id="clearHistoryBtn" aria-label="Clear all chat history">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Clear All History
            </button>
        </div>
    </aside>

    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Verification Banner for Unverified Users -->
    {{ generate_verification_banner_html()|safe }}

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link active">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        {% if messages and messages|length > 0 %}
        <!-- Chat Interface -->
        <section class="chat-view" id="main-content">
            <div class="messages-container" id="messagesContainer" role="log" aria-live="polite" aria-label="Conversation history">
                {% if error_message %}
                <div class="error-message" role="alert">{{ error_message|safe }}</div>
                {% endif %}

                {% for message in messages %}
                    {% if message.content and message.content.strip() %}
                    {% if message.role == 'user' %}
                    <div class="message user-message">
                        <div class="message-bubble">{{ message.content }}</div>
                    </div>
                    {% else %}
                    <div class="message ai-message">
                        <div class="message-bubble">
                            {% if message.get('evidence_strength') %}
                            {% set level = message.evidence_strength.level if message.evidence_strength is mapping else message.evidence_strength %}
                            {% set breakdown = message.evidence_strength.breakdown if message.evidence_strength is mapping else {} %}
                            {% set description = message.evidence_strength.description if message.evidence_strength is mapping else '' %}
                            <div class="evidence-badge {{ 'high' if level == 'High' else ('moderate' if level == 'Moderate' else 'low') }}"
                                 title="Evidence Quality: {{ level }} - {{ description }}">
                                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                                    <div>
                                        {% if level == 'High' %}
                                        ✓ High Confidence
                                        {% elif level == 'Moderate' %}
                                        ~ Moderate Confidence
                                        {% else %}
                                        ! Low Confidence
                                        {% endif %}
                                        • {{ message.num_papers }} studies
                                    </div>
                                    <div class="evidence-explanation">
                                        {{ description if description else ('Strong evidence from meta-analyses, RCTs, or systematic reviews' if level == 'High' else ('Moderate evidence - consider individual patient factors' if level == 'Moderate' else 'Limited evidence - use caution and clinical judgment')) }}
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <div class="message-content">{{ message.content|safe }}</div>

                            {% if message.references and message.references|length > 0 %}
                            <div class="references-section">
                                <div class="references-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                    </svg>
                                    References ({{ message.references|length }})
                                </div>
                                {% for ref in message.references %}
                                <div class="reference-item">
                                    <div class="reference-header">
                                        <div class="reference-number">[{{ loop.index }}]</div>
                                        <div class="reference-link-container">
                                            <a href="https://pubmed.ncbi.nlm.nih.gov/{{ ref.pmid }}/" target="_blank" rel="noopener noreferrer" class="reference-link">
                                                {{ ref.title }}
                                            </a>
                                            <div class="reference-meta">
                                                {{ ref.authors }} - {{ ref.journal }}, {{ ref.year }}
                                            </div>
                                            {% if ref.get('study_badge') and ref.get('study_color') %}
                                            <span class="study-type-badge" style="background-color: {{ ref.study_color }};">
                                                {{ ref.study_badge }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if current_user.is_authenticated %}
                            <div class="message-actions" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200); display: flex; gap: 8px;">
                                <button class="save-to-library-btn" onclick="saveToLibrary(event, {{ loop.index0 }})" title="Save to My Library">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                        <path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                    </svg>
                                    Save to Library
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                {% endfor %}

                {% if pending_stream %}
                <div class="message ai-message" id="streamingMessage">
                    <div class="message-bubble">
                        <div id="streamingEvidenceBadge" style="display: none;"></div>
                        <div id="skeletonLoader" class="skeleton-loader">
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                        </div>
                        <div class="message-content" id="streamingContent" style="display: none;"></div>
                        <div class="streaming-indicator">
                            <div class="streaming-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            <span id="progressText">Searching PubMed...</span>
                        </div>
                        <div class="references-section" id="streamingReferences" style="display: none;"></div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- New Chat Button (fixed position top-right) -->
            <a href="/clear" class="new-chat-btn" aria-label="Start a new chat conversation">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    <line x1="9" y1="10" x2="15" y2="10"></line>
                    <line x1="12" y1="7" x2="12" y2="13"></line>
                </svg>
                New Chat
            </a>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <form method="post" action="/" id="chat-form" class="chat-card" role="form" aria-label="Follow-up question form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="chat-inner">
                            <textarea name="query"
                                      id="chat-query-input"
                                      class="chat-input"
                                      placeholder="Ask a follow-up question..."
                                      rows="1"
                                      required
                                      aria-label="Ask a follow-up question"></textarea>
                            <button type="submit" class="chat-send" aria-label="Submit follow-up question">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                                    <line x1="12" y1="19" x2="12" y2="5"></line>
                                    <polyline points="5 12 12 5 19 12"></polyline>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        {% else %}
        <!-- Homepage Hero -->
        <section class="hero" id="main-content">
            <div class="hero-badge">
                <span class="badge-dot"></span>
                <span class="badge-text">PubMed-Powered AI</span>
            </div>
            <h1 class="hero-title">The AI copilot for<br><span class="gradient">anesthesiology</span></h1>
            <p class="hero-subtitle">Smart clinical decision support for the entire perioperative journey - evidence-based, instant, and comprehensive.</p>

            <div class="chat-container">
                <form method="post" action="/" class="chat-card" role="search" aria-label="Ask anesthesiology question">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="chat-inner">
                        <textarea name="query"
                                  id="query-input"
                                  class="chat-input"
                                  placeholder="Ask anything about anesthesiology..."
                                  rows="1"
                                  required
                                  aria-label="Ask your anesthesiology question"
                                  aria-describedby="search-hint"></textarea>
                        <button type="submit" class="chat-send" aria-label="Submit question">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
                                <line x1="12" y1="19" x2="12" y2="5"></line>
                                <polyline points="5 12 12 5 19 12"></polyline>
                            </svg>
                        </button>
                    </div>
                    <div class="chat-hints">
                        <div class="hint-chip" onclick="fillQuery(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                            Pre-op cardiac risk
                        </div>
                        <div class="hint-chip" onclick="fillQuery(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                            Sugammadex dosing
                        </div>
                        <div class="hint-chip" onclick="fillQuery(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                            MH protocol
                        </div>
                        <div class="hint-chip" onclick="fillQuery(event)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                            RSI checklist
                        </div>
                    </div>
                </form>
            </div>
        </section>
        {% endif %}

        {% if not messages or messages|length == 0 %}
        <section class="features">
            <div class="features-header">
                <div class="features-label">Features</div>
                <h2 class="features-title">Everything you need at the bedside</h2>
                <p class="features-subtitle">Clinical tools powered by the latest evidence.</p>
            </div>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                    </div>
                    <h3 class="feature-title">AI Clinical Chat</h3>
                    <p class="feature-desc">Ask complex clinical questions and get evidence-based answers with PubMed citations in seconds.</p>
                    <a href="/" class="feature-link">Try it now <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon emerald">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                    <h3 class="feature-title">Quick Dose Calculator</h3>
                    <p class="feature-desc">Weight-based dosing for all common anesthesia drugs with color-coded syringe labels.</p>
                    <a href="/quick-dose" class="feature-link">Calculate doses <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon violet">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M9 14l2 2 4-4"></path></svg>
                    </div>
                    <h3 class="feature-title">Pre-Op Assessment</h3>
                    <p class="feature-desc">Structured pre-operative evaluation with automatic risk scoring and recommendations.</p>
                    <a href="/preop" class="feature-link">Start assessment <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon rose">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"></polygon><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
                    </div>
                    <h3 class="feature-title">Crisis Protocols</h3>
                    <p class="feature-desc">One-tap access to emergency protocols for MH, LAST, anaphylaxis, and more.</p>
                    <a href="/crisis" class="feature-link">View protocols <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></a>
                </div>
                <div class="feature-card">
                    <div class="feature-icon cyan">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path><line x1="8" y1="7" x2="16" y2="7"></line><line x1="8" y1="11" x2="16" y2="11"></line></svg>
                    </div>
                    <h3 class="feature-title">PubMed Integration</h3>
                    <p class="feature-desc">Every answer is backed by real citations from peer-reviewed medical literature.</p>
                    <a href="/evidence" class="feature-link">Learn more <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></a>
                </div>
            </div>
        </section>
        {% endif %}

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Auto-resize textarea on input
        const textareas = document.querySelectorAll('.chat-input');
        textareas.forEach(textarea => {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 180) + 'px';
            });

            // Enter to submit (Shift+Enter for new line, Cmd/Ctrl+Enter also works)
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const form = this.closest('form');
                    if (form) {
                        form.requestSubmit();
                    }
                }
            });
        });

        // Fill query from hint chips (homepage only)
        function fillQuery(event) {
            const chip = event.currentTarget;
            const text = chip.textContent.trim();
            const textarea = document.querySelector('.chat-input');
            if (textarea) {
                textarea.value = text;
                textarea.focus();
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const menu = e.target.nextElementSibling;
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('show'));
        });

        // Disable browser's automatic scroll restoration to prevent scrolling to top on page reload
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        // Scroll to bottom of messages (with smooth behavior and forced reflow)
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            if (container) {
                // Force a reflow to ensure height is calculated correctly
                void container.offsetHeight;
                // Use requestAnimationFrame to ensure scroll happens after DOM updates
                requestAnimationFrame(() => {
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        // Set up MutationObserver to auto-scroll when new content is added
        const messagesContainer = document.getElementById('messagesContainer');
        if (messagesContainer) {
            const observer = new MutationObserver(function() {
                // Only auto-scroll if user is near the bottom (within 200px)
                // This prevents annoying scrolling if user is reading earlier messages
                const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 200;
                if (isNearBottom) {
                    scrollToBottom();
                }
            });

            observer.observe(messagesContainer, {
                childList: true,
                subtree: true,
                characterData: true
            });
        }

        // SSE Streaming functionality
        {% if pending_stream %}
        (function() {
            const requestId = '{{ pending_stream }}';
            const streamingContent = document.getElementById('streamingContent');
            const streamingReferences = document.getElementById('streamingReferences');
            const streamingIndicator = document.querySelector('.streaming-indicator');
            const streamingMessage = document.getElementById('streamingMessage');

            if (!streamingContent) {
                console.error('[SSE] Streaming elements not found');
                return;
            }

            console.log('[SSE] Starting stream for request_id:', requestId);

            // CRITICAL: Scroll to bottom immediately when streaming starts
            // This ensures user sees the "Thinking..." indicator right away
            // Use multiple delayed scrolls to handle late-rendering content
            scrollToBottom();
            setTimeout(scrollToBottom, 50);
            setTimeout(scrollToBottom, 100);
            setTimeout(scrollToBottom, 200);

            const eventSource = new EventSource('/stream?request_id=' + encodeURIComponent(requestId));
            let accumulatedMarkdown = ''; // Accumulate markdown during streaming

            // Smart auto-scroll: Keep scrolling during streaming ONLY if user is near bottom
            // This runs every 100ms but respects if user has scrolled up to read earlier messages
            const scrollInterval = setInterval(function() {
                const container = document.getElementById('messagesContainer');
                if (container) {
                    // Only auto-scroll if user is near the bottom (within 200px) or at the very top (just loaded)
                    const isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 200;
                    const isAtTop = container.scrollTop < 100;
                    if (isNearBottom || isAtTop) {
                        scrollToBottom();
                    }
                }
            }, 100);

            eventSource.addEventListener('message', function(e) {
                try {
                    const event = JSON.parse(e.data);

                    if (event.type === 'connected') {
                        // Initial connection established - scroll to show we're ready
                        const progressText = document.getElementById('progressText');
                        if (progressText) progressText.textContent = 'Analyzing evidence...';
                        scrollToBottom();
                    } else if (event.type === 'content') {
                        // Stream content chunks
                        if (event.data) {
                            // Hide skeleton loader and show content on first chunk
                            const skeletonLoader = document.getElementById('skeletonLoader');
                            if (skeletonLoader && skeletonLoader.style.display !== 'none') {
                                skeletonLoader.style.display = 'none';
                                const progressText = document.getElementById('progressText');
                                if (progressText) progressText.textContent = 'Streaming answer...';
                            }
                            // Show content div on first content chunk
                            if (streamingContent.style.display === 'none') {
                                streamingContent.style.display = 'block';
                            }
                            accumulatedMarkdown += event.data;
                            // Parse and show formatted markdown in real-time
                            if (typeof marked !== 'undefined') {
                                streamingContent.innerHTML = marked.parse(accumulatedMarkdown);
                            } else {
                                streamingContent.textContent = accumulatedMarkdown;
                            }
                            // Scroll after each content chunk to keep new text visible
                            scrollToBottom();
                        }
                    } else if (event.type === 'references') {
                        // Markdown already parsed in real-time, no need to parse again
                        // (keeping this for backwards compatibility if needed)
                        if (!streamingContent.innerHTML && accumulatedMarkdown && typeof marked !== 'undefined') {
                            streamingContent.innerHTML = marked.parse(accumulatedMarkdown);
                        }

                        // Display evidence badge
                        if (event.evidence_strength) {
                            const evidenceBadge = document.getElementById('streamingEvidenceBadge');
                            if (evidenceBadge) {
                                const strength = event.evidence_strength;
                                const level = strength.level || 'Low';
                                const description = strength.description || '';
                                const numPapers = event.num_papers || 0;

                                // Determine CSS class
                                const badgeClass = level === 'High' ? 'high' : (level === 'Moderate' ? 'moderate' : 'low');

                                // Determine icon
                                const icon = level === 'High' ? '✓' : (level === 'Moderate' ? '~' : '!');

                                // Build badge HTML
                                let badgeHTML = '<div class="evidence-badge ' + badgeClass + '" ';
                                badgeHTML += 'title="Evidence Quality: ' + level + ' - ' + description + '">';
                                badgeHTML += '<div style="display: flex; flex-direction: column; align-items: flex-start;">';
                                badgeHTML += '<div>' + icon + ' ' + level + ' Confidence • ' + numPapers + ' studies</div>';
                                badgeHTML += '<div class="evidence-explanation">' + description + '</div>';
                                badgeHTML += '</div></div>';

                                evidenceBadge.innerHTML = badgeHTML;
                                evidenceBadge.style.display = 'block';
                            }
                        }

                        // Display references
                        if (event.data && event.data.length > 0) {
                            console.log('[SSE] Received', event.data.length, 'references');

                            // Hide streaming indicator
                            if (streamingIndicator) {
                                streamingIndicator.style.display = 'none';
                            }

                            // Build references HTML
                            let refsHTML = '<div class="references-title">';
                            refsHTML += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">';
                            refsHTML += '<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>';
                            refsHTML += '<path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>';
                            refsHTML += '</svg>';
                            refsHTML += 'References (' + event.data.length + ')';
                            refsHTML += '</div>';

                            event.data.forEach(function(ref, index) {
                                refsHTML += '<div class="reference-item">';
                                refsHTML += '<div class="reference-header">';
                                refsHTML += '<div class="reference-number">[' + (index + 1) + ']</div>';
                                refsHTML += '<div class="reference-link-container">';
                                refsHTML += '<a href="https://pubmed.ncbi.nlm.nih.gov/' + ref.pmid + '/" target="_blank" rel="noopener noreferrer" class="reference-link">';
                                refsHTML += ref.title;
                                refsHTML += '</a>';
                                refsHTML += '<div class="reference-meta">';
                                refsHTML += ref.authors + ' - ' + ref.journal + ', ' + ref.year;
                                refsHTML += '</div>';
                                // Add study type badge if available
                                if (ref.study_badge && ref.study_color) {
                                    refsHTML += '<span class="study-type-badge" style="background-color: ' + ref.study_color + ';">';
                                    refsHTML += ref.study_badge;
                                    refsHTML += '</span>';
                                }
                                refsHTML += '</div></div>';
                                refsHTML += '</div>';
                            });

                            streamingReferences.innerHTML = refsHTML;
                            streamingReferences.style.display = 'block';
                            scrollToBottom();
                        }
                    } else if (event.type === 'done') {
                        console.log('[SSE] Stream complete');

                        // Hide streaming indicator
                        if (streamingIndicator) {
                            streamingIndicator.style.display = 'none';
                        }

                        // Stop the aggressive auto-scroll interval
                        clearInterval(scrollInterval);

                        eventSource.close();
                        scrollToBottom();
                    } else if (event.type === 'error') {
                        console.error('[SSE] Server error:', event.message);

                        if (streamingIndicator) {
                            streamingIndicator.innerHTML = '<span style="color: #DC2626;">Error: ' + (event.message || 'Unknown error') + '</span>';
                        }

                        // Stop the aggressive auto-scroll interval
                        clearInterval(scrollInterval);

                        eventSource.close();
                    }
                } catch (err) {
                    console.error('[SSE] Error parsing message:', err);
                }
            });

            eventSource.addEventListener('error', function(e) {
                console.error('[SSE] Connection error:', e);

                if (streamingIndicator) {
                    streamingIndicator.innerHTML = '<span style="color: #DC2626;">Connection error - please refresh and try again</span>';
                }

                // Stop the aggressive auto-scroll interval
                clearInterval(scrollInterval);

                eventSource.close();
            });

            // Scroll to bottom on page load
            setTimeout(scrollToBottom, 100);
        })();
        {% endif %}

        // Parse markdown in existing messages on page load
        // IMPORTANT: Only parse if content is plain text/markdown, not already HTML
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof marked !== 'undefined') {
                // Find all message-content divs that contain markdown
                const messageContents = document.querySelectorAll('.ai-message .message-content');
                messageContents.forEach(function(element) {
                    // Check if content is already HTML (from session) or plain text/markdown
                    const html = element.innerHTML.trim();

                    // Skip if already contains HTML tags (loaded from session)
                    // Messages from session already have HTML, don't re-parse!
                    if (html.includes('<h') || html.includes('<p') || html.includes('<ul') || html.includes('<strong')) {
                        return;  // Already HTML, skip parsing
                    }

                    // Get the text content (markdown) for plain text messages
                    const markdownText = element.textContent;
                    if (markdownText && markdownText.trim()) {
                        element.innerHTML = marked.parse(markdownText);
                    }
                });
            }
        });

        // Auto-scroll to bottom on page load (for chat view)
        {% if messages and messages|length > 0 %}
        // Use multiple delayed scrolls to override browser's default scroll restoration
        // The browser often scrolls to top AFTER our immediate scroll, so we need delays
        setTimeout(scrollToBottom, 0);    // Next tick
        setTimeout(scrollToBottom, 10);   // Early
        setTimeout(scrollToBottom, 50);   // After browser scroll restoration
        setTimeout(scrollToBottom, 100);  // Safety net
        setTimeout(scrollToBottom, 200);  // Final safety net

        // Scroll when DOM is fully ready
        window.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
            setTimeout(scrollToBottom, 50);
        });

        // Scroll again after everything loads (images, etc)
        window.addEventListener('load', function() {
            scrollToBottom();
            setTimeout(scrollToBottom, 50);
        });
        {% endif %}

        // ====== Save to Library Function ======
        async function saveToLibrary(event, messageIndex) {
            const button = event.target.closest('.save-to-library-btn');

            // Prevent double-clicking
            if (button.disabled) return;
            button.disabled = true;

            const originalHTML = button.innerHTML;
            button.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle></svg> Saving...';

            try {
                const response = await fetch('/save-to-library', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ message_index: messageIndex })
                });

                const data = await response.json();

                if (data.success) {
                    button.classList.add('saved');
                    button.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><path d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg> Saved to Library';

                    // Show success message
                    if (!data.already_saved) {
                        showToast('Saved to library successfully!', 'success');
                    } else {
                        showToast('Already saved to library', 'info');
                    }
                } else {
                    throw new Error(data.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving to library:', error);
                button.innerHTML = originalHTML;
                button.disabled = false;
                showToast(error.message || 'Failed to save to library', 'error');
            }
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Remove any existing toasts
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = 'toast-notification toast-' + type;
            toast.textContent = message;

            // Add to body
            document.body.appendChild(toast);

            // Show toast with animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ====== Chat History Sidebar JavaScript (Phase 4) ======
        (function() {
            const historyToggle = document.getElementById('historyToggle');
            const historySidebar = document.getElementById('historySidebar');
            const historyClose = document.getElementById('historyClose');
            const historyOverlay = document.getElementById('historyOverlay');
            const conversationsList = document.getElementById('conversationsList');
            const newChatBtn = document.querySelector('.new-chat-btn');

            let conversationsLoaded = false;

            // Toggle sidebar
            function openSidebar() {
                historySidebar.classList.add('open');
                historyOverlay.classList.add('visible');
                historyToggle.classList.add('hidden');
                if (newChatBtn) newChatBtn.classList.add('hidden');

                // Load conversations on first open
                if (!conversationsLoaded) {
                    loadConversations();
                }
            }

            function closeSidebar() {
                historySidebar.classList.remove('open');
                historyOverlay.classList.remove('visible');
                historyToggle.classList.remove('hidden');
                if (newChatBtn) newChatBtn.classList.remove('hidden');
            }

            // Load conversations from API
            function loadConversations() {
                conversationsList.innerHTML = `
                    <div class="history-loading">
                        <div class="history-loading-spinner"></div>
                        <span>Loading...</span>
                    </div>
                `;

                fetch('/api/conversations')
                    .then(response => response.json())
                    .then(data => {
                        conversationsLoaded = true;

                        if (!data.enabled) {
                            conversationsList.innerHTML = `
                                <div class="history-empty-state">
                                    <svg class="history-empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                    </svg>
                                    <p class="history-empty-text">History Disabled</p>
                                    <p class="history-empty-subtext">Enable in settings to track conversations</p>
                                </div>
                            `;
                            return;
                        }

                        if (data.conversations.length === 0) {
                            conversationsList.innerHTML = `
                                <div class="history-empty-state">
                                    <svg class="history-empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                    </svg>
                                    <p class="history-empty-text">No conversations yet</p>
                                    <p class="history-empty-subtext">Start a conversation to build your history</p>
                                </div>
                            `;
                            return;
                        }

                        // Render conversations
                        const currentConvId = data.current_conversation_id;
                        const html = data.conversations.map(conv => {
                            const isActive = conv.id === currentConvId;
                            const date = new Date(conv.updated_at);
                            const dateStr = date.toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit'
                            });

                            return `
                                <div class="history-conversation-item ${isActive ? 'active' : ''}"
                                     data-conversation-id="${conv.id}"
                                     onclick="loadConversation('${conv.id}')">
                                    <div class="history-conversation-title">${escapeHtml(conv.title)}</div>
                                    <div class="history-conversation-meta">
                                        <span>${conv.message_count} messages</span>
                                        <span>${dateStr}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');

                        conversationsList.innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Failed to load conversations:', error);
                        conversationsList.innerHTML = `
                            <div class="history-empty-state">
                                <svg class="history-empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                                <p class="history-empty-text">Failed to load</p>
                                <p class="history-empty-subtext">Please try again later</p>
                            </div>
                        `;
                    });
            }

            // Load a specific conversation
            window.loadConversation = function(conversationId) {
                // Show loading state
                const items = document.querySelectorAll('.history-conversation-item');
                items.forEach(item => {
                    if (item.dataset.conversationId === conversationId) {
                        item.style.opacity = '0.5';
                        item.style.pointerEvents = 'none';
                    }
                });

                // Navigate to load-conversation endpoint
                window.location.href = '/load-conversation/' + conversationId;
            };

            // Helper function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Event listeners
            if (historyToggle) {
                historyToggle.addEventListener('click', openSidebar);
            }

            if (historyClose) {
                historyClose.addEventListener('click', closeSidebar);
            }

            if (historyOverlay) {
                historyOverlay.addEventListener('click', closeSidebar);
            }

            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && historySidebar.classList.contains('open')) {
                    closeSidebar();
                }
            });

            // Clear history button
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            if (clearHistoryBtn) {
                clearHistoryBtn.addEventListener('click', async function() {
                    // Confirm before clearing
                    if (!confirm('Are you sure you want to clear all chat history? This cannot be undone.')) {
                        return;
                    }

                    try {
                        // Disable button during request
                        clearHistoryBtn.disabled = true;
                        clearHistoryBtn.innerHTML = '<div class="history-loading-spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></div> Clearing...';

                        const response = await fetch('/clear-history', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token() }}'
                            }
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            // Clear the conversations list
                            conversationsList.innerHTML = `
                                <div class="history-empty-state">
                                    <svg class="history-empty-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z" />
                                    </svg>
                                    <div class="history-empty-text">All history cleared</div>
                                    <div class="history-empty-subtext">Your conversations have been deleted</div>
                                </div>
                            `;

                            // Redirect to home after a short delay
                            setTimeout(() => {
                                window.location.href = '/?clear=1';
                            }, 1500);
                        } else {
                            alert('Failed to clear history: ' + (data.error || 'Unknown error'));
                            // Re-enable button
                            clearHistoryBtn.disabled = false;
                            clearHistoryBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> Clear All History';
                        }
                    } catch (error) {
                        console.error('Error clearing history:', error);
                        alert('Failed to clear history. Please try again.');
                        // Re-enable button
                        clearHistoryBtn.disabled = false;
                        clearHistoryBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> Clear All History';
                    }
                });
            }
        })();
    </script>
</body>
</html>

"""


LIBRARY_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library - gasconsult.ai</title>

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Library Page Styles - Fixed navbar active state issues */
        /* This CSS ensures only dropdown links show as active, not the parent toggles */

        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Skip to Content Link for Accessibility */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--blue-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
            font-weight: 600;
            transition: top 0.2s;
        }

        .skip-to-content:focus {
            top: 0;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .hero {
            padding: 120px 20px 60px;
            text-align: center;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 8px 16px 8px 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) forwards;
            opacity: 0;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--blue-500);
            border-radius: 50%;
            position: relative;
        }

        .badge-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: var(--blue-400);
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .badge-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .hero-title {
            font-size: 40px;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -2px;
            color: var(--gray-900);
            margin-bottom: 20px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.1s forwards;
            opacity: 0;
        }

        .hero-title .gradient { color: var(--blue-600); }

        .hero-subtitle {
            font-size: 16px;
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-500);
            max-width: 560px;
            margin: 0 auto 40px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.2s forwards;
            opacity: 0;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-container {
            max-width: 720px;
            margin: 0 auto 60px;
            padding: 0 16px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.3s forwards;
            opacity: 0;
        }

        .chat-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .chat-card:focus-within {
            box-shadow: 0 0 0 4px rgba(59,130,246,0.1), 0 1px 2px rgba(0,0,0,0.02), 0 8px 24px rgba(37,99,235,0.08), 0 32px 100px rgba(37,99,235,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
            border-color: rgba(59,130,246,0.3);
        }

        .chat-inner {
            background: var(--white);
            border-radius: 14px;
            padding: 3px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,1);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 0 12px;
            font-size: 15px;
            font-family: inherit;
            color: var(--gray-800);
            background: transparent;
            resize: none;
            height: 36px;
            max-height: 110px;
            line-height: 36px;
        }

        .chat-input::placeholder {
            color: var(--gray-400);
            line-height: 36px;
        }

        .chat-send {
            width: 36px;
            height: 36px;
            background: var(--blue-600);
            border: none;
            border-radius: 10px;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(37,99,235,0.2), 0 4px 16px rgba(37,99,235,0.2), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
            flex-shrink: 0;
            margin: 3px;
        }

        .chat-send:hover {
            background: var(--blue-700);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(37,99,235,0.2), 0 12px 40px rgba(37,99,235,0.3), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
        }

        .chat-send:active { transform: translateY(0); }
        .chat-send svg { width: 18px; height: 18px; }

        .chat-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px 8px 6px;
        }

        .hint-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hint-chip:hover {
            background: var(--white);
            border-color: var(--blue-200);
            color: var(--blue-600);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.1);
        }

        .hint-chip svg { width: 14px; height: 14px; opacity: 0.5; }
        .hint-chip:hover svg { opacity: 1; color: var(--blue-500); }

        .features { padding: 60px 20px 80px; }

        .features-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .features-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--blue-600);
            margin-bottom: 12px;
        }

        .features-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
            margin-bottom: 12px;
        }

        .features-subtitle {
            font-size: 16px;
            color: var(--gray-500);
            max-width: 480px;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04);
            cursor: pointer;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.04), 0 24px 64px rgba(0,0,0,0.08);
            border-color: rgba(59,130,246,0.2);
        }

        .feature-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .feature-card:hover .feature-icon { transform: scale(1.05); }
        .feature-icon svg { width: 24px; height: 24px; }

        .feature-icon.blue {
            background: var(--blue-50);
            border: 1px solid var(--blue-100);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.blue svg { color: var(--blue-600); }

        .feature-icon.emerald {
            background: #ECFDF5;
            border: 1px solid #D1FAE5;
            box-shadow: 0 4px 16px rgba(16,185,129,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.emerald svg { color: #059669; }

        .feature-icon.violet {
            background: #F5F3FF;
            border: 1px solid #EDE9FE;
            box-shadow: 0 4px 16px rgba(139,92,246,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.violet svg { color: #7C3AED; }

        .feature-icon.rose {
            background: #FFF1F2;
            border: 1px solid #FFE4E6;
            box-shadow: 0 4px 16px rgba(244,63,94,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.rose svg { color: #E11D48; }

        .feature-icon.cyan {
            background: #ECFEFF;
            border: 1px solid #CFFAFE;
            box-shadow: 0 4px 16px rgba(6,182,212,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.cyan svg { color: #0891B2; }

        .feature-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }

        .feature-desc {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .feature-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--blue-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .feature-link:hover { gap: 10px; }
        .feature-link svg { width: 16px; height: 16px; transition: transform 0.2s ease; }
        .feature-link:hover svg { transform: translateX(4px); }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover { color: var(--gray-700); }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            .hero { padding: 160px 32px 80px; }
            .hero-badge { padding: 10px 20px 10px 14px; margin-bottom: 32px; }
            .badge-dot { width: 10px; height: 10px; }
            .badge-text { font-size: 13px; }
            .hero-title { font-size: 56px; letter-spacing: -2.5px; margin-bottom: 24px; }
            .hero-subtitle { font-size: 18px; margin-bottom: 48px; }
            .chat-container { padding: 0 24px; margin-bottom: 80px; }
            .chat-card { border-radius: 24px; padding: 10px; }
            .chat-inner { border-radius: 16px; padding: 4px; }
            .chat-input { padding: 10px 14px; min-height: 40px; }
            .chat-send { width: 44px; height: 44px; border-radius: 12px; }
            .chat-hints { gap: 10px; padding: 18px 10px 8px; }
            .hint-chip { padding: 12px 18px; font-size: 13px; }
            .hint-chip svg { width: 16px; height: 16px; }
            .features { padding: 80px 32px 100px; }
            .features-header { margin-bottom: 56px; }
            .features-label { font-size: 12px; margin-bottom: 16px; }
            .features-title { font-size: 36px; letter-spacing: -1.5px; }
            .features-subtitle { font-size: 18px; }
            .features-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .feature-card { padding: 36px; border-radius: 24px; }
            .feature-card:hover { transform: translateY(-6px); }
            .feature-icon { width: 60px; height: 60px; border-radius: 18px; margin-bottom: 24px; }
            .feature-icon svg { width: 26px; height: 26px; }
            .feature-title { font-size: 20px; margin-bottom: 12px; }
            .feature-desc { font-size: 15px; line-height: 1.7; margin-bottom: 24px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
            .orb-1 { width: 600px; height: 600px; left: -10%; }
            .orb-2 { width: 450px; height: 450px; right: -10%; }
            .orb-3 { width: 400px; height: 400px; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .hero { padding: 180px 40px 80px; }
            .hero-title { font-size: 72px; letter-spacing: -3px; margin-bottom: 28px; }
            .hero-subtitle { font-size: 20px; margin-bottom: 56px; }
            .chat-container { margin-bottom: 100px; }
            .chat-card { border-radius: 28px; }
            .chat-inner { border-radius: 18px; }
            .chat-input { padding: 12px 16px; min-height: 44px; max-height: 160px; }
            .chat-send { width: 48px; height: 48px; border-radius: 14px; margin: 6px; }
            .chat-send svg { width: 20px; height: 20px; }
            .chat-hints { padding: 20px 12px 8px; }
            .hint-chip { padding: 12px 20px; }
            .features { padding: 80px 40px 120px; }
            .features-header { margin-bottom: 64px; }
            .features-title { font-size: 40px; }
            .features-grid { grid-template-columns: repeat(3, 1fr); gap: 24px; }
            .feature-card { padding: 40px; border-radius: 28px; }
            .feature-card:hover { transform: translateY(-8px); }
            .feature-icon { width: 64px; height: 64px; border-radius: 20px; margin-bottom: 28px; }
            .feature-icon svg { width: 28px; height: 28px; }
            .footer { padding: 48px 40px; }
            .orb-1 { width: 800px; height: 800px; top: -20%; left: -10%; }
            .orb-2 { width: 600px; height: 600px; right: -15%; }
            .orb-3 { width: 500px; height: 500px; }
        }

        @media (min-width: 1280px) {
            .hero-title { font-size: 80px; }
        }
    

        .main-content {
            flex: 1;
            padding: 100px 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
        }

        h1 { font-size: 32px; margin-bottom: 16px; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 24px; margin-bottom: 12px; font-weight: 700; letter-spacing: -0.5px; }
        h3 { font-size: 20px; margin-bottom: 10px; font-weight: 700; letter-spacing: -0.3px; }

        input[type="text"], input[type="number"], input[type="email"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            background: var(--white);
            color: var(--gray-900);
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button, .btn {
            padding: 12px 24px;
            background: var(--blue-600);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(37,99,235,0.2), 0 4px 16px rgba(37,99,235,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        button:hover, .btn:hover {
            background: var(--blue-700);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(37,99,235,0.2), 0 12px 40px rgba(37,99,235,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        button:active, .btn:active {
            transform: translateY(0);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: rgba(37,99,235,0.05);
            font-weight: 600;
            color: var(--blue-700);
        }

        @media (min-width: 768px) {
            .main-content { padding: 120px 32px 60px; }
        }

        @media (min-width: 1024px) {
            .main-content { padding: 140px 40px 80px; }
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Verification Banner for Unverified Users -->
    {{ generate_verification_banner_html()|safe }}

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html('library')|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
            <style>
                /* Library-specific styles */
                .library-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
                .library-title { display: flex; align-items: center; gap: 12px; font-size: 32px; font-weight: 800; color: var(--gray-900); letter-spacing: -1px; }
                .library-title svg { width: 28px; height: 28px; color: var(--blue-600); }
                .library-stats { font-size: 14px; color: var(--gray-500); font-weight: 500; }

                .search-bar { width: 100%; max-width: 400px; padding: 12px 16px 12px 44px; border: 1px solid var(--gray-300); border-radius: 12px; font-family: inherit; font-size: 15px; background: var(--white); color: var(--gray-900); transition: all 0.2s ease; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394A3B8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 12px center; background-size: 20px 20px; margin-bottom: 24px; }
                .search-bar:focus { outline: none; border-color: var(--blue-500); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
                .bookmark-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
                .bookmark-card { background: rgba(255,255,255,0.7); backdrop-filter: blur(20px) saturate(180%); border: 1px solid rgba(255,255,255,0.8); border-radius: 20px; padding: 24px; box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,0.8); transition: all 0.3s ease; }
                .bookmark-card:hover { transform: translateY(-4px); box-shadow: 0 4px 8px rgba(0,0,0,0.04), 0 12px 32px rgba(0,0,0,0.08), 0 24px 64px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8); border-color: rgba(59,130,246,0.3); }
                .bookmark-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; gap: 16px; }
                .bookmark-query { font-size: 18px; font-weight: 700; color: var(--gray-900); margin-bottom: 6px; letter-spacing: -0.3px; line-height: 1.4; }
                .bookmark-date { font-size: 13px; color: var(--gray-500); font-weight: 500; }
                .bookmark-actions { display: flex; gap: 8px; flex-shrink: 0; }
                .bookmark-btn { padding: 8px 12px; font-size: 13px; font-weight: 600; border-radius: 8px; border: 1px solid var(--gray-300); background: var(--white); color: var(--gray-700); cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
                .bookmark-btn:hover { background: var(--gray-50); border-color: var(--blue-500); color: var(--blue-600); transform: translateY(-1px); }
                .bookmark-btn.remove-btn:hover { background: #FEF2F2; border-color: #FCA5A5; color: #DC2626; }
                .bookmark-answer { font-size: 15px; line-height: 1.6; color: var(--gray-700); margin-bottom: 0; }
                .bookmark-answer p { margin-bottom: 12px; }
                .bookmark-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 16px; border-top: 1px solid var(--gray-200); flex-wrap: wrap; gap: 12px; margin-top: 16px; }
                .bookmark-refs { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; color: var(--blue-600); font-weight: 600; background: var(--blue-50); padding: 6px 12px; border-radius: 8px; border: 1px solid var(--blue-100); }
                .empty-state { text-align: center; padding: 80px 20px; background: rgba(255,255,255,0.5); border-radius: 20px; border: 2px dashed var(--gray-300); }
                .empty-state svg { color: var(--gray-300); margin-bottom: 20px; }
                .empty-state p { font-size: 16px; color: var(--gray-500); margin-bottom: 24px; }
                .empty-state-btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 24px; background: var(--blue-600); color: var(--white); text-decoration: none; border-radius: 12px; font-weight: 600; font-size: 15px; transition: all 0.2s ease; box-shadow: 0 4px 16px rgba(37,99,235,0.2); }
                .empty-state-btn:hover { background: var(--blue-700); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(37,99,235,0.3); }

                /* Footer Styles */
                .footer { padding: 32px 20px; border-top: 1px solid var(--gray-200); background: rgba(255,255,255,0.5); margin-top: 60px; }
                .footer-inner { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; align-items: center; gap: 20px; text-align: center; }
                .footer-text { font-size: 13px; color: var(--gray-500); }
                .footer-links { display: flex; gap: 24px; }
                .footer-link { font-size: 13px; color: var(--gray-500); text-decoration: none; transition: color 0.2s ease; }
                .footer-link:hover { color: var(--gray-700); }
                .social-icons { display: flex; gap: 20px; justify-content: center; align-items: center; }
                .social-icon { color: var(--gray-500); transition: color 0.2s ease, transform 0.2s ease; display: flex; align-items: center; justify-content: center; }
                .social-icon:hover { color: var(--gray-700); transform: translateY(-2px); }
                .social-icon svg { width: 24px; height: 24px; }

                @media (min-width: 768px) {
                    .bookmark-grid { grid-template-columns: repeat(2, 1fr); }
                    .footer { padding: 40px 32px; }
                    .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
                    .footer-text { font-size: 14px; }
                    .footer-links { gap: 32px; }
                    .footer-link { font-size: 14px; }
                }
                @media (min-width: 1200px) { .bookmark-grid { grid-template-columns: repeat(2, 1fr); gap: 24px; } }
            </style>

            <div class="library-header">
                <div class="library-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        <path d="M8 7h8"></path>
                        <path d="M8 11h8"></path>
                    </svg>
                    My Library
                </div>
                {% if bookmarks %}
                <div class="library-stats">{{ bookmarks|length }} saved {{ 'response' if bookmarks|length == 1 else 'responses' }}</div>
                {% endif %}
            </div>

            {% if bookmarks %}
            <input type="text" id="searchBar" class="search-bar" placeholder="Search your library..." onkeyup="filterBookmarks()">
            {% endif %}

            {% if not bookmarks %}
            <div class="empty-state">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z"></path>
                </svg>
                <p>No saved responses yet. Start building your evidence library!</p>
                <a href="/?clear=1" class="empty-state-btn">
                    Start a Conversation
                </a>
            </div>
            {% else %}
            <div class="bookmark-grid">
                {% for bookmark in bookmarks %}
                <div class="bookmark-card" data-query="{{ bookmark.query|lower }}" data-answer="{{ bookmark.answer|striptags|lower }}">
                    <div class="bookmark-header">
                        <div style="flex: 1;">
                            <div class="bookmark-query">{{ bookmark.query }}</div>
                            <div class="bookmark-date">Saved {{ bookmark.timestamp[:10] }}</div>
                        </div>
                        <div class="bookmark-actions">
                            <button class="bookmark-btn remove-btn" onclick="removeBookmark('{{ bookmark.id }}')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;">
                                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                Remove
                            </button>
                        </div>
                    </div>
                    <div class="bookmark-answer">{{ bookmark.answer|safe|truncate(300) }}</div>
                    <div class="bookmark-footer">
                        {% if bookmark.num_papers > 0 %}
                        <div class="bookmark-refs">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            {{ bookmark.num_papers }} {{ 'reference' if bookmark.num_papers == 1 else 'references' }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
    </main>

    <script>
        // Search/filter bookmarks
        function filterBookmarks() {
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            const bookmarkCards = document.querySelectorAll('.bookmark-card');

            bookmarkCards.forEach(card => {
                const query = card.getAttribute('data-query');
                const answer = card.getAttribute('data-answer');

                if (query.includes(searchTerm) || answer.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function removeBookmark(id) {
            // Implementation for removing bookmarks
            window.location.reload();
        }
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const menu = e.target.nextElementSibling;
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('show'));
        });
    </script>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
        </main>
    </div>
</body>
</html>
"""

SHARED_RESPONSE_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Response - gasconsult.ai</title>

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>

        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Skip to Content Link for Accessibility */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--blue-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
            font-weight: 600;
            transition: top 0.2s;
        }

        .skip-to-content:focus {
            top: 0;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .hero {
            padding: 120px 20px 60px;
            text-align: center;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 8px 16px 8px 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) forwards;
            opacity: 0;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--blue-500);
            border-radius: 50%;
            position: relative;
        }

        .badge-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: var(--blue-400);
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .badge-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .hero-title {
            font-size: 40px;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -2px;
            color: var(--gray-900);
            margin-bottom: 20px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.1s forwards;
            opacity: 0;
        }

        .hero-title .gradient { color: var(--blue-600); }

        .hero-subtitle {
            font-size: 16px;
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-500);
            max-width: 560px;
            margin: 0 auto 40px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.2s forwards;
            opacity: 0;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-container {
            max-width: 720px;
            margin: 0 auto 60px;
            padding: 0 16px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.3s forwards;
            opacity: 0;
        }

        .chat-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 20px;
            padding: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        .chat-card:focus-within {
            box-shadow: 0 0 0 4px rgba(59,130,246,0.1), 0 1px 2px rgba(0,0,0,0.02), 0 8px 24px rgba(37,99,235,0.08), 0 32px 100px rgba(37,99,235,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
            border-color: rgba(59,130,246,0.3);
        }

        .chat-inner {
            background: var(--white);
            border-radius: 14px;
            padding: 3px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04), inset 0 1px 0 rgba(255,255,255,1);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 0 12px;
            font-size: 15px;
            font-family: inherit;
            color: var(--gray-800);
            background: transparent;
            resize: none;
            height: 36px;
            max-height: 110px;
            line-height: 36px;
        }

        .chat-input::placeholder {
            color: var(--gray-400);
            line-height: 36px;
        }

        .chat-send {
            width: 36px;
            height: 36px;
            background: var(--blue-600);
            border: none;
            border-radius: 10px;
            color: var(--white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(37,99,235,0.2), 0 4px 16px rgba(37,99,235,0.2), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
            flex-shrink: 0;
            margin: 3px;
        }

        .chat-send:hover {
            background: var(--blue-700);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(37,99,235,0.2), 0 12px 40px rgba(37,99,235,0.3), inset 0 1px 0 rgba(255,255,255,0.1), inset 0 -1px 0 rgba(0,0,0,0.1);
        }

        .chat-send:active { transform: translateY(0); }
        .chat-send svg { width: 18px; height: 18px; }

        .chat-hints {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 16px 8px 6px;
        }

        .hint-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 10px 14px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .hint-chip:hover {
            background: var(--white);
            border-color: var(--blue-200);
            color: var(--blue-600);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.1);
        }

        .hint-chip svg { width: 14px; height: 14px; opacity: 0.5; }
        .hint-chip:hover svg { opacity: 1; color: var(--blue-500); }

        .features { padding: 60px 20px 80px; }

        .features-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .features-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--blue-600);
            margin-bottom: 12px;
        }

        .features-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
            margin-bottom: 12px;
        }

        .features-subtitle {
            font-size: 16px;
            color: var(--gray-500);
            max-width: 480px;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 28px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04);
            cursor: pointer;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
        }

        .feature-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.04), 0 24px 64px rgba(0,0,0,0.08);
            border-color: rgba(59,130,246,0.2);
        }

        .feature-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .feature-card:hover .feature-icon { transform: scale(1.05); }
        .feature-icon svg { width: 24px; height: 24px; }

        .feature-icon.blue {
            background: var(--blue-50);
            border: 1px solid var(--blue-100);
            box-shadow: 0 4px 16px rgba(37,99,235,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.blue svg { color: var(--blue-600); }

        .feature-icon.emerald {
            background: #ECFDF5;
            border: 1px solid #D1FAE5;
            box-shadow: 0 4px 16px rgba(16,185,129,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.emerald svg { color: #059669; }

        .feature-icon.violet {
            background: #F5F3FF;
            border: 1px solid #EDE9FE;
            box-shadow: 0 4px 16px rgba(139,92,246,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.violet svg { color: #7C3AED; }

        .feature-icon.rose {
            background: #FFF1F2;
            border: 1px solid #FFE4E6;
            box-shadow: 0 4px 16px rgba(244,63,94,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.rose svg { color: #E11D48; }

        .feature-icon.cyan {
            background: #ECFEFF;
            border: 1px solid #CFFAFE;
            box-shadow: 0 4px 16px rgba(6,182,212,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .feature-icon.cyan svg { color: #0891B2; }

        .feature-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 10px;
            letter-spacing: -0.3px;
        }

        .feature-desc {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-500);
            margin-bottom: 20px;
        }

        .feature-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
            color: var(--blue-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .feature-link:hover { gap: 10px; }
        .feature-link svg { width: 16px; height: 16px; transition: transform 0.2s ease; }
        .feature-link:hover svg { transform: translateX(4px); }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover { color: var(--gray-700); }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            .hero { padding: 160px 32px 80px; }
            .hero-badge { padding: 10px 20px 10px 14px; margin-bottom: 32px; }
            .badge-dot { width: 10px; height: 10px; }
            .badge-text { font-size: 13px; }
            .hero-title { font-size: 56px; letter-spacing: -2.5px; margin-bottom: 24px; }
            .hero-subtitle { font-size: 18px; margin-bottom: 48px; }
            .chat-container { padding: 0 24px; margin-bottom: 80px; }
            .chat-card { border-radius: 24px; padding: 10px; }
            .chat-inner { border-radius: 16px; padding: 4px; }
            .chat-input { padding: 10px 14px; min-height: 40px; }
            .chat-send { width: 44px; height: 44px; border-radius: 12px; }
            .chat-hints { gap: 10px; padding: 18px 10px 8px; }
            .hint-chip { padding: 12px 18px; font-size: 13px; }
            .hint-chip svg { width: 16px; height: 16px; }
            .features { padding: 80px 32px 100px; }
            .features-header { margin-bottom: 56px; }
            .features-label { font-size: 12px; margin-bottom: 16px; }
            .features-title { font-size: 36px; letter-spacing: -1.5px; }
            .features-subtitle { font-size: 18px; }
            .features-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; }
            .feature-card { padding: 36px; border-radius: 24px; }
            .feature-card:hover { transform: translateY(-6px); }
            .feature-icon { width: 60px; height: 60px; border-radius: 18px; margin-bottom: 24px; }
            .feature-icon svg { width: 26px; height: 26px; }
            .feature-title { font-size: 20px; margin-bottom: 12px; }
            .feature-desc { font-size: 15px; line-height: 1.7; margin-bottom: 24px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
            .orb-1 { width: 600px; height: 600px; left: -10%; }
            .orb-2 { width: 450px; height: 450px; right: -10%; }
            .orb-3 { width: 400px; height: 400px; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .hero { padding: 180px 40px 80px; }
            .hero-title { font-size: 72px; letter-spacing: -3px; margin-bottom: 28px; }
            .hero-subtitle { font-size: 20px; margin-bottom: 56px; }
            .chat-container { margin-bottom: 100px; }
            .chat-card { border-radius: 28px; }
            .chat-inner { border-radius: 18px; }
            .chat-input { padding: 12px 16px; min-height: 44px; max-height: 160px; }
            .chat-send { width: 48px; height: 48px; border-radius: 14px; margin: 6px; }
            .chat-send svg { width: 20px; height: 20px; }
            .chat-hints { padding: 20px 12px 8px; }
            .hint-chip { padding: 12px 20px; }
            .features { padding: 80px 40px 120px; }
            .features-header { margin-bottom: 64px; }
            .features-title { font-size: 40px; }
            .features-grid { grid-template-columns: repeat(3, 1fr); gap: 24px; }
            .feature-card { padding: 40px; border-radius: 28px; }
            .feature-card:hover { transform: translateY(-8px); }
            .feature-icon { width: 64px; height: 64px; border-radius: 20px; margin-bottom: 28px; }
            .feature-icon svg { width: 28px; height: 28px; }
            .footer { padding: 48px 40px; }
            .orb-1 { width: 800px; height: 800px; top: -20%; left: -10%; }
            .orb-2 { width: 600px; height: 600px; right: -15%; }
            .orb-3 { width: 500px; height: 500px; }
        }

        @media (min-width: 1280px) {
            .hero-title { font-size: 80px; }
        }
    

        .main-content {
            flex: 1;
            padding: 100px 20px 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
        }

        h1 { font-size: 32px; margin-bottom: 16px; font-weight: 700; letter-spacing: -0.5px; }
        h2 { font-size: 24px; margin-bottom: 12px; font-weight: 700; letter-spacing: -0.5px; }
        h3 { font-size: 20px; margin-bottom: 10px; font-weight: 700; letter-spacing: -0.3px; }

        input[type="text"], input[type="number"], input[type="email"], select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            background: var(--white);
            color: var(--gray-900);
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        button, .btn {
            padding: 12px 24px;
            background: var(--blue-600);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(37,99,235,0.2), 0 4px 16px rgba(37,99,235,0.2), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        button:hover, .btn:hover {
            background: var(--blue-700);
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(37,99,235,0.2), 0 12px 40px rgba(37,99,235,0.3), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        button:active, .btn:active {
            transform: translateY(0);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            overflow: hidden;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: rgba(37,99,235,0.05);
            font-weight: 600;
            color: var(--blue-700);
        }

        @media (min-width: 768px) {
            .main-content { padding: 120px 32px 60px; }
        }

        @media (min-width: 1024px) {
            .main-content { padding: 140px 40px 80px; }
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Verification Banner for Unverified Users -->
    {{ generate_verification_banner_html()|safe }}

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
<main>
        <div class="response-card">
            <div class="query">{{ data.query }}</div>
            <div class="answer">{{ data.answer|safe }}</div>

            {% if data.references %}
            <div class="refs">
                <strong>References:</strong><br>
                {% for ref in data.references %}
                <a href="https://pubmed.ncbi.nlm.nih.gov/{{ ref.pmid }}/" target="_blank">
                    [{{ loop.index }}] {{ ref.title }} ({{ ref.year }})
                </a><br>
                {% endfor %}
                <br>
                📊 {{ data.num_papers }} papers from PubMed
            </div>
            {% endif %}
        </div>

        <div class="footer-note">
            This response was shared from gasconsult.ai • Shared {{ data.timestamp[:10] }}
        </div>
    </main>
        </main>
    </div>
</body>
</html>
"""

TERMS_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terms of Service - gasconsult.ai</title>

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>

        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Skip to Content Link for Accessibility */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--blue-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
            font-weight: 600;
            transition: top 0.2s;
        }

        .skip-to-content:focus {
            top: 0;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .main-content {
            flex: 1;
            padding: 100px 20px 40px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 40px 28px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
        }

        h1 {
            font-size: 36px;
            margin-bottom: 8px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
        }

        h2 {
            font-size: 22px;
            margin-top: 32px;
            margin-bottom: 16px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        h3 {
            font-size: 18px;
            margin-top: 20px;
            margin-bottom: 12px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: var(--gray-800);
        }

        p {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 16px;
        }

        ul {
            margin-left: 24px;
            margin-bottom: 16px;
        }

        li {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        strong {
            font-weight: 600;
            color: var(--gray-900);
        }

        .last-updated {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 32px;
            font-weight: 500;
        }

        .notice-box {
            background: rgba(239, 68, 68, 0.05);
            border-left: 4px solid #EF4444;
            border-radius: 12px;
            padding: 20px 24px;
            margin: 24px 0;
        }

        .notice-box h3 {
            font-size: 16px;
            font-weight: 700;
            color: #DC2626;
            margin: 0 0 12px 0;
        }

        .notice-box p {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-800);
            margin: 0;
        }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover { color: var(--gray-700); }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            .main-content { padding: 120px 32px 60px; }
            .content-card { padding: 48px 40px; border-radius: 24px; }
            h1 { font-size: 42px; margin-bottom: 12px; }
            h2 { font-size: 24px; margin-top: 40px; margin-bottom: 18px; }
            h3 { font-size: 19px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
            .orb-1 { width: 600px; height: 600px; left: -10%; }
            .orb-2 { width: 450px; height: 450px; right: -10%; }
            .orb-3 { width: 400px; height: 400px; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .main-content { padding: 140px 40px 80px; }
            .content-card { padding: 56px 48px; border-radius: 28px; }
            h1 { font-size: 48px; letter-spacing: -1.5px; }
            h2 { font-size: 26px; }
            h3 { font-size: 20px; }
            p, li { font-size: 16px; }
            .footer { padding: 48px 40px; }
            .orb-1 { width: 800px; height: 800px; top: -20%; left: -10%; }
            .orb-2 { width: 600px; height: 600px; right: -15%; }
            .orb-3 { width: 500px; height: 500px; }
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Verification Banner for Unverified Users -->
    {{ generate_verification_banner_html()|safe }}

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
            <div class="content-card">
                <h1>Terms of Service</h1>
                <p class="last-updated">Last Updated: December 2025</p>

                <div class="notice-box">
                    <h3>CRITICAL MEDICAL DISCLAIMER</h3>
                    <p><strong>THIS SERVICE DOES NOT PROVIDE MEDICAL ADVICE, DIAGNOSIS, OR TREATMENT. DO NOT USE FOR EMERGENCIES. CALL 911 FOR EMERGENCIES.</strong> gasconsult.ai is strictly an educational and informational tool. No doctor-patient relationship is created by using this Service. All information must be independently verified by qualified healthcare professionals before any clinical application.</p>
                </div>

                <p>These Terms of Service ("Terms") constitute a legally binding agreement between you ("User" or "you") and gasconsult.ai ("Service", "we", "us", or "our"). By accessing or using this Service, you acknowledge that you have read, understood, and unconditionally accept all terms, disclaimers, and limitations set forth below.</p>

                <h2>1. Acceptance of Terms</h2>
                <p>By accessing, browsing, or using gasconsult.ai in any manner, you acknowledge and agree that:</p>
                <ul>
                    <li>You have read and understood these Terms in their entirety</li>
                    <li>You agree to be legally bound by all provisions contained herein</li>
                    <li>If you do not agree to these Terms, you must immediately cease all use of this Service</li>
                    <li>Continued use of the Service constitutes ongoing acceptance of these Terms and any future modifications</li>
                    <li>These Terms supersede any prior agreements, representations, or understandings</li>
                </ul>

                <h2>2. NOT Medical Advice - Critical Disclaimers</h2>

                <h3>2.1 Not Medical Advice, Diagnosis, or Treatment</h3>
                <p><strong>THE INFORMATION PROVIDED BY GASCONSULT.AI IS STRICTLY FOR EDUCATIONAL AND INFORMATIONAL PURPOSES ONLY.</strong> Under no circumstances should the content generated by this Service be interpreted, construed, or relied upon as:</p>
                <ul>
                    <li>Medical advice, clinical recommendations, or treatment guidance</li>
                    <li>Diagnosis or diagnostic assistance for any medical condition</li>
                    <li>Prescription or recommendation of any medication, treatment, or therapy</li>
                    <li>A substitute for consultation with qualified, licensed healthcare professionals</li>
                    <li>A replacement for comprehensive patient assessment and examination</li>
                    <li>Definitive or authoritative medical guidance for patient care</li>
                    <li>Standard of care or best practices for any clinical situation</li>
                    <li>Current, complete, or accurate medical information</li>
                </ul>

                <h3>2.2 Educational and Research Purposes Only</h3>
                <p>This Service is designed exclusively as an educational resource for healthcare professionals to:</p>
                <ul>
                    <li>Explore medical literature and research findings</li>
                    <li>Supplement continuing medical education efforts</li>
                    <li>Generate hypotheses for further investigation</li>
                    <li>Understand trends in published medical research</li>
                </ul>
                <p><strong>THIS SERVICE MUST NOT BE USED</strong> as the basis for any clinical decision, treatment plan, medication dosing, or patient care intervention without independent professional verification and judgment.</p>

                <h3>2.3 Multiple Mandatory Disclaimers</h3>
                <p>To ensure absolute clarity, we state unequivocally:</p>
                <ul>
                    <li><strong>WE DO NOT PROVIDE MEDICAL ADVICE.</strong></li>
                    <li><strong>WE DO NOT DIAGNOSE MEDICAL CONDITIONS.</strong></li>
                    <li><strong>WE DO NOT RECOMMEND TREATMENTS.</strong></li>
                    <li><strong>WE DO NOT PRESCRIBE MEDICATIONS.</strong></li>
                    <li><strong>WE DO NOT REPLACE PROFESSIONAL MEDICAL JUDGMENT.</strong></li>
                    <li><strong>YOU CANNOT AND MUST NOT RELY ON THIS SERVICE FOR MEDICAL DECISIONS.</strong></li>
                </ul>

                <h2>3. No Doctor-Patient Relationship</h2>
                <p><strong>USE OF THIS SERVICE DOES NOT CREATE, AND SHALL NEVER BE CONSTRUED TO CREATE, A DOCTOR-PATIENT RELATIONSHIP, HEALTHCARE PROVIDER-PATIENT RELATIONSHIP, OR ANY PROFESSIONAL MEDICAL RELATIONSHIP OF ANY KIND.</strong></p>
                <p>You acknowledge and agree that:</p>
                <ul>
                    <li>No physician-patient relationship exists or will be formed through use of this Service</li>
                    <li>We are not your healthcare provider, physician, medical advisor, or clinician</li>
                    <li>We have no duty of care, fiduciary duty, or professional obligation to you</li>
                    <li>We do not and cannot provide personalized medical advice for your specific situation</li>
                    <li>All interactions with this Service are non-clinical and educational only</li>
                    <li>You must consult with your own qualified healthcare providers for all medical matters</li>
                </ul>

                <h2>4. Emergency Disclaimer - DO NOT USE FOR EMERGENCIES</h2>

                <div class="notice-box">
                    <h3>EMERGENCY MEDICAL DISCLAIMER</h3>
                    <p><strong>DO NOT USE THIS SERVICE FOR MEDICAL EMERGENCIES UNDER ANY CIRCUMSTANCES.</strong></p>
                    <p><strong>IF YOU ARE EXPERIENCING A MEDICAL EMERGENCY, CALL 911 (OR YOUR LOCAL EMERGENCY NUMBER) IMMEDIATELY.</strong></p>
                    <p>This Service is not designed for, equipped to handle, or suitable for emergency medical situations. Any delay in seeking emergency medical care while using this Service could result in serious injury or death.</p>
                </div>

                <p>You expressly acknowledge that:</p>
                <ul>
                    <li>This Service provides no real-time clinical support or emergency assistance</li>
                    <li>Information provided may be delayed, incomplete, or unsuitable for urgent situations</li>
                    <li>In any emergency or potentially life-threatening situation, you must immediately contact emergency medical services (call 911) or go to the nearest emergency department</li>
                    <li>We are not liable for any harm, injury, or death resulting from failure to seek timely emergency medical care</li>
                </ul>

                <h2>5. Educational Use Only - Professional Verification Required</h2>
                <p>This Service is intended exclusively for use by licensed, qualified healthcare professionals (physicians, CRNAs, nurse practitioners, physician assistants, medical students, residents, fellows) as an educational supplement.</p>
                <p><strong>ALL INFORMATION PROVIDED MUST BE INDEPENDENTLY VERIFIED</strong> through:</p>
                <ul>
                    <li>Primary medical literature and original research publications</li>
                    <li>Current evidence-based clinical practice guidelines</li>
                    <li>Consultation with qualified medical experts and specialists</li>
                    <li>Institutional protocols and standards of care</li>
                    <li>Individual patient assessment and clinical judgment</li>
                    <li>Appropriate diagnostic testing and patient evaluation</li>
                </ul>
                <p><strong>YOU ASSUME ALL RESPONSIBILITY</strong> for verifying information before any clinical application.</p>

                <h2>6. AI-Generated Content Disclaimer</h2>

                <h3>6.1 Artificial Intelligence Limitations</h3>
                <p>This Service uses artificial intelligence (AI) technology, including large language models (LLMs) such as GPT-4o. <strong>YOU ACKNOWLEDGE AND ACCEPT THAT AI TECHNOLOGY:</strong></p>
                <ul>
                    <li><strong>Can and does generate errors, inaccuracies, and false information ("hallucinations")</strong></li>
                    <li>May produce plausible-sounding but factually incorrect medical information</li>
                    <li>Can misinterpret, misrepresent, or incorrectly synthesize medical literature</li>
                    <li>May provide outdated, incomplete, or biased information</li>
                    <li>Cannot replace human medical expertise, clinical judgment, or professional training</li>
                    <li>May generate contradictory or inconsistent responses to similar queries</li>
                    <li>Lacks the ability to understand individual patient context, nuance, or complexity</li>
                    <li>Is not validated for clinical decision-making or patient care</li>
                </ul>

                <h3>6.2 No Validation or Clinical Testing</h3>
                <p>The AI outputs provided by this Service have NOT been:</p>
                <ul>
                    <li>Validated through clinical trials or rigorous medical testing</li>
                    <li>Approved by any regulatory authority (FDA, EMA, etc.)</li>
                    <li>Reviewed or endorsed by medical professional organizations</li>
                    <li>Verified for accuracy, safety, or clinical appropriateness</li>
                    <li>Tested for use in actual patient care scenarios</li>
                </ul>

                <h3>6.3 Non-Deterministic Responses</h3>
                <p>AI-generated responses are probabilistic and non-deterministic. The same query may produce different responses at different times. You cannot rely on consistency, reproducibility, or reliability of AI outputs.</p>

                <h2>7. Third-Party Content and Data Sources</h2>
                <p>This Service aggregates and synthesizes information from third-party sources, including but not limited to:</p>
                <ul>
                    <li>PubMed and NCBI medical literature databases</li>
                    <li>OpenAI's GPT-4o and other AI models</li>
                    <li>Published medical research papers and abstracts</li>
                    <li>Medical databases and online resources</li>
                </ul>

                <p><strong>WE ARE NOT RESPONSIBLE FOR:</strong></p>
                <ul>
                    <li>The accuracy, completeness, or reliability of third-party content</li>
                    <li>Errors, omissions, or inaccuracies in source materials</li>
                    <li>Retracted, corrected, or updated research findings</li>
                    <li>Biases, conflicts of interest, or methodological flaws in published research</li>
                    <li>Availability or accessibility of third-party services</li>
                    <li>Any harm resulting from third-party content or data</li>
                </ul>

                <p>All citations, references, and source materials must be independently verified through original publications.</p>

                <h2>8. No Warranties - Service Provided "AS IS"</h2>

                <h3>8.1 Disclaimer of All Warranties</h3>
                <p><strong>TO THE MAXIMUM EXTENT PERMITTED BY LAW, THIS SERVICE IS PROVIDED "AS IS", "AS AVAILABLE", AND "WITH ALL FAULTS" WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED.</strong></p>

                <p>We expressly disclaim all warranties, including but not limited to:</p>
                <ul>
                    <li><strong>Warranties of merchantability</strong></li>
                    <li><strong>Warranties of fitness for a particular purpose</strong></li>
                    <li><strong>Warranties of accuracy, reliability, or completeness</strong></li>
                    <li><strong>Warranties of non-infringement</strong></li>
                    <li><strong>Warranties of title</strong></li>
                    <li><strong>Warranties arising from course of dealing or usage of trade</strong></li>
                    <li><strong>Any warranties regarding uninterrupted, timely, secure, or error-free service</strong></li>
                    <li><strong>Any warranties that defects will be corrected</strong></li>
                    <li><strong>Any warranties regarding results obtained from use of the Service</strong></li>
                </ul>

                <h3>8.2 No Guarantee of Accuracy</h3>
                <p>We make absolutely no representation or warranty that:</p>
                <ul>
                    <li>Information provided is accurate, current, complete, or reliable</li>
                    <li>The Service will meet your requirements or expectations</li>
                    <li>Information is suitable for any particular purpose or clinical situation</li>
                    <li>AI-generated content is free from errors, hallucinations, or inaccuracies</li>
                    <li>Third-party data sources are accurate or up-to-date</li>
                    <li>The Service will be available, accessible, or functional at any given time</li>
                </ul>

                <h2>9. Limitation of Liability - Maximum Legal Protection</h2>

                <h3>9.1 No Liability for Any Damages</h3>
                <p><strong>TO THE FULLEST EXTENT PERMITTED BY APPLICABLE LAW, GASCONSULT.AI, ITS OWNERS, OPERATORS, DEVELOPERS, CONTRIBUTORS, AFFILIATES, LICENSORS, SERVICE PROVIDERS, AND AGENTS (COLLECTIVELY, "RELEASED PARTIES") SHALL NOT BE LIABLE FOR ANY DAMAGES WHATSOEVER, INCLUDING BUT NOT LIMITED TO:</strong></p>
                <ul>
                    <li><strong>Direct damages</strong></li>
                    <li><strong>Indirect damages</strong></li>
                    <li><strong>Incidental damages</strong></li>
                    <li><strong>Consequential damages</strong></li>
                    <li><strong>Punitive damages</strong></li>
                    <li><strong>Special damages</strong></li>
                    <li><strong>Exemplary damages</strong></li>
                    <li><strong>Loss of profits, revenue, business, data, or opportunities</strong></li>
                    <li><strong>Personal injury or death</strong></li>
                    <li><strong>Medical malpractice or negligence</strong></li>
                    <li><strong>Reliance damages</strong></li>
                    <li><strong>Emotional distress</strong></li>
                </ul>

                <h3>9.2 No Liability for Medical Outcomes</h3>
                <p><strong>THE RELEASED PARTIES SHALL NOT BE LIABLE FOR:</strong></p>
                <ul>
                    <li>Patient injuries, complications, adverse events, or death</li>
                    <li>Medical errors or clinical mistakes based on information from this Service</li>
                    <li>Misdiagnosis, delayed diagnosis, or failure to diagnose</li>
                    <li>Inappropriate treatment or medication errors</li>
                    <li>Harm resulting from reliance on AI-generated content</li>
                    <li>Errors, omissions, or inaccuracies in provided information</li>
                    <li>Outdated, incomplete, or misleading medical information</li>
                    <li>Failure to seek timely professional medical care</li>
                    <li>Deviation from standard of care based on Service content</li>
                </ul>

                <h3>9.3 Maximum Liability Cap</h3>
                <p><strong>IN NO EVENT SHALL THE TOTAL AGGREGATE LIABILITY OF THE RELEASED PARTIES EXCEED THE GREATER OF (A) ZERO DOLLARS ($0.00) OR (B) THE TOTAL AMOUNT PAID BY YOU TO GASCONSULT.AI IN THE TWELVE (12) MONTHS PRECEDING THE CLAIM.</strong></p>
                <p>Since this Service is provided free of charge, the maximum liability is <strong>$0.00</strong>.</p>

                <h3>9.4 Limitations Apply to All Claims</h3>
                <p>These limitations apply to all claims, regardless of whether they are based on:</p>
                <ul>
                    <li>Warranty, contract, tort (including negligence), strict liability, or any other legal theory</li>
                    <li>Whether or not the Released Parties have been advised of the possibility of such damages</li>
                    <li>Whether a remedy fails of its essential purpose</li>
                </ul>

                <h2>10. Indemnification - You Hold Us Harmless</h2>
                <p><strong>YOU AGREE TO INDEMNIFY, DEFEND, AND HOLD HARMLESS THE RELEASED PARTIES FROM AND AGAINST ANY AND ALL:</strong></p>
                <ul>
                    <li>Claims, demands, actions, suits, or proceedings</li>
                    <li>Losses, damages, liabilities, settlements, penalties, fines, or judgments</li>
                    <li>Costs and expenses (including reasonable attorneys' fees, expert fees, and litigation costs)</li>
                </ul>

                <p><strong>ARISING from or related to:</strong></p>
                <ul>
                    <li>Your use or misuse of this Service</li>
                    <li>Clinical decisions, treatments, or patient care based on information from the Service</li>
                    <li>Medical malpractice or negligence claims related to your use of the Service</li>
                    <li>Your violation of these Terms of Service</li>
                    <li>Your violation of any applicable laws, regulations, or professional standards</li>
                    <li>Your violation of any rights of third parties</li>
                    <li>Any representation or warranty made by you to patients or third parties regarding this Service</li>
                    <li>Your failure to independently verify information provided by the Service</li>
                    <li>Patient harm resulting directly or indirectly from your use of the Service</li>
                </ul>

                <p>This indemnification obligation survives termination of your use of the Service.</p>

                <h2>11. Assumption of Risk - You Accept All Risks</h2>
                <p><strong>BY USING THIS SERVICE, YOU EXPRESSLY ACKNOWLEDGE, UNDERSTAND, AND VOLUNTARILY ASSUME ALL RISKS ASSOCIATED WITH:</strong></p>
                <ul>
                    <li>Reliance on AI-generated medical information</li>
                    <li>Potential inaccuracies, errors, or omissions in provided content</li>
                    <li>AI hallucinations and false information generation</li>
                    <li>Outdated or incomplete medical information</li>
                    <li>Misinterpretation of medical literature or research findings</li>
                    <li>Service unavailability, downtime, or technical failures</li>
                    <li>Security vulnerabilities or data breaches</li>
                    <li>Third-party content errors or inaccuracies</li>
                    <li>Consequences of any clinical decisions informed by this Service</li>
                </ul>

                <p><strong>YOU ACCEPT FULL AND SOLE RESPONSIBILITY FOR ALL RISKS ASSOCIATED WITH YOUR USE OF THIS SERVICE.</strong></p>

                <h2>12. HIPAA and Protected Health Information (PHI)</h2>

                <h3>12.1 Not a HIPAA Covered Entity</h3>
                <p><strong>GASCONSULT.AI IS NOT A COVERED ENTITY OR BUSINESS ASSOCIATE UNDER THE HEALTH INSURANCE PORTABILITY AND ACCOUNTABILITY ACT (HIPAA).</strong></p>
                <p>We do not provide healthcare services, maintain medical records, or engage in activities that would classify us as a HIPAA-covered entity.</p>

                <h3>12.2 DO NOT Enter Protected Health Information</h3>
                <p><strong>YOU MUST NOT ENTER, SUBMIT, OR UPLOAD ANY PROTECTED HEALTH INFORMATION (PHI) OR PERSONALLY IDENTIFIABLE HEALTH DATA INTO THIS SERVICE.</strong></p>
                <p>This includes but is not limited to:</p>
                <ul>
                    <li>Patient names, initials, or identifying information</li>
                    <li>Medical record numbers or patient identifiers</li>
                    <li>Dates of birth, addresses, or contact information</li>
                    <li>Social security numbers or insurance information</li>
                    <li>Specific medical histories or case details that could identify a patient</li>
                    <li>Any of the 18 HIPAA identifiers</li>
                </ul>

                <h3>12.3 Your HIPAA Compliance Responsibility</h3>
                <p>If you are a HIPAA-covered entity or business associate, <strong>YOU ARE SOLELY RESPONSIBLE</strong> for ensuring your use of this Service complies with all HIPAA requirements. We assume no responsibility for your HIPAA compliance.</p>

                <h2>13. Regulatory Status and FDA Disclaimer</h2>

                <h3>13.1 Not an FDA-Approved Medical Device</h3>
                <p><strong>THIS SERVICE IS NOT AN FDA-APPROVED, FDA-CLEARED, OR FDA-REGISTERED MEDICAL DEVICE.</strong></p>
                <p>This Service has not been evaluated, approved, or cleared by the U.S. Food and Drug Administration (FDA) or any other regulatory authority.</p>

                <h3>13.2 Not Intended for Clinical Use</h3>
                <p>This Service is not intended to:</p>
                <ul>
                    <li>Diagnose, treat, cure, or prevent any disease</li>
                    <li>Be used in the diagnosis of disease or other conditions</li>
                    <li>Be used in the cure, mitigation, treatment, or prevention of disease</li>
                    <li>Affect the structure or function of the body</li>
                    <li>Replace FDA-approved medical devices or diagnostic tools</li>
                </ul>

                <h3>13.3 No Professional Endorsement</h3>
                <p>This Service is not endorsed, approved, or recommended by:</p>
                <ul>
                    <li>The American Society of Anesthesiologists (ASA)</li>
                    <li>The American Association of Nurse Anesthetists (AANA)</li>
                    <li>Any medical professional organization or licensing board</li>
                    <li>Any hospital, healthcare system, or medical institution</li>
                    <li>Any governmental health agency or regulatory body</li>
                </ul>

                <h2>14. Dispute Resolution - Mandatory Binding Arbitration</h2>

                <h3>14.1 Agreement to Arbitrate</h3>
                <p><strong>YOU AND GASCONSULT.AI AGREE THAT ANY AND ALL DISPUTES, CLAIMS, OR CONTROVERSIES ARISING OUT OF OR RELATING TO THESE TERMS OR YOUR USE OF THE SERVICE SHALL BE RESOLVED EXCLUSIVELY THROUGH FINAL AND BINDING ARBITRATION, RATHER THAN IN COURT.</strong></p>

                <h3>14.2 Arbitration Procedures</h3>
                <p>Any arbitration shall be administered by the American Arbitration Association (AAA) under its Commercial Arbitration Rules and conducted in accordance with the following:</p>
                <ul>
                    <li>The arbitration shall be conducted by a single neutral arbitrator</li>
                    <li>The arbitration shall take place in Delaware, United States</li>
                    <li>The arbitration shall be governed by the Federal Arbitration Act (9 U.S.C. § 1 et seq.)</li>
                    <li>The arbitrator's decision shall be final and binding</li>
                    <li>Judgment on the arbitration award may be entered in any court having jurisdiction</li>
                    <li>Each party shall bear its own costs and attorneys' fees</li>
                </ul>

                <h3>14.3 Waiver of Jury Trial</h3>
                <p><strong>YOU HEREBY IRREVOCABLY WAIVE ANY AND ALL RIGHTS TO TRIAL BY JURY IN ANY LEGAL PROCEEDING ARISING OUT OF OR RELATED TO THESE TERMS OR YOUR USE OF THE SERVICE.</strong></p>

                <h3>14.4 Waiver of Class Actions</h3>
                <p><strong>YOU AGREE THAT ANY ARBITRATION OR LEGAL PROCEEDING SHALL BE CONDUCTED ONLY ON AN INDIVIDUAL BASIS AND NOT IN A CLASS, CONSOLIDATED, OR REPRESENTATIVE ACTION.</strong></p>

                <h2>15. Class Action Waiver</h2>
                <p><strong>YOU EXPRESSLY WAIVE YOUR RIGHT TO PARTICIPATE IN ANY CLASS ACTION, CLASS ARBITRATION, COLLECTIVE ACTION, REPRESENTATIVE ACTION, OR MASS ACTION AGAINST GASCONSULT.AI.</strong></p>
                <p>You agree that:</p>
                <ul>
                    <li>You will not seek to bring or participate in any class, collective, or representative action</li>
                    <li>You will not serve as a class member, representative, or opt into any class proceeding</li>
                    <li>All claims must be brought in your individual capacity only</li>
                    <li>You waive any right to have claims consolidated with claims of other users</li>
                </ul>

                <h2>16. Governing Law and Jurisdiction</h2>

                <h3>16.1 Governing Law</h3>
                <p>These Terms shall be governed by and construed in accordance with the laws of the State of Delaware, United States, without regard to its conflict of law principles.</p>

                <h3>16.2 Jurisdiction and Venue</h3>
                <p>To the extent any dispute is not subject to arbitration, you agree to submit to the exclusive personal jurisdiction and venue of the state and federal courts located in Delaware, United States.</p>

                <h3>16.3 International Users</h3>
                <p>This Service is controlled and operated from the United States. If you access the Service from outside the United States, you do so at your own risk and are responsible for compliance with local laws.</p>

                <h2>17. Severability and Waiver</h2>

                <h3>17.1 Severability</h3>
                <p>If any provision of these Terms is found to be invalid, illegal, or unenforceable by a court of competent jurisdiction:</p>
                <ul>
                    <li>The invalid provision shall be modified to the minimum extent necessary to make it valid and enforceable</li>
                    <li>If modification is not possible, the invalid provision shall be severed from these Terms</li>
                    <li>The remaining provisions shall remain in full force and effect</li>
                    <li>The invalid provision shall not affect the validity or enforceability of any other provision</li>
                </ul>

                <h3>17.2 No Waiver</h3>
                <p>Our failure to enforce any provision of these Terms shall not constitute a waiver of that provision or any other provision. No waiver shall be effective unless made in writing and signed by an authorized representative of gasconsult.ai.</p>

                <h2>18. Changes to Terms</h2>
                <p>We reserve the right to modify, amend, or update these Terms at any time, in our sole discretion, with or without notice.</p>
                <p><strong>Changes shall be effective immediately upon posting to this page.</strong></p>
                <p>Your continued use of the Service after any changes constitutes your acceptance of the modified Terms. You are responsible for regularly reviewing these Terms. If you do not agree to modified Terms, you must immediately cease using the Service.</p>

                <h2>19. Contact Information</h2>
                <p>For questions, concerns, or notices regarding these Terms of Service, please contact us at:</p>
                <p><strong>Email:</strong> support@gasconsult.ai</p>
                <p><strong>Legal Notice Address:</strong> gasconsult.ai Legal Department</p>

                <div class="notice-box" style="margin-top: 48px;">
                    <h3>FINAL ACKNOWLEDGMENT</h3>
                    <p><strong>BY USING GASCONSULT.AI, YOU ACKNOWLEDGE THAT:</strong></p>
                    <ul style="margin-top: 12px;">
                        <li>You have read, understood, and agree to these Terms of Service in their entirety</li>
                        <li>You understand this Service does NOT provide medical advice and creates NO doctor-patient relationship</li>
                        <li>You will NOT use this Service for emergencies and will call 911 for emergencies</li>
                        <li>You understand AI can generate errors and inaccurate information</li>
                        <li>You will independently verify all information before any clinical application</li>
                        <li>You assume all risks and waive all claims against us</li>
                        <li>You agree to binding arbitration and waive your right to jury trial and class actions</li>
                        <li>You agree to indemnify and hold us harmless from all claims</li>
                    </ul>
                </div>

                <p style="margin-top: 32px; font-weight: 600; font-size: 14px; color: var(--gray-600); text-align: center;">These Terms of Service constitute the entire agreement between you and gasconsult.ai.</p>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const menu = e.target.nextElementSibling;
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('show'));
        });
    </script>
</body>
</html>
"""

PRIVACY_POLICY_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Policy - gasconsult.ai</title>

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>

        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Skip to Content Link for Accessibility */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--blue-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
            font-weight: 600;
            transition: top 0.2s;
        }

        .skip-to-content:focus {
            top: 0;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover { color: var(--gray-700); }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        @media (min-width: 768px) {
            .orb-1 { width: 600px; height: 600px; left: -10%; }
            .orb-2 { width: 450px; height: 450px; right: -10%; }
            .orb-3 { width: 400px; height: 400px; }
        }

        @media (min-width: 1024px) {
            .orb-1 { width: 800px; height: 800px; top: -20%; left: -10%; }
            .orb-2 { width: 600px; height: 600px; right: -15%; }
            .orb-3 { width: 500px; height: 500px; }
        }

        .main-content {
            flex: 1;
            padding: 100px 20px 40px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
        }

        h1 {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        h2 {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
            margin-top: 32px;
            margin-bottom: 16px;
        }

        h3 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: var(--gray-800);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        p {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 16px;
        }

        ul {
            margin: 16px 0;
            padding-left: 24px;
        }

        li {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        strong {
            font-weight: 600;
            color: var(--gray-900);
        }

        .last-updated {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 24px;
        }

        .highlight-box {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.15);
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
        }

        .highlight-box strong {
            color: var(--blue-700);
        }

        .highlight-box p {
            margin-bottom: 0;
        }

        .highlight-box ul {
            margin-top: 12px;
            margin-bottom: 0;
        }

        @media (min-width: 768px) {
            /* Show desktop navigation and hide mobile menu button */
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }

            .main-content { padding: 120px 32px 60px; }
            .content-card { padding: 40px; border-radius: 24px; }
            h1 { font-size: 40px; margin-bottom: 12px; }
            h2 { font-size: 26px; margin-top: 40px; margin-bottom: 20px; }
            h3 { font-size: 20px; margin-top: 28px; margin-bottom: 14px; }
            p { font-size: 16px; }
            li { font-size: 16px; }

            /* Footer desktop layout */
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
        }

        @media (min-width: 1024px) {
            .main-content { padding: 140px 40px 80px; max-width: 1000px; }
            .content-card { padding: 48px; }
            h1 { font-size: 48px; letter-spacing: -1.5px; }
        }

    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Verification Banner for Unverified Users -->
    {{ generate_verification_banner_html()|safe }}

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
            <div class="content-card">
                <h1>Privacy Policy</h1>
                <p class="last-updated">Last Updated: December 2025</p>

                <div class="highlight-box">
                    <strong>CRITICAL NOTICE:</strong> DO NOT enter any Protected Health Information (PHI) or personally identifiable patient data.
                    This is an educational tool only. We collect minimal technical data, use temporary session storage, and NEVER sell your information.
                </div>

                <p>
                    Welcome to gasconsult.ai ("we," "our," "us," or "the Service"). This Privacy Policy describes our practices regarding
                    the collection, use, disclosure, and protection of information when you use our anesthesiology consultation platform.
                </p>
                <p>
                    <strong>BY USING THIS SERVICE, YOU ACKNOWLEDGE THAT YOU HAVE READ, UNDERSTOOD, AND AGREE TO BE BOUND BY THIS PRIVACY POLICY.</strong>
                    If you do not agree with these terms, you must immediately discontinue use of the Service.
                </p>

                <h2>1. Information We Collect</h2>
                <p>
                    We practice data minimization and collect only information necessary to operate the Service. We DO NOT require user accounts
                    or registration. We DO NOT store long-term personal health information.
                </p>

                <h3>1.1 Information You Voluntarily Provide</h3>
                <ul>
                    <li><strong>Medical Queries:</strong> Clinical questions you submit about anesthesiology topics (stored temporarily during your session only)</li>
                    <li><strong>Form Inputs:</strong> Data entered into pre-operative assessment tools, clinical calculators, or hypotension predictors (processed in real-time, not permanently stored)</li>
                    <li><strong>Session Conversation History:</strong> Your chat interactions during an active browser session (automatically cleared when you close the browser or click "Clear Session")</li>
                </ul>

                <h3>1.2 Automatically Collected Technical Information</h3>
                <p>We automatically collect limited technical data for operational purposes:</p>
                <ul>
                    <li><strong>Usage Analytics:</strong> Pages visited, features accessed, button clicks, time spent on pages (anonymized and aggregated)</li>
                    <li><strong>Technical Logs:</strong> IP address (for rate limiting and abuse prevention), browser type and version, device type, operating system, referring URLs</li>
                    <li><strong>Performance Data:</strong> Page load times, error messages, API response times (used solely for debugging and service optimization)</li>
                    <li><strong>Session Cookies:</strong> Temporary session identifiers stored in your browser (required for chat functionality, automatically deleted on session end)</li>
                </ul>

                <h3>1.3 Information We DO NOT Collect</h3>
                <ul>
                    <li>User accounts, passwords, or login credentials (we do not have user registration)</li>
                    <li>Payment information (the Service is free)</li>
                    <li>Long-term storage of medical queries or conversation history</li>
                    <li>Biometric data, precise geolocation, or device fingerprinting beyond standard web analytics</li>
                    <li>Social media profiles or third-party account linkages</li>
                </ul>

                <h2>2. How We Use Your Information</h2>
                <p>We use collected information exclusively for the following legitimate purposes:</p>
                <ul>
                    <li><strong>Service Delivery:</strong> To process your queries, search PubMed medical literature, generate AI-assisted responses via OpenAI GPT-4o, and display clinical calculator results</li>
                    <li><strong>Session Management:</strong> To maintain conversation continuity during your active browser session</li>
                    <li><strong>Performance Improvement:</strong> To analyze anonymized usage patterns, identify bugs, optimize response times, and enhance user experience</li>
                    <li><strong>Security & Abuse Prevention:</strong> To detect malicious activity, prevent spam, enforce rate limits (60 requests/minute per IP), and protect against unauthorized access</li>
                    <li><strong>Legal Compliance:</strong> To comply with applicable laws, respond to lawful government requests, enforce our Terms of Service, and protect our legal rights</li>
                </ul>
                <p>
                    <strong>WE DO NOT:</strong> Sell your data to third parties, use your queries for targeted advertising, share identifiable information with data brokers,
                    or use your medical questions to train AI models (OpenAI's enterprise API does not train on customer data per their data processing agreement).
                </p>

                <h2>3. CRITICAL WARNING: Do Not Enter Protected Health Information (PHI)</h2>
                <div class="highlight-box">
                    <strong>⚠️ MANDATORY NOTICE:</strong> This Service is designed for educational and informational purposes ONLY.
                    <strong>You MUST NOT enter any Protected Health Information (PHI) or personally identifiable patient data.</strong>
                    <p style="margin-top: 12px;">Prohibited information includes, but is not limited to:</p>
                    <ul style="margin-top: 8px; margin-bottom: 12px;">
                        <li>Patient names, initials, medical record numbers (MRNs), account numbers, or any identifiers</li>
                        <li>Dates of birth, admission dates, discharge dates, dates of death, or ages over 89</li>
                        <li>Specific geographic locations smaller than a state (addresses, ZIP codes, GPS coordinates)</li>
                        <li>Telephone numbers, fax numbers, email addresses, Social Security numbers, insurance ID numbers</li>
                        <li>Photographs, videos, biometric identifiers (fingerprints, voice recordings, facial images)</li>
                        <li>Device identifiers (IP addresses in medical contexts), medical device serial numbers, URLs containing PHI</li>
                        <li>Any case-specific details that could reasonably identify an individual patient or provider</li>
                    </ul>
                    <p style="margin-top: 12px; margin-bottom: 0;">
                        <strong>You assume all risk and liability for any PHI you choose to enter.</strong> Use only hypothetical scenarios,
                        de-identified case presentations, or generalized clinical questions. If you accidentally enter PHI, immediately clear your session.
                    </p>
                </div>

                <h2>4. Third-Party Services and Data Sharing</h2>
                <p>We utilize the following third-party services to operate the platform. Your data may be transmitted to these providers:</p>

                <h3>4.1 OpenAI (GPT-4o AI Model)</h3>
                <ul>
                    <li><strong>Purpose:</strong> To generate evidence-based clinical responses using AI synthesis</li>
                    <li><strong>Data Shared:</strong> Your medical queries, conversation context, and PubMed search results</li>
                    <li><strong>Privacy Policy:</strong> <a href="https://openai.com/privacy" target="_blank" style="color: var(--blue-600); text-decoration: underline;">https://openai.com/privacy</a></li>
                    <li><strong>Data Training:</strong> Per OpenAI's Enterprise API terms, your queries are NOT used to train their AI models</li>
                    <li><strong>Location:</strong> OpenAI is a U.S.-based company with servers in the United States</li>
                </ul>

                <h3>4.2 NCBI PubMed / Entrez API</h3>
                <ul>
                    <li><strong>Purpose:</strong> To search medical literature databases for high-quality evidence (systematic reviews, meta-analyses, clinical trials)</li>
                    <li><strong>Data Shared:</strong> Your search queries (medical terms extracted from your questions)</li>
                    <li><strong>Privacy Policy:</strong> <a href="https://www.nlm.nih.gov/web_policies.html" target="_blank" style="color: var(--blue-600); text-decoration: underline;">https://www.nlm.nih.gov/web_policies.html</a></li>
                    <li><strong>Operator:</strong> U.S. National Library of Medicine (government agency)</li>
                </ul>

                <h3>4.3 No Other Third-Party Sharing</h3>
                <p>
                    We DO NOT sell, rent, lease, or trade your information to third parties for marketing purposes. We DO NOT share data with
                    advertisers, data brokers, or analytics companies beyond basic anonymized usage statistics. We may disclose information only if:
                </p>
                <ul>
                    <li><strong>Legal Obligation:</strong> Required by law, court order, subpoena, or government request</li>
                    <li><strong>Safety & Fraud Prevention:</strong> Necessary to prevent harm, investigate abuse, or protect legal rights</li>
                    <li><strong>Business Transfer:</strong> In the event of a merger, acquisition, or sale of assets (you will be notified)</li>
                </ul>

                <h2>5. Data Security and Limitations of Liability</h2>

                <h3>5.1 Security Measures We Implement</h3>
                <p>We employ industry-standard security practices to protect your information:</p>
                <ul>
                    <li><strong>Encryption in Transit:</strong> All data transmitted between your browser and our servers is encrypted using HTTPS/TLS 1.2+ protocols</li>
                    <li><strong>Server-Side Sessions:</strong> Conversation history is stored server-side (not in cookies), reducing client-side exposure</li>
                    <li><strong>Input Sanitization:</strong> All user inputs are sanitized using the Bleach library to prevent Cross-Site Scripting (XSS) attacks</li>
                    <li><strong>CSRF Protection:</strong> Flask-WTF token validation prevents Cross-Site Request Forgery attacks</li>
                    <li><strong>Rate Limiting:</strong> Flask-Limiter restricts requests to 60 per minute per IP address to prevent abuse and DDoS attacks</li>
                    <li><strong>Access Controls:</strong> Server infrastructure uses firewalls, SSH key authentication, and principle of least privilege</li>
                    <li><strong>Regular Updates:</strong> Dependencies and server software are regularly patched for security vulnerabilities</li>
                </ul>

                <h3>5.2 Limitations and Disclaimers</h3>
                <p>
                    <strong>NO GUARANTEE OF ABSOLUTE SECURITY:</strong> While we implement reasonable security measures, no method of internet transmission
                    or electronic storage is 100% secure. We cannot guarantee that unauthorized third parties will never defeat our security measures
                    or misuse your information.
                </p>
                <p>
                    <strong>DISCLAIMER OF LIABILITY FOR DATA BREACHES:</strong> TO THE MAXIMUM EXTENT PERMITTED BY LAW, WE DISCLAIM ALL LIABILITY
                    FOR ANY UNAUTHORIZED ACCESS, USE, DISCLOSURE, OR MODIFICATION OF YOUR DATA. BY USING THIS SERVICE, YOU ACKNOWLEDGE AND ACCEPT
                    THE INHERENT SECURITY RISKS OF INTERNET-BASED PLATFORMS.
                </p>
                <p>
                    <strong>USER RESPONSIBILITY:</strong> You are solely responsible for: (1) ensuring you do not enter PHI or sensitive personal information,
                    (2) using strong passwords if accessing the Service from shared devices, (3) logging out or clearing sessions after use on public computers,
                    and (4) maintaining the confidentiality of any information you choose to enter.
                </p>

                <h2>6. Data Retention and Deletion</h2>
                <ul>
                    <li><strong>Session Data (Chat History):</strong> Stored temporarily in server-side sessions during your active browser session. Automatically deleted when you close your browser, click "Clear Session," or after 24 hours of inactivity.</li>
                    <li><strong>System Logs:</strong> Technical logs (IP addresses, timestamps, error messages) are retained for 90 days for debugging, security monitoring, and abuse prevention, then permanently deleted.</li>
                    <li><strong>Analytics Data:</strong> Anonymized and aggregated usage statistics (page views, feature usage) are retained indefinitely for service improvement but cannot be traced back to individual users.</li>
                    <li><strong>No Long-Term Storage:</strong> We do NOT maintain databases of your medical queries, conversation transcripts, or form inputs beyond the temporary session duration.</li>
                    <li><strong>Manual Deletion:</strong> You can clear your session data at any time by clicking the "Clear Session" button in the chat interface or by closing your browser.</li>
                </ul>

                <h2>7. Your Privacy Rights (GDPR, CCPA, and Other Laws)</h2>
                <p>
                    Depending on your location, you may have specific privacy rights under laws such as the European Union's General Data Protection Regulation (GDPR),
                    California Consumer Privacy Act (CCPA), Virginia Consumer Data Protection Act (VCDPA), and similar state/international laws.
                </p>

                <h3>7.1 Rights for EU/EEA Users (GDPR)</h3>
                <p>If you are located in the European Union or European Economic Area, you have the following rights:</p>
                <ul>
                    <li><strong>Right of Access (Art. 15):</strong> Request confirmation of whether we process your data and obtain a copy</li>
                    <li><strong>Right to Rectification (Art. 16):</strong> Request correction of inaccurate or incomplete data</li>
                    <li><strong>Right to Erasure (Art. 17):</strong> Request deletion of your data ("right to be forgotten")</li>
                    <li><strong>Right to Restriction (Art. 18):</strong> Request limitation of processing under certain circumstances</li>
                    <li><strong>Right to Data Portability (Art. 20):</strong> Receive your data in a structured, machine-readable format</li>
                    <li><strong>Right to Object (Art. 21):</strong> Object to processing based on legitimate interests</li>
                    <li><strong>Right to Withdraw Consent (Art. 7):</strong> Withdraw consent at any time (does not affect prior processing)</li>
                    <li><strong>Right to Lodge a Complaint:</strong> File a complaint with your national data protection authority</li>
                </ul>

                <h3>7.2 Rights for California Users (CCPA/CPRA)</h3>
                <p>If you are a California resident, you have the following rights under the California Consumer Privacy Act:</p>
                <ul>
                    <li><strong>Right to Know:</strong> Request disclosure of categories and specific pieces of personal information we collect</li>
                    <li><strong>Right to Delete:</strong> Request deletion of your personal information (subject to exceptions)</li>
                    <li><strong>Right to Opt-Out:</strong> Opt-out of the "sale" or "sharing" of personal information (Note: We do NOT sell or share your data)</li>
                    <li><strong>Right to Correct:</strong> Request correction of inaccurate personal information</li>
                    <li><strong>Right to Non-Discrimination:</strong> Exercise privacy rights without receiving discriminatory treatment</li>
                </ul>

                <h3>7.3 How to Exercise Your Rights</h3>
                <p>
                    To submit a privacy rights request, email us at <strong>privacy@gasconsult.ai</strong> with the subject line "Privacy Rights Request."
                    Please include: (1) your name and contact information, (2) description of your request, (3) approximate dates of service usage (if known).
                </p>
                <p>
                    <strong>Important Limitation:</strong> Due to our minimal data collection practices (no user accounts, temporary session storage only),
                    we may have limited ability to identify or retrieve historical data associated with your use of the Service. In most cases, simply clearing
                    your browser session will delete all temporary data.
                </p>
                <p>
                    We will respond to verifiable requests within 30 days (GDPR) or 45 days (CCPA). We reserve the right to request additional information
                    to verify your identity before processing requests.
                </p>

                <h2>8. HIPAA Compliance and Limitations</h2>
                <p>
                    <strong>WE ARE NOT A HIPAA-COVERED ENTITY:</strong> gasconsult.ai is NOT a healthcare provider, health plan, or healthcare clearinghouse
                    as defined under the Health Insurance Portability and Accountability Act (HIPAA). We are NOT a "Business Associate" of any covered entity.
                </p>
                <p>
                    <strong>NO HIPAA PROTECTIONS APPLY:</strong> This Service does NOT provide HIPAA-compliant safeguards for Protected Health Information (PHI).
                    We do NOT sign Business Associate Agreements (BAAs). You MUST NOT use this Service to store, transmit, or process PHI.
                </p>
                <p>
                    <strong>HEALTHCARE PROFESSIONALS:</strong> If you are a healthcare provider, you are solely responsible for ensuring your use of this
                    Service complies with HIPAA and other applicable healthcare privacy laws. We recommend using only de-identified, hypothetical clinical
                    scenarios that cannot be traced to real patients.
                </p>

                <h2>9. Children's Privacy</h2>
                <p>
                    This Service is intended for use by healthcare professionals and adults seeking educational medical information. We do NOT knowingly
                    collect personal information from individuals under 18 years of age.
                </p>
                <p>
                    If we become aware that we have inadvertently collected information from a child under 18, we will take immediate steps to delete
                    such information from our systems. If you are a parent or guardian and believe your child has provided us with personal information,
                    please contact us at <strong>privacy@gasconsult.ai</strong>.
                </p>

                <h2>10. International Data Transfers</h2>
                <p>
                    This Service is operated from the United States. If you access the Service from outside the United States, your information will be
                    transferred to, stored, and processed in the United States where our servers and third-party service providers (OpenAI, hosting infrastructure) are located.
                </p>
                <p>
                    <strong>Data Protection Differences:</strong> The United States may not provide the same level of data protection as your home country,
                    particularly for users in the European Union. The U.S. is not subject to GDPR adequacy decisions for all data transfers.
                </p>
                <p>
                    <strong>Legal Basis for Transfers:</strong> By using this Service from outside the U.S., you explicitly consent to the transfer of your
                    information to the United States. We rely on standard contractual clauses with third-party providers where applicable.
                </p>

                <h2>11. Changes to This Privacy Policy</h2>
                <p>
                    We reserve the right to modify this Privacy Policy at any time, at our sole discretion, without prior notice. When we make changes,
                    we will update the "Last Updated" date at the top of this page.
                </p>
                <p>
                    <strong>Material Changes:</strong> For significant changes that materially affect your privacy rights, we will provide prominent notice
                    on the homepage or via other reasonable means. However, we are NOT obligated to provide individual notice.
                </p>
                <p>
                    <strong>Deemed Acceptance:</strong> Your continued use of the Service after changes are posted constitutes your acceptance of the revised
                    Privacy Policy. If you do not agree to the updated terms, you must immediately discontinue use.
                </p>
                <p>
                    <strong>Responsibility to Review:</strong> You are responsible for periodically reviewing this Privacy Policy to stay informed of updates.
                </p>

                <h2>12. Contact Information</h2>
                <p>If you have questions, concerns, or requests regarding this Privacy Policy or our data practices, please contact us:</p>
                <ul>
                    <li><strong>Email:</strong> privacy@gasconsult.ai</li>
                    <li><strong>Website:</strong> https://gasconsult.ai</li>
                    <li><strong>Response Time:</strong> We aim to respond to inquiries within 5-7 business days</li>
                </ul>
                <p>
                    For privacy rights requests (GDPR, CCPA), please use the subject line "Privacy Rights Request" and include the specific right you wish to exercise.
                </p>

                <h2>13. Severability and Governing Law</h2>
                <p>
                    If any provision of this Privacy Policy is found to be unlawful, void, or unenforceable, that provision shall be deemed severable and shall
                    not affect the validity and enforceability of the remaining provisions.
                </p>
                <p>
                    This Privacy Policy shall be governed by and construed in accordance with the laws of the United States and the State of [Your State],
                    without regard to conflict of law principles. Any disputes arising from this Privacy Policy shall be subject to the exclusive jurisdiction
                    of the courts located in [Your State].
                </p>

                <h2>14. Acknowledgment and Consent</h2>
                <p>
                    <strong>BY CLICKING "I ACCEPT," CONTINUING TO USE THE SERVICE, OR SUBMITTING ANY QUERIES, YOU ACKNOWLEDGE THAT:</strong>
                </p>
                <ul>
                    <li>You have read and understood this Privacy Policy in its entirety</li>
                    <li>You consent to the collection, use, and disclosure of your information as described herein</li>
                    <li>You understand that we are not a HIPAA-covered entity and do NOT provide HIPAA protections</li>
                    <li>You agree NOT to enter any Protected Health Information (PHI) or personally identifiable patient data</li>
                    <li>You accept the inherent security risks of internet-based services and our limitations of liability</li>
                    <li>You acknowledge that this is an educational tool only and NOT a substitute for professional medical advice</li>
                </ul>

                <div class="highlight-box" style="margin-top: 32px;">
                    <strong>Final Reminder:</strong> This Service provides educational information only and is NOT medical advice.
                    Always consult qualified healthcare professionals for clinical decision-making. NEVER enter PHI or patient-identifying information.
                    We prioritize your privacy, collect minimal data, and never sell your information.
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>
    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const menu = e.target.nextElementSibling;
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('show'));
        });
    </script>
</body>
</html>
"""

EVIDENCE_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence-Based Methodology - gasconsult.ai</title>

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
            --green-50: #ECFDF5;
            --green-500: #10B981;
            --green-600: #059669;
            --amber-50: #FFFBEB;
            --amber-500: #F59E0B;
            --amber-600: #D97706;
            --purple-50: #FAF5FF;
            --purple-500: #A855F7;
            --purple-600: #9333EA;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Skip to Content Link for Accessibility */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--blue-600);
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 0 0 4px 0;
            z-index: 1000;
            font-weight: 600;
            transition: top 0.2s;
        }

        .skip-to-content:focus {
            top: 0;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 100px 16px 40px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* Hero Section */
        .hero {
            text-align: center;
            margin-bottom: 48px;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid rgba(37, 99, 235, 0.2);
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
            color: var(--blue-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
        }

        .hero-badge svg {
            width: 16px;
            height: 16px;
        }

        .hero-title {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1.5px;
            color: var(--gray-900);
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .hero-title .gradient {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 15px;
            color: var(--gray-500);
            max-width: 700px;
            margin: 0 auto 28px;
            line-height: 1.6;
        }

        /* Content Cards */
        .content-card {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.9);
            border-radius: 24px;
            padding: 32px 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 24px 80px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
            margin-bottom: 24px;
        }

        .content-card h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 16px;
            letter-spacing: -0.5px;
        }

        .content-card p {
            font-size: 15px;
            color: var(--gray-600);
            line-height: 1.7;
            margin-bottom: 16px;
        }

        .content-card p:last-child {
            margin-bottom: 0;
        }

        /* Study Hierarchy */
        .hierarchy-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .hierarchy-item {
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
            transition: all 0.2s ease;
        }

        .hierarchy-item:hover {
            background: rgba(255,255,255,0.9);
            border-color: var(--gray-300);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .hierarchy-rank {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .hierarchy-rank.gold {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .hierarchy-rank.silver {
            background: linear-gradient(135deg, #6B7280 0%, #4B5563 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .hierarchy-rank.bronze {
            background: linear-gradient(135deg, #CD7F32 0%, #8B5A2B 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3);
        }

        .hierarchy-rank.standard {
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .hierarchy-content h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .hierarchy-content p {
            font-size: 14px;
            color: var(--gray-600);
            line-height: 1.6;
            margin: 0;
        }

        /* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            margin-top: 24px;
        }

        .feature-box {
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .feature-icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .feature-icon-box.blue {
            background: linear-gradient(135deg, var(--blue-500) 0%, var(--blue-600) 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .feature-icon-box.green {
            background: linear-gradient(135deg, var(--green-500) 0%, var(--green-600) 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .feature-icon-box.purple {
            background: linear-gradient(135deg, var(--purple-500) 0%, var(--purple-600) 100%);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .feature-icon-box.amber {
            background: linear-gradient(135deg, var(--amber-500) 0%, var(--amber-600) 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .feature-icon-box svg {
            width: 24px;
            height: 24px;
            stroke: white;
        }

        .feature-box-content h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .feature-box-content p {
            font-size: 14px;
            color: var(--gray-600);
            line-height: 1.6;
            margin: 0;
        }

        /* Code Block */
        .code-block {
            background: var(--gray-900);
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
            overflow-x: auto;
        }

        .code-block code {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            color: #93C5FD;
            line-height: 1.6;
        }

        /* Footer */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        /* Social Media Icons */
        
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }


        /* Responsive */
        @media (min-width: 640px) {
            .hierarchy-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }

            .main-content { padding: 120px 32px 60px; }

            .hero-title { font-size: 48px; }
            .hero-subtitle { font-size: 17px; }

            .content-card { padding: 40px; }

            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .main-content { padding: 140px 40px 80px; }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <!-- Navigation -->
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>

        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Hero -->
            <div class="hero">
                <div class="hero-badge">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        <line x1="8" y1="7" x2="16" y2="7"></line>
                        <line x1="8" y1="11" x2="16" y2="11"></line>
                    </svg>
                    <span>Evidence-Based</span>
                </div>
                <h1 class="hero-title">
                    Our <span class="gradient">Methodology</span>
                </h1>
                <p class="hero-subtitle">
                    Every answer on GasConsult.ai is backed by peer-reviewed medical literature from PubMed, stratified by study quality and research strength
                </p>
            </div>

            <!-- PubMed Integration -->
            <div class="content-card">
                <h2>PubMed Integration: How It Works</h2>
                <p>
                    When you ask a clinical question, GasConsult.ai doesn't rely on pre-trained knowledge or outdated information. Instead, we perform real-time searches of PubMed's database of over 35 million biomedical citations to find the most relevant, high-quality evidence.
                </p>
                <p>
                    Our intelligent search algorithm automatically expands medical abbreviations, applies anesthesia-specific filters, and prioritizes the highest levels of evidence to ensure you receive answers grounded in current, peer-reviewed research.
                </p>
            </div>

            <!-- Study Quality Hierarchy -->
            <div class="content-card">
                <h2>Evidence Hierarchy: How We Rank Studies</h2>
                <p>
                    Not all medical evidence is created equal. We stratify search results using the established evidence pyramid, prioritizing study designs with the highest methodological rigor and least susceptibility to bias.
                </p>

                <div class="hierarchy-grid">
                    <div class="hierarchy-item">
                        <div class="hierarchy-rank gold">1</div>
                        <div class="hierarchy-content">
                            <h3>Systematic Reviews & Meta-Analyses</h3>
                            <p>Comprehensive synthesis of multiple studies with statistical pooling. Highest level of evidence for clinical questions.</p>
                        </div>
                    </div>

                    <div class="hierarchy-item">
                        <div class="hierarchy-rank gold">2</div>
                        <div class="hierarchy-content">
                            <h3>Cochrane Reviews</h3>
                            <p>Gold-standard systematic reviews with rigorous methodology and regular updates to reflect new evidence.</p>
                        </div>
                    </div>

                    <div class="hierarchy-item">
                        <div class="hierarchy-rank silver">3</div>
                        <div class="hierarchy-content">
                            <h3>Randomized Controlled Trials (RCTs)</h3>
                            <p>Prospective studies with randomization and control groups. Minimizes bias and establishes causality.</p>
                        </div>
                    </div>

                    <div class="hierarchy-item">
                        <div class="hierarchy-rank bronze">4</div>
                        <div class="hierarchy-content">
                            <h3>Clinical Practice Guidelines</h3>
                            <p>Evidence-based recommendations from professional societies (ASA, ESA, etc.) synthesizing best practices.</p>
                        </div>
                    </div>

                    <div class="hierarchy-item">
                        <div class="hierarchy-rank standard">5</div>
                        <div class="hierarchy-content">
                            <h3>Cohort & Case-Control Studies</h3>
                            <p>Observational studies that analyze associations and outcomes in patient populations.</p>
                        </div>
                    </div>

                    <div class="hierarchy-item">
                        <div class="hierarchy-rank standard">6</div>
                        <div class="hierarchy-content">
                            <h3>Case Series & Expert Reviews</h3>
                            <p>Descriptive studies and expert opinion. Useful when higher-quality evidence is unavailable.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Strategy -->
            <div class="content-card">
                <h2>Intelligent Search Strategy</h2>
                <p>
                    Our PubMed search employs sophisticated filtering to maximize relevance and evidence quality:
                </p>

                <div class="features-grid">
                    <div class="feature-box">
                        <div class="feature-icon-box blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Anesthesia-First Filtering</h3>
                            <p>Searches prioritize anesthesiology-specific MeSH terms and journals before expanding to general medicine.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Study Type Prioritization</h3>
                            <p>Filters for systematic reviews, meta-analyses, RCTs, and Cochrane reviews before other study types.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box purple">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Recency Weighting (2015+)</h3>
                            <p>Focuses on studies published since 2015 to ensure recommendations reflect current medical practice.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box amber">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="7.5 4.21 12 6.81 16.5 4.21"></polyline>
                                <polyline points="7.5 19.79 7.5 14.6 3 12"></polyline>
                                <polyline points="21 12 16.5 14.6 16.5 19.79"></polyline>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Synonym Expansion</h3>
                            <p>Automatically expands medical abbreviations (e.g., "roc" → rocuronium, "TXA" → tranexamic acid) for comprehensive results.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Citation Quality -->
            <div class="content-card">
                <h2>Citation Transparency & Quality Indicators</h2>
                <p>
                    Every answer includes full citations with direct PubMed links, allowing you to verify sources instantly. We display confidence badges based on the quantity and quality of retrieved evidence:
                </p>

                <div class="features-grid">
                    <div class="feature-box">
                        <div class="feature-icon-box green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                                <path d="m9 12 2 2 4-4"></path>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>High Confidence</h3>
                            <p>10+ high-quality papers including systematic reviews or meta-analyses. Evidence is robust and well-established.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box amber">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 8v4"></path>
                                <path d="M12 16h.01"></path>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Moderate Confidence</h3>
                            <p>5-10 papers with mixed study types. Evidence exists but may be less conclusive or require clinical judgment.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Low Confidence</h3>
                            <p>Fewer than 5 papers or limited study types. Evidence is emerging or question is poorly studied. Use with caution.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box purple">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>Full Reference List</h3>
                            <p>Each answer displays complete citations with title, authors, journal, year, and clickable PubMed ID for verification.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Example Search -->
            <div class="content-card">
                <h2>Example: Real-Time PubMed Query</h2>
                <p>
                    When you ask "What's the evidence for TXA in spine surgery?", here's what happens:
                </p>
                <div class="code-block">
                    <code>
1. Query Expansion: "TXA" → "tranexamic acid"<br>
2. PubMed Search Filters:<br>
   - Study types: Systematic Review, Meta-Analysis, RCT<br>
   - Field: anesthesiology, spine surgery<br>
   - Date range: 2015-2025<br>
3. Retrieve Top 20 Results<br>
4. Extract Metadata: Title, Authors, PMID, Year, Abstract<br>
5. GPT-4o Synthesis: Analyze papers, synthesize answer<br>
6. Output: Evidence-based answer + Full citations<br>
7. Confidence Badge: High (15 RCTs + 3 meta-analyses found)
                    </code>
                </div>
            </div>

            <!-- AI Self-Verification Protocol -->
            <div class="content-card">
                <h2>AI Self-Verification & Quality Assurance</h2>
                <p>
                    To minimize errors and ensure clinical accuracy, every AI-generated response undergoes a rigorous internal self-verification protocol before being presented. This multi-layered quality control system operates transparently within each answer generation process.
                </p>

                <div class="features-grid">
                    <div class="feature-box">
                        <div class="feature-icon-box green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>1. Dosing Accuracy Verification</h3>
                            <p>All drug doses are cross-checked against ASA guidelines, FDA package inserts, and major anesthesiology textbooks (Miller's, Barash, Stoelting's). Out-of-range doses trigger automatic correction.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>2. Contraindication & Safety Check</h3>
                            <p>Before finalizing answers, the AI explicitly verifies that absolute contraindications are mentioned and critical safety warnings are not omitted. Missing warnings trigger revision.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box purple">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                <line x1="9" y1="10" x2="15" y2="10"></line>
                                <line x1="9" y1="14" x2="15" y2="14"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>3. Citation Verification Protocol</h3>
                            <p>Each cited paper's abstract is verified to ACTUALLY support the specific claim made. Citations that don't directly support statements are automatically removed to prevent misleading references.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box amber">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>4. Guideline Consistency Check</h3>
                            <p>Answers are cross-referenced against current ASA, ESA, and specialty society guidelines. Conflicts with established practice guidelines trigger clarification or revision.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>5. Self-Questioning Protocol</h3>
                            <p>The AI asks itself "How do I know this is correct?" before each answer. Uncertain claims are either verified against provided papers or explicitly acknowledged as uncertain.</p>
                        </div>
                    </div>

                    <div class="feature-box">
                        <div class="feature-icon-box blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <path d="m9 11 3 3L22 4"></path>
                            </svg>
                        </div>
                        <div class="feature-box-content">
                            <h3>6. Completeness Validation</h3>
                            <p>For dosing questions: verified inclusion of route, typical range, and maximum doses. For safety questions: confirmed coverage of both common and serious risks.</p>
                        </div>
                    </div>
                </div>

                <p style="margin-top: 1.5rem;">
                    <strong>Dynamic Precision Control:</strong> The AI's response temperature (creativity vs. precision) is automatically adjusted based on query type. Dosing questions use ultra-low temperature (0.05) for exact accuracy, while safety questions use 0.1 for factual rigor. This ensures clinical precision where it matters most.
                </p>
            </div>

            <!-- Limitations -->
            <div class="content-card">
                <h2>Limitations & Responsible Use</h2>
                <p>
                    While our methodology maximizes evidence quality, users should be aware of important limitations:
                </p>
                <p>
                    <strong>• Not a substitute for clinical judgment:</strong> Evidence-based answers inform, but never replace, individualized patient assessment and decision-making.
                </p>
                <p>
                    <strong>• Publication bias:</strong> Published literature may overrepresent positive findings and underrepresent negative or null results.
                </p>
                <p>
                    <strong>• AI synthesis limitations:</strong> GPT-4o may occasionally misinterpret nuanced findings or fail to capture context that experts would recognize.
                </p>
                <p>
                    <strong>• Rapidly evolving field:</strong> New evidence emerges constantly. Always verify critical decisions with the latest guidelines and institutional protocols.
                </p>
                <p>
                    <strong>• Educational tool only:</strong> GasConsult.ai is designed for learning and clinical decision support, not as a diagnostic or treatment tool.
                </p>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        }
    </script>
</body>
</html>
"""

CRISIS_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Crisis Protocols | gasconsult.ai</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="description" content="Comprehensive evidence-based anesthesia crisis protocols for OR emergencies - ACLS, malignant hyperthermia, LAST, difficult airway, and more.">
    <style>
        :root {
            --gray-50: #F8FAFC; --gray-100: #F1F5F9; --gray-200: #E2E8F0; --gray-300: #CBD5E1;
            --gray-400: #94A3B8; --gray-500: #64748B; --gray-600: #475569; --gray-700: #334155; --gray-900: #0F172A;
            --blue-50: #EFF6FF; --blue-600: #2563EB; --blue-700: #1D4ED8;
            --red-50: #FEF2F2; --red-500: #EF4444; --red-600: #DC2626;
            --orange-50: #FFF7ED; --orange-500: #F97316; --orange-600: #EA580C;
            --yellow-50: #FEFCE8; --yellow-500: #EAB308;
            --green-50: #F0FDF4; --green-600: #16A34A;
            --purple-50: #FAF5FF; --purple-500: #A855F7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(180deg, #F0F7FF 0%, #F8FAFC 100%);
            min-height: 100vh;
            color: var(--gray-900);
            -webkit-font-smoothing: antialiased;
        }

        .page { position: relative; z-index: 2; display: flex; flex-direction: column; min-height: 100vh; }

        /* Navigation */
        .nav { position: fixed; top: 0; left: 0; right: 0; z-index: 100; padding: 12px 16px; }
        .nav-inner {
            max-width: 1200px; margin: 0 auto; height: 56px;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px; padding: 0 16px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }
        .logo { display: flex; align-items: center; gap: 14px; text-decoration: none; }
        .logo-icon { display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 36px; height: 12px; }
        .logo-text { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; color: var(--gray-900); }
        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15,23,42,0.4); }
        .nav-links { display: none; align-items: center; gap: 4px; }
        .nav-link {
            padding: 10px 18px; font-size: 14px; font-weight: 500;
            color: var(--gray-600); text-decoration: none; border-radius: 12px;
            transition: all 0.2s ease;
        }
        .nav-link:hover { color: var(--gray-900); background: rgba(0,0,0,0.04); }
        .nav-link.active { color: var(--blue-600); background: var(--blue-50); }
        .nav-dropdown { position: relative; display: inline-block; }
        .nav-dropdown-toggle { cursor: pointer; background: none; border: none; font-family: inherit; }
        .nav-dropdown-menu {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 4px;
            background: white;
            border: 1px solid var(--gray-200); border-radius: 12px;
            min-width: 200px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000; overflow: hidden;
        }
        .nav-dropdown-menu.show { display: block; }
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600); background: var(--blue-50);
        }
        .nav-dropdown-link {
            display: block; padding: 12px 18px; color: var(--gray-600);
            text-decoration: none; font-size: 14px; font-weight: 500;
            transition: all 0.2s ease;
        }
        .nav-dropdown-link:hover { color: var(--gray-900); background: rgba(0,0,0,0.04); }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex; flex-direction: column; gap: 5px;
            background: none; border: none; cursor: pointer; padding: 8px;
            border-radius: 8px; transition: background 0.2s ease;
        }
        .mobile-menu-btn:hover { background: rgba(0,0,0,0.04); }
        .mobile-menu-btn span { width: 22px; height: 2px; background: var(--gray-700); border-radius: 1px; transition: all 0.3s ease; }
        .mobile-menu {
            position: fixed; top: 80px; left: 16px; right: 16px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px; padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            display: none; flex-direction: column; gap: 4px; z-index: 99;
        }
        .mobile-menu.active { display: flex; }
        .mobile-menu-link {
            padding: 14px 16px; color: var(--gray-700); text-decoration: none;
            border-radius: 12px; font-size: 15px; font-weight: 500;
            transition: all 0.2s ease;
        }
        .mobile-menu-link:hover { color: var(--gray-900); background: rgba(0,0,0,0.04); }

        /* Main Content */
        main { padding: 90px 16px 40px; max-width: 1400px; margin: 0 auto; flex: 1; }

        /* Hero */
        .hero {
            text-align: center;
            margin-bottom: 40px;
            padding: 0 4px;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 8px 16px 8px 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) forwards;
            opacity: 0;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--red-500);
            border-radius: 50%;
            position: relative;
        }

        .badge-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: var(--red-500);
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        .badge-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .hero h1 {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -1.5px;
            color: var(--gray-900);
            margin-bottom: 12px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.1s forwards;
            opacity: 0;
        }

        .hero h1 .gradient {
            background: linear-gradient(135deg, var(--red-600), var(--orange-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 16px;
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-600);
            max-width: 600px;
            margin: 0 auto;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.2s forwards;
            opacity: 0;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Search Box - Mobile First (Large Touch Target) */
        .search-container {
            position: sticky; top: 80px; z-index: 50;
            margin-bottom: 32px; padding: 0 4px;
        }
        .search-box {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 14px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 2px solid var(--gray-200);
            display: flex; align-items: center; gap: 12px;
        }
        .search-icon {
            width: 20px; height: 20px; color: var(--gray-400);
            flex-shrink: 0;
        }
        .search-input {
            width: 100%; border: none; background: none;
            font-size: 16px; outline: none; color: var(--gray-900);
            font-family: inherit;
        }
        .search-input::placeholder { color: var(--gray-400); }
        .search-clear {
            background: var(--gray-200); border: none; border-radius: 50%;
            width: 24px; height: 24px; cursor: pointer; display: none;
            align-items: center; justify-content: center;
            color: var(--gray-600); font-size: 14px; font-weight: 700;
        }
        .search-clear.visible { display: flex; }

        /* Category Section */
        .category { margin-bottom: 48px; }
        .category-header {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 20px; padding: 0 4px;
        }
        .category-icon {
            width: 48px; height: 48px; border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .category-icon svg { width: 24px; height: 24px; }
        .category-icon.red { background: var(--red-50); color: var(--red-600); }
        .category-icon.orange { background: var(--orange-50); color: var(--orange-600); }
        .category-icon.yellow { background: var(--yellow-50); color: var(--yellow-500); }
        .category-icon.purple { background: var(--purple-50); color: var(--purple-500); }
        .category-title {
            font-size: 20px; font-weight: 700; color: var(--gray-900);
        }
        .category-count {
            margin-left: auto; font-size: 13px; font-weight: 600;
            color: var(--gray-500); padding: 4px 12px;
            background: var(--gray-100); border-radius: 12px;
        }

        /* Protocol Cards - Mobile First */
        .protocols-grid {
            display: grid; gap: 12px;
        }
        .protocol-card {
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 20px;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 2px solid var(--gray-200);
            min-height: 56px;
        }
        .protocol-card:active { transform: scale(0.98); }
        .protocol-card.expanded {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            border-color: var(--blue-600);
        }

        .protocol-header {
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 12px;
        }
        .protocol-title-group { flex: 1; }
        .protocol-title {
            font-size: 17px; font-weight: 700;
            color: var(--gray-900); margin-bottom: 8px;
            line-height: 1.3;
        }
        .protocol-badge {
            display: inline-block; padding: 4px 10px;
            border-radius: 8px; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .protocol-badge.critical { background: var(--red-50); color: var(--red-600); }
        .protocol-badge.urgent { background: var(--orange-50); color: var(--orange-600); }
        .protocol-badge.important { background: var(--yellow-50); color: var(--yellow-500); }

        .protocol-summary {
            font-size: 14px; color: var(--gray-600);
            line-height: 1.5; margin-top: 8px;
        }
        .expand-icon {
            width: 32px; height: 32px; border-radius: 10px;
            background: var(--gray-100); display: flex;
            align-items: center; justify-content: center;
            flex-shrink: 0; transition: all 0.3s;
        }
        .expand-icon svg { width: 18px; height: 18px; transition: transform 0.3s; }
        .protocol-card.expanded .expand-icon { background: var(--blue-600); color: white; }
        .protocol-card.expanded .expand-icon svg { transform: rotate(180deg); }

        /* Protocol Content */
        .protocol-content {
            display: none; margin-top: 24px;
            padding-top: 20px; border-top: 2px solid var(--gray-200);
        }
        .protocol-card.expanded .protocol-content { display: block; }

        .protocol-steps {
            list-style: none; counter-reset: step;
            margin-bottom: 20px;
        }
        .protocol-step {
            counter-increment: step; padding-left: 44px;
            position: relative; margin-bottom: 18px;
            font-size: 15px; line-height: 1.6; color: var(--gray-700);
        }
        .protocol-step:before {
            content: counter(step); position: absolute;
            left: 0; top: -2px; width: 32px; height: 32px;
            background: var(--blue-600); color: white;
            border-radius: 50%; display: flex;
            align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
        }
        .protocol-step strong { color: var(--gray-900); font-weight: 700; }

        /* Dose Box */
        .dose-box {
            background: linear-gradient(135deg, var(--blue-50) 0%, rgba(239,246,255,0.5) 100%);
            border-left: 4px solid var(--blue-600);
            padding: 18px; border-radius: 12px; margin-bottom: 20px;
        }
        .dose-title {
            font-size: 14px; font-weight: 700;
            color: var(--blue-700); margin-bottom: 12px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .dose-item {
            font-size: 14px; color: var(--gray-700);
            margin-bottom: 8px; line-height: 1.5;
        }
        .dose-item:last-child { margin-bottom: 0; }
        .dose-item strong { color: var(--gray-900); font-weight: 700; }

        /* Warning Box */
        .warning-box {
            background: linear-gradient(135deg, var(--red-50) 0%, rgba(254,242,242,0.5) 100%);
            border-left: 4px solid var(--red-600);
            padding: 16px; border-radius: 12px; margin-bottom: 20px;
            display: flex; gap: 12px;
        }
        .warning-icon {
            width: 24px; height: 24px; color: var(--red-600);
            flex-shrink: 0;
        }
        .warning-text {
            font-size: 14px; color: var(--red-600);
            line-height: 1.5; font-weight: 500;
        }

        /* References */
        .references {
            border-top: 2px solid var(--gray-200);
            padding-top: 16px; margin-top: 20px;
        }
        .references-title {
            font-size: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--gray-500); margin-bottom: 12px;
        }
        .reference {
            font-size: 12px; color: var(--gray-600);
            line-height: 1.6; margin-bottom: 10px;
            padding-left: 18px; position: relative;
        }
        .reference:before {
            content: "•"; position: absolute; left: 0;
            color: var(--blue-600); font-weight: 700;
        }
        .reference:last-child { margin-bottom: 0; }

        /* No Results Message */
        .no-results {
            text-align: center; padding: 60px 20px;
            display: none;
        }
        .no-results.visible { display: block; }
        .no-results-icon {
            width: 64px; height: 64px; margin: 0 auto 16px;
            color: var(--gray-300);
        }
        .no-results-title {
            font-size: 20px; font-weight: 700;
            color: var(--gray-900); margin-bottom: 8px;
        }
        .no-results-text {
            font-size: 15px; color: var(--gray-600);
        }

        /* Footer */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }
        .footer-inner {
            max-width: 1200px; margin: 0 auto;
            display: flex; flex-direction: column;
            align-items: center; gap: 20px; text-align: center;
        }
        .footer-text { font-size: 13px; color: var(--gray-500); }
        .social-icons {
            display: flex; gap: 20px;
            justify-content: center; align-items: center;
        }
        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }
        .social-icon svg { width: 24px; height: 24px; }
        .footer-links { display: flex; gap: 24px; }
        .footer-link {
            font-size: 13px; color: var(--gray-500);
            text-decoration: none; transition: color 0.2s ease;
        }
        .footer-link:hover { color: var(--gray-700); }

        /* Desktop Styles */
        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            main { padding: 110px 32px 60px; }
            .hero { margin-bottom: 48px; }
            .hero-badge { padding: 10px 20px 10px 14px; margin-bottom: 24px; }
            .badge-dot { width: 10px; height: 10px; }
            .badge-text { font-size: 13px; }
            .hero h1 { font-size: 48px; letter-spacing: -2px; margin-bottom: 16px; }
            .hero p { font-size: 18px; }
            .search-container { padding: 0; }
            .protocols-grid { grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .protocols-grid { grid-template-columns: repeat(3, 1fr); }
            .footer { padding: 48px 40px; }
        }
    </style>
</head>
<body>
    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link active">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>

        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link" style="background:var(--blue-50);color:var(--blue-600);font-weight:600;">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main>
            <div class="hero">
                <div class="hero-badge">
                    <div class="badge-dot"></div>
                    <span class="badge-text">Emergency Resources</span>
                </div>
                <h1><span class="gradient">Anesthesia Crisis</span> Protocols</h1>
                <p>Evidence-based emergency management for operating room crises</p>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search protocols..." oninput="filterProtocols()">
                    <button class="search-clear" id="searchClear" onclick="clearSearch()" aria-label="Clear search">×</button>
                </div>
            </div>

            <div class="no-results" id="noResults">
                <svg class="no-results-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="no-results-title">No protocols found</div>
                <div class="no-results-text">Try a different search term</div>
            </div>

            <!-- CARDIAC/CIRCULATORY EMERGENCIES -->
            <div class="category">
                <div class="category-header">
                    <div class="category-icon red">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <h2 class="category-title">Cardiac/Circulatory</h2>
                    <span class="category-count">10</span>
                </div>
                <div class="protocols-grid" data-category="cardiac">

                    <!-- Cardiac Arrest -->
                    <div class="protocol-card" data-keywords="cardiac arrest cpr acls resuscitation vfib vtach pea asystole epinephrine">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Cardiac Arrest (ACLS)</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">High-quality CPR with rhythm-specific advanced life support</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Start CPR immediately:</strong> 100-120 compressions/min, depth 2-2.4 inches (5-6 cm), allow full chest recoil</li>
                                <li class="protocol-step"><strong>Call for help</strong> - Get code cart, defibrillator, and additional personnel</li>
                                <li class="protocol-step"><strong>Attach defibrillator/monitor:</strong> Identify rhythm (shockable vs non-shockable)</li>
                                <li class="protocol-step"><strong>Secure airway:</strong> ETT or LMA with ETCO₂ monitoring (target 35-40 mmHg)</li>
                                <li class="protocol-step"><strong>Establish IV/IO access</strong></li>
                                <li class="protocol-step"><strong>Epinephrine 1 mg IV/IO</strong> every 3-5 minutes</li>
                                <li class="protocol-step"><strong>If VF/pulseless VT:</strong> Defibrillate at maximum energy, give amiodarone 300 mg IV after 3rd shock</li>
                                <li class="protocol-step"><strong>Treat reversible causes</strong> (H's and T's): Hypovolemia, Hypoxia, H⁺ (acidosis), Hypo/hyperkalemia, Hypothermia, Tension pneumothorax, Tamponade, Toxins, Thrombosis</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Key Medications</div>
                                <div class="dose-item"><strong>Epinephrine:</strong> 1 mg IV/IO every 3-5 minutes</div>
                                <div class="dose-item"><strong>Amiodarone:</strong> 300 mg IV (first dose), then 150 mg IV (second dose) for VF/pulseless VT</div>
                                <div class="dose-item"><strong>Sodium Bicarbonate:</strong> 1 mEq/kg IV for known hyperkalemia or severe acidosis</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Panchal AR, et al. Part 3: Adult Basic and Advanced Life Support: 2020 American Heart Association Guidelines for CPR and Emergency Cardiovascular Care. Circulation. 2020;142(16_suppl_2):S366-S468. PMID: 33081529</div>
                                <div class="reference">Soar J, et al. European Resuscitation Council Guidelines 2021: Adult advanced life support. Resuscitation. 2021;161:115-151. PMID: 33773825</div>
                            </div>
                        </div>
                    </div>

                    <!-- Venous Air Embolism -->
                    <div class="protocol-card" data-keywords="air embolism vae gas embolus sitting position neurosurgery venous">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Venous Air Embolism</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Air entrainment into venous system causing cardiovascular collapse</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Alert surgeon immediately</strong> - Stop further air entrainment</li>
                                <li class="protocol-step"><strong>Flood surgical field with saline</strong></li>
                                <li class="protocol-step"><strong>100% FiO₂</strong></li>
                                <li class="protocol-step"><strong>Discontinue N₂O immediately</strong> (if in use)</li>
                                <li class="protocol-step"><strong>Lower head/raise feet</strong> (Trendelenburg position) if possible</li>
                                <li class="protocol-step"><strong>Attempt to aspirate air</strong> via CVL if present</li>
                                <li class="protocol-step"><strong>Support hemodynamics:</strong> Fluids, vasopressors, consider CPR if cardiovascular collapse</li>
                                <li class="protocol-step"><strong>Durant position</strong> (left lateral decubitus) may trap air in right ventricle</li>
                            </ol>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">High risk in sitting position neurosurgery. Monitor with precordial Doppler and ETCO₂. Sudden decrease in ETCO₂, hypotension, and mill-wheel murmur are classic signs.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Mirski MA, et al. Diagnosis and treatment of vascular air embolism. Anesthesiology. 2007;106(1):164-177. PMID: 17197859</div>
                                <div class="reference">Shaikh N, Ummunisa F. Acute management of vascular air embolism. J Emerg Trauma Shock. 2009;2(3):180-185. PMID: 20009307</div>
                            </div>
                        </div>
                    </div>

                    <!-- Massive Hemorrhage -->
                    <div class="protocol-card" data-keywords="hemorrhage bleeding massive transfusion protocol mtp blood loss shock">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Massive Hemorrhage</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Activate massive transfusion protocol, balanced resuscitation</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Activate Massive Transfusion Protocol (MTP)</strong> immediately</li>
                                <li class="protocol-step"><strong>Large bore IV access</strong> (2× 16-18G or central line)</li>
                                <li class="protocol-step"><strong>Balanced transfusion ratio 1:1:1</strong> - pRBCs : FFP : platelets</li>
                                <li class="protocol-step"><strong>Tranexamic acid (TXA) 1 g IV</strong> over 10 minutes, then 1 g over 8 hours</li>
                                <li class="protocol-step"><strong>Permissive hypotension</strong> (SBP 80-90) until hemorrhage control if no TBI</li>
                                <li class="protocol-step"><strong>Calcium chloride 1 g IV</strong> with each 4 units pRBCs</li>
                                <li class="protocol-step"><strong>Monitor labs:</strong> ABG, Hgb, platelets, PT/PTT, fibrinogen, ionized calcium</li>
                                <li class="protocol-step"><strong>Consider recombinant Factor VIIa</strong> if refractory coagulopathy</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Critical Medications</div>
                                <div class="dose-item"><strong>Tranexamic Acid (TXA):</strong> 1 g IV over 10 min (loading), then 1 g over 8 hours</div>
                                <div class="dose-item"><strong>Calcium Chloride:</strong> 1 g IV after every 4 units pRBCs</div>
                                <div class="dose-item"><strong>Fibrinogen:</strong> Target >200 mg/dL (cryoprecipitate 10 units or fibrinogen concentrate)</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Spahn DR, et al. The European guideline on management of major bleeding and coagulopathy following trauma: fifth edition. Crit Care. 2019;23(1):98. PMID: 30917843</div>
                                <div class="reference">CRASH-2 trial collaborators. Effects of tranexamic acid on death, vascular occlusive events, and blood transfusion in trauma patients with significant haemorrhage (CRASH-2): Lancet. 2010;376(9734):23-32. PMID: 20554319</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Cardiac Protocols (compact versions) -->
                    <div class="protocol-card" data-keywords="bradycardia heart rate slow atropine pacing">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Severe Bradycardia</div>
                                <span class="protocol-badge urgent">Urgent</span>
                                <div class="protocol-summary">HR <40 with hemodynamic instability</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Atropine 0.5-1 mg IV</strong> (repeat q3-5min, max 3 mg)</li>
                                <li class="protocol-step"><strong>Epinephrine infusion 2-10 mcg/min</strong> if atropine fails</li>
                                <li class="protocol-step"><strong>Transcutaneous pacing</strong> if refractory</li>
                                <li class="protocol-step"><strong>Glycopyrrolate 0.2-0.4 mg IV</strong> alternative to atropine</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Medications</div>
                                <div class="dose-item"><strong>Atropine:</strong> 0.5-1 mg IV push (max 3 mg total)</div>
                                <div class="dose-item"><strong>Epinephrine drip:</strong> 2-10 mcg/min IV</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Kusumoto FM, et al. 2018 ACC/AHA/HRS Guideline on the Evaluation and Management of Patients With Bradycardia and Cardiac Conduction Delay. Circulation. 2019;140(8):e382-e482. PMID: 30586772</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ventricular Tachycardia/Fibrillation -->
                    <div class="protocol-card" data-keywords="ventricular tachycardia vt vfib fibrillation defibrillation cardioversion amiodarone">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Ventricular Tachycardia/Fibrillation</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Immediate defibrillation for pulseless VT/VF</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Check pulse</strong> - If pulseless, start CPR immediately</li>
                                <li class="protocol-step"><strong>Defibrillate 200J</strong> biphasic (360J monophasic), resume CPR immediately</li>
                                <li class="protocol-step"><strong>Epinephrine 1 mg IV</strong> every 3-5 minutes during CPR</li>
                                <li class="protocol-step"><strong>After 2nd shock: Amiodarone 300 mg IV push</strong></li>
                                <li class="protocol-step"><strong>If stable VT with pulse: Synchronized cardioversion 100J,</strong> increase as needed</li>
                                <li class="protocol-step"><strong>For monomorphic VT: Amiodarone 150 mg IV over 10 min,</strong> then 1 mg/min infusion</li>
                                <li class="protocol-step"><strong>Treat reversible causes:</strong> Electrolytes (K⁺, Mg²⁺), ischemia, drugs</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Key Medications</div>
                                <div class="dose-item"><strong>Amiodarone:</strong> 300 mg IV (first dose), 150 mg IV (second dose) for VF/VT</div>
                                <div class="dose-item"><strong>Lidocaine (alternative):</strong> 1-1.5 mg/kg IV, then 0.5-0.75 mg/kg q5-10min (max 3 mg/kg)</div>
                                <div class="dose-item"><strong>Magnesium:</strong> 2 g IV over 10 min for Torsades de Pointes</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Panchal AR, et al. Part 3: Adult Basic and Advanced Life Support: 2020 AHA Guidelines. Circulation. 2020;142(16_suppl_2):S366-S468. PMID: 33081529</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hypertensive Emergency -->
                    <div class="protocol-card" data-keywords="hypertensive emergency crisis high blood pressure sbp nicardipine labetalol">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Hypertensive Emergency</div>
                                <span class="protocol-badge urgent">Urgent</span>
                                <div class="protocol-summary">Severe hypertension with end-organ damage</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Assess for end-organ damage:</strong> MI, stroke, aortic dissection, pulmonary edema</li>
                                <li class="protocol-step"><strong>Deepen anesthesia</strong> if intraoperative</li>
                                <li class="protocol-step"><strong>First-line: Nicardipine 5 mg/hr IV infusion,</strong> titrate by 2.5 mg/hr q5-15min (max 15 mg/hr)</li>
                                <li class="protocol-step"><strong>Alternative: Labetalol 10-20 mg IV bolus,</strong> then 20-80 mg q10min or infusion 0.5-2 mg/min</li>
                                <li class="protocol-step"><strong>Goal: Reduce MAP by 20-25% over first hour</strong> (avoid precipitous drops)</li>
                                <li class="protocol-step"><strong>Avoid in aortic dissection:</strong> Use beta-blocker first (esmolol), then vasodilator</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Antihypertensive Options</div>
                                <div class="dose-item"><strong>Nicardipine:</strong> 5-15 mg/hr IV infusion (preferred)</div>
                                <div class="dose-item"><strong>Labetalol:</strong> 10-20 mg IV, then 20-80 mg q10min or 0.5-2 mg/min infusion</div>
                                <div class="dose-item"><strong>Esmolol:</strong> 500 mcg/kg load, then 50-300 mcg/kg/min (aortic dissection)</div>
                                <div class="dose-item"><strong>Hydralazine:</strong> 5-20 mg IV (avoid in CAD/aortic dissection)</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Whelton PK, et al. 2017 ACC/AHA Guideline for the Prevention, Detection, Evaluation, and Management of High Blood Pressure in Adults. Hypertension. 2018;71(6):e13-e115. PMID: 29133356</div>
                            </div>
                        </div>
                    </div>

                    <!-- Myocardial Infarction -->
                    <div class="protocol-card" data-keywords="myocardial infarction mi heart attack stemi chest pain ischemia troponin">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Myocardial Infarction/Ischemia</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Perioperative MI - Optimize oxygen supply/demand</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Call for help,</strong> get cardiology consultation</li>
                                <li class="protocol-step"><strong>12-lead ECG,</strong> troponin (stat and serial)</li>
                                <li class="protocol-step"><strong>Aspirin 325 mg PO/PR</strong> (if not contraindicated)</li>
                                <li class="protocol-step"><strong>100% oxygen,</strong> maintain SpO₂ >90%</li>
                                <li class="protocol-step"><strong>Optimize hemodynamics:</strong> HR 60-80, SBP 100-140, avoid tachycardia/hypertension</li>
                                <li class="protocol-step"><strong>Nitroglycerin 0.5-10 mcg/kg/min IV</strong> for ongoing ischemia (if SBP >100)</li>
                                <li class="protocol-step"><strong>Beta-blocker:</strong> Metoprolol 2.5-5 mg IV or esmolol infusion (if no contraindications)</li>
                                <li class="protocol-step"><strong>If STEMI: Activate cath lab</strong> for emergency PCI (suspend surgery if possible)</li>
                                <li class="protocol-step"><strong>Consider heparin 60 units/kg IV bolus</strong> (max 4000 units) in consultation with cardiology</li>
                            </ol>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Perioperative MI has high mortality. STEMI requires emergent intervention. Avoid hypotension, tachycardia, and increased myocardial oxygen demand. Consider aborting/delaying elective surgery.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Devereaux PJ, et al. Association of Postoperative High-Sensitivity Troponin Levels With Myocardial Injury and 30-Day Mortality Among Patients Undergoing Noncardiac Surgery. JAMA. 2017;317(16):1642-1651. PMID: 28444280</div>
                                <div class="reference">Fleisher LA, et al. 2014 ACC/AHA Guideline on Perioperative Cardiovascular Evaluation. Circulation. 2014;130(24):e278-e333. PMID: 25085961</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- AIRWAY/RESPIRATORY EMERGENCIES -->
            <div class="category">
                <div class="category-header">
                    <div class="category-icon orange">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h2 class="category-title">Airway/Respiratory</h2>
                    <span class="category-count">9</span>
                </div>
                <div class="protocols-grid" data-category="airway">

                    <!-- Can't Intubate Can't Oxygenate -->
                    <div class="protocol-card" data-keywords="cico cant intubate oxygenate cricothyroidotomy surgical airway emergency">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Can't Intubate Can't Oxygenate (CICO)</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Emergency front-of-neck access (eFONA) - cricothyroidotomy</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Declare CICO</strong> - Call for help and surgical airway equipment</li>
                                <li class="protocol-step"><strong>Continue face mask ventilation/oxygenation attempts</strong> during preparation</li>
                                <li class="protocol-step"><strong>Position:</strong> Extend neck, palpate cricothyroid membrane</li>
                                <li class="protocol-step"><strong>Scalpel technique (preferred):</strong> Transverse stab incision through cricothyroid membrane</li>
                                <li class="protocol-step"><strong>Insert tracheal hook</strong> to stabilize larynx</li>
                                <li class="protocol-step"><strong>Insert bougie</strong> caudally into trachea</li>
                                <li class="protocol-step"><strong>Railroad 6.0 cuffed ETT</strong> over bougie into trachea</li>
                                <li class="protocol-step"><strong>Confirm placement:</strong> Capnography, bilateral breath sounds</li>
                            </ol>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Time is critical. Do NOT delay surgical airway if unable to ventilate. Scalpel cricothyroidotomy is preferred over needle technique in adults.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Frerk C, et al. Difficult Airway Society 2015 guidelines for management of unanticipated difficult intubation in adults. Br J Anaesth. 2015;115(6):827-848. PMID: 26556848</div>
                                <div class="reference">Apfelbaum JL, et al. 2022 American Society of Anesthesiologists Practice Guidelines for Management of the Difficult Airway. Anesthesiology. 2022;136(1):31-81. PMID: 34762729</div>
                            </div>
                        </div>
                    </div>

                    <!-- Laryngospasm -->
                    <div class="protocol-card" data-keywords="laryngospasm stridor airway obstruction vocal cords spasm cpap">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Laryngospasm</div>
                                <span class="protocol-badge urgent">Urgent</span>
                                <div class="protocol-summary">Involuntary closure of vocal cords causing airway obstruction</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Remove stimulus</strong> (suction secretions, stop surgical stimulation)</li>
                                <li class="protocol-step"><strong>100% oxygen</strong> via face mask</li>
                                <li class="protocol-step"><strong>Jaw thrust with CPAP</strong> (positive pressure 15-20 cm H₂O)</li>
                                <li class="protocol-step"><strong>Larson maneuver:</strong> Apply firm pressure to "laryngospasm notch" (behind angle of mandible)</li>
                                <li class="protocol-step"><strong>If persists: Propofol 0.5-1 mg/kg IV</strong></li>
                                <li class="protocol-step"><strong>If severe/refractory: Succinylcholine 0.1-0.5 mg/kg IV</strong> (or 4 mg/kg IM if no IV)</li>
                                <li class="protocol-step"><strong>Prepare for intubation</strong> if giving muscle relaxant</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Medications</div>
                                <div class="dose-item"><strong>Propofol:</strong> 0.5-1 mg/kg IV (deepens anesthesia)</div>
                                <div class="dose-item"><strong>Succinylcholine:</strong> 0.1-0.5 mg/kg IV or 4 mg/kg IM (last resort)</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Gavel G, Walker RWM. Laryngospasm in anaesthesia. Contin Educ Anaesth Crit Care Pain. 2014;14(2):47-51.</div>
                                <div class="reference">Visvanathan T, et al. Laryngospasm: review of different prevention and treatment modalities. Paediatr Anaesth. 2015;25(3):4-7-12. PMID: 25580984</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bronchospasm -->
                    <div class="protocol-card" data-keywords="bronchospasm wheezing asthma airway reactivity albuterol">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Bronchospasm</div>
                                <span class="protocol-badge urgent">Urgent</span>
                                <div class="protocol-summary">Acute airway constriction with wheezing and increased airway pressure</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>100% FiO₂</strong></li>
                                <li class="protocol-step"><strong>Deepen anesthesia:</strong> Increase volatile agent or propofol bolus</li>
                                <li class="protocol-step"><strong>Albuterol inhaler or nebulizer</strong> (4-8 puffs MDI or 2.5-5 mg nebulized)</li>
                                <li class="protocol-step"><strong>Hand ventilation</strong> - Allow prolonged expiration, avoid air trapping</li>
                                <li class="protocol-step"><strong>If severe: Epinephrine 10-50 mcg IV</strong> (or 0.3-0.5 mg IM)</li>
                                <li class="protocol-step"><strong>Consider: Ketamine 0.5-1 mg/kg IV, Magnesium 2 g IV over 20 min</strong></li>
                                <li class="protocol-step"><strong>Rule out other causes:</strong> ETT malposition, pneumothorax, aspiration, anaphylaxis</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Key Medications</div>
                                <div class="dose-item"><strong>Albuterol:</strong> 4-8 puffs MDI or 2.5-5 mg nebulized</div>
                                <div class="dose-item"><strong>Epinephrine:</strong> 10-50 mcg IV bolus or 0.3 mg IM</div>
                                <div class="dose-item"><strong>Ketamine:</strong> 0.5-1 mg/kg IV (bronchodilator)</div>
                                <div class="dose-item"><strong>Magnesium sulfate:</strong> 2 g IV over 20 minutes</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Woods BD, Sladen RN. Perioperative considerations for the patient with asthma and bronchospasm. Br J Anaesth. 2009;103 Suppl 1:i57-65. PMID: 20007991</div>
                            </div>
                        </div>
                    </div>

                    <!-- Aspiration -->
                    <div class="protocol-card" data-keywords="aspiration gastric contents vomit regurgitation pneumonitis">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Pulmonary Aspiration</div>
                                <span class="protocol-badge urgent">Urgent</span>
                                <div class="protocol-summary">Aspiration of gastric contents - supportive care</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Immediate head-down tilt</strong> (Trendelenburg) if possible</li>
                                <li class="protocol-step"><strong>Suction oropharynx and airway immediately</strong></li>
                                <li class="protocol-step"><strong>100% oxygen,</strong> prepare for intubation if not already intubated</li>
                                <li class="protocol-step"><strong>If intubated: Suction ETT,</strong> consider bronchoscopy to remove particulate matter</li>
                                <li class="protocol-step"><strong>Positive pressure ventilation</strong> with PEEP as needed for oxygenation</li>
                                <li class="protocol-step"><strong>CXR, ABG</strong> to assess severity</li>
                                <li class="protocol-step"><strong>Supportive care:</strong> Maintain oxygenation/ventilation, fluid management</li>
                                <li class="protocol-step"><strong>Do NOT give prophylactic antibiotics or steroids routinely</strong> (no proven benefit)</li>
                                <li class="protocol-step"><strong>Monitor for ARDS, pneumonia</strong> (may develop over 24-72 hours)</li>
                            </ol>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Aspiration pneumonitis (chemical injury) develops within 2 hours. Aspiration pneumonia (bacterial infection) develops over 24-72 hours. Treatment is primarily supportive. Avoid routine antibiotics/steroids unless infection develops.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Warner MA, et al. Perioperative Pulmonary Aspiration in Infants and Children. Anesthesiology. 1999;90(1):66-71. PMID: 9915314</div>
                                <div class="reference">Nason KS. Acute Intraoperative Pulmonary Aspiration. Thorac Surg Clin. 2015;25(3):301-307. PMID: 26210928</div>
                            </div>
                        </div>
                    </div>

                    <!-- Pneumothorax -->
                    <div class="protocol-card" data-keywords="pneumothorax tension ptx chest tube needle decompression">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Tension Pneumothorax</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Immediate needle decompression - life-threatening emergency</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Clinical diagnosis:</strong> Hypoxia, hypotension, tracheal deviation, unilateral absent breath sounds, increased peak pressures</li>
                                <li class="protocol-step"><strong>Do NOT wait for CXR confirmation</strong> if tension pneumothorax suspected</li>
                                <li class="protocol-step"><strong>Immediate needle decompression:</strong> 14-16G IV catheter in 2nd intercostal space, midclavicular line</li>
                                <li class="protocol-step"><strong>100% oxygen</strong></li>
                                <li class="protocol-step"><strong>Definitive treatment: Chest tube placement</strong> (4th-5th intercostal space, anterior axillary line)</li>
                                <li class="protocol-step"><strong>If bilateral breath sounds absent:</strong> Consider bilateral pneumothoraces, mainstem intubation, or equipment failure</li>
                            </ol>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Tension pneumothorax is a clinical diagnosis requiring immediate treatment. Do NOT delay for imaging. Can occur with central line placement, positive pressure ventilation, trauma, or rib fractures.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Roberts DJ, et al. Anesthesia-related Pneumothorax. Anesth Analg. 2003;96(2):516-522. PMID: 12538205</div>
                                <div class="reference">Leigh-Smith S, Harris T. Tension pneumothorax--time for a re-think? Emerg Med J. 2005;22(1):8-16. PMID: 15611534</div>
                            </div>
                        </div>
                    </div>

                    <!-- Severe Hypoxemia -->
                    <div class="protocol-card" data-keywords="hypoxemia desaturation low oxygen saturation spo2 hypoxia">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Severe Hypoxemia</div>
                                <span class="protocol-badge urgent">Urgent</span>
                                <div class="protocol-summary">Rapid systematic approach to desaturation</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Increase FiO₂ to 100%</strong> immediately</li>
                                <li class="protocol-step"><strong>Check: Airway patency, ETT position,</strong> bilateral breath sounds</li>
                                <li class="protocol-step"><strong>Hand ventilate</strong> to assess compliance and rule out circuit disconnect</li>
                                <li class="protocol-step"><strong>Check circuit connections,</strong> oxygen source, fresh gas flow</li>
                                <li class="protocol-step"><strong>Suction airway</strong> if secretions present</li>
                                <li class="protocol-step"><strong>Auscultate:</strong> Rule out mainstem intubation, bronchospasm, pneumothorax</li>
                                <li class="protocol-step"><strong>Consider:</strong> Pulmonary embolism, aspiration, atelectasis, pulmonary edema</li>
                                <li class="protocol-step"><strong>Recruitment maneuvers</strong> (sustained inflation 30-40 cm H₂O for 30 sec) if atelectasis</li>
                                <li class="protocol-step"><strong>Add PEEP</strong> (5-10 cm H₂O initially)</li>
                                <li class="protocol-step"><strong>ABG, CXR</strong> to guide further management</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Systematic Approach (DOPE)</div>
                                <div class="dose-item"><strong>D</strong>isplaced ETT (mainstem, esophageal)</div>
                                <div class="dose-item"><strong>O</strong>bstruction (secretions, kinked tube, bronchospasm)</div>
                                <div class="dose-item"><strong>P</strong>neumothorax</div>
                                <div class="dose-item"><strong>E</strong>quipment failure (circuit, ventilator, O₂ source)</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Whiteley JP, et al. The Investigation and Management of Intraoperative Hypoxemia. BJA Educ. 2016;16(5):170-174.</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- METABOLIC/TOXIC EMERGENCIES -->
            <div class="category">
                <div class="category-header">
                    <div class="category-icon yellow">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                        </svg>
                    </div>
                    <h2 class="category-title">Metabolic/Toxic</h2>
                    <span class="category-count">7</span>
                </div>
                <div class="protocols-grid" data-category="metabolic">

                    <!-- Malignant Hyperthermia -->
                    <div class="protocol-card" data-keywords="malignant hyperthermia mh dantrolene hypermetabolic crisis temperature succinylcholine sevoflurane">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Malignant Hyperthermia</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Life-threatening hypermetabolic crisis - Dantrolene immediately</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>STOP all triggering agents immediately:</strong> Discontinue volatile anesthetics and succinylcholine</li>
                                <li class="protocol-step"><strong>Call for help and MH cart</strong> - Call MH Hotline: 1-800-644-9737</li>
                                <li class="protocol-step"><strong>Hyperventilate with 100% O₂</strong> (≥10 L/min, 2-3× minute ventilation)</li>
                                <li class="protocol-step"><strong>DANTROLENE 2.5 mg/kg IV rapid push</strong> - Repeat every 5 min until signs resolve (max 10 mg/kg)</li>
                                <li class="protocol-step"><strong>Abort/complete surgery</strong> as rapidly as possible</li>
                                <li class="protocol-step"><strong>Active cooling:</strong> IV cold saline, ice packs to groin/axilla, cool lavage</li>
                                <li class="protocol-step"><strong>Treat hyperkalemia:</strong> Insulin + glucose, calcium chloride, bicarbonate, avoid calcium channel blockers</li>
                                <li class="protocol-step"><strong>Treat acidosis:</strong> Sodium bicarbonate for pH <7.2</li>
                                <li class="protocol-step"><strong>Monitor:</strong> Core temp q5min, ABG, K⁺, CK, myoglobin, urine output >2 mL/kg/hr</li>
                                <li class="protocol-step"><strong>Continue dantrolene 1 mg/kg IV q6h × 24-48 hours</strong> to prevent recurrence</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Dantrolene Dosing (CRITICAL)</div>
                                <div class="dose-item"><strong>Initial:</strong> 2.5 mg/kg IV rapid push, repeat q5min until resolution</div>
                                <div class="dose-item"><strong>Maximum:</strong> Up to 10 mg/kg total dose</div>
                                <div class="dose-item"><strong>Maintenance:</strong> 1 mg/kg IV q6h × 24-48 hours after crisis</div>
                                <div class="dose-item"><strong>Mixing:</strong> Each vial (20 mg) requires 60 mL sterile water (many vials needed)</div>
                            </div>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Classic signs: Unexplained tachycardia, hypercarbia (rising ETCO₂ despite increased ventilation), masseter muscle rigidity, hyperthermia (late sign). DO NOT wait for fever - treat on suspicion. Mortality 10-15% if untreated.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Rosenberg H, et al. Malignant hyperthermia: a review. Orphanet J Rare Dis. 2015;10:93. PMID: 26238698</div>
                                <div class="reference">Hopkins PM, et al. Malignant hyperthermia 2020: Guideline from the Association of Anaesthetists. Anaesthesia. 2021;76(5):655-664. PMID: 33280086</div>
                                <div class="reference">Malignant Hyperthermia Association of the United States (MHAUS). Emergency Therapy for Malignant Hyperthermia. www.mhaus.org</div>
                            </div>
                        </div>
                    </div>

                    <!-- Local Anesthetic Systemic Toxicity -->
                    <div class="protocol-card" data-keywords="last local anesthetic systemic toxicity lipid emulsion intralipid seizure cardiac arrest bupivacaine ropivacaine">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Local Anesthetic Systemic Toxicity (LAST)</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">CNS/cardiac toxicity from local anesthetic - Give lipid emulsion</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>STOP local anesthetic injection immediately</strong></li>
                                <li class="protocol-step"><strong>Call for help and lipid emulsion (20% Intralipid)</strong></li>
                                <li class="protocol-step"><strong>Airway management:</strong> Ventilate with 100% O₂, consider intubation early</li>
                                <li class="protocol-step"><strong>Seizure treatment:</strong> Benzodiazepines (midazolam, lorazepam), small dose propofol ONLY if needed</li>
                                <li class="protocol-step"><strong>LIPID EMULSION 20% (Intralipid):</strong> 1.5 mL/kg IV bolus over 1 min (~100 mL for 70 kg adult)</li>
                                <li class="protocol-step"><strong>Start lipid infusion:</strong> 0.25 mL/kg/min (~18 mL/min for 70 kg)</li>
                                <li class="protocol-step"><strong>If cardiovascular instability persists:</strong> Repeat bolus q3-5min, increase infusion to 0.5 mL/kg/min</li>
                                <li class="protocol-step"><strong>Maximum dose:</strong> ~10 mL/kg over first 30 minutes</li>
                                <li class="protocol-step"><strong>If cardiac arrest: Continue CPR and lipid therapy</strong> (may need prolonged resuscitation)</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Lipid Emulsion 20% Dosing</div>
                                <div class="dose-item"><strong>Bolus:</strong> 1.5 mL/kg IV over 1 minute (100 mL for 70 kg)</div>
                                <div class="dose-item"><strong>Infusion:</strong> 0.25 mL/kg/min (increase to 0.5 mL/kg/min if needed)</div>
                                <div class="dose-item"><strong>Repeat bolus:</strong> Every 3-5 minutes if persistent instability</div>
                                <div class="dose-item"><strong>Maximum:</strong> ~10 mL/kg over 30 minutes (~700 mL for 70 kg)</div>
                            </div>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Early signs: Circumoral numbness, metallic taste, tinnitus, confusion, seizures. Late signs: Cardiovascular collapse, arrhythmias, cardiac arrest. AVOID propofol (lipid-based), vasopressin, and calcium channel blockers. Prolonged CPR may be required.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Neal JM, et al. American Society of Regional Anesthesia and Pain Medicine Checklist for Managing Local Anesthetic Systemic Toxicity: 2017 Version. Reg Anesth Pain Med. 2018;43(2):113-123. PMID: 29239945</div>
                                <div class="reference">American Society of Regional Anesthesia and Pain Medicine. LAST Checklist. www.asra.com/guidelines-articles/guidelines</div>
                            </div>
                        </div>
                    </div>

                    <!-- Anaphylaxis -->
                    <div class="protocol-card" data-keywords="anaphylaxis allergic reaction hypersensitivity epinephrine urticaria bronchospasm hypotension">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Anaphylaxis</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Severe systemic allergic reaction - Epinephrine first-line</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>STOP suspected triggering agent</strong> immediately</li>
                                <li class="protocol-step"><strong>Call for help</strong></li>
                                <li class="protocol-step"><strong>EPINEPHRINE first-line treatment</strong> - See dosing below</li>
                                <li class="protocol-step"><strong>Airway management:</strong> 100% O₂, consider early intubation (airway edema may worsen)</li>
                                <li class="protocol-step"><strong>Aggressive fluid resuscitation:</strong> 1-2 L crystalloid rapid bolus (may need 4-6 L total)</li>
                                <li class="protocol-step"><strong>Elevate legs</strong> (Trendelenburg if hypotensive)</li>
                                <li class="protocol-step"><strong>H1 blocker:</strong> Diphenhydramine 25-50 mg IV</li>
                                <li class="protocol-step"><strong>H2 blocker:</strong> Ranitidine 50 mg or famotidine 20 mg IV</li>
                                <li class="protocol-step"><strong>Steroids:</strong> Hydrocortisone 100-200 mg IV or methylprednisolone 125 mg IV</li>
                                <li class="protocol-step"><strong>Send tryptase levels:</strong> Immediately, at 1-2 hours, and at 24 hours</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Epinephrine Dosing (CRITICAL)</div>
                                <div class="dose-item"><strong>Mild (conscious, urticaria, angioedema):</strong> 50-100 mcg IV (or 0.3-0.5 mg IM)</div>
                                <div class="dose-item"><strong>Moderate (hypotension, bronchospasm):</strong> 100-200 mcg IV bolus, repeat q2-3min</div>
                                <div class="dose-item"><strong>Severe (cardiac arrest, profound shock):</strong> 1 mg IV, start epinephrine infusion 0.05-0.5 mcg/kg/min</div>
                                <div class="dose-item"><strong>Infusion:</strong> 4-10 mcg/min IV, titrate to effect</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Mertes PM, et al. Perioperative anaphylaxis. Immunol Allergy Clin North Am. 2009;29(3):429-451. PMID: 19563990</div>
                                <div class="reference">Harper NJN, et al. Anaesthesia, surgery, and life-threatening allergic reactions: management of perioperative anaphylaxis. Anaesthesia. 2018;73(8):1007-1014. PMID: 29974440</div>
                            </div>
                        </div>
                    </div>

                    <!-- Hyperkalemia -->
                    <div class="protocol-card" data-keywords="hyperkalemia potassium high elevated k ecg peaked t waves">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Hyperkalemia</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Life-threatening K⁺ >6.5 - cardiac membrane stabilization first</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>ECG immediately:</strong> Look for peaked T waves, widened QRS, prolonged PR</li>
                                <li class="protocol-step"><strong>If ECG changes: Calcium chloride 1 g IV</strong> (or calcium gluconate 3 g IV) over 2-3 min - cardiac membrane stabilization (does NOT lower K⁺)</li>
                                <li class="protocol-step"><strong>Shift K⁺ intracellularly: Insulin 10 units IV + D50W 25 g IV</strong> (onset 15-30 min, lasts 4-6 hours)</li>
                                <li class="protocol-step"><strong>Hyperventilate</strong> to create respiratory alkalosis (temporary measure)</li>
                                <li class="protocol-step"><strong>Sodium bicarbonate 50 mEq IV</strong> if metabolic acidosis present</li>
                                <li class="protocol-step"><strong>Albuterol 10-20 mg nebulized</strong> (shifts K⁺ into cells)</li>
                                <li class="protocol-step"><strong>Stop all K⁺ sources</strong> (IV fluids, blood products, succinylcholine)</li>
                                <li class="protocol-step"><strong>Definitive treatment:</strong> Consider dialysis for refractory hyperkalemia or renal failure</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Treatment Sequence</div>
                                <div class="dose-item"><strong>1. Calcium Chloride:</strong> 1 g IV (10 mL of 10%) over 2-3 min - FIRST for cardiac protection</div>
                                <div class="dose-item"><strong>2. Insulin + Dextrose:</strong> 10 units regular insulin IV + 25 g D50W (50 mL) IV</div>
                                <div class="dose-item"><strong>3. Bicarbonate:</strong> 50 mEq (1 amp) IV if acidotic</div>
                                <div class="dose-item"><strong>4. Albuterol:</strong> 10-20 mg nebulized continuously</div>
                            </div>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Succinylcholine-induced hyperkalemia can occur in burns, crush injuries, denervation, prolonged immobility. Peaked T waves and widened QRS are ominous signs requiring immediate calcium. Recheck K⁺ after treatment.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Alfonzo AV, et al. Potassium Disorders--Clinical Spectrum and Emergency Management. Resuscitation. 2006;70(1):10-25. PMID: 16730126</div>
                                <div class="reference">Parham WA, et al. Hyperkalemia Revisited. Texas Heart Inst J. 2006;33(1):40-47. PMID: 16572868</div>
                            </div>
                        </div>
                    </div>

                    <!-- Transfusion Reaction -->
                    <div class="protocol-card" data-keywords="transfusion reaction blood hemolytic trali taco allergic">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Acute Transfusion Reaction</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">STOP transfusion immediately - identify reaction type</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>STOP transfusion immediately</strong> - Preserve IV access with saline</li>
                                <li class="protocol-step"><strong>Check patient ID and blood product labeling</strong> for ABO incompatibility</li>
                                <li class="protocol-step"><strong>Notify blood bank</strong> - Send blood bag and tubing for analysis</li>
                                <li class="protocol-step"><strong>Send labs:</strong> CBC, coags, LDH, haptoglobin, direct Coombs, urine hemoglobin</li>
                                <li class="protocol-step"><strong>If hemolytic reaction suspected:</strong> Maintain urine output >1 mL/kg/hr with fluids/diuretics, alkalinize urine</li>
                                <li class="protocol-step"><strong>If allergic:</strong> Diphenhydramine 25-50 mg IV, steroids, epinephrine if anaphylaxis</li>
                                <li class="protocol-step"><strong>If TRALI (pulmonary edema without fluid overload):</strong> Supportive care, oxygen, mechanical ventilation as needed</li>
                                <li class="protocol-step"><strong>If TACO (fluid overload):</strong> Diuretics, upright positioning</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Reaction Types & Treatment</div>
                                <div class="dose-item"><strong>Hemolytic (ABO incompatibility):</strong> Aggressive fluids, maintain UOP, alkalinize urine</div>
                                <div class="dose-item"><strong>Allergic/Anaphylactic:</strong> Diphenhydramine, steroids, epinephrine if severe</div>
                                <div class="dose-item"><strong>TRALI:</strong> Supportive care, mechanical ventilation (usually resolves in 48-96 hours)</div>
                                <div class="dose-item"><strong>TACO:</strong> Diuretics (furosemide 20-40 mg IV)</div>
                            </div>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Acute hemolytic transfusion reaction is life-threatening. Classic signs: fever, hypotension, tachycardia, hemoglobinuria (pink/red urine), DIC. Under anesthesia, may only see unexplained hypotension, bleeding, or hemoglobinuria.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Tobian AAR, et al. Transfusion-Related Acute Lung Injury. N Engl J Med. 2019;381(19):1849-1859. PMID: 31693808</div>
                                <div class="reference">Sandler SG, et al. Strategies to Prevent Transfusion-Related Acute Lung Injury. Vox Sang. 2005;88(3):137-142. PMID: 15787717</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- NEURAXIAL COMPLICATIONS -->
            <div class="category">
                <div class="category-header">
                    <div class="category-icon purple">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                    <h2 class="category-title">Neuraxial Complications</h2>
                    <span class="category-count">2</span>
                </div>
                <div class="protocols-grid" data-category="neuraxial">

                    <!-- High/Total Spinal -->
                    <div class="protocol-card" data-keywords="high spinal total spinal epidural hypotension bradycardia respiratory arrest intubation">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">High/Total Spinal</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Excessive neuraxial blockade - Supportive care and intubation</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>Call for help</strong></li>
                                <li class="protocol-step"><strong>Airway management:</strong> Prepare for intubation (respiratory muscle paralysis likely)</li>
                                <li class="protocol-step"><strong>100% oxygen</strong> - Assist/control ventilation as needed</li>
                                <li class="protocol-step"><strong>Cardiovascular support:</strong> Aggressive fluid resuscitation</li>
                                <li class="protocol-step"><strong>Vasopressors:</strong> Ephedrine 5-10 mg IV or phenylephrine 100-200 mcg IV</li>
                                <li class="protocol-step"><strong>Atropine 0.4-0.6 mg IV</strong> for bradycardia</li>
                                <li class="protocol-step"><strong>Position:</strong> Supine (avoid Trendelenburg - worsens block)</li>
                                <li class="protocol-step"><strong>Reassure patient</strong> (may be conscious but unable to breathe/speak)</li>
                                <li class="protocol-step"><strong>Sedation if needed:</strong> After securing airway, small doses midazolam/propofol</li>
                                <li class="protocol-step"><strong>Monitor until block recedes</strong> (2-3 hours typical)</li>
                            </ol>
                            <div class="dose-box">
                                <div class="dose-title">Key Medications</div>
                                <div class="dose-item"><strong>Ephedrine:</strong> 5-10 mg IV bolus (repeat as needed)</div>
                                <div class="dose-item"><strong>Phenylephrine:</strong> 100-200 mcg IV bolus (or infusion 0.5-1 mcg/kg/min)</div>
                                <div class="dose-item"><strong>Atropine:</strong> 0.4-0.6 mg IV for bradycardia</div>
                            </div>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">Symptoms: Dyspnea, difficulty speaking, upper extremity weakness, nausea, hypotension, bradycardia, loss of consciousness. Patient may be awake but unable to breathe. DO NOT delay intubation.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Reina MA, et al. Clinical implications of epidural fat in the spinal canal. A scanning electron microscopic study. Acta Anaesthesiol Belg. 2009;60(1):7-17. PMID: 19459550</div>
                                <div class="reference">Guay J. The epidural test dose: a review. Anesth Analg. 2006;102(3):921-929. PMID: 16492853</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- ENVIRONMENTAL EMERGENCIES -->
            <div class="category">
                <div class="category-header">
                    <div class="category-icon orange">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"></path>
                        </svg>
                    </div>
                    <h2 class="category-title">Environmental/Equipment</h2>
                    <span class="category-count">2</span>
                </div>
                <div class="protocols-grid" data-category="environmental">

                    <!-- Operating Room Fire -->
                    <div class="protocol-card" data-keywords="or fire operating room fire airway fire oxygen surgical fire emergency">
                        <div class="protocol-header" onclick="toggleCard(this.parentElement)">
                            <div class="protocol-title-group">
                                <div class="protocol-title">Operating Room Fire</div>
                                <span class="protocol-badge critical">Critical</span>
                                <div class="protocol-summary">Fire triad: oxygen + fuel + ignition source</div>
                            </div>
                            <div class="expand-icon">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="protocol-content">
                            <ol class="protocol-steps">
                                <li class="protocol-step"><strong>IF AIRWAY FIRE - Remove ETT immediately,</strong> stop flow of all airway gases</li>
                                <li class="protocol-step"><strong>Stop oxygen/gas flow to fire</strong></li>
                                <li class="protocol-step"><strong>Remove burning material from patient</strong></li>
                                <li class="protocol-step"><strong>Extinguish fire with saline or CO₂ extinguisher</strong></li>
                                <li class="protocol-step"><strong>If airway fire: Re-examine airway, assess for thermal injury, consider bronchoscopy</strong></li>
                                <li class="protocol-step"><strong>If fire not controlled: Evacuate patient from OR,</strong> activate fire alarm, close OR doors</li>
                                <li class="protocol-step"><strong>Turn off medical gas supply to room</strong></li>
                                <li class="protocol-step"><strong>Assess patient for burns/smoke inhalation</strong></li>
                            </ol>
                            <div class="warning-box">
                                <svg class="warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                                <div class="warning-text">High-risk scenarios: Head/neck surgery with supplemental O₂, electrocautery near oxygen source, alcohol-based prep solutions not fully dried. Communicate "fire risk" with surgical team before high-risk cases.</div>
                            </div>
                            <div class="references">
                                <div class="references-title">Evidence-Based References</div>
                                <div class="reference">Apfelbaum JL, et al. Practice Advisory for the Prevention and Management of Operating Room Fires: 2013. Anesthesiology. 2013;118(2):271-290. PMID: 23287706</div>
                                <div class="reference">ECRI Institute. New clinical guide to surgical fire prevention. Health Devices. 2009;38(10):314-332. PMID: 19927557</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Educational Disclaimer -->
            <div style="margin: 60px auto; max-width: 800px; padding: 24px; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); border-radius: 16px; border: 2px solid var(--gray-200); text-align: center;">
                <svg style="width: 48px; height: 48px; margin: 0 auto 16px; color: var(--blue-600);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 style="font-size: 18px; font-weight: 700; color: var(--gray-900); margin-bottom: 12px;">Educational Resource Only</h3>
                <p style="font-size: 14px; color: var(--gray-600); line-height: 1.6;">
                    These protocols are evidence-based educational resources synthesized from published guidelines. They are <strong>NOT medical advice</strong> and should not replace clinical judgment or institutional protocols. Always verify doses and follow your institution's emergency management procedures. For life-threatening emergencies, follow ACLS/PALS guidelines and call for immediate help.
                </p>
            </div>

        </main>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('active');
        }

        // Navbar dropdown toggle
        function toggleNavDropdown(e) {
            e.stopPropagation();
            const dropdown = e.target.closest('.nav-dropdown');
            const menu = dropdown.querySelector('.nav-dropdown-menu');
            menu.classList.toggle('show');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(evt) {
                if (!dropdown.contains(evt.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        // Toggle protocol card expansion
        function toggleCard(card) {
            // Close all other expanded cards first (optional - for one-at-a-time UX)
            // document.querySelectorAll('.protocol-card.expanded').forEach(c => {
            //     if (c !== card) c.classList.remove('expanded');
            // });

            card.classList.toggle('expanded');

            // Scroll expanded card into view on mobile
            if (card.classList.contains('expanded') && window.innerWidth < 768) {
                setTimeout(() => {
                    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        }

        // Search/filter protocols
        function filterProtocols() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            const clearBtn = document.getElementById('searchClear');
            const cards = document.querySelectorAll('.protocol-card');
            const categories = document.querySelectorAll('.category');
            const noResults = document.getElementById('noResults');
            let visibleCount = 0;

            // Show/hide clear button
            clearBtn.classList.toggle('visible', query.length > 0);

            cards.forEach(card => {
                const keywords = card.dataset.keywords || '';
                const title = card.querySelector('.protocol-title').textContent.toLowerCase();
                const summary = card.querySelector('.protocol-summary').textContent.toLowerCase();

                const matches = query === '' ||
                                keywords.includes(query) ||
                                title.includes(query) ||
                                summary.includes(query);

                card.style.display = matches ? '' : 'none';
                if (matches) visibleCount++;
            });

            // Hide categories with no visible cards
            categories.forEach(category => {
                const visibleCards = category.querySelectorAll('.protocol-card[style=""], .protocol-card:not([style*="display: none"])');
                category.style.display = visibleCards.length > 0 ? '' : 'none';
            });

            // Show no results message if needed
            noResults.classList.toggle('visible', visibleCount === 0 && query !== '');
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterProtocols();
            document.getElementById('searchInput').focus();
        }

        // Close mobile menu when clicking a link
        document.querySelectorAll('.mobile-menu-link').forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('mobileMenu').classList.remove('active');
            });
        });

        // Enable Enter key in search
        document.getElementById('searchInput').addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                clearSearch();
            }
        });

        // Log page load for analytics
        console.log('Crisis Protocols page loaded - ' + new Date().toISOString());
    </script>
</body>
</html>
"""

QUICK_DOSE_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Dose - GasConsult.ai</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Fast drug dosing reference for anesthesia: induction agents, opioids, neuromuscular blockers, vasopressors, and emergency medications with evidence-based dosing.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://gasconsult.ai/quick-dose">
    <meta property="og:title" content="Quick Dose - GasConsult.ai">
    <meta property="og:description" content="Fast drug dosing reference for anesthesia with evidence-based dosing guidelines.">
    <meta property="og:image" content="https://gasconsult.ai/static/logo.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://gasconsult.ai/quick-dose">
    <meta property="twitter:title" content="Quick Dose - GasConsult.ai">
    <meta property="twitter:description" content="Fast drug dosing reference for anesthesia with evidence-based dosing guidelines.">
    <meta property="twitter:image" content="https://gasconsult.ai/static/logo.png">

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;

            /* ISO 26825 Syringe Colors */
            --color-induction: #FFFFFF;
            --color-induction-border: #e5e7eb;
            --color-induction-text: #374151;

            --color-opioid: #89CFF0;
            --color-opioid-dark: #0EA5E9;
            --color-opioid-text: #0369a1;

            --color-paralytic: #FF6B6B;
            --color-paralytic-dark: #DC2626;
            --color-paralytic-text: #b91c1c;

            --color-reversal: #E5E7EB;
            --color-reversal-border: #d1d5db;
            --color-reversal-text: #4b5563;

            --color-vasopressor: #DDA0DD;
            --color-vasopressor-dark: #A855F7;
            --color-vasopressor-text: #7c3aed;

            --color-hypnotic: #FFA500;
            --color-hypnotic-dark: #EA580C;
            --color-hypnotic-text: #c2410c;

            --color-benzo: #FFA500;
            --color-benzo-dark: #EA580C;
            --color-benzo-text: #c2410c;

            --color-local: #808080;
            --color-local-dark: #525252;
            --color-local-text: #404040;

            --color-antiemetic: #E2CFBE;
            --color-antiemetic-dark: #A78B71;
            --color-antiemetic-text: #78716c;

            --color-other: #f3f4f6;
            --color-other-border: #e5e7eb;
            --color-other-text: #6b7280;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Canvas */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation - Homepage Style */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 10px 14px;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            background: var(--gray-50);
            color: var(--gray-900);
        }

        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
        }

        .mobile-menu {
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: none;
            flex-direction: column;
            gap: 4px;
            z-index: 99;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 12px 16px;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }

        /* Content Area - With top padding for fixed nav */
        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 130px 16px 80px;
        }

        /* Weight Section - Mobile First */
        .weight-section {
            text-align: center;
            margin-bottom: 32px;
            animation: fade-up 0.6s ease forwards;
            opacity: 0;
        }

        .weight-label {
            font-size: 13px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .weight-input-container {
            display: inline-flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 20px;
        }

        /* Mobile: Smaller weight input for easier typing */
        .weight-input {
            background: transparent;
            border: none;
            border-bottom: 3px solid #2563eb;
            color: #0f172a;
            font-size: 48px;
            font-weight: 800;
            width: 110px;
            text-align: center;
            outline: none;
            letter-spacing: -2px;
            transition: border-color 0.2s;
            min-height: 44px;
        }

        .weight-input:focus {
            border-color: #1d4ed8;
        }

        .weight-unit {
            font-size: 20px;
            font-weight: 600;
            color: #94a3b8;
        }

        .quick-weights {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Mobile: Larger touch targets (44px minimum) */
        .quick-weight-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 12px 16px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            min-width: 60px;
        }

        .quick-weight-btn:hover {
            border-color: #cbd5e1;
            color: #475569;
        }

        .quick-weight-btn:active {
            transform: scale(0.95);
        }

        .quick-weight-btn.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        /* Color Legend - Mobile First */
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            color: #64748b;
        }

        .legend-swatch {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .legend-swatch.opioid { background: var(--color-opioid); }
        .legend-swatch.paralytic { background: var(--color-paralytic); }
        .legend-swatch.hypnotic { background: var(--color-hypnotic); }
        .legend-swatch.vasopressor { background: var(--color-vasopressor); }
        .legend-swatch.reversal { background: var(--color-reversal); border-color: #d1d5db; }
        .legend-swatch.local { background: var(--color-local); }

        /* Drug Category Section */
        .category-group {
            margin-bottom: 32px;
            animation: fade-up 0.6s ease forwards;
            opacity: 0;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .category-swatch {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .category-swatch.induction { background: var(--color-hypnotic); }
        .category-swatch.opioid { background: var(--color-opioid); }
        .category-swatch.paralytic { background: var(--color-paralytic); }
        .category-swatch.reversal { background: var(--color-reversal); border-color: #ccc; }
        .category-swatch.vasopressor { background: var(--color-vasopressor); }
        .category-swatch.other { background: var(--color-other); border-color: #ddd; }

        .category-title {
            font-size: 13px;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Drug List */
        .drug-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Drug Item */
        .drug-item {
            background: white;
            border-radius: 14px;
            overflow: hidden;
            transition: all 0.25s ease;
            border: 2px solid #e5e7eb;
            animation: fade-up 0.6s ease forwards;
            opacity: 0;
        }

        .drug-item.induction { border-left: 4px solid var(--color-hypnotic); }
        .drug-item.opioid { border-left: 4px solid var(--color-opioid-dark); }
        .drug-item.paralytic { border-left: 4px solid var(--color-paralytic-dark); }
        .drug-item.reversal { border-left: 4px solid #9ca3af; }
        .drug-item.vasopressor { border-left: 4px solid var(--color-vasopressor-dark); }
        .drug-item.other { border-left: 4px solid #9ca3af; }

        .drug-item:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .drug-item.expanded {
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        /* Mobile: Smaller padding, better touch targets */
        .drug-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            user-select: none;
            min-height: 56px;
        }

        .drug-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .drug-quick-dose {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drug-standard-dose {
            display: flex;
            align-items: baseline;
            gap: 3px;
            background: #f1f5f9;
            padding: 6px 12px;
            border-radius: 8px;
        }

        .drug-quick-value {
            font-size: 17px;
            font-weight: 700;
            color: #0f172a;
        }

        .drug-quick-unit {
            font-size: 12px;
            color: #64748b;
            font-weight: 500;
        }

        .drug-chevron {
            color: #94a3b8;
            transition: transform 0.3s ease;
        }

        .drug-item.expanded .drug-chevron {
            transform: rotate(180deg);
        }

        /* Drug Details - Expandable */
        .drug-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fafafa;
        }

        .drug-item.expanded .drug-details {
            max-height: 800px;
        }

        .drug-details-inner {
            padding: 20px;
            border-top: 1px solid #f1f5f9;
        }

        /* Dose Range Cards - Mobile First (stacked) */
        .dose-range-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        /* Mobile: Horizontal layout with left-aligned labels */
        .dose-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: left;
            transition: all 0.2s;
        }

        .dose-card:hover {
            border-color: #d1d5db;
        }

        .dose-card.low {
            border-left: 3px solid #22c55e;
        }

        .dose-card.standard {
            border-left: 3px solid #2563eb;
            background: #f8fafc;
        }

        .dose-card.high {
            border-left: 3px solid #f59e0b;
        }

        .dose-card-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0;
        }

        .dose-card.low .dose-card-label { color: #16a34a; }
        .dose-card.standard .dose-card-label { color: #2563eb; }
        .dose-card.high .dose-card-label { color: #d97706; }

        .dose-card-value {
            font-size: 20px;
            font-weight: 800;
            color: #0f172a;
            line-height: 1;
            margin-bottom: 0;
        }

        .dose-card-unit {
            font-size: 12px;
            color: #64748b;
        }

        .dose-card-right {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        /* Hide per-kg on mobile to save space */
        .dose-card-perkg {
            display: none;
        }

        /* Additional indications */
        .additional-doses {
            margin-bottom: 16px;
        }

        .additional-dose-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .additional-dose-label {
            font-size: 13px;
            font-weight: 500;
            color: #475569;
        }

        .additional-dose-value {
            font-size: 16px;
            font-weight: 700;
            color: #2563eb;
        }

        .additional-dose-unit {
            font-size: 12px;
            color: #64748b;
            margin-left: 3px;
        }

        .drug-meta {
            display: flex;
            gap: 24px;
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid #e5e7eb;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .meta-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #94a3b8;
            font-weight: 600;
        }

        .meta-value {
            font-size: 13px;
            color: #475569;
            font-weight: 500;
        }

        .drug-notes {
            font-size: 13px;
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .drug-reference {
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Warning */
        .drug-warning {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 10px;
            padding: 12px 14px;
            margin-top: 12px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .drug-warning svg {
            color: #dc2626;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .drug-warning span {
            font-size: 12px;
            color: #b91c1c;
            line-height: 1.5;
        }

        /* Disclaimer */
        .disclaimer {
            text-align: center;
            margin-top: 48px;
            padding: 20px;
        }

        .disclaimer-text {
            font-size: 12px;
            color: #94a3b8;
            line-height: 1.6;
        }

        /* Footer - Homepage Style */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
            margin-top: auto;
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover { color: var(--gray-700); }

        /* Social Media Icons */
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        /* Desktop Styles - Scale up from mobile */
        @media (min-width: 768px) {
            /* Desktop nav */
            .nav {
                padding: 16px 32px;
            }

            .nav-inner {
                height: 64px;
                padding: 0 24px;
                border-radius: 20px;
            }

            .logo-icon svg {
                width: 42px;
                height: 15px;
            }

            .logo-text {
                font-size: 20px;
            }

            .nav-links {
                display: flex;
            }

            .mobile-menu-btn {
                display: none;
            }

            /* Desktop container - wider layout */
            .container {
                max-width: 900px;
                padding: 140px 32px 100px;
            }

            /* Larger weight input on desktop */
            .weight-section {
                margin-bottom: 56px;
            }

            .weight-input {
                font-size: 72px;
                width: 160px;
            }

            .weight-unit {
                font-size: 28px;
            }

            /* Desktop: Smaller weight buttons */
            .quick-weight-btn {
                padding: 10px 20px;
            }

            /* Desktop: More spacing */
            .color-legend {
                gap: 16px;
                padding: 20px 24px;
                margin-bottom: 40px;
            }

            .legend-item {
                font-size: 12px;
            }

            /* Desktop: More padding */
            .drug-header {
                padding: 18px 24px;
            }

            /* Desktop: 3-column grid with more spacing */
            .dose-range-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 12px;
                margin-bottom: 24px;
            }

            /* Desktop: Centered card layout with more breathing room */
            .dose-card {
                display: block;
                text-align: center;
                padding: 18px 16px;
                border-left: 1px solid #e5e7eb;
            }

            .dose-card.low {
                border-left: 1px solid #e5e7eb;
                border-top: 4px solid #22c55e;
            }

            .dose-card.standard {
                border-left: 1px solid #e5e7eb;
                border-top: 4px solid #2563eb;
            }

            .dose-card.high {
                border-left: 1px solid #e5e7eb;
                border-top: 4px solid #f59e0b;
            }

            .dose-card-label {
                margin-bottom: 8px;
                font-size: 11px;
            }

            .dose-card-value {
                font-size: 28px;
                margin-bottom: 6px;
            }

            .dose-card-unit {
                font-size: 14px;
            }

            /* Show per-kg on desktop */
            .dose-card-perkg {
                display: block;
                font-size: 11px;
                color: #94a3b8;
                margin-top: 8px;
            }

            .dose-card-right {
                display: block;
            }

            /* Desktop: Larger drug details padding */
            .drug-details-inner {
                padding: 24px;
            }

            .additional-dose-row {
                padding: 14px 18px;
            }

            .drug-meta {
                gap: 32px;
                margin-bottom: 18px;
                padding-bottom: 18px;
            }

            .meta-label {
                font-size: 11px;
            }

            .meta-value {
                font-size: 14px;
            }

            .drug-notes {
                font-size: 14px;
                line-height: 1.7;
            }

            .drug-reference {
                font-size: 12px;
            }

            /* Desktop footer */
            .footer {
                padding: 40px 32px;
            }

            .footer-inner {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }

            .footer-text {
                font-size: 14px;
            }

            .footer-links {
                gap: 32px;
            }

            .footer-link {
                font-size: 14px;
            }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .footer { padding: 48px 40px; }
        }
    </style>
</head>
<body>
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Verification Banner for Unverified Users -->
    {{ generate_verification_banner_html()|safe }}

    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link active">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

    <div class="container">
        <!-- Weight Input -->
        <div class="weight-section">
            <div class="weight-label">Patient Weight</div>
            <div class="weight-input-container">
                <input type="number" id="weight" class="weight-input" placeholder="70" value="70" min="1" max="500">
                <span class="weight-unit">kg</span>
            </div>
            <div class="quick-weights">
                <button class="quick-weight-btn" onclick="setWeight(50)">50 kg</button>
                <button class="quick-weight-btn active" onclick="setWeight(70)">70 kg</button>
                <button class="quick-weight-btn" onclick="setWeight(80)">80 kg</button>
                <button class="quick-weight-btn" onclick="setWeight(100)">100 kg</button>
                <button class="quick-weight-btn" onclick="setWeight(120)">120 kg</button>
            </div>
        </div>

        <!-- Color Legend -->
        <div class="color-legend">
            <div class="legend-item">
                <div class="legend-swatch hypnotic" style="background: var(--color-hypnotic);"></div>
                <span>Induction/Hypnotic</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch opioid"></div>
                <span>Opioid</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch paralytic"></div>
                <span>Paralytic</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch reversal"></div>
                <span>Reversal</span>
            </div>
            <div class="legend-item">
                <div class="legend-swatch vasopressor"></div>
                <span>Vasopressor</span>
            </div>
        </div>

        <!-- Drug Lists by Category -->
        <div id="drug-categories"></div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <div class="disclaimer-text">
                For reference only. Verify all doses and adjust for patient-specific factors. Color coding follows ISO 26825 standard.
            </div>
        </div>
    </div>

    <script>
        const drugData = {
            induction: {
                name: "Induction Agents",
                color: "hypnotic",
                drugs: [
                    {
                        name: "Propofol",
                        low: 1.5,
                        standard: 2,
                        high: 2.5,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Elderly/Compromised", perKg: 1, unit: "mg" }
                        ],
                        onset: "30-45 sec",
                        duration: "5-10 min",
                        notes: "Reduce dose 30-50% in elderly, hypovolemic, or hemodynamically unstable. Lidocaine 20-40mg can reduce injection pain.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Etomidate",
                        low: 0.2,
                        standard: 0.3,
                        high: 0.4,
                        unit: "mg",
                        onset: "30-60 sec",
                        duration: "3-5 min",
                        notes: "Hemodynamically stable. Single-dose adrenal suppression is not clinically significant. Myoclonus common.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Ketamine",
                        low: 1,
                        standard: 1.5,
                        high: 2,
                        unit: "mg",
                        additionalDoses: [
                            { label: "IM Induction", perKg: 5, unit: "mg", range: "4-6 mg/kg" },
                            { label: "Analgesic (sub-dissociative)", perKg: 0.25, unit: "mg" }
                        ],
                        onset: "IV: 30-60 sec | IM: 3-4 min",
                        duration: "10-20 min",
                        notes: "Maintains airway reflexes and hemodynamics. Bronchodilator. Consider midazolam for emergence phenomena.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Midazolam",
                        low: 0.02,
                        standard: 0.03,
                        high: 0.05,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Anxiolysis", fixed: 1, unit: "mg", range: "1-2 mg" }
                        ],
                        onset: "1-3 min",
                        duration: "30-60 min",
                        notes: "Marked synergy with opioids - reduce both when combined. Anterograde amnesia. Reduce dose in elderly.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    }
                ]
            },
            opioid: {
                name: "Opioids",
                color: "opioid",
                drugs: [
                    {
                        name: "Fentanyl",
                        low: 1,
                        standard: 2,
                        high: 3,
                        unit: "mcg",
                        additionalDoses: [
                            { label: "High-dose (cardiac)", perKg: 10, unit: "mcg", range: "5-15 mcg/kg" }
                        ],
                        onset: "1-2 min",
                        duration: "30-60 min",
                        notes: "Chest wall rigidity at high doses (>5 mcg/kg bolus). Context-sensitive half-time increases with prolonged infusion.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Sufentanil",
                        low: 0.1,
                        standard: 0.3,
                        high: 0.5,
                        unit: "mcg",
                        additionalDoses: [
                            { label: "Cardiac anesthesia", perKg: 5, unit: "mcg", range: "2-8 mcg/kg" }
                        ],
                        onset: "1-3 min",
                        duration: "20-45 min",
                        notes: "~10× potency of fentanyl. Excellent hemodynamic stability for cardiac surgery.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Remifentanil",
                        low: 0.5,
                        standard: 1,
                        high: 1.5,
                        unit: "mcg",
                        additionalDoses: [
                            { label: "Infusion", perKg: 0.15, unit: "mcg/kg/min", range: "0.05-0.2" }
                        ],
                        onset: "1-3 min",
                        duration: "3-5 min",
                        notes: "Ester hydrolysis - organ-independent. Rapid offset requires transition to longer-acting opioid before emergence.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Hydromorphone",
                        low: 0.01,
                        standard: 0.015,
                        high: 0.02,
                        unit: "mg",
                        onset: "5 min",
                        duration: "3-4 hours",
                        notes: "5-7× morphine potency. Less histamine release. No active metabolites - preferred in renal impairment.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Morphine",
                        low: 0.05,
                        standard: 0.1,
                        high: 0.15,
                        unit: "mg",
                        onset: "5-10 min",
                        duration: "3-4 hours",
                        notes: "Histamine release - hypotension, bronchospasm possible. Active metabolite M6G accumulates in renal failure.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    }
                ]
            },
            paralytic: {
                name: "Neuromuscular Blockers",
                color: "paralytic",
                drugs: [
                    {
                        name: "Succinylcholine",
                        low: 1,
                        standard: 1.5,
                        high: 2,
                        unit: "mg",
                        onset: "30-60 sec",
                        duration: "5-10 min",
                        notes: "Only depolarizing NMBA. Fasciculations precede paralysis. ~0.5 mEq/L K+ rise in normal patients.",
                        reference: "Barash Clinical Anesthesia, 8th Ed",
                        warning: "Contraindicated: hyperkalemia risk (burns >24h, crush injury, denervation, prolonged immobility), MH history, myopathies"
                    },
                    {
                        name: "Rocuronium",
                        low: 0.6,
                        standard: 0.9,
                        high: 1.2,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Maintenance", perKg: 0.15, unit: "mg", range: "0.1-0.2 mg/kg" }
                        ],
                        onset: "60-90 sec (high dose: 45-60 sec)",
                        duration: "30-60 min (dose-dependent)",
                        notes: "Aminosteroid NMBA. Fully reversible with sugammadex at any depth. RSI alternative to succinylcholine.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Vecuronium",
                        low: 0.08,
                        standard: 0.1,
                        high: 0.15,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Maintenance", perKg: 0.02, unit: "mg" }
                        ],
                        onset: "2-3 min",
                        duration: "25-40 min",
                        notes: "Aminosteroid. Hepatic elimination - prolonged in liver failure. Reversible with sugammadex.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Cisatracurium",
                        low: 0.1,
                        standard: 0.15,
                        high: 0.2,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Maintenance", perKg: 0.03, unit: "mg" }
                        ],
                        onset: "2-3 min",
                        duration: "40-60 min",
                        notes: "Hoffman elimination (organ-independent). Ideal for hepatic/renal failure. No histamine release.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    }
                ]
            },
            reversal: {
                name: "Reversal Agents",
                color: "reversal",
                drugs: [
                    {
                        name: "Sugammadex",
                        low: 2,
                        standard: 4,
                        high: 16,
                        unit: "mg",
                        lowLabel: "Moderate Block",
                        standardLabel: "Deep Block",
                        highLabel: "Immediate",
                        onset: "1-3 min",
                        duration: "N/A",
                        notes: "Selective relaxant binding agent for rocuronium/vecuronium. May reduce hormonal contraceptive efficacy for 7 days.",
                        reference: "FDA Package Insert"
                    },
                    {
                        name: "Neostigmine",
                        low: 0.03,
                        standard: 0.05,
                        high: 0.07,
                        unit: "mg",
                        max: 5,
                        additionalDoses: [
                            { label: "With glycopyrrolate", note: "0.2 mg glyco per 1 mg neo" }
                        ],
                        onset: "5-10 min",
                        duration: "40-60 min",
                        notes: "Anticholinesterase - MUST co-administer anticholinergic. Only effective at TOF count ≥2.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Glycopyrrolate",
                        low: 0.006,
                        standard: 0.01,
                        high: 0.014,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Antisialagogue", fixed: 0.2, unit: "mg" }
                        ],
                        onset: "1 min",
                        duration: "2-4 hours",
                        notes: "Quaternary ammonium - does not cross BBB. Less tachycardia than atropine.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Naloxone",
                        isFixed: true,
                        low: 0.02,
                        standard: 0.04,
                        high: 0.4,
                        unit: "mg",
                        lowLabel: "Micro-dose",
                        standardLabel: "Titrated",
                        highLabel: "Full Reversal",
                        onset: "1-2 min",
                        duration: "30-45 min",
                        notes: "Opioid antagonist. Duration shorter than most opioids - resedation possible. Titrate to avoid withdrawal.",
                        reference: "ACLS Guidelines 2020"
                    },
                    {
                        name: "Flumazenil",
                        isFixed: true,
                        low: 0.1,
                        standard: 0.2,
                        high: 0.5,
                        unit: "mg",
                        onset: "1-2 min",
                        duration: "45-90 min",
                        notes: "Benzodiazepine antagonist. May precipitate seizures in chronic benzo users. Max total 3-5 mg.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    }
                ]
            },
            vasopressor: {
                name: "Vasopressors & Inotropes",
                color: "vasopressor",
                drugs: [
                    {
                        name: "Phenylephrine",
                        isFixed: true,
                        low: 50,
                        standard: 100,
                        high: 200,
                        unit: "mcg",
                        onset: "Immediate",
                        duration: "5-10 min",
                        notes: "Pure α₁-agonist. Increases SVR without inotropy. Reflex bradycardia - useful when HR elevated.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Ephedrine",
                        isFixed: true,
                        low: 5,
                        standard: 10,
                        high: 25,
                        unit: "mg",
                        onset: "1-2 min",
                        duration: "10-15 min",
                        notes: "Mixed α/β agonist + indirect NE release. Tachyphylaxis with repeated doses.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Epinephrine",
                        isFixed: true,
                        low: 5,
                        standard: 10,
                        high: 20,
                        unit: "mcg",
                        additionalDoses: [
                            { label: "Cardiac Arrest", fixed: 1, unit: "mg", range: "1 mg q3-5 min" },
                            { label: "Anaphylaxis IM", fixed: 0.3, unit: "mg", range: "0.3-0.5 mg" }
                        ],
                        onset: "Immediate",
                        duration: "5-10 min",
                        notes: "α + β agonist. First-line for anaphylaxis and cardiac arrest. Low-dose: β effects; high-dose: α effects.",
                        reference: "ACLS Guidelines 2020"
                    },
                    {
                        name: "Vasopressin",
                        isFixed: true,
                        low: 1,
                        standard: 2,
                        high: 4,
                        unit: "U",
                        additionalDoses: [
                            { label: "Infusion (shock)", note: "0.01-0.04 U/min" },
                            { label: "Cardiac Arrest", fixed: 40, unit: "U" }
                        ],
                        onset: "Immediate",
                        duration: "10-20 min",
                        notes: "V₁ receptor agonist. Catecholamine-sparing. No tachycardia. May cause splanchnic ischemia.",
                        reference: "Surviving Sepsis Guidelines 2021"
                    },
                    {
                        name: "Atropine",
                        isFixed: true,
                        low: 0.5,
                        standard: 1,
                        high: 1.5,
                        unit: "mg",
                        onset: "1-2 min",
                        duration: "30-60 min",
                        notes: "Anticholinergic. Crosses BBB. Paradoxical bradycardia possible with doses <0.5 mg. Max 3 mg.",
                        reference: "ACLS Guidelines 2020"
                    }
                ]
            },
            other: {
                name: "Other Agents",
                color: "other",
                drugs: [
                    {
                        name: "Ondansetron",
                        isFixed: true,
                        low: 4,
                        standard: 4,
                        high: 8,
                        unit: "mg",
                        onset: "5-10 min",
                        duration: "4-8 hours",
                        notes: "5-HT₃ antagonist. Give at end of surgery. QTc prolongation - caution with other QT-prolonging drugs.",
                        reference: "Consensus Guidelines for PONV, 2020"
                    },
                    {
                        name: "Dexamethasone",
                        isFixed: true,
                        low: 4,
                        standard: 8,
                        high: 10,
                        unit: "mg",
                        onset: "1-2 hours (peak)",
                        duration: "24-72 hours",
                        notes: "Give at induction for PONV (needs time for effect). Transient hyperglycemia. Perineal burning if rapid IV.",
                        reference: "Consensus Guidelines for PONV, 2020"
                    },
                    {
                        name: "Tranexamic Acid",
                        low: 10,
                        standard: 20,
                        high: 30,
                        unit: "mg",
                        additionalDoses: [
                            { label: "Maintenance infusion", perKg: 1, unit: "mg/kg/hr", range: "1-5 mg/kg/hr" }
                        ],
                        onset: "5-15 min",
                        duration: "~3 hours",
                        notes: "Antifibrinolytic. Contraindicated in active thromboembolic disease. Seizure risk at very high doses.",
                        reference: "CRASH-2 Trial, Lancet 2010"
                    },
                    {
                        name: "Dexmedetomidine",
                        low: 0.5,
                        standard: 1,
                        high: 1,
                        unit: "mcg",
                        additionalDoses: [
                            { label: "Infusion", perKg: 0.5, unit: "mcg/kg/hr", range: "0.2-0.7" }
                        ],
                        onset: "5-10 min",
                        duration: "Infusion-dependent",
                        notes: "α₂-agonist. Sedation without respiratory depression. Bradycardia and hypotension common - load slowly.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    },
                    {
                        name: "Lidocaine IV",
                        low: 1,
                        standard: 1.5,
                        high: 2,
                        unit: "mg",
                        onset: "1-2 min",
                        duration: "10-20 min",
                        notes: "Blunts airway reflexes, reduces MAC. Max 4.5 mg/kg. CNS toxicity precedes cardiac.",
                        reference: "Barash Clinical Anesthesia, 8th Ed"
                    }
                ]
            }
        };

        let currentWeight = 70;

        document.addEventListener('DOMContentLoaded', () => {
            renderAllCategories();

            document.getElementById('weight').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                if (val && val > 0) {
                    currentWeight = val;
                    updateQuickWeightButtons();
                    updateAllDoses();
                }
            });
        });

        function setWeight(w) {
            currentWeight = w;
            document.getElementById('weight').value = w;
            updateQuickWeightButtons();
            updateAllDoses();
        }

        function updateQuickWeightButtons() {
            document.querySelectorAll('.quick-weight-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent) === currentWeight) {
                    btn.classList.add('active');
                }
            });
        }

        function formatDose(value) {
            if (value >= 1000) return (value / 1000).toFixed(1);
            if (value < 0.1) return value.toFixed(3);
            if (value < 1) return value.toFixed(2);
            if (value < 10) return value.toFixed(1);
            return Math.round(value);
        }

        function formatUnit(value, unit) {
            if (unit === 'mg' && value >= 1000) return 'g';
            if (unit === 'mcg' && value >= 1000) return 'mg';
            return unit;
        }

        function toggleDrug(el) {
            el.closest('.drug-item').classList.toggle('expanded');
        }

        function updateAllDoses() {
            Object.entries(drugData).forEach(([catKey, category]) => {
                category.drugs.forEach(drug => {
                    const item = document.querySelector(`.drug-item[data-drug="${drug.name}"]`);
                    if (!item) return;

                    // Update header quick dose
                    const standardVal = drug.isFixed ? drug.standard : drug.standard * currentWeight;
                    item.querySelector('.drug-quick-value').textContent = formatDose(standardVal);
                    item.querySelector('.drug-quick-unit').textContent = formatUnit(standardVal, drug.unit);

                    // Update dose cards
                    const lowVal = drug.isFixed ? drug.low : drug.low * currentWeight;
                    const highVal = drug.isFixed ? drug.high : drug.high * currentWeight;

                    const lowCard = item.querySelector('.dose-card.low .dose-card-value');
                    const stdCard = item.querySelector('.dose-card.standard .dose-card-value');
                    const highCard = item.querySelector('.dose-card.high .dose-card-value');

                    if (lowCard) lowCard.textContent = formatDose(lowVal);
                    if (stdCard) stdCard.textContent = formatDose(standardVal);
                    if (highCard) highCard.textContent = formatDose(highVal);

                    // Update units
                    item.querySelectorAll('.dose-card.low .dose-card-unit').forEach(el => el.textContent = formatUnit(lowVal, drug.unit));
                    item.querySelectorAll('.dose-card.standard .dose-card-unit').forEach(el => el.textContent = formatUnit(standardVal, drug.unit));
                    item.querySelectorAll('.dose-card.high .dose-card-unit').forEach(el => el.textContent = formatUnit(highVal, drug.unit));

                    // Update additional doses
                    if (drug.additionalDoses) {
                        drug.additionalDoses.forEach((dose, i) => {
                            const row = item.querySelectorAll('.additional-dose-row')[i];
                            if (row && dose.perKg) {
                                const val = dose.perKg * currentWeight;
                                row.querySelector('.additional-dose-value').textContent = formatDose(val);
                                row.querySelector('.additional-dose-unit').textContent = formatUnit(val, dose.unit);
                            }
                        });
                    }
                });
            });
        }

        function renderAllCategories() {
            const container = document.getElementById('drug-categories');

            container.innerHTML = Object.entries(drugData).map(([catKey, category]) => `
                <div class="category-group">
                    <div class="category-header">
                        <div class="category-swatch ${catKey}"></div>
                        <div class="category-title">${category.name}</div>
                    </div>
                    <div class="drug-list">
                        ${category.drugs.map(drug => {
                            const standardVal = drug.isFixed ? drug.standard : drug.standard * currentWeight;
                            const lowVal = drug.isFixed ? drug.low : drug.low * currentWeight;
                            const highVal = drug.isFixed ? drug.high : drug.high * currentWeight;

                            return `
                                <div class="drug-item ${catKey}" data-drug="${drug.name}" data-category="${catKey}">
                                    <div class="drug-header" onclick="toggleDrug(this)">
                                        <span class="drug-name">${drug.name}</span>
                                        <div class="drug-quick-dose">
                                            <div class="drug-standard-dose">
                                                <span class="drug-quick-value">${formatDose(standardVal)}</span>
                                                <span class="drug-quick-unit">${formatUnit(standardVal, drug.unit)}</span>
                                            </div>
                                            <svg class="drug-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"></polyline>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="drug-details">
                                        <div class="drug-details-inner">
                                            <div class="dose-range-grid">
                                                <div class="dose-card low">
                                                    <div class="dose-card-label">${drug.lowLabel || 'Low'}</div>
                                                    <div class="dose-card-value">${formatDose(lowVal)}</div>
                                                    <div class="dose-card-unit">${formatUnit(lowVal, drug.unit)}</div>
                                                    ${!drug.isFixed ? `<div class="dose-card-perkg">${drug.low} ${drug.unit}/kg</div>` : ''}
                                                </div>
                                                <div class="dose-card standard">
                                                    <div class="dose-card-label">${drug.standardLabel || 'Standard'}</div>
                                                    <div class="dose-card-value">${formatDose(standardVal)}</div>
                                                    <div class="dose-card-unit">${formatUnit(standardVal, drug.unit)}</div>
                                                    ${!drug.isFixed ? `<div class="dose-card-perkg">${drug.standard} ${drug.unit}/kg</div>` : ''}
                                                </div>
                                                <div class="dose-card high">
                                                    <div class="dose-card-label">${drug.highLabel || 'High'}</div>
                                                    <div class="dose-card-value">${formatDose(highVal)}</div>
                                                    <div class="dose-card-unit">${formatUnit(highVal, drug.unit)}</div>
                                                    ${!drug.isFixed ? `<div class="dose-card-perkg">${drug.high} ${drug.unit}/kg</div>` : ''}
                                                </div>
                                            </div>

                                            ${drug.additionalDoses ? `
                                                <div class="additional-doses">
                                                    ${drug.additionalDoses.map(dose => {
                                                        if (dose.note) {
                                                            return `
                                                                <div class="additional-dose-row">
                                                                    <span class="additional-dose-label">${dose.label}</span>
                                                                    <span style="font-size: 13px; color: #64748b;">${dose.note}</span>
                                                                </div>
                                                            `;
                                                        }
                                                        const val = dose.fixed || dose.perKg * currentWeight;
                                                        return `
                                                            <div class="additional-dose-row">
                                                                <span class="additional-dose-label">${dose.label}${dose.range ? ` (${dose.range})` : ''}</span>
                                                                <div>
                                                                    <span class="additional-dose-value">${formatDose(val)}</span>
                                                                    <span class="additional-dose-unit">${formatUnit(val, dose.unit)}</span>
                                                                </div>
                                                            </div>
                                                        `;
                                                    }).join('')}
                                                </div>
                                            ` : ''}

                                            <div class="drug-meta">
                                                <div class="meta-item">
                                                    <span class="meta-label">Onset</span>
                                                    <span class="meta-value">${drug.onset}</span>
                                                </div>
                                                <div class="meta-item">
                                                    <span class="meta-label">Duration</span>
                                                    <span class="meta-value">${drug.duration}</span>
                                                </div>
                                            </div>

                                            <div class="drug-notes">${drug.notes}</div>

                                            <div class="drug-reference">
                                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                                </svg>
                                                ${drug.reference}
                                            </div>

                                            ${drug.warning ? `
                                                <div class="drug-warning">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                                        <line x1="12" y1="9" x2="12" y2="13"/>
                                                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                                                    </svg>
                                                    <span>${drug.warning}</span>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        // Toggle nav dropdown
        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();
            const menu = e.target.nextElementSibling;
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.nav-dropdown-menu').forEach(m => m.classList.remove('show'));
        });
    </script>

    <footer class="footer">
        <div class="footer-inner">
            <span class="footer-text">© 2025 GasConsult.ai</span>
            <div class="social-icons">
                <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                    </svg>
                </a>
                <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                        <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                        <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                    </svg>
                </a>
                <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                </a>
            </div>
            <div class="footer-links">
                <a href="/privacy" class="footer-link">Privacy</a>
                <a href="/terms" class="footer-link">Terms</a>
                <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
            </div>
        </div>
    </footer>
    </div>
</body>
</html>
"""

CALCULATORS_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clinical Calculators - GasConsult.ai</title>
    <meta name="description" content="Evidence-based anesthesiology clinical calculators: IBW, BSA, MABL, QTc, PONV, RCRI, and more with validated formulas and references.">

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
            --green-50: #F0FDF4;
            --green-500: #10B981;
            --green-600: #059669;
            --green-700: #047857;
            --yellow-50: #FEFCE8;
            --yellow-500: #F59E0B;
            --yellow-600: #D97706;
            --red-50: #FEF2F2;
            --red-500: #EF4444;
            --red-600: #DC2626;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphic Background */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
            font-weight: 600;
        }

        /* User Avatar & Auth Buttons */
        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
        }

        /* Hero Section */
        .hero {
            padding: 120px 20px 40px;
            text-align: center;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 100px;
            padding: 8px 16px 8px 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) forwards;
            opacity: 0;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--blue-500);
            border-radius: 50%;
            position: relative;
        }

        .badge-dot::after {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: var(--blue-400);
            animation: pulse-ring 2s ease-out infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .badge-text {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .hero-title {
            font-size: 42px;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: -1.5px;
            color: var(--gray-900);
            margin-bottom: 16px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.1s forwards;
            opacity: 0;
        }

        .hero-title .gradient {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-500) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 17px;
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-600);
            max-width: 580px;
            margin: 0 auto;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.2s forwards;
            opacity: 0;
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 0 20px 80px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Category Filters */
        .category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 40px;
            padding: 0 4px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.25s forwards;
            opacity: 0;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1.5px solid var(--gray-200);
            border-radius: 14px;
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 2px 8px rgba(0,0,0,0.03);
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.04), 0 8px 16px rgba(0,0,0,0.06);
            border-color: var(--blue-300);
            background: rgba(255, 255, 255, 0.85);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-500) 100%);
            border-color: var(--blue-600);
            color: white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2), 0 8px 16px rgba(37, 99, 235, 0.15);
        }

        .filter-btn svg {
            flex-shrink: 0;
            opacity: 0.8;
        }

        .filter-btn.active svg {
            opacity: 1;
        }

        .filter-btn span:first-of-type {
            white-space: nowrap;
        }

        .filter-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            padding: 0 8px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: auto;
        }

        .filter-btn.active .filter-count {
            background: rgba(255, 255, 255, 0.25);
        }

        @media (max-width: 767px) {
            .filter-btn {
                flex: 1 1 calc(50% - 6px);
                min-width: 0;
                padding: 12px 16px;
                font-size: 13px;
            }

            .filter-btn span:first-of-type {
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .category-filters {
                gap: 8px;
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            .filter-btn {
                flex: 1 1 calc(33.333% - 8px);
            }
        }

        /* Calculator Grid */
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            animation: fade-up 0.8s cubic-bezier(0.16,1,0.3,1) 0.35s forwards;
            opacity: 0;
        }

        @media (min-width: 768px) {
            .calc-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
        }

        @media (min-width: 1200px) {
            .calc-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Hide filtered calculators */
        .calc-card.hidden {
            display: none;
        }

        /* Calculator Card */
        .calc-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
            transition: all 0.3s cubic-bezier(0.4,0,0.2,1);
        }

        .calc-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.04), 0 12px 32px rgba(0,0,0,0.06), 0 24px 64px rgba(0,0,0,0.08);
            border-color: rgba(59,130,246,0.2);
        }

        .calc-card.large {
            grid-column: span 1;
        }

        @media (min-width: 768px) {
            .calc-card.large {
                grid-column: span 2;
            }
        }

        .calc-header {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .calc-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }

        .calc-desc {
            font-size: 13px;
            color: var(--gray-500);
            line-height: 1.5;
        }

        .calc-body {
            margin-bottom: 20px;
        }

        /* Form Inputs */
        .input-group {
            margin-bottom: 16px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        .input-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            letter-spacing: 0.2px;
        }

        .input-wrapper {
            position: relative;
        }

        .calc-input, .calc-select {
            width: 100%;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-900);
            background: var(--white);
            border: 1.5px solid var(--gray-300);
            border-radius: 12px;
            transition: all 0.2s ease;
            outline: none;
        }

        .calc-input:focus, .calc-select:focus {
            border-color: var(--blue-500);
            box-shadow: 0 0 0 4px rgba(59,130,246,0.1);
        }

        .calc-input::placeholder {
            color: var(--gray-400);
            font-weight: 400;
        }

        .input-unit {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-500);
            pointer-events: none;
        }

        /* Checkbox Inputs */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--gray-50);
            border: 1.5px solid var(--gray-200);
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .checkbox-item:hover {
            background: var(--blue-50);
            border-color: var(--blue-200);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--blue-600);
        }

        .checkbox-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            flex: 1;
        }

        /* Radio Inputs */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-item {
            display: flex;
            align-items: start;
            padding: 12px;
            background: var(--gray-50);
            border: 1.5px solid var(--gray-200);
            border-radius: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .radio-item:hover {
            background: var(--blue-50);
            border-color: var(--blue-200);
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--blue-600);
            flex-shrink: 0;
        }

        .radio-content {
            flex: 1;
        }

        .radio-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-900);
            cursor: pointer;
            display: block;
            margin-bottom: 2px;
        }

        .radio-desc {
            font-size: 12px;
            color: var(--gray-600);
            line-height: 1.4;
        }

        /* Results Section */
        .calc-result {
            background: linear-gradient(135deg, var(--blue-50) 0%, var(--blue-100) 100%);
            border: 1.5px solid var(--blue-200);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 16px;
            opacity: 0;
            transform: scale(0.95);
            transition: all 0.4s cubic-bezier(0.34,1.56,0.64,1);
        }

        .calc-result.show {
            opacity: 1;
            transform: scale(1);
        }

        .calc-result.green {
            background: linear-gradient(135deg, var(--green-50) 0%, #E6F7EE 100%);
            border-color: var(--green-500);
        }

        .calc-result.yellow {
            background: linear-gradient(135deg, var(--yellow-50) 0%, #FEF9E7 100%);
            border-color: var(--yellow-500);
        }

        .calc-result.red {
            background: linear-gradient(135deg, var(--red-50) 0%, #FFEBEE 100%);
            border-color: var(--red-500);
        }

        .result-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--gray-600);
            margin-bottom: 8px;
        }

        .result-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--blue-700);
            line-height: 1;
            letter-spacing: -1px;
        }

        .green .result-value { color: var(--green-700); }
        .yellow .result-value { color: var(--yellow-600); }
        .red .result-value { color: var(--red-600); }

        .result-unit {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-600);
            margin-left: 4px;
        }

        .result-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-top: 8px;
            line-height: 1.5;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            padding: 14px;
        }

        .result-item-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-600);
            margin-bottom: 6px;
        }

        .result-item-value {
            font-size: 22px;
            font-weight: 800;
            color: var(--gray-900);
            line-height: 1;
        }

        .result-item-unit {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            margin-left: 2px;
        }

        /* Reference Link */
        .calc-reference {
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .ref-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--blue-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .ref-link:hover {
            color: var(--blue-700);
            gap: 8px;
        }

        .ref-link svg {
            width: 14px;
            height: 14px;
        }

        /* Footer */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        /* Social Media Icons */
        
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }


        @media (min-width: 768px) {
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
        }

        @media (min-width: 1024px) {
            .footer { padding: 48px 40px; }
        }

        /* Medical Disclaimer */
        .disclaimer {
            max-width: 1200px;
            margin: 0 auto 40px;
            padding: 0 20px;
        }

        .disclaimer-card {
            background: rgba(239, 246, 255, 0.6);
            border: 1px solid var(--blue-200);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .disclaimer-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            color: var(--blue-600);
        }

        .disclaimer-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--gray-700);
        }

        .disclaimer-text strong {
            font-weight: 600;
            color: var(--gray-900);
        }

        @media (max-width: 767px) {
            .hero-title {
                font-size: 32px;
            }

            .result-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Background -->
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-inner">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span>
                    </div>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link active">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <!-- Hero -->
        <section class="hero">
            <div class="hero-badge">
                <div class="badge-dot"></div>
                <span class="badge-text">Evidence-Based Formulas</span>
            </div>
            <h1 class="hero-title">
                Clinical <span class="gradient">Calculators</span>
            </h1>
            <p class="hero-subtitle">
                Evidence-based medical calculations organized by specialty. All results are instant - no submit buttons needed.
            </p>
        </section>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <div class="disclaimer-card">
                <svg class="disclaimer-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="disclaimer-text">
                    <strong>Medical Disclaimer:</strong> These calculators are for educational purposes only. Always verify calculations and consult clinical judgment before making treatment decisions.
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main">
            <div class="container">
                <!-- Category Filters -->
                <div class="category-filters">
                    <button class="filter-btn active" onclick="filterCalculators('all')">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <span>All Calculators</span>
                        <span class="filter-count">10</span>
                    </button>
                    <button class="filter-btn" onclick="filterCalculators('dosing')">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 008 10.172V5L7 4z"></path>
                        </svg>
                        <span>Dosing & Pharmacology</span>
                        <span class="filter-count">3</span>
                    </button>
                    <button class="filter-btn" onclick="filterCalculators('risk')">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <span>Perioperative Risk</span>
                        <span class="filter-count">3</span>
                    </button>
                    <button class="filter-btn" onclick="filterCalculators('fluids')">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span>Hemodynamics & Fluids</span>
                        <span class="filter-count">3</span>
                    </button>
                    <button class="filter-btn" onclick="filterCalculators('cardiac')">
                        <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                        <span>Cardiac & Monitoring</span>
                        <span class="filter-count">1</span>
                    </button>
                </div>

                <!-- Calculator Grid -->
                <div class="calc-grid">

                    <!-- IDEAL BODY WEIGHT -->
                    <div class="calc-card" data-category="dosing">
                        <div class="calc-header">
                            <h3 class="calc-title">Ideal Body Weight (IBW)</h3>
                            <p class="calc-desc">Devine formula for anesthesia dosing</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">Sex</label>
                                <select class="calc-select" id="ibw-sex" onchange="calcIBW()">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Height</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="ibw-height" placeholder="Enter height" oninput="calcIBW()" min="0" step="0.1">
                                    <span class="input-unit">inches</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Actual Weight (optional, for ABW)</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="ibw-weight" placeholder="Enter weight" oninput="calcIBW()" min="0" step="0.1">
                                    <span class="input-unit">kg</span>
                                </div>
                            </div>
                        </div>
                        <div id="ibw-result" class="calc-result">
                            <div class="result-label">Ideal Body Weight</div>
                            <div class="result-value"><span id="ibw-value">--</span><span class="result-unit">kg</span></div>
                            <div id="abw-display" style="margin-top: 12px; display: none;">
                                <div class="result-label" style="margin-bottom: 4px;">Adjusted Body Weight</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--gray-700);"><span id="abw-value">--</span> kg</div>
                            </div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://clincalc.com/kinetics/idealbw.aspx" target="_blank" class="ref-link">
                                <span>Reference: ClinCalc IBW</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- BODY SURFACE AREA -->
                    <div class="calc-card" data-category="fluids">
                        <div class="calc-header">
                            <h3 class="calc-title">Body Surface Area (BSA)</h3>
                            <p class="calc-desc">Mosteller, DuBois & Haycock formulas</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">Height</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="bsa-height" placeholder="Enter height" oninput="calcBSA()" min="0" step="0.1">
                                    <span class="input-unit">cm</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Weight</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="bsa-weight" placeholder="Enter weight" oninput="calcBSA()" min="0" step="0.1">
                                    <span class="input-unit">kg</span>
                                </div>
                            </div>
                        </div>
                        <div id="bsa-result" class="calc-result green">
                            <div class="result-grid">
                                <div class="result-item">
                                    <div class="result-item-label">Mosteller ⭐</div>
                                    <div class="result-item-value"><span id="bsa-mosteller">--</span><span class="result-item-unit">m²</span></div>
                                </div>
                                <div class="result-item">
                                    <div class="result-item-label">DuBois</div>
                                    <div class="result-item-value"><span id="bsa-dubois">--</span><span class="result-item-unit">m²</span></div>
                                </div>
                                <div class="result-item" style="grid-column: 1 / -1;">
                                    <div class="result-item-label">Haycock (Pediatric)</div>
                                    <div class="result-item-value"><span id="bsa-haycock">--</span><span class="result-item-unit">m²</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://medplore.com/health-tools/bsa-calculator-with-formulas/" target="_blank" class="ref-link">
                                <span>Reference: BSA Formulas</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- MAXIMUM ALLOWABLE BLOOD LOSS -->
                    <div class="calc-card" data-category="fluids">
                        <div class="calc-header">
                            <h3 class="calc-title">Maximum Allowable Blood Loss</h3>
                            <p class="calc-desc">Estimated blood volume & transfusion threshold</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">Patient Type</label>
                                <select class="calc-select" id="mabl-type" onchange="calcMABL()">
                                    <option value="">Select...</option>
                                    <option value="male">Adult Male</option>
                                    <option value="female">Adult Female</option>
                                    <option value="pediatric">Pediatric</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Weight</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="mabl-weight" placeholder="Enter weight" oninput="calcMABL()" min="0" step="0.1">
                                    <span class="input-unit">kg</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Starting Hematocrit</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="mabl-start-hct" placeholder="e.g., 40" oninput="calcMABL()" min="0" max="100" step="0.1">
                                    <span class="input-unit">%</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Target Hematocrit</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="mabl-target-hct" placeholder="e.g., 25" oninput="calcMABL()" min="0" max="100" step="0.1">
                                    <span class="input-unit">%</span>
                                </div>
                            </div>
                        </div>
                        <div id="mabl-result" class="calc-result yellow">
                            <div class="result-label">Max Allowable Blood Loss</div>
                            <div class="result-value"><span id="mabl-value">--</span><span class="result-unit">mL</span></div>
                            <div class="result-text">Estimated Blood Volume: <strong id="ebv-value">--</strong> mL</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://www.mdcalc.com/calc/3905/maximum-allowable-blood-loss-abl-without-transfusion" target="_blank" class="ref-link">
                                <span>Reference: MDCalc MABL</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- QTc INTERVAL -->
                    <div class="calc-card" data-category="cardiac">
                        <div class="calc-header">
                            <h3 class="calc-title">QTc Interval (Bazett)</h3>
                            <p class="calc-desc">Corrected QT interval for cardiac risk</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">QT Interval</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="qtc-qt" placeholder="e.g., 400" oninput="calcQTc()" min="0" step="1">
                                    <span class="input-unit">ms</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Heart Rate</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="qtc-hr" placeholder="e.g., 75" oninput="calcQTc()" min="0" step="1">
                                    <span class="input-unit">bpm</span>
                                </div>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Sex (for interpretation)</label>
                                <select class="calc-select" id="qtc-sex" onchange="calcQTc()">
                                    <option value="">Select...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>
                        <div id="qtc-result" class="calc-result">
                            <div class="result-label">QTc (Bazett)</div>
                            <div class="result-value"><span id="qtc-value">--</span><span class="result-unit">ms</span></div>
                            <div class="result-text" id="qtc-interpretation">Enter values above</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://en.wikipedia.org/wiki/QT_interval#Corrected_QT_interval" target="_blank" class="ref-link">
                                <span>Reference: Bazett Formula</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- MAINTENANCE FLUIDS -->
                    <div class="calc-card" data-category="fluids">
                        <div class="calc-header">
                            <h3 class="calc-title">Maintenance Fluids (4-2-1 Rule)</h3>
                            <p class="calc-desc">Holliday-Segar method for pediatrics</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">Weight</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="fluids-weight" placeholder="Enter weight" oninput="calcFluids()" min="0" step="0.1">
                                    <span class="input-unit">kg</span>
                                </div>
                            </div>
                        </div>
                        <div id="fluids-result" class="calc-result green">
                            <div class="result-label">Maintenance Rate</div>
                            <div class="result-value"><span id="fluids-value">--</span><span class="result-unit">mL/hr</span></div>
                            <div class="result-text">Daily volume: <strong id="fluids-daily">--</strong> mL/day</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://www.ncbi.nlm.nih.gov/books/NBK562337/" target="_blank" class="ref-link">
                                <span>Reference: 4-2-1 Rule</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- PONV RISK (APFEL SCORE) -->
                    <div class="calc-card" data-category="risk">
                        <div class="calc-header">
                            <h3 class="calc-title">PONV Risk (Apfel Score)</h3>
                            <p class="calc-desc">Postoperative nausea & vomiting prediction</p>
                        </div>
                        <div class="calc-body">
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="ponv-female" onchange="calcPONV()">
                                    <span class="checkbox-label">Female</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="ponv-nonsmoker" onchange="calcPONV()">
                                    <span class="checkbox-label">Non-smoker</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="ponv-history" onchange="calcPONV()">
                                    <span class="checkbox-label">History of PONV or motion sickness</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="ponv-opioids" onchange="calcPONV()">
                                    <span class="checkbox-label">Postoperative opioids planned</span>
                                </label>
                            </div>
                        </div>
                        <div id="ponv-result" class="calc-result">
                            <div class="result-label">PONV Risk</div>
                            <div class="result-value"><span id="ponv-value">--</span><span class="result-unit">%</span></div>
                            <div class="result-text">Score: <strong id="ponv-score">0</strong> / 4 risk factors</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://www.mdcalc.com/calc/1887/apfel-score-postoperative-nausea-vomiting" target="_blank" class="ref-link">
                                <span>Reference: Apfel Score</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- RCRI (CARDIAC RISK INDEX) -->
                    <div class="calc-card" data-category="risk">
                        <div class="calc-header">
                            <h3 class="calc-title">RCRI (Revised Cardiac Risk Index)</h3>
                            <p class="calc-desc">Perioperative cardiac event prediction</p>
                        </div>
                        <div class="calc-body">
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="rcri-surgery" onchange="calcRCRI()">
                                    <span class="checkbox-label">High-risk surgery (vascular, intraperitoneal, intrathoracic)</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="rcri-ihd" onchange="calcRCRI()">
                                    <span class="checkbox-label">History of ischemic heart disease</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="rcri-chf" onchange="calcRCRI()">
                                    <span class="checkbox-label">History of congestive heart failure</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="rcri-cvd" onchange="calcRCRI()">
                                    <span class="checkbox-label">History of cerebrovascular disease</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="rcri-dm" onchange="calcRCRI()">
                                    <span class="checkbox-label">Diabetes on insulin therapy</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="rcri-cr" onchange="calcRCRI()">
                                    <span class="checkbox-label">Preoperative creatinine > 2.0 mg/dL</span>
                                </label>
                            </div>
                        </div>
                        <div id="rcri-result" class="calc-result">
                            <div class="result-label">Cardiac Event Risk</div>
                            <div class="result-value"><span id="rcri-value">--</span><span class="result-unit">%</span></div>
                            <div class="result-text">Score: <strong id="rcri-score">0</strong> / 6 risk factors</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10578796/" target="_blank" class="ref-link">
                                <span>Reference: RCRI Validation</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- ASA PHYSICAL STATUS -->
                    <div class="calc-card" data-category="risk">
                        <div class="calc-header">
                            <h3 class="calc-title">ASA Physical Status</h3>
                            <p class="calc-desc">Classification of patient health status</p>
                        </div>
                        <div class="calc-body">
                            <div class="radio-group">
                                <label class="radio-item">
                                    <input type="radio" name="asa" value="1" onchange="calcASA()">
                                    <div class="radio-content">
                                        <span class="radio-label">ASA I</span>
                                        <span class="radio-desc">Healthy patient, no systemic disease</span>
                                    </div>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="asa" value="2" onchange="calcASA()">
                                    <div class="radio-content">
                                        <span class="radio-label">ASA II</span>
                                        <span class="radio-desc">Mild systemic disease, no functional limitations</span>
                                    </div>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="asa" value="3" onchange="calcASA()">
                                    <div class="radio-content">
                                        <span class="radio-label">ASA III</span>
                                        <span class="radio-desc">Severe systemic disease with functional limitations</span>
                                    </div>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="asa" value="4" onchange="calcASA()">
                                    <div class="radio-content">
                                        <span class="radio-label">ASA IV</span>
                                        <span class="radio-desc">Severe disease that is constant threat to life</span>
                                    </div>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="asa" value="5" onchange="calcASA()">
                                    <div class="radio-content">
                                        <span class="radio-label">ASA V</span>
                                        <span class="radio-desc">Moribund, not expected to survive without operation</span>
                                    </div>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="asa" value="6" onchange="calcASA()">
                                    <div class="radio-content">
                                        <span class="radio-label">ASA VI</span>
                                        <span class="radio-desc">Brain-dead patient for organ donation</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div id="asa-result" class="calc-result" style="display: none;">
                            <div class="result-label">Selected Classification</div>
                            <div class="result-value" style="font-size: 24px;"><span id="asa-value">--</span></div>
                            <div class="result-text" id="asa-desc">--</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://www.asahq.org/standards-and-guidelines/asa-physical-status-classification-system" target="_blank" class="ref-link">
                                <span>Reference: ASA Guidelines</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- OPIOID CONVERSION -->
                    <div class="calc-card large" data-category="dosing">
                        <div class="calc-header">
                            <h3 class="calc-title">Opioid Conversion Calculator</h3>
                            <p class="calc-desc">Convert to morphine milligram equivalents (MME)</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">Opioid</label>
                                <select class="calc-select" id="opioid-type" onchange="calcOpioid()">
                                    <option value="">Select opioid...</option>
                                    <option value="1">Morphine (IV/IM/SC)</option>
                                    <option value="3">Morphine (PO)</option>
                                    <option value="0.01">Fentanyl (IV/IM)</option>
                                    <option value="0.3">Fentanyl (Transdermal mcg/hr)</option>
                                    <option value="5">Hydromorphone (PO)</option>
                                    <option value="1.5">Oxycodone (PO)</option>
                                    <option value="1.5">Hydrocodone (PO)</option>
                                    <option value="10">Tramadol (PO)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Dose</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="opioid-dose" placeholder="Enter dose" oninput="calcOpioid()" min="0" step="0.1">
                                    <span class="input-unit">mg (or mcg/hr for fentanyl patch)</span>
                                </div>
                            </div>
                        </div>
                        <div id="opioid-result" class="calc-result yellow">
                            <div class="result-label">Morphine Milligram Equivalent (MME)</div>
                            <div class="result-value"><span id="opioid-value">--</span><span class="result-unit">mg</span></div>
                            <div class="result-text">Use caution with opioid conversions - consider patient factors and start at lower doses.</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://www.cdc.gov/opioids/data-resources/calculating-mme.html" target="_blank" class="ref-link">
                                <span>Reference: CDC MME Conversion</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                    <!-- LOCAL ANESTHETIC MAX DOSE -->
                    <div class="calc-card" data-category="dosing">
                        <div class="calc-header">
                            <h3 class="calc-title">Local Anesthetic Max Dose</h3>
                            <p class="calc-desc">Maximum safe dosing to prevent LAST</p>
                        </div>
                        <div class="calc-body">
                            <div class="input-group">
                                <label class="input-label">Local Anesthetic</label>
                                <select class="calc-select" id="la-type" onchange="calcLA()">
                                    <option value="">Select...</option>
                                    <option value="lidocaine">Lidocaine (without epi)</option>
                                    <option value="lidocaine-epi">Lidocaine (with epi)</option>
                                    <option value="bupivacaine">Bupivacaine (without epi)</option>
                                    <option value="bupivacaine-epi">Bupivacaine (with epi)</option>
                                    <option value="ropivacaine">Ropivacaine</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Patient Weight</label>
                                <div class="input-wrapper">
                                    <input type="number" class="calc-input" id="la-weight" placeholder="Enter weight" oninput="calcLA()" min="0" step="0.1">
                                    <span class="input-unit">kg</span>
                                </div>
                            </div>
                        </div>
                        <div id="la-result" class="calc-result red">
                            <div class="result-label">Maximum Dose</div>
                            <div class="result-value"><span id="la-value">--</span><span class="result-unit">mg</span></div>
                            <div class="result-text" id="la-volume">--</div>
                        </div>
                        <div class="calc-reference">
                            <a href="https://www.nysora.com/topics/foundations-of-regional-anesthesia/pharmacology/local-anesthetics/" target="_blank" class="ref-link">
                                <span>Reference: NYSORA Guidelines</span>
                                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                </svg>
                            </a>
                        </div>
                    </div>

                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Toggle Mobile Menu
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            menu.classList.toggle('active');
            btn.classList.toggle('active');
        }

        // Toggle Navigation Dropdown
        function toggleNavDropdown(event) {
            event.stopPropagation();
            const dropdown = event.target.closest('.nav-dropdown');
            const menu = dropdown.querySelector('.nav-dropdown-menu');
            menu.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.nav-dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        });

        // Filter Calculators by Category
        function filterCalculators(category) {
            const cards = document.querySelectorAll('.calc-card');
            const buttons = document.querySelectorAll('.filter-btn');

            // Update button active states
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.closest('.filter-btn').classList.add('active');

            // Filter cards with smooth transition
            cards.forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.classList.remove('hidden');
                    // Smooth fade-in
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(10px)';
                    setTimeout(() => {
                        card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, 10);
                } else {
                    card.classList.add('hidden');
                }
            });
        }

        // IDEAL BODY WEIGHT
        function calcIBW() {
            const sex = document.getElementById('ibw-sex').value;
            const height = parseFloat(document.getElementById('ibw-height').value);
            const weight = parseFloat(document.getElementById('ibw-weight').value);

            if (!sex || !height) return;

            let ibw;
            if (sex === 'male') {
                ibw = 50 + 2.3 * (height - 60);
            } else {
                ibw = 45.5 + 2.3 * (height - 60);
            }

            ibw = Math.max(ibw, 0);
            document.getElementById('ibw-value').textContent = ibw.toFixed(1);

            // Calculate ABW if actual weight provided
            if (weight) {
                const abw = ibw + 0.4 * (weight - ibw);
                document.getElementById('abw-value').textContent = abw.toFixed(1);
                document.getElementById('abw-display').style.display = 'block';
            } else {
                document.getElementById('abw-display').style.display = 'none';
            }

            const result = document.getElementById('ibw-result');
            result.classList.add('show');
        }

        // BODY SURFACE AREA
        function calcBSA() {
            const height = parseFloat(document.getElementById('bsa-height').value);
            const weight = parseFloat(document.getElementById('bsa-weight').value);

            if (!height || !weight) return;

            // Mosteller
            const mosteller = Math.sqrt((height * weight) / 3600);

            // DuBois
            const dubois = 0.007184 * Math.pow(height, 0.725) * Math.pow(weight, 0.425);

            // Haycock
            const haycock = 0.024265 * Math.pow(height, 0.3964) * Math.pow(weight, 0.5378);

            document.getElementById('bsa-mosteller').textContent = mosteller.toFixed(2);
            document.getElementById('bsa-dubois').textContent = dubois.toFixed(2);
            document.getElementById('bsa-haycock').textContent = haycock.toFixed(2);

            const result = document.getElementById('bsa-result');
            result.classList.add('show');
        }

        // MAXIMUM ALLOWABLE BLOOD LOSS
        function calcMABL() {
            const type = document.getElementById('mabl-type').value;
            const weight = parseFloat(document.getElementById('mabl-weight').value);
            const startHct = parseFloat(document.getElementById('mabl-start-hct').value);
            const targetHct = parseFloat(document.getElementById('mabl-target-hct').value);

            if (!type || !weight || !startHct || !targetHct) return;

            let ebvPerKg;
            if (type === 'male') ebvPerKg = 75;
            else if (type === 'female') ebvPerKg = 65;
            else ebvPerKg = 85; // pediatric

            const ebv = weight * ebvPerKg;
            const avgHct = (startHct + targetHct) / 2;
            const mabl = ebv * ((startHct - targetHct) / avgHct);

            document.getElementById('ebv-value').textContent = Math.round(ebv);
            document.getElementById('mabl-value').textContent = Math.round(mabl);

            const result = document.getElementById('mabl-result');
            result.classList.add('show');
        }

        // QTc INTERVAL
        function calcQTc() {
            const qt = parseFloat(document.getElementById('qtc-qt').value);
            const hr = parseFloat(document.getElementById('qtc-hr').value);
            const sex = document.getElementById('qtc-sex').value;

            if (!qt || !hr) return;

            const rr = 60000 / hr; // RR interval in ms
            const qtc = qt / Math.sqrt(rr / 1000);

            document.getElementById('qtc-value').textContent = Math.round(qtc);

            let interpretation = '';
            let resultClass = 'green';

            if (sex === 'male') {
                if (qtc < 440) {
                    interpretation = 'Normal (< 440 ms in males)';
                    resultClass = 'green';
                } else if (qtc < 500) {
                    interpretation = 'Borderline prolonged (440-500 ms)';
                    resultClass = 'yellow';
                } else {
                    interpretation = 'Prolonged (> 500 ms) - High risk for arrhythmia';
                    resultClass = 'red';
                }
            } else if (sex === 'female') {
                if (qtc < 460) {
                    interpretation = 'Normal (< 460 ms in females)';
                    resultClass = 'green';
                } else if (qtc < 500) {
                    interpretation = 'Borderline prolonged (460-500 ms)';
                    resultClass = 'yellow';
                } else {
                    interpretation = 'Prolonged (> 500 ms) - High risk for arrhythmia';
                    resultClass = 'red';
                }
            } else {
                interpretation = 'Select sex for interpretation';
            }

            document.getElementById('qtc-interpretation').textContent = interpretation;

            const result = document.getElementById('qtc-result');
            result.className = 'calc-result ' + resultClass + ' show';
        }

        // MAINTENANCE FLUIDS
        function calcFluids() {
            const weight = parseFloat(document.getElementById('fluids-weight').value);

            if (!weight) return;

            let rate;
            if (weight <= 10) {
                rate = weight * 4;
            } else if (weight <= 20) {
                rate = 40 + (weight - 10) * 2;
            } else {
                rate = 60 + (weight - 20) * 1;
            }

            const daily = rate * 24;

            document.getElementById('fluids-value').textContent = Math.round(rate);
            document.getElementById('fluids-daily').textContent = Math.round(daily);

            const result = document.getElementById('fluids-result');
            result.classList.add('show');
        }

        // PONV RISK
        function calcPONV() {
            const female = document.getElementById('ponv-female').checked;
            const nonsmoker = document.getElementById('ponv-nonsmoker').checked;
            const history = document.getElementById('ponv-history').checked;
            const opioids = document.getElementById('ponv-opioids').checked;

            const score = (female ? 1 : 0) + (nonsmoker ? 1 : 0) + (history ? 1 : 0) + (opioids ? 1 : 0);

            const risks = [10, 20, 40, 60, 80];
            const risk = score === 0 ? 10 : score === 1 ? 20 : score === 2 ? 40 : score === 3 ? 60 : 80;

            document.getElementById('ponv-score').textContent = score;
            document.getElementById('ponv-value').textContent = risk;

            const result = document.getElementById('ponv-result');
            result.className = 'calc-result show';
            if (risk <= 20) result.classList.add('green');
            else if (risk <= 60) result.classList.add('yellow');
            else result.classList.add('red');
        }

        // RCRI
        function calcRCRI() {
            const surgery = document.getElementById('rcri-surgery').checked;
            const ihd = document.getElementById('rcri-ihd').checked;
            const chf = document.getElementById('rcri-chf').checked;
            const cvd = document.getElementById('rcri-cvd').checked;
            const dm = document.getElementById('rcri-dm').checked;
            const cr = document.getElementById('rcri-cr').checked;

            const score = (surgery ? 1 : 0) + (ihd ? 1 : 0) + (chf ? 1 : 0) + (cvd ? 1 : 0) + (dm ? 1 : 0) + (cr ? 1 : 0);

            const risks = [0.4, 1.0, 2.4, 5.4, 5.4, 5.4, 5.4];
            const risk = risks[score];

            document.getElementById('rcri-score').textContent = score;
            document.getElementById('rcri-value').textContent = risk.toFixed(1);

            const result = document.getElementById('rcri-result');
            result.className = 'calc-result show';
            if (score === 0) result.classList.add('green');
            else if (score <= 2) result.classList.add('yellow');
            else result.classList.add('red');
        }

        // ASA PHYSICAL STATUS
        function calcASA() {
            const selected = document.querySelector('input[name="asa"]:checked');
            if (!selected) return;

            const value = selected.value;
            const descriptions = {
                '1': 'Healthy patient with no systemic disease',
                '2': 'Mild systemic disease without functional limitations',
                '3': 'Severe systemic disease with definite functional limitations',
                '4': 'Severe systemic disease that is constant threat to life',
                '5': 'Moribund patient not expected to survive without operation',
                '6': 'Brain-dead patient whose organs are being removed for donation'
            };

            document.getElementById('asa-value').textContent = 'ASA ' + value;
            document.getElementById('asa-desc').textContent = descriptions[value];

            const result = document.getElementById('asa-result');
            result.style.display = 'block';
            result.className = 'calc-result show';
            if (value <= 2) result.classList.add('green');
            else if (value <= 3) result.classList.add('yellow');
            else result.classList.add('red');
        }

        // OPIOID CONVERSION
        function calcOpioid() {
            const type = parseFloat(document.getElementById('opioid-type').value);
            const dose = parseFloat(document.getElementById('opioid-dose').value);

            if (!type || !dose) return;

            const mme = dose / type;

            document.getElementById('opioid-value').textContent = mme.toFixed(1);

            const result = document.getElementById('opioid-result');
            result.classList.add('show');
        }

        // LOCAL ANESTHETIC MAX DOSE
        function calcLA() {
            const type = document.getElementById('la-type').value;
            const weight = parseFloat(document.getElementById('la-weight').value);

            if (!type || !weight) return;

            const maxDoses = {
                'lidocaine': 5,
                'lidocaine-epi': 7,
                'bupivacaine': 2.5,
                'bupivacaine-epi': 3,
                'ropivacaine': 3
            };

            const concentrations = {
                'lidocaine': '1% = 10 mg/mL, 2% = 20 mg/mL',
                'lidocaine-epi': '1% = 10 mg/mL, 2% = 20 mg/mL',
                'bupivacaine': '0.25% = 2.5 mg/mL, 0.5% = 5 mg/mL',
                'bupivacaine-epi': '0.25% = 2.5 mg/mL, 0.5% = 5 mg/mL',
                'ropivacaine': '0.2% = 2 mg/mL, 0.5% = 5 mg/mL'
            };

            const maxDose = weight * maxDoses[type];

            document.getElementById('la-value').textContent = Math.round(maxDose);
            document.getElementById('la-volume').textContent = 'Common concentrations: ' + concentrations[type];

            const result = document.getElementById('la-result');
            result.classList.add('show');
        }

        // Initialize PONV result on page load
        document.addEventListener('DOMContentLoaded', () => {
            calcPONV();
            calcRCRI();
        });
    </script>
</body>
</html>
"""

HYPOTENSION_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-01NZYD1DPP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-01NZYD1DPP');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IOH Predictor - GasConsult.ai</title>

    <!-- PWA -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="apple-touch-icon" href="/static/favicon.svg?v=6">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#2563EB">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
            --orange-50: #FFF7ED;
            --orange-500: #F97316;
            --red-50: #FEF2F2;
            --red-500: #EF4444;
            --red-600: #DC2626;
            --green-50: #ECFDF5;
            --green-500: #10B981;
            --amber-50: #FFFBEB;
            --amber-500: #F59E0B;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glass Background */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show { display: block; }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active { display: flex; }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        /* Main Content */
        .main {
            flex: 1;
            padding: 100px 20px 60px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* Hero */
        .hero {
            text-align: center;
            margin-bottom: 48px;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--orange-50) 0%, #FEE2E2 100%);
            border: 1px solid rgba(249, 115, 22, 0.2);
            border-radius: 100px;
            padding: 8px 16px 8px 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(249, 115, 22, 0.08);
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--orange-500);
            border-radius: 50%;
        }

        .badge-text {
            font-size: 12px;
            font-weight: 600;
            color: #EA580C;
        }

        .hero-title {
            font-size: 42px;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -1.5px;
            color: var(--gray-900);
            margin-bottom: 16px;
        }

        .hero-title .gradient {
            background: linear-gradient(135deg, var(--orange-500) 0%, var(--red-600) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero-subtitle {
            font-size: 17px;
            font-weight: 400;
            line-height: 1.6;
            color: var(--gray-600);
            max-width: 680px;
            margin: 0 auto;
        }

        /* Glass Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
            animation: fade-up 0.6s ease forwards;
            opacity: 0;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
            margin-bottom: 12px;
        }

        .section-subtitle {
            font-size: 15px;
            line-height: 1.7;
            color: var(--gray-600);
            margin-bottom: 28px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .required {
            color: var(--red-600);
            margin-left: 2px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--gray-300);
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .section-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 24px 0;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* Risk Cards */
        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .risk-card {
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .risk-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        .risk-card.low {
            background: var(--green-50);
            border-color: var(--green-500);
        }

        .risk-card.moderate {
            background: var(--amber-50);
            border-color: var(--amber-500);
        }

        .risk-card.high {
            background: var(--red-50);
            border-color: var(--red-500);
        }

        .risk-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-value {
            font-size: 40px;
            font-weight: 900;
            margin-bottom: 8px;
            line-height: 1;
        }

        .risk-card.low .risk-value { color: var(--green-500); }
        .risk-card.moderate .risk-value { color: var(--amber-500); }
        .risk-card.high .risk-value { color: var(--red-500); }

        .risk-text {
            font-size: 13px;
            font-weight: 600;
            color: var(--gray-700);
        }

        /* Factor/Intervention Cards */
        .factor-card {
            background: var(--blue-50);
            border-left: 4px solid var(--blue-600);
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .factor-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .intervention-card {
            background: var(--green-50);
            border-left: 4px solid var(--green-500);
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .intervention-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
        }

        .card-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 6px;
        }

        .card-desc {
            font-size: 14px;
            line-height: 1.6;
            color: var(--gray-700);
        }

        /* Model Evidence Section */
        .evidence-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .evidence-card {
            background: var(--blue-50);
            border: 1px solid var(--blue-200);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .evidence-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15);
        }

        .evidence-number {
            width: 40px;
            height: 40px;
            background: var(--blue-600);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .evidence-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .evidence-text {
            font-size: 14px;
            line-height: 1.7;
            color: var(--gray-700);
        }

        .evidence-text strong {
            color: var(--blue-700);
            font-weight: 600;
        }

        /* Footer */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        /* Social Media Icons */
        
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }


        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--gray-200);
            color: var(--gray-900);
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            margin-top: 24px;
        }

        .back-btn:hover {
            background: var(--gray-300);
            transform: translateX(-2px);
        }

        /* Responsive */
        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            .main { padding: 120px 32px 80px; }
            .hero-title { font-size: 52px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .main { padding: 140px 40px 100px; }
            .footer { padding: 48px 40px; }
        }

        /* Disclaimer Banner */
        .disclaimer {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(220, 38, 38, 0.05) 100%);
            border: 2px solid rgba(239, 68, 68, 0.2);
            border-radius: 16px;
            padding: 20px 24px;
            margin-bottom: 32px;
            display: flex;
            align-items: start;
            gap: 16px;
        }

        .disclaimer-icon {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            color: var(--red-600);
        }

        .disclaimer-text {
            font-size: 14px;
            line-height: 1.7;
            color: var(--gray-800);
        }

        .disclaimer-text strong {
            font-weight: 700;
            color: var(--red-600);
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 20px;
            padding: 32px 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Generating Assessment...</div>
        </div>
    </div>

    <!-- Background -->
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-inner">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span>
                    </div>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link active">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <!-- Main Content -->
        <main class="main">
            <!-- Hero -->
            <div class="hero">
                <div class="hero-badge">
                    <div class="badge-dot"></div>
                    <span class="badge-text">Machine Learning</span>
                </div>
                <h1 class="hero-title">
                    Intraoperative <span class="gradient">Hypotension</span> Predictor
                </h1>
                <p class="hero-subtitle">
                    Evidence-based ML model that predicts IOH risk using 14 clinical features. Trained on 6,388 real surgical cases from the VitalDB open dataset.
                </p>
            </div>

            <!-- Disclaimer -->
            <div class="disclaimer">
                <svg class="disclaimer-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div class="disclaimer-text">
                    <strong>Educational Tool Only:</strong> This ML model is designed for learning about IOH risk prediction. It is NOT intended for clinical decision-making or actual patient care. Always consult evidence-based guidelines and clinical judgment for real patient management.
                </div>
            </div>

            {% if not prediction %}
            <!-- Prediction Form -->
            <div class="glass-card">
                <h2 class="section-title">Patient & Hemodynamic Parameters</h2>
                <p class="section-subtitle">
                    Enter current intraoperative data to estimate IOH risk using our RandomForest classifier.
                </p>

                <form method="POST" action="/hypotension">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <!-- Patient Demographics -->
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">Patient Information</h3>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Age<span class="required">*</span></label>
                            <input type="number" name="age" class="form-input" placeholder="65" required min="18" max="120">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sex<span class="required">*</span></label>
                            <select name="sex" class="form-input" required>
                                <option value="">Select...</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Weight (kg)<span class="required">*</span></label>
                            <input type="number" name="weight" class="form-input" placeholder="70" required min="30" max="300" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Height (cm)<span class="required">*</span></label>
                            <input type="number" name="height" class="form-input" placeholder="170" required min="100" max="250">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ASA Class<span class="required">*</span></label>
                        <select name="asa" class="form-input" required>
                            <option value="">Select...</option>
                            <option value="1">ASA I - Healthy</option>
                            <option value="2">ASA II - Mild systemic disease</option>
                            <option value="3">ASA III - Severe systemic disease</option>
                            <option value="4">ASA IV - Life-threatening disease</option>
                        </select>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Hemodynamic Parameters -->
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">Hemodynamic Parameters</h3>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Baseline MAP (mmHg)<span class="required">*</span></label>
                            <input type="number" name="baseline_map" class="form-input" placeholder="85" required min="40" max="150">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Baseline HR (bpm)<span class="required">*</span></label>
                            <input type="number" name="baseline_hr" class="form-input" placeholder="75" required min="30" max="200">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Current MAP (mmHg)<span class="required">*</span></label>
                            <input type="number" name="current_map" class="form-input" placeholder="72" required min="40" max="150">
                        </div>
                        <div class="form-group">
                            <label class="form-label">MAP 5 min ago<span class="required">*</span></label>
                            <input type="number" name="map_5min" class="form-input" placeholder="76" required min="40" max="150">
                        </div>
                        <div class="form-group">
                            <label class="form-label">MAP 10 min ago<span class="required">*</span></label>
                            <input type="number" name="map_10min" class="form-input" placeholder="80" required min="40" max="150">
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Surgical & Anesthetic Factors -->
                    <h3 style="font-size: 18px; font-weight: 700; color: var(--gray-900); margin-bottom: 16px;">Surgical & Anesthetic Factors</h3>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Surgery Type<span class="required">*</span></label>
                            <select name="surgery_type" class="form-input" required>
                                <option value="">Select...</option>
                                <option value="minor">Minor Surgery</option>
                                <option value="moderate">Moderate Surgery</option>
                                <option value="major_abdominal">Major Abdominal</option>
                                <option value="cardiac">Cardiac Surgery</option>
                                <option value="vascular">Vascular Surgery</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Surgery Duration (min)<span class="required">*</span></label>
                            <input type="number" name="surgery_duration" class="form-input" placeholder="120" required min="0" max="1000">
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label class="form-label">Induction Agent<span class="required">*</span></label>
                            <select name="induction_agent" class="form-input" required>
                                <option value="">Select...</option>
                                <option value="propofol">Propofol</option>
                                <option value="etomidate">Etomidate</option>
                                <option value="ketamine">Ketamine</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Vasopressor in Use<span class="required">*</span></label>
                            <select name="vasopressor" class="form-input" required>
                                <option value="none">None</option>
                                <option value="phenylephrine">Phenylephrine</option>
                                <option value="ephedrine">Ephedrine</option>
                                <option value="norepinephrine">Norepinephrine</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Emergency Surgery<span class="required">*</span></label>
                        <select name="emergency" class="form-input" required>
                            <option value="no">No</option>
                            <option value="yes">Yes</option>
                        </select>
                    </div>

                    <button type="submit" class="submit-btn">Calculate IOH Risk</button>
                </form>
            </div>

            {% else %}
            <!-- Prediction Results -->
            <div class="glass-card">
                <h2 class="section-title">Machine Learning Prediction Results</h2>
                <p class="section-subtitle">
                    RandomForest classifier analyzed 14 clinical features to estimate IOH probability.
                </p>

                <!-- Risk Probabilities -->
                <div class="risk-grid">
                    <div class="risk-card {{ prediction.risk_5min_class }}">
                        <div class="risk-label">5-Minute Risk</div>
                        <div class="risk-value">{{ prediction.prob_5min }}%</div>
                        <div class="risk-text">{{ prediction.risk_5min_text }}</div>
                    </div>
                    <div class="risk-card {{ prediction.risk_10min_class }}">
                        <div class="risk-label">10-Minute Risk</div>
                        <div class="risk-value">{{ prediction.prob_10min }}%</div>
                        <div class="risk-text">{{ prediction.risk_10min_text }}</div>
                    </div>
                    <div class="risk-card {{ prediction.risk_20min_class }}">
                        <div class="risk-label">20-Minute Risk</div>
                        <div class="risk-value">{{ prediction.prob_20min }}%</div>
                        <div class="risk-text">{{ prediction.risk_20min_text }}</div>
                    </div>
                </div>

                <!-- Risk Factors -->
                <h3 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-top: 40px; margin-bottom: 20px;">Top Risk Factors Identified</h3>
                {% for factor in prediction.factors %}
                <div class="factor-card">
                    <div class="card-title">{{ factor.name }}</div>
                    <div class="card-desc">{{ factor.description }}</div>
                </div>
                {% endfor %}

                <!-- Interventions -->
                <h3 style="font-size: 20px; font-weight: 700; color: var(--gray-900); margin-top: 40px; margin-bottom: 20px;">Suggested Interventions</h3>
                {% for intervention in prediction.interventions %}
                <div class="intervention-card">
                    <div class="card-title">{{ intervention.name }}</div>
                    <div class="card-desc">{{ intervention.description }}</div>
                </div>
                {% endfor %}

                <a href="/hypotension" class="back-btn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Calculate Another
                </a>
            </div>
            {% endif %}

            <!-- Model Evidence & Transparency -->
            <div class="glass-card">
                <h2 class="section-title">How the ML Model Works</h2>
                <p class="section-subtitle">
                    Our RandomForest classifier provides transparent, evidence-based IOH risk predictions. Here's how it works:
                </p>

                <div class="evidence-grid">
                    <div class="evidence-card">
                        <div class="evidence-number">1</div>
                        <h3 class="evidence-title">Training Dataset</h3>
                        <p class="evidence-text">
                            Trained on <strong>6,388 real surgical cases</strong> from the VitalDB open dataset (Seoul National University Hospital, 2011-2020). Dataset includes high-resolution intraoperative vital signs across diverse surgical procedures.
                        </p>
                    </div>

                    <div class="evidence-card">
                        <div class="evidence-number">2</div>
                        <h3 class="evidence-title">14 Clinical Features</h3>
                        <p class="evidence-text">
                            Model analyzes <strong>demographics</strong> (age, sex, BMI, ASA), <strong>hemodynamics</strong> (MAP trends, HR), and <strong>surgical factors</strong> (type, duration, induction agent, emergency status).
                        </p>
                    </div>

                    <div class="evidence-card">
                        <div class="evidence-number">3</div>
                        <h3 class="evidence-title">RandomForest Algorithm</h3>
                        <p class="evidence-text">
                            Uses <strong>300 decision trees</strong> with balanced class weights and feature scaling. <strong>ROC-AUC: 0.87, Test accuracy: 89%</strong>. Most important features: current MAP (18%), MAP 5-min trend (15%), MAP 10-min trend (12%).
                        </p>
                    </div>

                    <div class="evidence-card">
                        <div class="evidence-number">4</div>
                        <h3 class="evidence-title">Evidence-Based</h3>
                        <p class="evidence-text">
                            Training data from <strong>VitalDB open dataset</strong> (Lee et al. Nature Sci Data 2022). Performance comparable to published ML models: Springer 2024 (ROC-AUC: 0.92), eClinicalMedicine 2024 (ROC-AUC: 0.93).
                        </p>
                    </div>

                    <div class="evidence-card">
                        <div class="evidence-number">5</div>
                        <h3 class="evidence-title">Interpretable Outputs</h3>
                        <p class="evidence-text">
                            Provides <strong>3 time-windowed predictions</strong> (5/10/20 min) with decay modeling. Identifies top risk factors and suggests evidence-based interventions for clinical context.
                        </p>
                    </div>

                    <div class="evidence-card">
                        <div class="evidence-number">6</div>
                        <h3 class="evidence-title">Clinical Validation</h3>
                        <p class="evidence-text">
                            Trained and validated on <strong>real surgical data</strong> from 6,388 cases. Test set performance: ROC-AUC 0.87. Model can be retrained as new evidence emerges. For educational purposes only.
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        // Dropdown toggle
        function toggleNavDropdown(event) {
            event.stopPropagation();
            const menu = event.currentTarget.nextElementSibling;
            menu.classList.toggle('show');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!event.currentTarget.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        // Show loading overlay when form is submitted
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[method="POST"]');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (form && loadingOverlay) {
                form.addEventListener('submit', function(e) {
                    // Show loading overlay
                    loadingOverlay.classList.add('active');
                });
            }
        });
    </script>
</body>
</html>
"""

@app.route("/stream")
@csrf.exempt  # SSE endpoint uses GET requests, CSRF not applicable
def stream():
    """Server-Sent Events endpoint for streaming GPT responses"""
    request_id = request.args.get('request_id')

    logger.info(f"[STREAM] Received request with request_id: {request_id}")

    if not request_id:
        logger.error("[STREAM] No request_id provided")
        error_msg = json.dumps({'type': 'error', 'message': 'No request ID provided'})
        return Response(f"data: {error_msg}\n\n", mimetype='text/event-stream')

    stream_key = f'stream_data_{request_id}'
    stream_data = None

    # Try to get from session first
    logger.info(f"[STREAM] Looking for key: {stream_key}")
    logger.info(f"[STREAM] Session stream keys: {[k for k in session.keys() if k.startswith('stream_')]}")

    if stream_key in session:
        stream_data = session[stream_key]
        logger.info(f"[STREAM] Found stream data in session")
    else:
        # Fallback to in-memory cache
        logger.info(f"[STREAM] Session miss, checking cache...")
        logger.info(f"[STREAM] Cache keys: {list(STREAM_DATA_CACHE.keys())}")
        stream_data = get_stream_data(request_id)
        if stream_data:
            logger.info(f"[STREAM] Found stream data in cache (session fallback)")

    if not stream_data:
        logger.error(f"[STREAM] Stream data not found in session or cache for key: {stream_key}")
        logger.error(f"[STREAM] This usually means the session was not properly shared between requests")
        logger.error(f"[STREAM] If using multiple workers, consider using Redis for session storage")
        error_msg = json.dumps({
            'type': 'error',
            'message': 'Session expired or not found. This can happen if the server restarted. Please go back and try again.'
        })
        return Response(f"data: {error_msg}\n\n", mimetype='text/event-stream')

    # Extract data from stream_data (already retrieved from session or cache)
    prompt = stream_data['prompt']
    refs = stream_data['refs']
    num_papers = stream_data['num_papers']
    raw_query = stream_data['raw_query']

    def generate():
        try:
            # Send initial event to confirm connection
            yield f"data: {json.dumps({'type': 'connected'})}\n\n"

            # Dynamic temperature based on question type and evidence availability
            question_type = stream_data.get('question_type', 'general')

            if question_type == 'casual':
                # Casual conversation - natural, friendly temperature
                temperature = 0.7
            elif num_papers == 0:
                # No papers - use higher temperature for general knowledge
                temperature = 0.2
            elif question_type == 'dosing':
                # Dosing questions need very precise answers
                temperature = 0.05
            elif question_type == 'safety':
                # Safety questions need factual accuracy
                temperature = 0.1
            elif question_type == 'mechanism':
                # Mechanism explanations can be slightly more fluid
                temperature = 0.15
            elif question_type == 'comparison':
                # Comparisons need balanced precision
                temperature = 0.1
            else:
                # Default (general, management)
                temperature = 0.1

            logger.debug(f"Using temperature {temperature} for question type '{question_type}'")

            # Stream GPT response
            stream_response = openai_client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": prompt}],
                temperature=temperature,
                stream=True
            )

            full_response = ""
            for chunk in stream_response:
                if chunk.choices[0].delta.content:
                    content = chunk.choices[0].delta.content
                    full_response += content
                    # Send content chunk - ensure_ascii=False to preserve HTML characters
                    yield f"data: {json.dumps({'type': 'content', 'data': content}, ensure_ascii=False)}\n\n"

            # Calculate evidence strength (skip for casual conversations)
            if question_type == 'casual':
                evidence_strength = None  # No evidence badge for casual chat
            else:
                evidence_strength = get_evidence_strength(num_papers, refs)

            # Clean markdown code fences from the response
            cleaned_response = strip_markdown_code_fences(full_response)

            # Save complete response to session
            logger.debug(f"[STREAM] Before saving - session has {len(session.get('messages', []))} messages")
            for i, msg in enumerate(session.get('messages', [])):
                logger.debug(f"[STREAM]   Message {i}: role={msg.get('role')}, content_length={len(msg.get('content', ''))}")

            # CRITICAL FIX: Get a copy of messages list to force Flask session change detection
            # Modifying nested list items directly (session['messages'][-1] = ...) doesn't
            # properly trigger Flask's filesystem session backend to persist changes
            messages = list(session.get('messages', []))

            # Check if last message is an empty assistant placeholder (from homepage redirect)
            # If so, update it instead of appending a new one
            if (messages and
                len(messages) > 0 and
                messages[-1].get('role') == 'assistant' and
                messages[-1].get('content') == ''):
                # Update the placeholder
                messages[-1] = {
                    "role": "assistant",
                    "content": cleaned_response,
                    "references": refs,
                    "num_papers": num_papers,
                    "evidence_strength": evidence_strength
                }
                logger.debug("[STREAM] Updated existing placeholder assistant message")
            else:
                # Append new message (for AJAX submissions from chat page)
                messages.append({
                    "role": "assistant",
                    "content": cleaned_response,
                    "references": refs,
                    "num_papers": num_papers,
                    "evidence_strength": evidence_strength
                })
                logger.debug("[STREAM] Appended new assistant message")

            # Reassign entire list to trigger Flask session change detection
            session['messages'] = messages
            session.modified = True

            # CRITICAL: Explicitly save session for SSE streaming responses
            # Even with Redis, generator functions need manual session save because
            # Flask only auto-saves at the end of the request, but generators
            # are still yielding data. We must force the save NOW before continuing.
            try:
                # Create a mock response object for save_session
                from werkzeug.wrappers import Response as WerkzeugResponse
                mock_response = WerkzeugResponse()
                app.session_interface.save_session(app, session, mock_response)
                logger.debug("[STREAM] Explicitly saved session to Redis")
            except Exception as e:
                logger.error(f"[STREAM] Failed to explicitly save session: {e}")

            logger.debug(f"[STREAM] After saving - session has {len(session['messages'])} messages")
            logger.debug(f"[STREAM] Verified last message content_length: {len(messages[-1].get('content', ''))}")

            # [PHASE 2] Save assistant response to database (non-blocking)
            conversation_id = session.get('conversation_id')
            if conversation_id:
                if safe_db_save_message(
                    conversation_id=conversation_id,
                    role="assistant",
                    content=cleaned_response,
                    references=refs,
                    num_papers=num_papers,
                    evidence_strength=evidence_strength
                ):
                    logger.info("Saved assistant response to database")
                else:
                    logger.debug("Assistant response not saved to database (feature disabled or error)")
            else:
                logger.debug("No conversation_id in session, skipping database save")

            # Send references with evidence strength
            yield f"data: {json.dumps({'type': 'references', 'data': refs, 'num_papers': num_papers, 'evidence_strength': evidence_strength}, ensure_ascii=False)}\n\n"

            # Send completion event
            yield f"data: {json.dumps({'type': 'done'})}\n\n"

            # Clean up stream data from session
            session.pop(f'stream_data_{request_id}', None)
            session.modified = True

        except Exception as e:
            logger.error(f"Streaming failed: {e}")
            yield f"data: {json.dumps({'type': 'error', 'message': str(e)})}\n\n"

    return Response(stream_with_context(generate()), mimetype='text/event-stream')

# ============================================================================
# PubMed Query Caching Functions
# ============================================================================

def generate_cache_key(search_term, retmax=20):
    """Generate a cache key for PubMed queries"""
    key_string = f"pubmed:{search_term}:{retmax}"
    return f"pubmed_query:{hashlib.md5(key_string.encode()).hexdigest()}"

def get_cached_pubmed_results(search_term, retmax=20):
    """Retrieve cached PubMed search results"""
    if not redis_client:
        return None

    try:
        cache_key = generate_cache_key(search_term, retmax)
        cached = redis_client.get(cache_key)
        if cached:
            logger.debug(f"Cache hit for query: {search_term[:50]}")
            return json.loads(cached)
        logger.debug(f"Cache miss for query: {search_term[:50]}")
        return None
    except Exception as e:
        logger.error(f"Failed to retrieve from cache: {e}")
        return None

def cache_pubmed_results(search_term, ids, retmax=20, ttl=86400):
    """Cache PubMed search results (default TTL: 24 hours)"""
    if not redis_client:
        return False

    try:
        cache_key = generate_cache_key(search_term, retmax)
        cache_data = {
            'ids': ids,
            'search_term': search_term,
            'timestamp': str(datetime.now()),
            'count': len(ids)
        }
        redis_client.setex(cache_key, ttl, json.dumps(cache_data))
        logger.debug(f"Cached {len(ids)} results for query: {search_term[:50]}")
        return True
    except Exception as e:
        logger.error(f"Failed to save to cache: {e}")
        return False

def get_cached_paper_metadata(pmid):
    """Retrieve cached paper metadata"""
    if not redis_client:
        return None

    try:
        cache_key = f"pubmed_paper:{pmid}"
        cached = redis_client.get(cache_key)
        if cached:
            return json.loads(cached)
        return None
    except Exception as e:
        logger.error(f"Failed to retrieve paper {pmid} from cache: {e}")
        return None

def cache_paper_metadata(pmid, metadata, ttl=604800):
    """Cache paper metadata (default TTL: 7 days)"""
    if not redis_client:
        return False

    try:
        cache_key = f"pubmed_paper:{pmid}"
        redis_client.setex(cache_key, ttl, json.dumps(metadata))
        return True
    except Exception as e:
        logger.error(f"Failed to cache paper {pmid}: {e}")
        return False

# ============================================================================
# Main Route
# ============================================================================

@app.route("/", methods=["GET", "POST"])
def index():
    """Homepage - handles both welcome screen and chat"""
    # Check if user wants to clear chat and return to hero state
    if request.method == "GET" and request.args.get('clear') == '1':
        session.pop('messages', None)
        session.pop('chat_active', None)
        session.pop('conversation_topic', None)
        # [PHASE 2] Clear conversation ID to start a new conversation
        session.pop('conversation_id', None)
        session.modified = True
        return redirect(url_for('index'))

    # Initialize conversation history in session
    if 'messages' not in session:
        session['messages'] = []

    # Initialize conversation topic tracking
    if 'conversation_topic' not in session:
        session['conversation_topic'] = None

    # Explicitly initialize session to ensure CSRF token is generated
    if 'initialized' not in session:
        session['initialized'] = True

    if request.method == "POST":
        try:
            # Safely get query from form data and sanitize it
            raw_query = request.form.get("query", "").strip()
            logger.debug(f"Form data received: {dict(request.form)}")
            logger.debug(f"Query field raw value: '{request.form.get('query', 'MISSING')}'")
            logger.debug(f"Is AJAX: {request.headers.get('X-Requested-With') == 'XMLHttpRequest'}")
            logger.debug(f"Session messages count: {len(session.get('messages', []))}")
            raw_query = sanitize_user_query(raw_query)

            # Check if this is an AJAX request
            is_ajax = request.headers.get('X-Requested-With') == 'XMLHttpRequest' or request.form.get('modal') == '1'

            # If query is empty, return appropriate response
            if not raw_query:
                logger.debug("Empty query received - likely issue with form submission")
                if is_ajax:
                    return jsonify({'status': 'error', 'message': 'Please enter a question before submitting.'})
                # Return to homepage with error message in session
                session['error_message'] = 'Please enter a question before submitting.'
                session.modified = True
                return redirect(url_for('index'))

            logger.debug(f"===== NEW REQUEST =====")
            logger.debug(f"Raw query: '{raw_query}'")
            logger.debug(f"Session has {len(session['messages'])} messages before")

            # Check if this is the first message (from homepage)
            is_first_message = len(session['messages']) == 0

            # [PHASE 2] Get or create conversation ID for database persistence
            conversation_id, is_new_conversation = get_or_create_conversation_id()

            # Set conversation topic on first message (for context in future vague queries)
            if is_first_message and not session['conversation_topic']:
                # Extract main topic from first query (simple keyword extraction)
                topic_words = []
                for word in raw_query.lower().split():
                    # Keep medical terms (4+ chars, not common words)
                    if len(word) >= 4 and word not in ['what', 'about', 'when', 'where', 'which', 'that', 'this', 'with', 'from', 'have', 'been', 'does', 'should', 'would', 'could']:
                        topic_words.append(word)
                if topic_words:
                    session['conversation_topic'] = ' '.join(topic_words[:3])  # First 3 meaningful words
                    logger.debug(f"Conversation topic set: {session['conversation_topic']}")

            # [PHASE 2] If this is a new conversation, save it to database
            if is_new_conversation:
                # Generate conversation title from first query
                conversation_title = database.generate_conversation_title(raw_query) if DATABASE_AVAILABLE else raw_query[:60]
                user_session_id = session.get('persistent_session_id', 'anonymous')

                if safe_db_save_conversation(conversation_id, user_session_id, conversation_title):
                    logger.info(f"Created new conversation in database: {conversation_id}")
                else:
                    logger.info(f"Conversation not saved to database (feature disabled or error)")

            # Add user message to conversation
            session['messages'].append({"role": "user", "content": raw_query})
            session['chat_active'] = True  # Set chat mode flag
            session.modified = True
            logger.debug(f"Added user message, session now has {len(session['messages'])} messages")

            # [PHASE 2] Save user message to database (non-blocking)
            if safe_db_save_message(conversation_id, "user", raw_query):
                logger.info(f"Saved user message to database")
            else:
                logger.info(f"User message not saved to database (feature disabled or error)")

            # Check if this is a calculation request
            context_hint = None
            if len(session['messages']) >= 3:
                last_msgs = session['messages'][-4:]
                for msg in last_msgs:
                    content = msg.get('content', '').lower()
                    if any(term in content for term in ['mabl', 'ibw', 'bsa', 'qtc', 'maintenance fluid', 'ideal body weight', 'body surface']):
                        for term in ['mabl', 'ibw', 'bsa', 'qtc', 'maintenance fluid']:
                            if term in content:
                                context_hint = term
                                break
                        break

            calc_result = detect_and_calculate(raw_query, context_hint=context_hint)

            if calc_result:
                logger.debug(f"Calculator result generated")
                session['messages'].append({
                    "role": "assistant",
                    "content": calc_result,
                    "references": [],
                    "num_papers": 0
                })
                session.modified = True

                # [PHASE 2] Save calculator result to database (non-blocking)
                if safe_db_save_message(conversation_id, "assistant", calc_result, references=[], num_papers=0):
                    logger.info(f"Saved calculator result to database")

                if is_ajax:
                    return jsonify({
                        'status': 'calculation',
                        'result': calc_result,
                        'message': 'Calculation complete'
                    })
                logger.debug(f"Redirecting after calculation")
                return redirect(url_for('index'))

            query = clean_query(raw_query)
            logger.debug(f"Cleaned query: '{query}'")

            # ========== DETECT QUERY INTENT (Casual vs Medical) ==========
            query_intent = detect_query_intent(query)
            logger.debug(f"Query intent: {query_intent}")

            # If casual query, respond with streaming (no PubMed search)
            if query_intent == 'casual':
                logger.debug(f"Handling as casual conversation - preparing streaming")

                # Build minimal conversation context (last 3 messages)
                context = ""
                recent = session['messages'][-4:-1]  # Exclude just-added user message
                for msg in recent:
                    if msg['role'] == 'user':
                        context += f"User: {msg['content']}\n"
                    else:
                        # Strip HTML and truncate
                        content_text = re.sub('<[^<]+?>', '', msg.get('content', ''))
                        context += f"Assistant: {content_text[:200]}\n"

                # Build casual conversation prompt
                prompt = f"""You are gasconsult.ai, a friendly AI assistant specialized in anesthesiology. The user just sent a casual message (greeting, small talk, or non-medical question).

Previous conversation:
{context if context else "New conversation."}

User's message: {raw_query}

Respond naturally and warmly as a helpful assistant. Keep it brief (2-3 sentences max). If appropriate, gently remind them that you specialize in anesthesiology questions but are happy to chat.

Use HTML formatting: <p> for paragraphs, <strong> for emphasis.

CRITICAL: Return ONLY the HTML content - do NOT wrap your response in markdown code fences (```html or ```)."""

                # Generate unique request ID for streaming
                request_id = str(uuid.uuid4())

                # Prepare stream data (casual mode)
                stream_data = {
                    'prompt': prompt,
                    'refs': [],  # No references for casual chat
                    'num_papers': 0,
                    'raw_query': raw_query,
                    'question_type': 'casual'  # Special type for temperature 0.7
                }

                # Store in session
                session[f'stream_data_{request_id}'] = stream_data
                session.modified = True

                # Also store in memory cache as backup
                store_stream_data(request_id, stream_data)

                logger.debug(f"Casual stream data prepared, request_id: {request_id}")

                # Add placeholder assistant message for streaming to populate
                session['messages'].append({
                    "role": "assistant",
                    "content": "",  # Will be populated by streaming
                    "references": [],
                    "num_papers": 0
                })
                session['pending_stream'] = request_id
                session.modified = True

                # Return response
                if is_ajax:
                    return jsonify({
                        'status': 'ready',
                        'request_id': request_id,
                        'raw_query': raw_query
                    })

                logger.debug(f"Redirecting for casual streaming")
                return redirect(url_for('index'))

            # ========== CONTINUE WITH MEDICAL QUERY (existing code) ==========
            logger.debug(f"Handling as medical query - proceeding with PubMed search")

            is_followup = len(session['messages']) >= 3
            logger.debug(f"Is follow-up: {is_followup}")

            # Resolve pronouns and references using conversation context
            query = resolve_references(query, session['messages'][:-1])  # Exclude the just-added user message
            logger.debug(f"After reference resolution: '{query}'")

            # Detect question type for customized search and temperature
            question_type = detect_question_type(query)
            logger.debug(f"Question type: {question_type}")

            # Detect if this is a multi-part question
            is_multipart = detect_multipart(query)
            if is_multipart:
                logger.debug(f"Multi-part question detected")

            # Handle negations (contraindications, when NOT to use, etc.)
            negation_search_modifier, negation_prompt_modifier = handle_negations(query)
            if negation_search_modifier:
                logger.debug(f"Negation detected - will modify search and prompt")

            # Expand medical abbreviations and synonyms
            q = expand_medical_abbreviations(query)

            # Boost emergency protocol searches
            query_lower = query.lower()
            if any(word in query_lower for word in ['protocol', 'checklist', 'crisis', 'emergency', 'management']):
                # Add protocol/guideline terms to boost relevant results
                if 'malignant hyperthermia' in query_lower or 'mh' in query_lower:
                    q = q + ' AND (protocol[ti] OR emergency[ti] OR crisis[ti] OR treatment[ti])'
                elif any(term in query_lower for term in ['rapid sequence', 'rsi', 'intubation']):
                    q = q + ' AND (protocol[ti] OR guideline[ti] OR airway[ti])'
                elif 'last' in query_lower or 'local anesthetic' in query_lower:
                    q = q + ' AND (protocol[ti] OR treatment[ti] OR resuscitation[ti])'

            logger.debug(f"Expanded query: '{q}'")

            # Detect well-established topics that should have lots of evidence
            well_established_topics = [
                'malignant hyperthermia', 'difficult airway', 'aspiration', 'local anesthetic systemic toxicity',
                'last', 'propofol infusion syndrome', 'pris', 'anaphylaxis', 'tranexamic acid', 'txa',
                'postoperative nausea', 'ponv', 'rapid sequence', 'rsi', 'spinal anesthesia', 'epidural',
                'general anesthesia', 'blood transfusion', 'massive transfusion', 'coagulopathy'
            ]
            is_established_topic = any(topic in query_lower for topic in well_established_topics)

            # Adjust date range for established topics (go back further for classic evidence)
            date_range = '("2010/01/01"[PDAT] : "3000"[PDAT])' if is_established_topic else '("2018/01/01"[PDAT] : "3000"[PDAT])'

            # Customize search based on question type
            if is_followup:
                # Broader search for follow-ups
                search_term = f'({q}) AND ("2010/01/01"[PDAT] : "3000"[PDAT])'
            else:
                # Customize search filters based on question type with tighter date ranges
                if question_type == 'dosing':
                    # Prioritize guidelines and reviews for dosing questions
                    search_term = (
                        f'({q}) AND '
                        f'(guideline[pt] OR "practice guideline"[pt] OR review[pt] OR meta-analysis[pt]) AND '
                        f'{date_range}'
                    )
                elif question_type == 'safety':
                    # Include adverse effects and safety studies
                    search_term = (
                        f'({q}) AND '
                        f'(systematic review[pt] OR meta-analysis[pt] OR "randomized controlled trial"[pt] OR '
                        f'guideline[pt] OR "adverse effects"[sh] OR safety[ti]) AND '
                        f'{date_range}'
                    )
                elif question_type == 'comparison':
                    # Prioritize comparative studies
                    search_term = (
                        f'({q}) AND '
                        f'(systematic review[pt] OR meta-analysis[pt] OR "randomized controlled trial"[pt] OR '
                        f'"comparative study"[pt]) AND '
                        f'{date_range}'
                    )
                else:
                    # Default search (general, mechanism, management)
                    search_term = (
                        f'({q}) AND '
                        f'(systematic review[pt] OR meta-analysis[pt] OR "randomized controlled trial"[pt] OR '
                        f'"Cochrane Database Syst Rev"[ta] OR guideline[pt]) AND '
                        f'{date_range}'
                    )

            # Add negation modifier if detected
            if negation_search_modifier:
                search_term += negation_search_modifier

            logger.debug(f"Search term: '{search_term[:150]}...'")

            # Multi-tier search strategy to find relevant papers
            ids = []

            # Tier 1: Broad perioperative/critical care context (inclusive of related specialties)
            # Anesthesia is closely tied to critical care, ICU, surgery, emergency medicine, and pain
            # Be INCLUSIVE of related fields while excluding obviously unrelated specialties
            periop_context = (
                '(anesthesia[MeSH Terms] OR anesthesiology[MeSH Terms] OR anesthetics[MeSH Terms] OR '
                'perioperative[tiab] OR intraoperative[tiab] OR postoperative[tiab] OR preoperative[tiab] OR '
                '"critical care"[MeSH Terms] OR "intensive care"[tiab] OR "ICU"[tiab] OR "critical illness"[tiab] OR '
                '"surgical anesthesia"[tiab] OR "anesthetic management"[tiab] OR '
                'surgery[MeSH Subheading] OR surgical[tiab] OR "operating room"[tiab] OR '
                '"emergency medicine"[MeSH Terms] OR resuscitation[MeSH Terms] OR "trauma"[tiab] OR '
                '"pain management"[tiab] OR "acute pain"[tiab] OR "pain medicine"[tiab] OR '
                'airway[tiab] OR "airway management"[tiab] OR ventilation[tiab] OR hemodynamic[tiab] OR '
                '"fluid management"[tiab] OR "blood transfusion"[tiab] OR shock[tiab])'
            )

            # Include papers from major related journals (anesthesia, critical care, surgery, emergency, general medical)
            # This is an OR boost, not a filter - papers in other journals are NOT excluded
            related_journals = (
                '("Anesthesiology"[Journal] OR "Anesthesia and Analgesia"[Journal] OR '
                '"British Journal of Anaesthesia"[Journal] OR "Anaesthesia"[Journal] OR '
                '"Critical Care Medicine"[Journal] OR "Intensive Care Medicine"[Journal] OR '
                '"Critical Care"[Journal] OR "Shock"[Journal] OR '
                '"JAMA Surgery"[Journal] OR "Annals of Surgery"[Journal] OR "Surgery"[Journal] OR '
                '"New England Journal of Medicine"[Journal] OR "JAMA"[Journal] OR '
                '"Lancet"[Journal] OR "Chest"[Journal] OR "Circulation"[Journal] OR '
                '"Emergency Medicine Journal"[Journal] OR "Academic Emergency Medicine"[Journal])'
            )

            tier1_search_term = f'{search_term} AND ({periop_context} OR {related_journals})'
            cached_result = get_cached_pubmed_results(tier1_search_term, retmax=20)

            if cached_result:
                ids = cached_result.get('ids', [])
                logger.debug(f"Tier 1 (CACHED): Found {len(ids)} papers")
            else:
                try:
                    logger.debug(f"Tier 1: Searching PubMed with anesthesiology context...")
                    handle = Entrez.esearch(db="pubmed", term=tier1_search_term, retmax=20, sort="relevance")
                    result = Entrez.read(handle)
                    ids = result.get("IdList", [])
                    logger.debug(f"Tier 1 found {len(ids)} papers")
                    # Cache the results
                    cache_pubmed_results(tier1_search_term, ids, retmax=20)
                except Exception as e:
                    logger.error(f"Tier 1 search failed: {e}")
                    ids = []

            # Tier 2: Even broader perioperative/critical care context (very inclusive)
            # Uses text words instead of MeSH for more flexibility
            # Includes critical care, ICU, surgical, emergency - all relevant to anesthesia practice
            if len(ids) < 5 and not is_followup:
                broader_periop = (
                    '(anesthesia[tiab] OR anesthesiology[tiab] OR anesthetic[tiab] OR '
                    'anaesthesia[tiab] OR anaesthetic[tiab] OR '
                    'perioperative[tiab] OR intraoperative[tiab] OR postoperative[tiab] OR '
                    'critical[tiab] OR ICU[tiab] OR intensive[tiab] OR '
                    'surgical[tiab] OR surgery[tiab] OR operative[tiab] OR '
                    'emergency[tiab] OR resuscitation[tiab] OR trauma[tiab] OR '
                    'airway[tiab] OR ventilat[tiab] OR hemodynamic[tiab] OR '
                    'pain[tiab] OR sedation[tiab])'
                )
                tier2_search_term = f'{search_term} AND {broader_periop}'

                # Check cache first
                cached_result = get_cached_pubmed_results(tier2_search_term, retmax=20)

                if cached_result:
                    tier2_ids = cached_result.get('ids', [])
                    ids = list(set(ids + tier2_ids))
                    logger.debug(f"Tier 2 (CACHED): Found {len(tier2_ids)} papers, total unique: {len(ids)}")
                else:
                    try:
                        logger.debug(f"Tier 2: Broader anesthesia context (still anesthesia-focused)...")
                        handle = Entrez.esearch(db="pubmed", term=tier2_search_term, retmax=20, sort="relevance")
                        result = Entrez.read(handle)
                        tier2_ids = result.get("IdList", [])
                        # Combine and deduplicate
                        ids = list(set(ids + tier2_ids))
                        logger.debug(f"Tier 2 found {len(tier2_ids)} papers, total unique: {len(ids)}")
                        # Cache the results
                        cache_pubmed_results(tier2_search_term, tier2_ids, retmax=20)
                    except Exception as e:
                        logger.error(f"Tier 2 search failed: {e}")

            # Tier 3: High-quality studies with broad perioperative context and extended date range
            if len(ids) < 5 and not is_followup:
                try:
                    logger.debug(f"Tier 3: High-quality studies with broad perioperative context...")
                    # Maintain perioperative/critical care context - inclusive of related fields
                    tier3_periop = (
                        '(anesthesia[tiab] OR anesthetic[tiab] OR perioperative[tiab] OR '
                        'surgical[tiab] OR critical[tiab] OR ICU[tiab] OR intensive[tiab] OR '
                        'emergency[tiab] OR resuscitation[tiab])'
                    )
                    broader_term = (
                        f'({q}) AND {tier3_periop} AND '
                        f'(systematic review[pt] OR meta-analysis[pt] OR "randomized controlled trial"[pt] OR guideline[pt] OR review[pt]) AND '
                        f'("2010/01/01"[PDAT] : "3000"[PDAT])'
                    )
                    handle = Entrez.esearch(db="pubmed", term=broader_term, retmax=15, sort="relevance")
                    result = Entrez.read(handle)
                    tier3_ids = result.get("IdList", [])
                    # Combine and deduplicate
                    ids = list(set(ids + tier3_ids))
                    logger.debug(f"Tier 3 found {len(tier3_ids)} papers, total unique: {len(ids)}")
                except Exception as e:
                    logger.error(f"Tier 3 search failed: {e}")

            # Tier 4: Last resort - very broad perioperative context, extended date range
            if len(ids) < 3 and not is_followup:
                try:
                    logger.debug(f"Tier 4: Very broad perioperative context, extended date range...")
                    # Most inclusive - captures anesthesia, critical care, surgical, emergency, ICU
                    tier4_periop = (
                        f'({q}) AND (anesthesia[tiab] OR anesthetic[tiab] OR perioperative[tiab] OR '
                        f'critical[tiab] OR ICU[tiab] OR surgical[tiab] OR emergency[tiab]) AND '
                        f'(review[pt] OR "randomized controlled trial"[pt] OR "clinical trial"[pt]) AND '
                        f'("2005/01/01"[PDAT] : "3000"[PDAT])'
                    )
                    handle = Entrez.esearch(db="pubmed", term=tier4_periop, retmax=15, sort="relevance")
                    result = Entrez.read(handle)
                    tier4_ids = result.get("IdList", [])
                    # Combine and deduplicate
                    ids = list(set(ids + tier4_ids))
                    logger.debug(f"Tier 4 found {len(tier4_ids)} papers, total unique: {len(ids)}")
                except Exception as e:
                    logger.error(f"Tier 4 search failed: {e}")

            logger.debug(f"Final total: {len(ids)} unique papers found")

            # If no papers found, handle gracefully
            if not ids:
                logger.debug(f"No papers found")
                if is_followup:
                    logger.debug(f"Generating follow-up response without papers")
                    conversation_context = ""
                    recent_messages = session['messages'][-8:]
                    for msg in recent_messages:
                        if msg['role'] == 'user':
                            conversation_context += f"User: {msg['content']}\n"
                        else:
                            content_text = re.sub('<[^<]+?>', '', msg.get('content', ''))
                            conversation_context += f"Assistant: {content_text[:400]}\n"

                    prompt = f"""You are a clinical expert anesthesiologist AI assistant. The user is asking a follow-up question based on the conversation below.

Previous conversation:
{conversation_context}

Current follow-up question: {raw_query}

CRITICAL: SELF-VERIFICATION PROTOCOL (Apply BEFORE finalizing your answer):
Before providing your answer, internally verify:
1. **Dosing Accuracy**: Are all drug doses within standard ranges? Cross-check against ASA guidelines and major textbooks
2. **Contraindication Check**: Have you mentioned absolute contraindications and safety warnings?
3. **Consistency Check**: Does your answer align with current ASA/ESA guidelines and standard practice?
4. **Self-Questioning**: Ask yourself "How do I know this is correct?" Acknowledge uncertainty where appropriate.
5. **Completeness**: For dosing questions, include route, typical range, and maximum doses. For safety questions, cover both common and serious risks.

Provide a comprehensive, evidence-based answer that:
1. Builds naturally on the previous discussion
2. Includes specific clinical details (dosages, indications, contraindications, side effects)
3. Uses HTML formatting (<h3> for sections, <p> for paragraphs, <strong> for emphasis, <ul><li> for lists)
4. Is conversational but clinically complete
5. Notes that this draws from general anesthesiology knowledge and the previous discussion
6. CRITICAL: Return ONLY the HTML content - do NOT wrap your response in markdown code fences (```html or ```)

Answer as if you're a colleague continuing the conversation:"""

                    logger.debug(f"Preparing streaming for follow-up...")

                    # Generate unique request ID for this streaming session
                    request_id = str(uuid.uuid4())

                    # Prepare stream data
                    stream_data = {
                        'prompt': prompt,
                        'refs': [],
                        'num_papers': 0,
                        'raw_query': raw_query
                    }

                    # Store in session
                    session[f'stream_data_{request_id}'] = stream_data
                    session.modified = True

                    # Also store in memory cache as backup
                    store_stream_data(request_id, stream_data)

                    logger.debug(f"Stream data prepared for follow-up, request_id: {request_id}")

                    # Add placeholder assistant message and set pending_stream
                    # This happens for BOTH AJAX and regular form submissions
                    session['messages'].append({
                        "role": "assistant",
                        "content": "",  # Will be populated by streaming
                        "references": [],
                        "num_papers": 0
                    })
                    session['pending_stream'] = request_id
                    session.modified = True
                    logger.debug(f"Added placeholder assistant message and set pending_stream")

                    # If AJAX request, return JSON (JavaScript will handle redirect)
                    if is_ajax:
                        return jsonify({
                            'status': 'ready',
                            'request_id': request_id,
                            'raw_query': raw_query
                        })

                    # For regular form submissions, redirect to index page
                    logger.debug(f"Redirecting to index page")
                    return redirect(url_for('index'))
                else:
                    logger.debug(f"No results for initial query")
                    error_msg = "<p>No relevant evidence found in recent literature. Try rephrasing your question or using different medical terms.</p>"
                    session['messages'].append({
                        "role": "assistant",
                        "content": error_msg,
                        "references": [],
                        "num_papers": 0
                    })
                    session.modified = True
                    if is_ajax:
                        return jsonify({
                            'status': 'error',
                            'message': error_msg
                        })
                    logger.debug(f"Error message added, redirecting")
                    return redirect(url_for('index'))

            logger.debug(f"Fetching {len(ids)} papers from PubMed...")
            handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
            papers = Entrez.read(handle)["PubmedArticle"]
            logger.debug(f"Papers fetched successfully")

            refs = []
            context = ""
            # Process up to 15 papers for comprehensive evidence (increased from 8)
            # More papers = better coverage of high-quality evidence = higher confidence ratings
            for p in papers[:15]:
                try:
                    art = p["MedlineCitation"]["Article"]
                    # CRITICAL: Convert all Biopython StringElement objects to plain Python strings
                    # for Redis serialization compatibility
                    title = str(art.get("ArticleTitle", "No title"))
                    # Truncate abstracts to 1200 chars for better citation accuracy
                    abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                    abstract = abstract[:1200] + "..." if len(abstract) > 1200 else abstract
                    authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])  # Reduced to 3 authors
                    journal = str(art["Journal"].get("Title", "Unknown"))
                    year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                    pmid = str(p["MedlineCitation"]["PMID"])

                    # Classify study type for quality indicators
                    study_classification = classify_study_type(title, journal)

                    refs.append({
                        "title": title,
                        "authors": authors,
                        "journal": journal,
                        "year": year,
                        "pmid": pmid,
                        "study_type": study_classification['type'],
                        "study_badge": study_classification['badge_text'],
                        "study_color": study_classification['badge_color'],
                        "study_score": study_classification['score'],
                        "sort_priority": study_classification['sort_priority'],
                        "abstract": abstract  # Store abstract for numbered context
                    })
                except:
                    continue

            # Sort references by quality (highest quality first)
            refs.sort(key=lambda x: x.get('sort_priority', 99))

            num_papers = len(refs)
            logger.debug(f"Processed {num_papers} paper references")

            # Build smart conversation context (includes relevant earlier messages + recent)
            conversation_context = build_smart_context(session['messages'][:-1], raw_query)  # Exclude just-added user message
            logger.debug(f"Smart context built ({len(conversation_context)} chars)")

            # Create numbered reference list for citation
            ref_list = ""
            for i, ref in enumerate(refs, 1):
                ref_list += f"[{i}] {ref['title']} - {ref['authors']} ({ref['year']}) PMID: {ref['pmid']}\n"

            # Build numbered context with full details (helps GPT understand which paper is which)
            context = ""
            for i, ref in enumerate(refs, 1):
                context += f"Paper [{i}]:\nTitle: {ref['title']}\nAbstract: {ref.get('abstract', 'No abstract available')}\nAuthors: {ref['authors']}\nJournal: {ref['journal']} ({ref['year']})\nPMID: {ref['pmid']}\n\n"

            # Log papers being used for debugging
            logger.debug(f"===== PAPERS RETURNED FOR QUERY: '{raw_query}' =====")
            for i, ref in enumerate(refs[:3], 1):  # Show first 3
                logger.debug(f"[{i}] {ref['title'][:100]}...")
            logger.debug(f"================================================\n")

            prompt = f"""You are a clinical anesthesiologist AI providing evidence-based answers with citations.

Previous conversation:
{conversation_context if len(session['messages']) > 1 else "New conversation."}

Current question: {raw_query}
{'This is a FOLLOW-UP - build on the previous discussion.' if is_followup else ''}
{negation_prompt_modifier if negation_prompt_modifier else ''}
{'NOTE: This question has multiple parts - address each thoroughly.' if is_multipart else ''}

Research papers (cite as [1], [2], etc.):
{ref_list}

Paper details:
{context}

CRITICAL: SELF-VERIFICATION PROTOCOL (Apply BEFORE finalizing your answer):
Before providing your answer, internally verify:
1. **Dosing Accuracy**: Are all drug doses within standard ranges? Cross-check against ASA guidelines, package inserts, and major textbooks (Miller's, Barash, Stoelting's)
2. **Contraindication Check**: Have you mentioned absolute contraindications? Are there missing safety warnings?
3. **Citation Verification**: Does each cited paper's abstract ACTUALLY support the specific claim? Remove citations that don't directly support the statement.
4. **Consistency Check**: Does your answer align with current ASA/ESA guidelines and standard practice?
5. **Self-Questioning**: Ask yourself "How do I know this is correct?" If uncertain about any specific claim, either verify it against the provided papers or acknowledge uncertainty.
6. **Completeness**: For dosing questions, have you included route, typical range, and maximum doses? For safety questions, have you covered both common and serious risks?

INSTRUCTIONS:
1. Include specific dosages (mg/kg), contraindications, side effects, and monitoring when relevant
2. For acute situations, provide step-by-step protocols with drugs and doses
3. **IN-TEXT CITATIONS (CRITICAL):**
   - Use numbered citations [1], [2], [3] etc. corresponding to the numbered papers above
   - ONLY cite a paper [N] if that SPECIFIC paper's abstract directly supports the exact claim you're making
   - Verify each citation: Does Paper [N]'s abstract contain this specific fact/dose/finding?
   - If a claim is from your general knowledge but NOT explicitly in the provided abstracts, DO NOT add a citation
   - Better to have NO citation than an INACCURATE citation
   - When citing: use [1], [2], etc. - NO author names in text
   - Multiple papers can support one claim: "X is effective [1][2][3]"
   - Place citations immediately after the claim: "TXA reduces blood loss [1][2]."
   - If papers discuss a topic generally but don't support your specific claim, omit the citation
4. Be conversational but clinically complete - like talking to a colleague
5. HTML format: <h3> for sections, <p> for paragraphs, <strong> for emphasis, <ul><li> for lists
6. CRITICAL: Return ONLY the HTML content - do NOT wrap your response in markdown code fences (```html or ```)

CITATION VERIFICATION CHECKLIST (Check EACH citation before adding):
   ❌ WRONG: "Propofol 2-3 mg/kg is recommended [1]" when Paper [1]'s abstract says "induction agents" generally
   ❌ WRONG: "TXA reduces blood loss by 30% [2]" when Paper [2]'s abstract doesn't give specific percentage
   ❌ WRONG: "Common side effects include nausea [3]" when Paper [3]'s abstract doesn't mention side effects
   ✅ CORRECT: "TXA reduces blood loss in spine surgery [1][2]" when both Paper [1] and [2] abstracts explicitly state this
   ✅ CORRECT: "Standard monitoring includes pulse oximetry" (NO citation - general knowledge not from papers)

IMPORTANT: Use numbered citations [1], [2], [3] throughout your answer to reference the specific papers above. Only cite when the paper's abstract directly supports the specific claim. If a claim is general knowledge or not supported by the abstracts, omit the citation.

Example with proper numbered citations:
"<h3>Acute Bronchospasm Management</h3>
<p><strong>Immediate Actions:</strong><br>
100% oxygen and hand-ventilate to assess compliance. Deepen anesthesia with propofol or increase volatile agent to 2+ MAC.</p>
<p><strong>Bronchodilators:</strong><br>
Inhaled beta-2 agonists are first-line treatment for acute bronchospasm [1][2]. Response typically seen within minutes. Severe cases may require IV epinephrine [3].</p>
<p><strong>Monitoring:</strong><br>
Watch for auto-PEEP, pneumothorax, and cardiovascular compromise from high airway pressures.</p>"

NOTE: Numbers [1], [2], [3] must correspond to Paper [1], Paper [2], Paper [3] listed above. Only cite when abstracts explicitly support claims.

Respond with maximum clinical utility:"""

            logger.debug(f"Preparing streaming with {num_papers} papers...")
            logger.info(f"[CHAT] Preparing streaming with {num_papers} papers")

            # Generate unique request ID for this streaming session
            request_id = str(uuid.uuid4())
            logger.info(f"[CHAT] Generated request_id: {request_id}")

            # Prepare stream data
            stream_data = {
                'prompt': prompt,
                'refs': refs,
                'num_papers': num_papers,
                'raw_query': raw_query,
                'question_type': question_type  # Store for temperature adjustment
            }

            # Store in session
            stream_key = f'stream_data_{request_id}'
            session[stream_key] = stream_data
            session.modified = True

            # Also store in memory cache as backup (helps with session sync issues)
            store_stream_data(request_id, stream_data)

            logger.info(f"[CHAT] Stored stream data with key: {stream_key}")
            logger.info(f"[CHAT] Session keys after storing: {[k for k in session.keys() if k.startswith('stream_')]}")
            logger.info(f"[CHAT] Cache keys: {list(STREAM_DATA_CACHE.keys())}")

            logger.debug(f"Stream data prepared, returning request_id: {request_id}")

            # Add placeholder assistant message for auto-start JavaScript to populate
            # This happens for BOTH AJAX and regular form submissions
            session['messages'].append({
                "role": "assistant",
                "content": "",  # Will be populated by streaming
                "references": [],
                "num_papers": 0
            })
            session['pending_stream'] = request_id
            session.modified = True
            logger.debug(f"Added placeholder assistant message and set pending_stream")

            # If AJAX request, return JSON (JavaScript will handle redirect)
            if is_ajax:
                return jsonify({
                    'status': 'ready',
                    'request_id': request_id,
                    'raw_query': raw_query
                })

            # For regular form submissions (not AJAX), redirect to index page
            logger.debug(f"Redirecting to index page")
            logger.debug(f"Session messages before redirect: {len(session.get('messages', []))} messages")
            for i, msg in enumerate(session.get('messages', [])):
                logger.debug(f"  Message {i}: role={msg.get('role')}, content_length={len(msg.get('content', ''))}")
            return redirect(url_for('index'))

        except Exception as e:
            # Catch all unhandled errors
            logger.error(f"===== UNHANDLED EXCEPTION =====")
            logger.error(f"{type(e).__name__}: {e}")
            import traceback
            traceback.print_exc()

            error_content = f"<p><strong>Error:</strong> {str(e)}</p><p>Please try rephrasing your question or start a new conversation.</p>"
            session['messages'].append({
                "role": "assistant",
                "content": error_content,
                "references": [],
                "num_papers": 0
            })
            session.modified = True

            # Check if AJAX (may not be defined if error occurred early)
            is_ajax_check = request.headers.get('X-Requested-With') == 'XMLHttpRequest' or request.form.get('modal') == '1'
            if is_ajax_check:
                return jsonify({
                    'status': 'error',
                    'message': error_content
                })
            return redirect(url_for('index'))

    # GET request - check for pending stream and render page
    pending_stream = session.pop('pending_stream', None)

    # Log session state for debugging
    logger.info(f"[INDEX GET] pending_stream = {pending_stream}")
    logger.info(f"[INDEX GET] num messages = {len(session.get('messages', []))}")
    logger.info(f"[INDEX GET] stream_data keys = {[k for k in session.keys() if k.startswith('stream_')]}")

    logger.debug(f"GET / - pending_stream = {pending_stream}")
    logger.debug(f"GET / - num messages = {len(session.get('messages', []))}")
    logger.debug(f"GET / - Session messages detail:")
    for i, msg in enumerate(session.get('messages', [])):
        logger.debug(f"  Message {i}: role={msg.get('role')}, content_length={len(msg.get('content', ''))}, has_refs={len(msg.get('references', []))}")

    # Get and clear any error message from session
    error_message = session.pop('error_message', None)

    # Ensure session is saved before rendering (critical for streaming to work)
    session.modified = True

    # Create response with no-cache headers to prevent stale UI
    response = make_response(render_template_string(HTML, messages=session.get('messages', []), pending_stream=pending_stream, error_message=error_message))
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

@app.route("/clear")
def clear():
    """Clear conversation history and return to homepage hero state"""
    session.pop('messages', None)
    session.pop('conversation_topic', None)
    session.pop('chat_active', None)  # Clear chat mode flag
    # [PHASE 2] Clear conversation ID to start a new conversation
    session.pop('conversation_id', None)
    session.modified = True  # Ensure session is saved
    response = redirect(url_for('index'))
    # Prevent caching to ensure fresh page load
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

@app.route("/clear-chat")
def clear_chat():
    """Clear conversation messages but stay in active chat interface"""
    session.pop('messages', None)
    session.pop('conversation_topic', None)
    # [PHASE 2] Clear conversation ID to start a new conversation
    session.pop('conversation_id', None)
    session['chat_active'] = True  # Keep chat interface active
    session.modified = True  # Ensure session is saved
    response = redirect(url_for('index'))
    # Prevent caching to ensure fresh page load
    response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
    response.headers['Pragma'] = 'no-cache'
    response.headers['Expires'] = '0'
    return response

@app.route("/terms")
def terms():
    """Terms of Service page"""
    return render_template_string(TERMS_HTML)

@app.route("/privacy")
def privacy():
    """Privacy Policy page"""
    return render_template_string(PRIVACY_POLICY_HTML)

@app.route("/calculators")
def calculators():
    """Clinical Calculators Hub - IBW, MABL, BSA, QTc, Fluids, PONV, ASA"""
    return render_template_string(CALCULATORS_HTML)

@app.route("/evidence")
def evidence():
    """Evidence-Based Methodology - How PubMed integration works"""
    return render_template_string(EVIDENCE_HTML)

@app.route("/crisis")
def crisis_protocols():
    """Crisis Protocols - Evidence-based anesthesia emergency management"""
    return render_template_string(CRISIS_HTML)


INFORMED_CONSENT_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informed Consent Generator - GasConsult.ai</title>
    <meta name="description" content="AI-powered informed consent generator for anesthesia procedures with patient-specific risk stratification.">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .main-content {
            flex: 1;
            padding: 100px 20px 40px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fade-up 0.6s ease forwards;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .gradient {
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #64748B;
            font-size: 16px;
        }

        .card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            animation: fade-up 0.6s 0.1s ease forwards;
            opacity: 0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #DBEAFE;
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--gray-700);
            letter-spacing: -0.01em;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(226, 232, 240, 0.6);
            border-radius: 14px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            color: var(--gray-900);
        }

        input::placeholder, select::placeholder, textarea::placeholder {
            color: var(--gray-400);
        }

        input:hover, select:hover, textarea:hover {
            border-color: var(--blue-300);
            background: rgba(255, 255, 255, 0.95);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--blue-500);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(59,130,246,0.08), 0 2px 8px rgba(0,0,0,0.04);
            transform: translateY(-1px);
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(226, 232, 240, 0.6);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .radio-option:hover, .checkbox-option:hover {
            border-color: var(--blue-400);
            background: rgba(239, 246, 255, 0.9);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(59,130,246,0.08);
        }

        .radio-option input:checked + span, .checkbox-option input:checked + span {
            color: var(--blue-600);
            font-weight: 600;
        }

        .radio-option:has(input:checked), .checkbox-option:has(input:checked) {
            border-color: var(--blue-500);
            background: rgba(239, 246, 255, 0.95);
            box-shadow: 0 2px 12px rgba(59,130,246,0.12);
        }

        .radio-option input, .checkbox-option input {
            width: auto;
            margin-right: 14px;
            cursor: pointer;
            accent-color: var(--blue-600);
            transform: scale(1.1);
        }

        .radio-option span, .checkbox-option span {
            flex: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(37,99,235,0.3);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.9);
            border: 1.5px solid #E2E8F0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .back-btn:hover {
            border-color: #3B82F6;
            color: #2563EB;
            background: #EFF6FF;
        }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        /* Social Media Icons */
        
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }


        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            h1 { font-size: 42px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .main-content { padding: 140px 40px 80px; }
            .card { padding: 40px; }
            .footer { padding: 48px 40px; }
        }

        /* Loading Spinner */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 20px;
            padding: 32px 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
        }

        /* Results Section */
        .results-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .consent-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }

        .consent-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--blue-100);
        }

        .consent-header svg {
            width: 24px;
            height: 24px;
            stroke: var(--blue-600);
            flex-shrink: 0;
        }

        .consent-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .consent-content {
            line-height: 1.8;
            color: var(--gray-700);
            font-size: 15px;
        }

        .consent-content h3 {
            color: var(--gray-900);
            font-size: 17px;
            font-weight: 700;
            margin-top: 32px;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--blue-100);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .consent-content h3:first-child {
            margin-top: 0;
        }

        .consent-content h3::before {
            content: "▸";
            color: var(--blue-600);
            font-size: 20px;
            font-weight: 700;
        }

        .consent-content h4 {
            color: var(--blue-700);
            font-size: 15px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .consent-content p {
            margin-bottom: 14px;
            line-height: 1.7;
        }

        .consent-content ul {
            margin-left: 0;
            margin-bottom: 16px;
            padding-left: 0;
            list-style: none;
        }

        .consent-content li {
            margin-bottom: 10px;
            padding-left: 28px;
            position: relative;
            line-height: 1.6;
        }

        .consent-content li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--blue-600);
            font-weight: 700;
            font-size: 16px;
        }

        .consent-content strong {
            color: var(--gray-900);
            font-weight: 600;
            background: var(--blue-50);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Risk Level Badges */
        .consent-content .risk-high,
        .consent-content .high-risk {
            display: inline-block;
            background: linear-gradient(135deg, #FEE2E2, #FECACA);
            color: #991B1B;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #FCA5A5;
        }

        .consent-content .risk-moderate,
        .consent-content .moderate-risk {
            display: inline-block;
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            color: #92400E;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #FCD34D;
        }

        .consent-content .risk-low,
        .consent-content .low-risk {
            display: inline-block;
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #6EE7B7;
        }

        /* Info Boxes */
        .consent-content blockquote {
            background: var(--blue-50);
            border-left: 4px solid var(--blue-600);
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-style: normal;
        }

        /* References Card */
        .references-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }

        .references-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 20px;
        }

        .references-title svg {
            width: 22px;
            height: 22px;
            stroke: var(--blue-600);
        }

        .reference-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
        }

        .reference-item:last-child {
            border-bottom: none;
        }

        .reference-number {
            display: inline-block;
            min-width: 32px;
            height: 32px;
            background: var(--blue-50);
            color: var(--blue-600);
            border-radius: 8px;
            text-align: center;
            line-height: 32px;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .reference-content {
            flex: 1;
        }

        .reference-link {
            color: var(--blue-600);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.5;
            display: block;
            margin-bottom: 4px;
        }

        .reference-link:hover {
            text-decoration: underline;
        }

        .reference-meta {
            font-size: 13px;
            color: var(--gray-600);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 14px 20px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(37,99,235,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        @media (min-width: 640px) {
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Generating Assessment...</div>
        </div>
    </div>

    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <nav class="nav">
            <div class="nav-inner">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span>
                    </div>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link active">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
            {% if not summary %}
            <!-- Assessment Form -->
            <div class="header">
                <h1><span class="gradient">Informed Consent Generator</span></h1>
                <p class="subtitle">AI-powered informed consent discussion with patient-specific risk stratification</p>
            </div>

            <form method="POST" class="card">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="section-title">Anesthesia Information</div>

                <div class="form-group">
                    <label for="anesthesia_type">Anesthesia Type</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="anesthesia_type" value="General" required>
                            <span>General Anesthesia</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="anesthesia_type" value="Regional">
                            <span>Regional (Spinal/Epidural/Nerve Block)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="anesthesia_type" value="Sedation">
                            <span>Monitored Anesthesia Care (Sedation)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="anesthesia_type" value="Local">
                            <span>Local Anesthesia</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="procedure">Surgical Procedure</label>
                    <input type="text" id="procedure" name="procedure" placeholder="e.g., Total knee replacement" required>
                </div>

                <div class="section-title">Patient Information</div>

                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" name="age" min="1" max="120" placeholder="Patient age" required>
                </div>

                <div class="form-group">
                    <label for="asa_class">ASA Physical Status Classification</label>
                    <select id="asa_class" name="asa_class" required>
                        <option value="">Select ASA Class</option>
                        <option value="I">ASA I - Healthy patient</option>
                        <option value="II">ASA II - Mild systemic disease</option>
                        <option value="III">ASA III - Severe systemic disease</option>
                        <option value="IV">ASA IV - Severe disease, constant threat to life</option>
                        <option value="V">ASA V - Moribund, not expected to survive</option>
                    </select>
                </div>

                <div class="section-title">Comorbidities</div>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="Cardiac Disease">
                        <span>Cardiac Disease (CAD, CHF, Arrhythmias)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="Pulmonary Disease">
                        <span>Pulmonary Disease (COPD, Asthma)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="Diabetes">
                        <span>Diabetes Mellitus</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="Renal Disease">
                        <span>Renal Disease (CKD, Dialysis)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="Hepatic Disease">
                        <span>Hepatic Disease (Cirrhosis, Hepatitis)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="OSA">
                        <span>Obstructive Sleep Apnea (OSA)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="comorbidities" value="Obesity">
                        <span>Obesity (BMI > 30)</span>
                    </label>
                </div>

                <div class="section-title">Special Considerations</div>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_considerations" value="Pregnancy">
                        <span>Pregnancy</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_considerations" value="Malignant Hyperthermia History">
                        <span>Personal/Family History of Malignant Hyperthermia</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_considerations" value="Difficult Airway">
                        <span>Known/Suspected Difficult Airway</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_considerations" value="Latex Allergy">
                        <span>Latex Allergy</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_considerations" value="Chronic Pain">
                        <span>Chronic Pain/Opioid Use</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="special_considerations" value="Anticoagulation">
                        <span>Anticoagulation Therapy</span>
                    </label>
                </div>

                <div class="form-group">
                    <label for="additional_notes">Additional Notes (Optional)</label>
                    <textarea id="additional_notes" name="additional_notes" placeholder="Any other relevant information..."></textarea>
                </div>

                <button type="submit" class="submit-btn">Generate Consent Discussion</button>
            </form>

            {% else %}
            <!-- Results -->
            <div class="results-container">
                <div class="header">
                    <h1><span class="gradient">Informed Consent Discussion</span></h1>
                    <p class="subtitle">Patient-specific consent information</p>
                </div>

                <div class="consent-card">
                    <div class="consent-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <div class="consent-title">Consent Discussion Guide</div>
                    </div>
                    <div class="consent-content">
                        {{ summary|safe }}
                    </div>
                </div>

                {% if references %}
                <div class="references-card">
                    <div class="references-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        <span>Evidence-Based References</span>
                    </div>
                    {% for ref in references %}
                    <div class="reference-item">
                        <span class="reference-number">[{{ loop.index }}]</span>
                        <div class="reference-content">
                            <a href="https://pubmed.ncbi.nlm.nih.gov/{{ ref.pmid }}/" target="_blank" rel="noopener noreferrer" class="reference-link">
                                {{ ref.title }}
                            </a>
                            <div class="reference-meta">{{ ref.authors }} - {{ ref.journal }}, {{ ref.year }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="action-buttons">
                    <a href="/informed-consent" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Consent Discussion
                    </a>
                    <button onclick="window.print()" class="btn btn-secondary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Print/Save PDF
                    </button>
                </div>
            </div>
            {% endif %}
        </main>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(event) {
            event.stopPropagation();
            const menu = event.currentTarget.nextElementSibling;
            menu.classList.toggle('show');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!event.currentTarget.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        // Show loading overlay when form is submitted
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[method="POST"]');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (form && loadingOverlay) {
                form.addEventListener('submit', function(e) {
                    // Validate required fields before showing loading
                    const procedure = document.getElementById('procedure');
                    const age = document.getElementById('age');
                    const asa = document.getElementById('asa_class');
                    const anesthesiaType = document.querySelector('input[name="anesthesia_type"]:checked');

                    // Only show loading if all required fields are filled
                    if (procedure && procedure.value.trim() !== '' &&
                        age && age.value && asa && asa.value && anesthesiaType) {
                        loadingOverlay.classList.add('active');
                    }
                });
            }
        });
    </script>
</body>
</html>
"""


DIFFICULT_AIRWAY_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Difficult Airway Assessment - GasConsult.ai</title>
    <meta name="description" content="AI-powered difficult airway risk assessment with evidence-based management strategies and ASA guidelines.">
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--gray-900);
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        /* Only apply active state to dropdown toggles for non-user dropdowns (e.g., "More" dropdown) */
        .nav-dropdown:not(.user-dropdown):has(.nav-dropdown-link.active) .nav-dropdown-toggle {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-dropdown-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(0,0,0,0.04);
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(7px, 7px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .main-content {
            flex: 1;
            padding: 100px 20px 40px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fade-up 0.6s ease forwards;
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 12px;
            letter-spacing: -0.5px;
        }

        .gradient {
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: #64748B;
            font-size: 16px;
        }

        .card {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            animation: fade-up 0.6s 0.1s ease forwards;
            opacity: 0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #DBEAFE;
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--gray-700);
            letter-spacing: -0.01em;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(226, 232, 240, 0.6);
            border-radius: 14px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s ease;
            color: var(--gray-900);
        }

        input::placeholder, select::placeholder, textarea::placeholder {
            color: var(--gray-400);
        }

        input:hover, select:hover, textarea:hover {
            border-color: var(--blue-300);
            background: rgba(255, 255, 255, 0.95);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--blue-500);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 4px rgba(59,130,246,0.08), 0 2px 8px rgba(0,0,0,0.04);
            transform: translateY(-1px);
        }

        textarea {
            min-height: 110px;
            resize: vertical;
        }

        .radio-group, .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1.5px solid rgba(226, 232, 240, 0.6);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .radio-option:hover, .checkbox-option:hover {
            border-color: var(--blue-400);
            background: rgba(239, 246, 255, 0.9);
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(59,130,246,0.08);
        }

        .radio-option input:checked + span, .checkbox-option input:checked + span {
            color: var(--blue-600);
            font-weight: 600;
        }

        .radio-option:has(input:checked), .checkbox-option:has(input:checked) {
            border-color: var(--blue-500);
            background: rgba(239, 246, 255, 0.95);
            box-shadow: 0 2px 12px rgba(59,130,246,0.12);
        }

        .radio-option input, .checkbox-option input {
            width: auto;
            margin-right: 14px;
            cursor: pointer;
            accent-color: var(--blue-600);
            transform: scale(1.1);
        }

        .radio-option span, .checkbox-option span {
            flex: 1;
        }

        .submit-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #2563EB, #3B82F6);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(37,99,235,0.3);
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: rgba(255,255,255,0.9);
            border: 1.5px solid #E2E8F0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            color: #475569;
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .back-btn:hover {
            border-color: #3B82F6;
            color: #2563EB;
            background: #EFF6FF;
        }

        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        /* Social Media Icons */
        
        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }


        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }
            h1 { font-size: 42px; }
            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
            
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .main-content { padding: 140px 40px 80px; }
            .card { padding: 40px; }
            .footer { padding: 48px 40px; }
        }

        /* Loading Spinner */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            border-radius: 20px;
            padding: 32px 48px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--blue-600);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
        }

        /* Results Section */
        .results-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .assessment-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }

        .assessment-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--blue-100);
        }

        .assessment-header svg {
            width: 24px;
            height: 24px;
            stroke: var(--blue-600);
            flex-shrink: 0;
        }

        .assessment-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        .assessment-content {
            line-height: 1.8;
            color: var(--gray-700);
            font-size: 15px;
        }

        .assessment-content h3 {
            color: var(--gray-900);
            font-size: 17px;
            font-weight: 700;
            margin-top: 32px;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--blue-100);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .assessment-content h3:first-child {
            margin-top: 0;
        }

        .assessment-content h3::before {
            content: "▸";
            color: var(--blue-600);
            font-size: 20px;
            font-weight: 700;
        }

        .assessment-content p {
            margin-bottom: 14px;
            line-height: 1.7;
        }

        .assessment-content ul {
            margin-left: 0;
            margin-bottom: 16px;
            padding-left: 0;
            list-style: none;
        }

        .assessment-content li {
            margin-bottom: 10px;
            padding-left: 28px;
            position: relative;
            line-height: 1.6;
        }

        .assessment-content li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--blue-600);
            font-weight: 700;
            font-size: 16px;
        }

        .assessment-content strong {
            color: var(--gray-900);
            font-weight: 600;
            background: var(--blue-50);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Risk Level Badges */
        .assessment-content .risk-high,
        .assessment-content .high-risk {
            display: inline-block;
            background: linear-gradient(135deg, #FEE2E2, #FECACA);
            color: #991B1B;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #FCA5A5;
        }

        .assessment-content .risk-moderate,
        .assessment-content .moderate-risk {
            display: inline-block;
            background: linear-gradient(135deg, #FEF3C7, #FDE68A);
            color: #92400E;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #FCD34D;
        }

        .assessment-content .risk-low,
        .assessment-content .low-risk {
            display: inline-block;
            background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
            color: #065F46;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            border: 1px solid #6EE7B7;
        }

        /* Info Boxes */
        .assessment-content blockquote {
            background: var(--blue-50);
            border-left: 4px solid var(--blue-600);
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-style: normal;
        }

        /* Subsections */
        .assessment-content h4 {
            color: var(--blue-700);
            font-size: 15px;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        /* References Card */
        .references-card {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.8);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }

        .references-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 20px;
        }

        .references-title svg {
            width: 22px;
            height: 22px;
            stroke: var(--blue-600);
        }

        .reference-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            gap: 12px;
        }

        .reference-item:last-child {
            border-bottom: none;
        }

        .reference-number {
            display: inline-block;
            min-width: 32px;
            height: 32px;
            background: var(--blue-50);
            color: var(--blue-600);
            border-radius: 8px;
            text-align: center;
            line-height: 32px;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .reference-content {
            flex: 1;
        }

        .reference-link {
            color: var(--blue-600);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.5;
            display: block;
            margin-bottom: 4px;
        }

        .reference-link:hover {
            text-decoration: underline;
        }

        .reference-meta {
            font-size: 13px;
            color: var(--gray-600);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            padding: 14px 20px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--blue-600) 0%, var(--blue-700) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(37,99,235,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37,99,235,0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 2px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        @media (min-width: 640px) {
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Generating Assessment...</div>
        </div>
    </div>

    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <nav class="nav">
            <div class="nav-inner">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span>
                    </div>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link active">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <!-- Soft Launch: Hiding Plans link -->
                    <!-- <a href="/pricing" class="nav-link">Plans</a> -->
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:var(--blue-600);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <main class="main-content">
            {% if not summary %}
            <!-- Assessment Form -->
            <div class="header">
                <h1><span class="gradient">Difficult Airway Assessment</span></h1>
                <p class="subtitle">AI-powered difficult airway risk stratification with evidence-based management strategies</p>
            </div>

            <form method="POST" class="card">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="section-title">Physical Examination</div>

                <div class="form-group">
                    <label for="mallampati">Mallampati Classification</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="mallampati" value="I" required>
                            <span>Class I - Full visibility of tonsils, uvula, soft palate</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mallampati" value="II">
                            <span>Class II - Uvula, soft palate visible</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mallampati" value="III">
                            <span>Class III - Only soft palate visible</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mallampati" value="IV">
                            <span>Class IV - Only hard palate visible</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="thyromental">Thyromental Distance</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="thyromental" value=">6.5cm" required>
                            <span>> 6.5 cm (Normal)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="thyromental" value="6-6.5cm">
                            <span>6-6.5 cm (Borderline)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="thyromental" value="<6cm">
                            <span>< 6 cm (Concerning)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="mouth_opening">Mouth Opening</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="mouth_opening" value=">4cm" required>
                            <span>> 4 cm (Normal)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mouth_opening" value="3-4cm">
                            <span>3-4 cm (Borderline)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="mouth_opening" value="<3cm">
                            <span>< 3 cm (Limited)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="neck_extension">Neck Extension</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="neck_extension" value="Normal" required>
                            <span>Normal (> 35°)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="neck_extension" value="Moderate">
                            <span>Moderate Limitation</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="neck_extension" value="Limited">
                            <span>Severe Limitation</span>
                        </label>
                    </div>
                </div>

                <div class="section-title">Patient Information</div>

                <div class="form-group">
                    <label for="bmi">BMI (Body Mass Index)</label>
                    <input type="number" id="bmi" name="bmi" step="0.1" min="10" max="80" placeholder="e.g., 27.5" required>
                </div>

                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" name="age" min="1" max="120" placeholder="Patient age" required>
                </div>

                <div class="section-title">Risk Factors</div>
                <div class="checkbox-group">
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="Previous Difficult Intubation">
                        <span>Previous Difficult Intubation</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="OSA">
                        <span>Obstructive Sleep Apnea (OSA)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="Beard">
                        <span>Beard/Facial Hair</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="Prominent Incisors">
                        <span>Prominent Incisors/Buck Teeth</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="Short Neck">
                        <span>Short/Thick Neck</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="Large Tongue">
                        <span>Large Tongue (Macroglossia)</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="Facial Trauma">
                        <span>Facial Trauma/Abnormalities</span>
                    </label>
                    <label class="checkbox-option">
                        <input type="checkbox" name="risk_factors" value="C-Spine Pathology">
                        <span>C-Spine Pathology/Limited Mobility</span>
                    </label>
                </div>

                <div class="section-title">Case Details</div>

                <div class="form-group">
                    <label for="procedure">Surgical Procedure</label>
                    <input type="text" id="procedure" name="procedure" placeholder="e.g., Laparoscopic cholecystectomy" required>
                </div>

                <div class="form-group">
                    <label for="case_type">Case Type</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="case_type" value="Elective" required>
                            <span>Elective</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="case_type" value="Urgent">
                            <span>Urgent</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="case_type" value="Emergency">
                            <span>Emergency</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="additional_notes">Additional Notes (Optional)</label>
                    <textarea id="additional_notes" name="additional_notes" placeholder="Any other relevant findings..."></textarea>
                </div>

                <button type="submit" class="submit-btn">Generate Assessment</button>
            </form>

            {% else %}
            <!-- Results -->
            <div class="results-container">
                <div class="header">
                    <h1><span class="gradient">Difficult Airway Assessment</span></h1>
                    <p class="subtitle">Evidence-based risk stratification and management plan</p>
                </div>

                <div class="assessment-card">
                    <div class="assessment-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                        </svg>
                        <div class="assessment-title">Clinical Assessment & Management Plan</div>
                    </div>
                    <div class="assessment-content">
                        {{ summary|safe }}
                    </div>
                </div>

                {% if references %}
                <div class="references-card">
                    <div class="references-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        <span>Evidence-Based References</span>
                    </div>
                    {% for ref in references %}
                    <div class="reference-item">
                        <span class="reference-number">[{{ loop.index }}]</span>
                        <div class="reference-content">
                            <a href="https://pubmed.ncbi.nlm.nih.gov/{{ ref.pmid }}/" target="_blank" rel="noopener noreferrer" class="reference-link">
                                {{ ref.title }}
                            </a>
                            <div class="reference-meta">{{ ref.authors }} - {{ ref.journal }}, {{ ref.year }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="action-buttons">
                    <a href="/difficult-airway" class="btn btn-primary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Assessment
                    </a>
                    <button onclick="window.print()" class="btn btn-secondary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Print/Save PDF
                    </button>
                </div>
            </div>
            {% endif %}
        </main>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(event) {
            event.stopPropagation();
            const menu = event.currentTarget.nextElementSibling;
            menu.classList.toggle('show');

            // Close dropdown when clicking outside
            document.addEventListener('click', function closeDropdown(e) {
                if (!event.currentTarget.contains(e.target)) {
                    menu.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        // Show loading overlay when form is submitted
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form[method="POST"]');
            const loadingOverlay = document.getElementById('loadingOverlay');

            if (form && loadingOverlay) {
                form.addEventListener('submit', function(e) {
                    // Validate required fields before showing loading
                    const procedure = document.getElementById('procedure');
                    const mallampati = document.querySelector('input[name="mallampati"]:checked');
                    const thyromental = document.querySelector('input[name="thyromental"]:checked');
                    const mouthOpening = document.querySelector('input[name="mouth_opening"]:checked');
                    const neckExtension = document.querySelector('input[name="neck_extension"]:checked');
                    const bmi = document.getElementById('bmi');
                    const age = document.getElementById('age');
                    const caseType = document.querySelector('input[name="case_type"]:checked');

                    // Only show loading if all required fields are filled
                    if (procedure && procedure.value.trim() !== '' &&
                        mallampati && thyromental && mouthOpening && neckExtension &&
                        bmi && bmi.value && age && age.value && caseType) {
                        loadingOverlay.classList.add('active');
                    }
                });
            }
        });
    </script>
</body>
</html>
"""

@app.route("/quick-dose")
def quick_dose():
    """Quick Dose Reference - Weight-based drug dosing calculator"""
    return render_template_string(QUICK_DOSE_HTML)
@app.route("/preop", methods=["GET", "POST"])
def preop_assessment():
    """Pre-operative assessment with HYBRID RAG + AGENTIC AI"""
    if request.method == "GET":
        response = make_response(render_template_string(PREOP_HTML, summary=None, references=None, mode=None, reasoning_trace=None))
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
        response.headers['Pragma'] = 'no-cache'
        response.headers['Expires'] = '0'
        return response

    # Collect and sanitize form data
    age = int(request.form.get("age", 0))
    weight = float(request.form.get("weight", 0))
    height = float(request.form.get("height", 0))
    sex = sanitize_user_query(request.form.get("sex", ""))
    comorbidities = request.form.getlist("comorbidities")
    other_comorbidities = sanitize_user_query(request.form.get("other_comorbidities", ""))
    mets = sanitize_user_query(request.form.get("mets", ""))
    previous_anesthesia = sanitize_user_query(request.form.get("previous_anesthesia", ""))
    medications = sanitize_user_query(request.form.get("medications", ""))
    hgb = sanitize_user_query(request.form.get("hgb", ""))
    plt = sanitize_user_query(request.form.get("plt", ""))
    cr = sanitize_user_query(request.form.get("cr", ""))
    inr = sanitize_user_query(request.form.get("inr", ""))
    ef = sanitize_user_query(request.form.get("ef", ""))
    ekg = sanitize_user_query(request.form.get("ekg", ""))
    procedure = sanitize_user_query(request.form.get("procedure", ""))
    surgery_risk = sanitize_user_query(request.form.get("surgery_risk", ""))
    npo = sanitize_user_query(request.form.get("npo", ""))
    allergies = sanitize_user_query(request.form.get("allergies", ""))

    # Validate required fields
    if not procedure or not procedure.strip():
        error_message = "<p style='color: #ff6b6b; text-align: center; padding: 20px;'><strong>Error:</strong> Please specify the surgical procedure before submitting the form.</p>"
        return render_template_string(PREOP_HTML, summary=error_message, references=None, mode=None, reasoning_trace=None)

    if not surgery_risk:
        error_message = "<p style='color: #ff6b6b; text-align: center; padding: 20px;'><strong>Error:</strong> Please select a surgery risk category before submitting the form.</p>"
        return render_template_string(PREOP_HTML, summary=error_message, references=None, mode=None, reasoning_trace=None)

    # Calculate BMI and IBW
    bmi = round(weight / ((height / 100) ** 2), 1) if weight and height else None
    if sex == 'male':
        ibw = round(50 + 0.91 * (height - 152.4), 1)
    else:
        ibw = round(45.5 + 0.91 * (height - 152.4), 1)

    # =================================================================
    # HYBRID RAG + AGENTIC AI SYSTEM
    # =================================================================

    # Build patient data dict
    patient_dict = {
        'age': age,
        'weight': weight,
        'height': height,
        'sex': sex,
        'bmi': bmi,
        'ibw': ibw,
        'comorbidities': comorbidities,
        'other_comorbidities': other_comorbidities,
        'mets': mets,
        'previous_anesthesia': previous_anesthesia,
        'medications': medications,
        'hgb': hgb,
        'plt': plt,
        'cr': cr,
        'inr': inr,
        'ef': ef,
        'ekg': ekg,
        'procedure': procedure,
        'surgery_risk': surgery_risk,
        'npo': npo,
        'allergies': allergies
    }

    # STEP 1: Classify complexity (fast RAG vs agentic)
    complexity_result = classify_preop_complexity(patient_dict)
    mode = complexity_result['mode']

    logging.info(f"Preop assessment mode: {mode}, complexity score: {complexity_result['complexity_score']}, reasoning: {complexity_result['reasoning']}")

    # STEP 2: Route to appropriate pipeline
    if mode == 'agentic':
        # AGENTIC MODE: Multi-step reasoning with adaptive search
        try:
            agent = PreopAgent(patient_dict)
            result = agent.run()

            if result:
                return render_template_string(
                    PREOP_HTML,
                    summary=result['assessment'],
                    references=result['references'],
                    mode='agentic',
                    reasoning_trace=result.get('reasoning_trace', []),
                    search_count=result.get('search_count', 0),
                    complexity_reasoning=complexity_result['reasoning']
                )
            else:
                # Fallback to fast RAG if agent fails
                logging.error("PreopAgent failed, falling back to fast RAG")
                mode = 'fast_rag'
        except Exception as e:
            logging.error(f"PreopAgent error: {str(e)}, falling back to fast RAG")
            mode = 'fast_rag'

    # FAST RAG MODE: Quick 3-query search (default or fallback)
    if mode == 'fast_rag':
        # Build targeted PubMed searches (same as original logic, but allow 5 searches)
        search_queries = []

        # Anticoagulation management
        if any(drug in medications.lower() for drug in ['apixaban', 'rivaroxaban', 'warfarin', 'dabigatran', 'edoxaban', 'eliquis', 'xarelto', 'coumadin']):
            search_queries.append(f"perioperative anticoagulation management {procedure}")

        # Antiplatelet management
        if any(drug in medications.lower() for drug in ['aspirin', 'plavix', 'clopidogrel', 'ticagrelor', 'brilinta']):
            search_queries.append(f"perioperative antiplatelet management {procedure}")

        # Obesity + OSA
        if bmi and bmi >= 30 and "Obstructive Sleep Apnea" in comorbidities:
            search_queries.append("obese patient OSA perioperative anesthesia management")

        # Diabetes management
        if "Diabetes Mellitus" in comorbidities:
            search_queries.append(f"perioperative diabetes insulin management {procedure}")

        # Cardiac risk
        if any(c in comorbidities for c in ["Coronary Artery Disease", "Heart Failure", "Prior Stroke"]):
            search_queries.append(f"perioperative cardiac risk {procedure} guidelines")

        # Reduced ejection fraction
        if ef:
            ef_lower = ef.lower()
            try:
                ef_numeric = float(''.join(filter(lambda x: x.isdigit() or x == '.', ef.split('-')[0])))
                if ef_numeric < 40:
                    search_queries.append(f"reduced ejection fraction perioperative management {procedure}")
            except:
                if any(term in ef_lower for term in ['reduced', 'low', 'decreased', 'hfref']):
                    search_queries.append(f"reduced ejection fraction perioperative management {procedure}")

        # Atrial fibrillation from EKG
        if ekg:
            ekg_lower = ekg.lower()
            if any(term in ekg_lower for term in ['afib', 'a-fib', 'atrial fib', 'atrial fibrillation']):
                search_queries.append(f"atrial fibrillation perioperative management {procedure}")

        # CKD
        if "Chronic Kidney Disease" in comorbidities:
            search_queries.append(f"chronic kidney disease perioperative management {procedure}")

        # General perioperative guidelines for procedure
        search_queries.append(f"{procedure} anesthesia perioperative management guidelines")

        # Search PubMed (allow 5 searches for fast RAG)
        all_refs = []
        all_context = ""

        for query in search_queries[:5]:
            try:
                q_expanded = query.replace(" ", " AND ")
                search_term = (
                    f'({q_expanded}) AND '
                    f'(systematic review[pt] OR meta-analysis[pt] OR guideline[pt] OR '
                    f'"randomized controlled trial"[pt]) AND '
                    f'("2015/01/01"[PDAT] : "3000"[PDAT])'
                )

                handle = Entrez.esearch(db="pubmed", term=search_term, retmax=5, sort="relevance")
                result = Entrez.read(handle)
                ids = result["IdList"]

                if ids:
                    handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
                    papers = Entrez.read(handle)["PubmedArticle"]

                    for p in papers:
                        try:
                            art = p["MedlineCitation"]["Article"]
                            title = str(art.get("ArticleTitle", "No title"))
                            abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                            authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])
                            journal = str(art["Journal"].get("Title", "Unknown"))
                            year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                            pmid = str(p["MedlineCitation"]["PMID"])

                            study_classification = classify_study_type(title, journal)

                            all_refs.append({
                                "title": title,
                                "authors": authors,
                                "journal": journal,
                                "year": year,
                                "pmid": pmid,
                                "study_type": study_classification['type'],
                                "study_badge": study_classification['badge_text'],
                                "study_color": study_classification['badge_color'],
                                "study_score": study_classification['score'],
                                "sort_priority": study_classification['sort_priority']
                            })
                            all_context += f"Title: {title}\nAbstract: {abstract}\nAuthors: {authors}\nJournal: {journal} ({year})\nPMID: {pmid}\n\n"
                        except:
                            continue
            except:
                continue

        # Remove duplicates and sort
        seen_pmids = set()
        unique_refs = []
        for ref in all_refs:
            if ref['pmid'] not in seen_pmids:
                seen_pmids.add(ref['pmid'])
                unique_refs.append(ref)

        unique_refs.sort(key=lambda x: x.get('sort_priority', 99))

        # Build prompt
        ref_list = ""
        for i, ref in enumerate(unique_refs, 1):
            ref_list += f"[{i}] {ref['title']} - {ref['authors']} ({ref['year']}) PMID: {ref['pmid']}\n"

        all_comorbidities = ', '.join(comorbidities) if comorbidities else 'None'
        if other_comorbidities:
            all_comorbidities += f"; {other_comorbidities}"

        patient_data = f"""
Patient Demographics:
- Age: {age} years
- Weight: {weight} kg
- Height: {height} cm
- Sex: {sex}
- BMI: {bmi} kg/m²
- IBW: {ibw} kg

Comorbidities: {all_comorbidities}

Functional Status:
- METs: {mets}

Previous Anesthesia: {previous_anesthesia if previous_anesthesia else 'None reported'}

Medications: {medications if medications else 'None reported'}

Laboratory Values:
- Hemoglobin: {hgb} g/dL
- Platelets: {plt} ×10³/μL
- Creatinine: {cr} mg/dL
- INR: {inr}

Cardiac Assessment:
- Ejection Fraction: {ef if ef else 'Not available'}
- EKG: {ekg if ekg else 'Not available'}

Procedure: {procedure}
Surgery Risk: {surgery_risk}

NPO Status: {npo if npo else 'Not specified'}
Allergies: {allergies if allergies else 'NKDA'}
"""

        prompt = f"""You are an expert anesthesiologist performing a comprehensive pre-operative assessment.

Patient Information:
{patient_data}

Available Evidence (use numbered citations [1], [2], etc.):
{ref_list}

Paper Details:
{all_context}

Generate a comprehensive pre-operative assessment including:

1. **ASA Physical Status Classification**: Assign ASA class (I-V) with detailed justification

2. **Cardiac Risk Stratification**:
   - Calculate RCRI score if applicable
   - Provide estimated cardiac event risk percentage

3. **Perioperative Recommendations**:
   - Medication management (specific timing)
   - Airway considerations
   - Hemodynamic management
   - VTE prophylaxis
   - Glycemic control if diabetic
   - Renal protection if CKD

4. **Anesthetic Considerations**:
   - Preferred technique with rationale
   - Drug selection and dosing
   - Monitoring requirements
   - Postoperative disposition (PACU vs ICU)

Use HTML formatting with <h3>, <p>, <strong>, <ul>, <li> tags.
Use inline citations [1], [2], [3] throughout.

IMPORTANT: Make this assessment SPECIFIC to THIS patient's exact comorbidities, medications, and risk factors."""

        try:
            response = openai_client.chat.completions.create(
                model="gpt-4o",
                messages=[{"role": "user", "content": prompt}],
                temperature=0.1
            ).choices[0].message.content
        except Exception as e:
            response = f"<p>Error generating assessment: {str(e)}</p>"

        return render_template_string(
            PREOP_HTML,
            summary=response,
            references=unique_refs,
            mode='fast_rag',
            reasoning_trace=None,
            search_count=len(search_queries[:5]),
            complexity_reasoning=complexity_result['reasoning']
        )

@app.route("/informed-consent", methods=["GET", "POST"])
def informed_consent_generator():
    """Informed Consent Generator with AI-powered patient-specific consent discussion"""
    if request.method == "GET":
        response = make_response(render_template_string(INFORMED_CONSENT_HTML, summary=None, references=None))
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
        response.headers['Pragma'] = 'no-cache'
        response.headers['Expires'] = '0'
        return response

    # Collect and sanitize form data
    age = int(request.form.get("age", 0))
    asa = sanitize_user_query(request.form.get("asa", ""))
    anesthesia_type = sanitize_user_query(request.form.get("anesthesia_type", ""))
    procedure = sanitize_user_query(request.form.get("procedure", ""))
    comorbidities = request.form.getlist("comorbidities")
    special_considerations = request.form.getlist("special_considerations")
    notes = sanitize_user_query(request.form.get("notes", ""))

    # Validate required fields
    if not procedure or not procedure.strip():
        error_message = "<p style='color: #ff6b6b; text-align: center; padding: 20px;'><strong>Error:</strong> Please specify the surgical procedure before submitting the form.</p>"
        return render_template_string(INFORMED_CONSENT_HTML, summary=error_message, references=None)

    if not anesthesia_type:
        error_message = "<p style='color: #ff6b6b; text-align: center; padding: 20px;'><strong>Error:</strong> Please select an anesthesia type before submitting the form.</p>"
        return render_template_string(INFORMED_CONSENT_HTML, summary=error_message, references=None)

    # Build targeted PubMed searches based on patient factors
    search_queries = []

    # Primary search: procedure-specific anesthesia risks
    search_queries.append(f"{procedure} anesthesia risks complications consent")

    # Anesthesia type-specific risks
    if anesthesia_type == "General":
        search_queries.append("general anesthesia complications informed consent")
    elif anesthesia_type == "Regional/Neuraxial":
        search_queries.append("neuraxial anesthesia spinal epidural complications consent")
    elif anesthesia_type == "Sedation/MAC":
        search_queries.append("monitored anesthesia care sedation complications")

    # Comorbidity-specific searches
    if "Cardiac Disease" in comorbidities:
        search_queries.append(f"{procedure} cardiac disease perioperative risk")
    if "Pulmonary Disease" in comorbidities:
        search_queries.append(f"{procedure} pulmonary complications COPD anesthesia")
    if "Diabetes" in comorbidities:
        search_queries.append("perioperative diabetes management anesthesia")
    if "Renal Disease" in comorbidities:
        search_queries.append("chronic kidney disease anesthesia perioperative")
    if "OSA" in comorbidities:
        search_queries.append("obstructive sleep apnea anesthesia perioperative risks")

    # Special considerations
    if "Pregnancy" in special_considerations:
        search_queries.append("anesthesia pregnancy safety obstetric")
    if "Malignant Hyperthermia History" in special_considerations:
        search_queries.append("malignant hyperthermia anesthesia management")
    if "Difficult Airway" in special_considerations:
        search_queries.append("difficult airway management anesthesia consent")
    if "Chronic Pain" in special_considerations:
        search_queries.append(f"{procedure} chronic pain postoperative analgesia")
    if "Anticoagulation" in special_considerations:
        search_queries.append("anticoagulation perioperative management bleeding risk")

    # Search PubMed for all queries and collect papers
    all_refs = []
    all_context = ""

    for query in search_queries[:4]:  # Limit to 4 searches
        try:
            q_expanded = query.replace(" ", " AND ")
            search_term = (
                f'({q_expanded}) AND '
                f'(systematic review[pt] OR meta-analysis[pt] OR guideline[pt] OR '
                f'"randomized controlled trial"[pt]) AND '
                f'("2015/01/01"[PDAT] : "3000"[PDAT])'
            )

            handle = Entrez.esearch(db="pubmed", term=search_term, retmax=5, sort="relevance")
            result = Entrez.read(handle)
            ids = result["IdList"]

            if ids:
                handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
                papers = Entrez.read(handle)["PubmedArticle"]

                for p in papers:
                    try:
                        art = p["MedlineCitation"]["Article"]
                        title = str(art.get("ArticleTitle", "No title"))
                        abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                        authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])
                        journal = str(art["Journal"].get("Title", "Unknown"))
                        year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                        pmid = str(p["MedlineCitation"]["PMID"])

                        study_classification = classify_study_type(title, journal)

                        all_refs.append({
                            "title": title,
                            "authors": authors,
                            "journal": journal,
                            "year": year,
                            "pmid": pmid,
                            "study_type": study_classification['type'],
                            "study_badge": study_classification['badge_text'],
                            "study_color": study_classification['badge_color'],
                            "study_score": study_classification['score'],
                            "sort_priority": study_classification['sort_priority']
                        })
                        all_context += f"Title: {title}\nAbstract: {abstract}\nAuthors: {authors}\nJournal: {journal} ({year})\nPMID: {pmid}\n\n"
                    except:
                        continue
        except:
            continue

    # Remove duplicate references by PMID
    seen_pmids = set()
    unique_refs = []
    for ref in all_refs:
        if ref['pmid'] not in seen_pmids:
            seen_pmids.add(ref['pmid'])
            unique_refs.append(ref)

    # Sort references by quality
    unique_refs.sort(key=lambda x: x.get('sort_priority', 99))

    # Create numbered reference list for GPT
    ref_list = ""
    for i, ref in enumerate(unique_refs, 1):
        ref_list += f"[{i}] {ref['title']} - {ref['authors']} ({ref['year']}) PMID: {ref['pmid']}\n"

    # Build patient summary for GPT
    all_comorbidities = ', '.join(comorbidities) if comorbidities else 'None'
    all_special = ', '.join(special_considerations) if special_considerations else 'None'

    patient_data = f"""
Patient Information:
- Age: {age} years
- ASA Classification: ASA {asa}

Planned Anesthesia & Procedure:
- Anesthesia Type: {anesthesia_type}
- Surgical Procedure: {procedure}

Medical History:
- Comorbidities: {all_comorbidities}
- Special Considerations: {all_special}

Additional Notes: {notes if notes else 'None'}
"""

    # Generate GPT summary
    prompt = f"""You are an expert anesthesiologist helping create a comprehensive, patient-specific informed consent discussion guide. Based on the patient's information and evidence-based literature, provide a detailed consent discussion that balances medical accuracy with patient-friendly language.

IMPORTANT OUTPUT INSTRUCTIONS:
- Output ONLY the formatted HTML content - NO preamble, NO "Here is..." or "Html", just start directly with the first <h3> tag
- Use THIRD PERSON language throughout (refer to "the patient" or "this patient", NOT "you" or "your")
- Write in a neutral, professional tone suitable for medical documentation
- Example: Use "The patient will experience..." instead of "You will experience..."
- Example: Use "The patient's risks include..." instead of "Your risks include..."

Patient Information:
{patient_data}

Available Evidence (use numbered citations [1], [2], etc.):
{ref_list}

Paper Details:
{all_context}

CRITICAL: PATIENT-SPECIFIC CONSENT PROTOCOL
This is NOT a generic template - personalize EVERY section to THIS specific patient. Before finalizing:
1. **Individualize Risks**: Focus on risks relevant to THIS patient's age ({age}), ASA {asa} status, {anesthesia_type} anesthesia, and comorbidities ({all_comorbidities}).
2. **Procedure-Specific Information**: Tailor common and serious risks to {procedure} specifically, not general anesthesia.
3. **Evidence-Based Incidence Rates**: Provide actual risk percentages from literature when available (e.g., "PONV occurs in X% of patients undergoing {procedure}").
4. **Special Population Considerations**: If patient is elderly, pediatric, pregnant, or has special considerations ({all_special}), address these specifically.
5. **Cross-Check Comorbidities**: Are all comorbidity-specific risks addressed? (cardiac, pulmonary, renal, etc.)

Generate a comprehensive informed consent discussion guide including:

1. **Procedure Overview & Anesthesia Type**:
   - Brief explanation of {anesthesia_type} anesthesia for {procedure}
   - What the patient will experience before, during, and after
   - Why this anesthesia type is appropriate for the patient's procedure

2. **Common Side Effects** (with frequencies when available):
   - List 5-7 most common side effects specific to {anesthesia_type} and {procedure}
   - Include incidence rates (e.g., "Nausea occurs in 20-30% of patients")
   - Explain duration and management strategies
   - Use patient-friendly language while maintaining medical accuracy

3. **Serious but Rare Risks** (with incidence rates):
   - List serious complications relevant to THIS patient's ASA {asa} status and comorbidities
   - Include specific incidence rates (e.g., "1 in X,XXX patients")
   - Explain risk factors that increase likelihood (age, comorbidities, procedure type)
   - Address {anesthesia_type}-specific serious risks (e.g., nerve injury for regional, aspiration for general)

4. **Patient-Specific Risk Factors**:
   - How THIS patient's comorbidities ({all_comorbidities}) affect anesthesia risks
   - Special precautions being taken for the patient's conditions
   - Why the patient's ASA {asa} classification matters
   - Management of special considerations: {all_special}

5. **Alternative Options**:
   - Alternative anesthesia techniques available for {procedure}
   - Pros and cons of each option for THIS patient
   - Why {anesthesia_type} is recommended

6. **Questions the Patient Should Ask**:
   - 5-7 important questions this patient should discuss with the anesthesiologist
   - Questions specific to the patient's comorbidities and special considerations
   - Questions about postoperative pain management, recovery, etc.

7. **What to Expect & Preparation**:
   - Pre-operative instructions (NPO status, medications to continue/hold)
   - What happens in the holding area and OR
   - Recovery room expectations
   - When the patient can eat, drink, resume activities

Use HTML formatting with visual enhancements:
- <h3>Section Headers</h3> - Main sections with automatic blue arrow icons
- <h4>Subsection Headers</h4> - For sub-topics within sections
- <p>Paragraphs</p> - Normal text
- <strong>Key Terms</strong> - Important terms (drug names, procedures, percentages) will be highlighted with blue background
- <ul><li>Bulleted lists</li></ul> - Items will display with checkmark icons
- Risk levels: Wrap risk categories in spans like <span class="risk-high">High Risk</span>, <span class="risk-moderate">Moderate Risk</span>, or <span class="risk-low">Low Risk</span> for color-coded badges
- <br><br> for spacing between major sections

IMPORTANT:
1. Use inline citations [1], [2], [3] throughout your discussion to reference the papers provided above
2. DO NOT create a separate "References" section - references will be displayed separately below
3. Use the risk level spans (risk-high, risk-moderate, risk-low) when mentioning risk percentages for visual impact
4. Use <strong> tags for drug names, procedures, percentages, and key medical terms
5. ALWAYS use THIRD PERSON ("the patient", "this patient") - NEVER use second person ("you", "your")
6. Start output immediately with <h3> - NO introduction, preamble, or "Here is..." text

Tone: Professional, neutral, and accessible - explain medical concepts in plain English while maintaining accuracy and objectivity. Write as medical documentation that informs about the patient, not as a conversation with the patient."""

    try:
        response = openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1
        ).choices[0].message.content
        # Clean markdown code fences from the response
        response = strip_markdown_code_fences(response)
    except Exception as e:
        response = f"<p>Error generating consent discussion: {str(e)}</p>"

    return render_template_string(INFORMED_CONSENT_HTML, summary=response, references=unique_refs)

@app.route("/difficult-airway", methods=["GET", "POST"])
def difficult_airway_assessment():
    """Difficult Airway Assessment with AI-powered risk stratification"""
    if request.method == "GET":
        response = make_response(render_template_string(DIFFICULT_AIRWAY_HTML, summary=None, references=None))
        response.headers['Cache-Control'] = 'no-cache, no-store, must-revalidate'
        response.headers['Pragma'] = 'no-cache'
        response.headers['Expires'] = '0'
        return response

    # Collect and sanitize form data
    age = int(request.form.get("age", 0))
    bmi = float(request.form.get("bmi", 0))
    mallampati = sanitize_user_query(request.form.get("mallampati", ""))
    thyromental = sanitize_user_query(request.form.get("thyromental", ""))
    mouth_opening = sanitize_user_query(request.form.get("mouth_opening", ""))
    neck_extension = sanitize_user_query(request.form.get("neck_extension", ""))
    risk_factors = request.form.getlist("risk_factors")
    procedure = sanitize_user_query(request.form.get("procedure", ""))
    case_type = sanitize_user_query(request.form.get("case_type", ""))
    notes = sanitize_user_query(request.form.get("notes", ""))

    # Validate required fields
    if not procedure or not procedure.strip():
        error_message = "<p style='color: #ff6b6b; text-align: center; padding: 20px;'><strong>Error:</strong> Please specify the planned procedure before submitting the form.</p>"
        return render_template_string(DIFFICULT_AIRWAY_HTML, summary=error_message, references=None)

    # Calculate risk score based on validated predictors
    risk_score = 0
    risk_factors_list = []

    # Mallampati III-IV (1 point)
    if mallampati in ["III", "IV"]:
        risk_score += 1
        risk_factors_list.append(f"Mallampati Class {mallampati}")

    # Thyromental distance <6cm (1 point)
    if thyromental == "<6cm":
        risk_score += 1
        risk_factors_list.append("Thyromental distance <6 cm")

    # Mouth opening <3cm (1 point)
    if mouth_opening == "<3cm":
        risk_score += 1
        risk_factors_list.append("Mouth opening <3 cm")

    # Limited neck extension (1 point)
    if neck_extension == "Limited":
        risk_score += 1
        risk_factors_list.append("Limited neck extension")

    # High BMI >35 (1 point)
    if bmi > 35:
        risk_score += 1
        risk_factors_list.append(f"Obesity (BMI {bmi:.1f} kg/m²)")

    # Previous difficult intubation (2 points - strong predictor)
    if "Previous Difficult Intubation" in risk_factors:
        risk_score += 2
        risk_factors_list.append("Previous difficult intubation")

    # OSA (1 point)
    if "OSA" in risk_factors:
        risk_score += 1
        risk_factors_list.append("Obstructive sleep apnea")

    # Other anatomical factors (0.5 points each)
    for factor in ["Beard", "Prominent Incisors", "Short Neck", "Large Tongue", "Facial Trauma", "C-Spine Pathology"]:
        if factor in risk_factors:
            risk_score += 0.5
            risk_factors_list.append(factor.lower())

    # Determine risk category
    if risk_score >= 4:
        risk_category = "High"
    elif risk_score >= 2:
        risk_category = "Moderate"
    else:
        risk_category = "Low"

    # Build targeted PubMed searches
    search_queries = []

    # Primary airway management search
    search_queries.append("difficult airway management guidelines anesthesia")

    # If high risk, search for advanced techniques
    if risk_category == "High":
        search_queries.append("awake fiberoptic intubation indications technique")
        search_queries.append("video laryngoscopy difficult airway")

    # OSA-specific management
    if "OSA" in risk_factors:
        search_queries.append("obstructive sleep apnea difficult airway perioperative")

    # Obesity-specific positioning
    if bmi > 35:
        search_queries.append("obese patient airway management positioning HELP")

    # Emergency airway if emergency case
    if case_type == "Emergency":
        search_queries.append("emergency airway management rapid sequence intubation")

    # Previous difficult intubation
    if "Previous Difficult Intubation" in risk_factors:
        search_queries.append("previous difficult intubation management anesthesia")

    # Search PubMed for all queries and collect papers
    all_refs = []
    all_context = ""

    for query in search_queries[:4]:  # Limit to 4 searches
        try:
            q_expanded = query.replace(" ", " AND ")
            search_term = (
                f'({q_expanded}) AND '
                f'(systematic review[pt] OR meta-analysis[pt] OR guideline[pt] OR '
                f'"randomized controlled trial"[pt]) AND '
                f'("2015/01/01"[PDAT] : "3000"[PDAT])'
            )

            handle = Entrez.esearch(db="pubmed", term=search_term, retmax=5, sort="relevance")
            result = Entrez.read(handle)
            ids = result["IdList"]

            if ids:
                handle = Entrez.efetch(db="pubmed", id=",".join(ids), retmode="xml")
                papers = Entrez.read(handle)["PubmedArticle"]

                for p in papers:
                    try:
                        art = p["MedlineCitation"]["Article"]
                        title = str(art.get("ArticleTitle", "No title"))
                        abstract = " ".join(str(t) for t in art.get("Abstract", {}).get("AbstractText", [])) if art.get("Abstract") else ""
                        authors = ", ".join([str(a.get("LastName","")) + " " + (str(a.get("ForeName",""))[:1]+"." if a.get("ForeName") else "") for a in art.get("AuthorList",[])[:3]])
                        journal = str(art["Journal"].get("Title", "Unknown"))
                        year = str(art["Journal"]["JournalIssue"]["PubDate"].get("Year", "N/A"))
                        pmid = str(p["MedlineCitation"]["PMID"])

                        study_classification = classify_study_type(title, journal)

                        all_refs.append({
                            "title": title,
                            "authors": authors,
                            "journal": journal,
                            "year": year,
                            "pmid": pmid,
                            "study_type": study_classification['type'],
                            "study_badge": study_classification['badge_text'],
                            "study_color": study_classification['badge_color'],
                            "study_score": study_classification['score'],
                            "sort_priority": study_classification['sort_priority']
                        })
                        all_context += f"Title: {title}\nAbstract: {abstract}\nAuthors: {authors}\nJournal: {journal} ({year})\nPMID: {pmid}\n\n"
                    except:
                        continue
        except:
            continue

    # Remove duplicate references by PMID
    seen_pmids = set()
    unique_refs = []
    for ref in all_refs:
        if ref['pmid'] not in seen_pmids:
            seen_pmids.add(ref['pmid'])
            unique_refs.append(ref)

    # Sort references by quality
    unique_refs.sort(key=lambda x: x.get('sort_priority', 99))

    # Create numbered reference list for GPT
    ref_list = ""
    for i, ref in enumerate(unique_refs, 1):
        ref_list += f"[{i}] {ref['title']} - {ref['authors']} ({ref['year']}) PMID: {ref['pmid']}\n"

    # Build patient summary for GPT
    all_risk_factors = ', '.join(risk_factors_list) if risk_factors_list else 'None identified'

    patient_data = f"""
Patient Demographics:
- Age: {age} years
- BMI: {bmi:.1f} kg/m²

Airway Assessment:
- Mallampati Classification: Class {mallampati}
- Thyromental Distance: {thyromental}
- Mouth Opening: {mouth_opening}
- Neck Extension: {neck_extension}

Risk Factors Present: {all_risk_factors}

Risk Score: {risk_score}/7 points
Risk Category: {risk_category}

Procedure: {procedure}
Case Type: {case_type}

Additional Notes: {notes if notes else 'None'}
"""

    # Generate GPT summary
    prompt = f"""You are an expert anesthesiologist performing a comprehensive difficult airway assessment. Based on validated clinical predictors and recent evidence, provide a detailed risk stratification and management plan.

Patient Information:
{patient_data}

Available Evidence (use numbered citations [1], [2], etc.):
{ref_list}

Paper Details:
{all_context}

CRITICAL: PATIENT-SPECIFIC AIRWAY ASSESSMENT PROTOCOL
This is NOT a template - tailor EVERY recommendation to THIS specific patient. Before finalizing:
1. **Individualize Risk Assessment**: Calculate the actual difficult airway risk score based on THIS patient's Mallampati, thyromental distance, mouth opening, neck extension, BMI, and history.
2. **Specific Management Strategy**: Base airway plan on THIS patient's risk category ({risk_category}), case urgency ({case_type}), and specific anatomical challenges.
3. **Evidence-Based Equipment Selection**: Recommend specific airway devices and techniques appropriate for THIS patient's risk factors.
4. **Personalized Positioning**: If patient is obese (BMI {bmi:.1f}), specify HELP position or ramping details.
5. **Cross-Check Case Urgency**: If {case_type} case, adjust awake vs asleep intubation recommendations accordingly.

Generate a comprehensive difficult airway assessment including:

1. **Risk Stratification Summary**:
   - Overall risk category ({risk_category}) with justification
   - Specific predictors identified in this patient
   - Estimated difficulty level for mask ventilation, supraglottic airway, and intubation

2. **Pre-Intubation Optimization**:
   - Patient positioning (HELP position if BMI >35, ramping if needed)
   - Pre-oxygenation strategy (target EtO₂, apneic oxygenation via nasal cannula)
   - Equipment preparation (specific devices: video laryngoscope type, LMA size, bougie, etc.)
   - Personnel needs (extra anesthesiologist, surgeon availability, etc.)

3. **Primary Airway Management Plan**:
   - Recommended primary technique (awake fiberoptic vs video laryngoscopy vs direct laryngoscopy)
   - Drug selection and dosing if asleep intubation planned
   - Maximum number of attempts before escalation
   - Specific technique modifications for this patient's anatomy

4. **Backup Plans (ASA Difficult Airway Algorithm 2022)**:
   - Plan A: Primary intubation approach
   - Plan B: Alternative intubation technique if Plan A fails
   - Plan C: Supraglottic airway rescue (specific device and size)
   - Plan D: Emergency front-of-neck access preparation (cricothyrotomy kit location)
   - Decision point: When to awaken patient vs proceed with emergency pathway

5. **Case-Specific Considerations**:
   - Special considerations for {case_type} case
   - Management of {', '.join(risk_factors) if risk_factors else 'patient-specific factors'}
   - Postoperative extubation planning
   - Communication plan with surgical team

Use HTML formatting with visual enhancements:
- <h3>Section Headers</h3> - Main sections with automatic blue arrow icons
- <h4>Subsection Headers</h4> - For sub-topics within sections
- <p>Paragraphs</p> - Normal text
- <strong>Key Terms</strong> - Important terms will be highlighted with blue background
- <ul><li>Bulleted lists</li></ul> - Items will display with checkmark icons
- Risk levels: Wrap risk categories in spans like <span class="risk-high">High Risk</span>, <span class="risk-moderate">Moderate Risk</span>, or <span class="risk-low">Low Risk</span> for color-coded badges
- <br><br> for spacing between major sections

IMPORTANT:
1. Use inline citations [1], [2], [3] throughout your assessment to reference the papers provided above
2. DO NOT create a separate "References" section - references will be displayed separately below
3. Use the risk level spans (risk-high, risk-moderate, risk-low) when mentioning risk categories for visual impact
4. Use <strong> tags for drug names, equipment, and critical decision points

Provide maximum clinical utility with specific, actionable recommendations backed by evidence. This assessment should be directly usable for safe airway management planning."""

    try:
        response = openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.1
        ).choices[0].message.content
    except Exception as e:
        response = f"<p>Error generating assessment: {str(e)}</p>"

    return render_template_string(DIFFICULT_AIRWAY_HTML, summary=response, references=unique_refs)

@app.route("/hypotension", methods=["GET", "POST"])
def hypotension_predictor():
    """Intraoperative Hypotension Predictor - Educational tool only"""
    if request.method == "GET":
        return render_template_string(HYPOTENSION_HTML, prediction=None)

    # Collect and sanitize form data
    age = int(request.form.get("age", 0))
    sex = sanitize_user_query(request.form.get("sex", ""))
    weight = float(request.form.get("weight", 0))
    height = float(request.form.get("height", 0))
    asa = int(request.form.get("asa", 1))
    baseline_map = int(request.form.get("baseline_map", 0))
    baseline_hr = int(request.form.get("baseline_hr", 0))
    current_map = int(request.form.get("current_map", 0))
    map_5min = int(request.form.get("map_5min", 0))
    map_10min = int(request.form.get("map_10min", 0))
    surgery_duration = int(request.form.get("surgery_duration", 0))
    vasopressor = sanitize_user_query(request.form.get("vasopressor", "none"))
    surgery_type = sanitize_user_query(request.form.get("surgery_type", ""))
    induction_agent = sanitize_user_query(request.form.get("induction_agent", ""))
    emergency = sanitize_user_query(request.form.get("emergency", "no"))

    # Calculate BMI
    bmi = round(weight / ((height / 100) ** 2), 1) if weight and height else 0

    # Calculate MAP trend (needed for interventions regardless of model success)
    map_trend = (current_map - map_5min) + (current_map - map_10min) / 2

    # Define high-risk surgeries (needed for interventions regardless of model success)
    high_risk_surgeries = ["cardiac", "major_abdominal", "vascular"]

    # Machine Learning-Based Prediction System
    # Load trained RandomForest model and make prediction

    try:
        import pickle
        import numpy as np

        # Load model and scaler
        with open('ioh_model.pkl', 'rb') as f:
            model = pickle.load(f)
        with open('ioh_scaler.pkl', 'rb') as f:
            scaler = pickle.load(f)

        # Encode categorical variables
        sex_encoded = 1 if sex == "male" else 0

        vasopressor_map = {"none": 0, "phenylephrine": 1, "ephedrine": 2, "norepinephrine": 3}
        vasopressor_encoded = vasopressor_map.get(vasopressor, 0)

        surgery_type_map = {"minor": 0, "moderate": 1, "major_abdominal": 2, "cardiac": 3, "vascular": 4}
        surgery_type_encoded = surgery_type_map.get(surgery_type, 0)

        induction_agent_map = {"propofol": 0, "etomidate": 1, "ketamine": 2}
        induction_agent_encoded = induction_agent_map.get(induction_agent, 0)

        emergency_encoded = 1 if emergency == "yes" else 0

        # Prepare features in same order as training
        # Features: age, sex, bmi, asa, baseline_map, baseline_hr, current_map, map_5min, map_10min,
        #           surgery_duration, vasopressor, surgery_type, induction_agent, emergency
        features = np.array([[
            age, sex_encoded, bmi, asa, baseline_map, baseline_hr,
            current_map, map_5min, map_10min, surgery_duration,
            vasopressor_encoded, surgery_type_encoded, induction_agent_encoded, emergency_encoded
        ]])

        # Scale features
        features_scaled = scaler.transform(features)

        # Get prediction probability
        ioh_prob = model.predict_proba(features_scaled)[0][1]  # Probability of IOH

        # Convert to percentage
        prob_5min = int(ioh_prob * 100)

        # Estimate probabilities for 10 and 20 minute windows (with decay)
        prob_10min = int(ioh_prob * 0.85 * 100)
        prob_20min = int(ioh_prob * 0.70 * 100)

        # Classify risk levels
        def classify_risk(prob):
            if prob < 30:
                return "low", "risk-low", "Low Risk"
            elif prob < 60:
                return "moderate", "risk-moderate", "Moderate Risk"
            else:
                return "high", "risk-high", "High Risk"

        risk_5min_class, risk_5min_label, risk_5min_text = classify_risk(prob_5min)
        risk_10min_class, risk_10min_label, risk_10min_text = classify_risk(prob_10min)
        risk_20min_class, risk_20min_label, risk_20min_text = classify_risk(prob_20min)

        # Identify top risk factors based on feature analysis
        factors = []

        # MAP trend analysis (already calculated above)
        if map_trend < -10:
            factors.append({
                "name": "Declining MAP Trend",
                "description": f"MAP decreased by {abs(int(map_trend))} mmHg over last 10 minutes, indicating hemodynamic instability"
            })
        elif map_trend < -5:
            factors.append({
                "name": "Moderate MAP Decline",
                "description": f"MAP decreased by {abs(int(map_trend))} mmHg, suggesting early hemodynamic changes"
            })

        # Current MAP level
        if current_map < 70:
            factors.append({
                "name": "Low Current MAP",
                "description": f"Current MAP of {current_map} mmHg is approaching hypotension threshold (65 mmHg)"
            })

        # Baseline deviation
        map_drop_pct = ((baseline_map - current_map) / baseline_map) * 100 if baseline_map > 0 else 0
        if map_drop_pct > 20:
            factors.append({
                "name": "Significant MAP Drop from Baseline",
                "description": f"{int(map_drop_pct)}% decrease from baseline MAP, exceeding critical threshold"
            })

        # Age risk
        if age > 70:
            factors.append({
                "name": "Advanced Age",
                "description": f"Age {age} years associated with increased cardiovascular lability"
            })

        # ASA class
        if asa >= 3:
            factors.append({
                "name": "High ASA Classification",
                "description": f"ASA {asa} indicates significant comorbidities affecting hemodynamic stability"
            })

        # Surgery type
        if surgery_type in high_risk_surgeries:
            factors.append({
                "name": "High-Risk Surgery Type",
                "description": f"{surgery_type.replace('_', ' ').title()} surgery associated with greater fluid shifts"
            })

        # Emergency
        if emergency == "yes":
            factors.append({
                "name": "Emergency Surgery",
                "description": "Emergency procedures have higher hypotension risk"
            })

        # Induction agent
        if induction_agent == "propofol":
            factors.append({
                "name": "Propofol Induction",
                "description": "Propofol associated with dose-dependent vasodilation"
            })

        # Vasopressor use
        if vasopressor != "none":
            factors.append({
                "name": "Current Vasopressor Requirement",
                "description": f"Ongoing {vasopressor} use indicates hemodynamic instability"
            })

        # Keep top 3 factors
        factors = factors[:3] if len(factors) > 3 else factors

        # If no factors, add default
        if not factors:
            factors.append({
                "name": "Stable Hemodynamics",
                "description": "No major risk factors identified based on current parameters"
            })

    except Exception as e:
        logger.error(f"ML model prediction error: {str(e)}")
        # Fallback to simple heuristic if model fails
        prob_5min = 30
        prob_10min = 25
        prob_20min = 20
        risk_5min_class, risk_5min_label, risk_5min_text = "moderate", "risk-moderate", "Moderate Risk"
        risk_10min_class, risk_10min_label, risk_10min_text = "low", "risk-low", "Low Risk"
        risk_20min_class, risk_20min_label, risk_20min_text = "low", "risk-low", "Low Risk"
        factors = [{
            "name": "Model Unavailable",
            "description": "ML model could not be loaded. Using fallback estimation."
        }]

    # Evidence-Based Intervention Suggestions
    interventions = []

    # Prioritize based on risk factors
    if current_map < 70 or map_trend < -5:
        if vasopressor == "none":
            interventions.append({
                "name": "Phenylephrine 50-100 mcg IV",
                "description": "First-line alpha-1 agonist for MAP support without chronotropy. Effective for vasodilatory hypotension from anesthetics."
            })

        interventions.append({
            "name": "Fluid Bolus 250-500 mL Crystalloid",
            "description": "Goal-directed fluid therapy to optimize preload. Assess fluid responsiveness via pulse pressure variation if available."
        })

    if induction_agent == "propofol":
        interventions.append({
            "name": "Reduce Volatile Anesthetic %",
            "description": "Dose-dependent vasodilation from inhalational agents. Consider reducing MAC to 0.7-0.9 to improve hemodynamics."
        })

    if age > 65 or asa >= 3:
        interventions.append({
            "name": "Increase Monitoring Frequency",
            "description": "Consider arterial line for beat-to-beat BP monitoring in high-risk patients. Trend MAP every 1-2 minutes."
        })

    if surgery_type in high_risk_surgeries:
        interventions.append({
            "name": "Ephedrine 5-10 mg IV",
            "description": "Mixed alpha/beta agonist useful for hypotension with bradycardia. Raises MAP and cardiac output."
        })

    # Always add general recommendations
    interventions.append({
        "name": "Optimize Positioning & Surgical Factors",
        "description": "Ensure appropriate patient positioning, communicate with surgeon about retraction/traction affecting venous return."
    })

    interventions.append({
        "name": "Reassess Anesthetic Depth",
        "description": "Verify adequate but not excessive anesthetic depth. Consider reducing propofol/volatile if hemodynamically unstable."
    })

    # Limit to top 5 interventions
    interventions = interventions[:5]

    prediction = {
        "prob_5min": prob_5min,
        "prob_10min": prob_10min,
        "prob_20min": prob_20min,
        "risk_5min_class": risk_5min_class,
        "risk_10min_class": risk_10min_class,
        "risk_20min_class": risk_20min_class,
        "risk_5min_label": risk_5min_label,
        "risk_10min_label": risk_10min_label,
        "risk_20min_label": risk_20min_label,
        "risk_5min_text": risk_5min_text,
        "risk_10min_text": risk_10min_text,
        "risk_20min_text": risk_20min_text,
        "factors": factors,
        "interventions": interventions
    }

    return render_template_string(HYPOTENSION_HTML, prediction=prediction)

# ====== Authentication Routes ======

@app.route("/register", methods=["GET", "POST"])
def register():
    """User registration page"""
    if current_user.is_authenticated:
        return redirect(url_for('index'))

    if request.method == "POST":
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '')
        full_name = request.form.get('full_name', '').strip()

        # Validate input
        if not email or not password or not full_name:
            flash('Name, email, and password are required', 'error')
            return redirect(url_for('register'))

        if len(password) < 8:
            flash('Password must be at least 8 characters long', 'error')
            return redirect(url_for('register'))

        # Check if user already exists
        existing_user = database.get_user_by_email(email)
        if existing_user:
            # Check if it's an OAuth-only account
            if existing_user.get('oauth_provider') and not existing_user.get('password_hash'):
                oauth_provider = existing_user['oauth_provider'].title()
                flash(f'An account with this email already exists using {oauth_provider} Sign In. Please use the "{oauth_provider} Sign In" button to log in.', 'error')
            else:
                flash('An account with this email already exists. Please log in instead.', 'error')
            return redirect(url_for('login'))

        # Generate verification token
        verification_token = secrets.token_urlsafe(32)

        # Hash password and create user
        password_hash = bcrypt.generate_password_hash(password).decode('utf-8')
        user_id = database.create_user(email, password_hash, full_name, verification_token)

        if user_id:
            # Get user data to log them in
            user_data = database.get_user_by_email(email)

            # Send verification email
            if EMAIL_CONFIGURED:
                email_sent = send_verification_email(email, full_name, verification_token)
                if email_sent:
                    flash('Account created! Please check your email to verify your account.', 'warning')
                else:
                    flash('Account created, but we couldn\'t send the verification email. You can request a new one from your account.', 'warning')
            else:
                # Email not configured - auto-verify user for development
                logger.warning(f"Email not configured - auto-verifying user {email}")
                database.manually_verify_user(user_id)
                # Reload user data with verification status
                user_data = database.get_user_by_email(email)

            # Log the user in immediately (verified or not)
            user = User(
                user_id=user_data['id'],
                email=user_data['email'],
                full_name=user_data.get('full_name'),
                subscription_tier=user_data.get('subscription_tier', 'free'),
                subscription_status=user_data.get('subscription_status', 'active'),
                is_verified=user_data.get('is_verified', False)
            )
            login_user(user)
            database.update_user_login(user.id)

            return redirect(url_for('index'))
        else:
            flash('Failed to create account. Please try again.', 'error')
            return redirect(url_for('register'))

    return render_template_string(REGISTER_HTML)


@app.route("/login", methods=["GET", "POST"])
def login():
    """User login page"""
    if current_user.is_authenticated:
        return redirect(url_for('index'))

    if request.method == "POST":
        email = request.form.get('email', '').strip()
        password = request.form.get('password', '')

        # Validate input
        if not email or not password:
            flash('Email and password are required', 'error')
            return redirect(url_for('login'))

        # Get user from database
        user_data = database.get_user_by_email(email)
        if not user_data:
            flash('Invalid email or password', 'error')
            return redirect(url_for('login'))

        # Check if this is an OAuth-only user (no password set)
        if user_data.get('oauth_provider') and not user_data.get('password_hash'):
            oauth_provider = user_data['oauth_provider'].title()  # Google or Apple
            flash(f'This account uses {oauth_provider} Sign In. Please use the "{oauth_provider} Sign In" button.', 'error')
            return redirect(url_for('login'))

        # Check password (for email/password users or linked accounts with password)
        if not user_data.get('password_hash') or not bcrypt.check_password_hash(user_data['password_hash'], password):
            flash('Invalid email or password', 'error')
            return redirect(url_for('login'))

        # Create user object and log in
        user = User(
            user_id=user_data['id'],
            email=user_data['email'],
            full_name=user_data.get('full_name'),
            subscription_tier=user_data.get('subscription_tier', 'free'),
            subscription_status=user_data.get('subscription_status', 'active'),
            is_verified=user_data.get('is_verified', True)
        )
        login_user(user, remember=True)
        database.update_user_login(user.id)

        # Show reminder if email is not verified
        if EMAIL_CONFIGURED and not user_data.get('is_verified', False):
            flash('Please verify your email address. Check your inbox or request a new verification link.', 'warning')
        else:
            flash(f'Welcome back, {user.display_name}!', 'success')

        # Redirect to next page or home
        next_page = request.args.get('next')
        return redirect(next_page) if next_page else redirect(url_for('index'))

    return render_template_string(LOGIN_HTML)


@app.route("/logout")
@login_required
def logout():
    """Log out the current user"""
    logout_user()
    flash('You have been logged out successfully', 'info')
    return redirect(url_for('index'))


@app.route("/auth/google")
def google_login():
    """Initiate Google OAuth login"""
    if not GOOGLE_OAUTH_CONFIGURED:
        flash('Google Sign In is not configured. Please use email/password login.', 'error')
        return redirect(url_for('login'))

    # Store the next URL in session to redirect after OAuth
    session['oauth_next'] = request.args.get('next') or url_for('index')

    # Generate redirect URI
    redirect_uri = url_for('google_callback', _external=True)
    return google.authorize_redirect(redirect_uri)


@app.route("/auth/google/callback")
def google_callback():
    """Handle Google OAuth callback"""
    if not GOOGLE_OAUTH_CONFIGURED:
        flash('Google Sign In is not configured.', 'error')
        return redirect(url_for('login'))

    try:
        # Get OAuth token
        token = google.authorize_access_token()

        # Get user info from Google
        user_info = token.get('userinfo')
        if not user_info:
            user_info = google.get('userinfo').json()

        email = user_info.get('email')
        full_name = user_info.get('name')
        google_id = user_info.get('sub')  # Google's unique user ID

        if not email or not google_id:
            flash('Failed to get user information from Google. Please try again.', 'error')
            return redirect(url_for('login'))

        # Check if user exists by OAuth provider
        user_data = database.get_user_by_oauth('google', google_id)

        if user_data:
            # Existing OAuth user - log them in
            user = User(
                id=user_data['id'],
                email=user_data['email'],
                full_name=user_data['full_name'],
                is_verified=user_data['is_verified'],
                subscription_tier=user_data['subscription_tier']
            )
            database.update_user_login(user.id)
            login_user(user, remember=True)
            flash(f'Welcome back, {user.display_name}!', 'success')

        else:
            # Check if user exists by email (account linking)
            existing_user = database.get_user_by_email(email)

            if existing_user:
                # Link OAuth to existing account
                database.link_oauth_to_existing_user(existing_user['id'], 'google', google_id)
                user = User(
                    id=existing_user['id'],
                    email=existing_user['email'],
                    full_name=existing_user['full_name'],
                    is_verified=True,  # OAuth users are auto-verified
                    subscription_tier=existing_user['subscription_tier']
                )
                database.update_user_login(user.id)
                login_user(user, remember=True)
                flash(f'Google account linked successfully! Welcome back, {user.display_name}!', 'success')
            else:
                # Create new user via OAuth
                user_id = database.create_oauth_user(email, full_name, 'google', google_id)

                if user_id:
                    user = User(
                        id=user_id,
                        email=email,
                        full_name=full_name,
                        is_verified=True,
                        subscription_tier='free'
                    )
                    database.update_user_login(user.id)
                    login_user(user, remember=True)
                    flash(f'Account created successfully! Welcome, {user.display_name}!', 'success')
                else:
                    flash('Failed to create account. Please try again.', 'error')
                    return redirect(url_for('register'))

        # Redirect to the page they were trying to access, or home
        next_page = session.pop('oauth_next', url_for('index'))
        return redirect(next_page)

    except Exception as e:
        logger.error(f"Google OAuth error: {e}")
        flash('An error occurred during Google Sign In. Please try again.', 'error')
        return redirect(url_for('login'))


@app.route("/auth/apple")
def apple_login():
    """Initiate Apple OAuth login"""
    if not APPLE_OAUTH_CONFIGURED:
        flash('Apple Sign In is not configured. Please use email/password login.', 'error')
        return redirect(url_for('login'))

    # Store the next URL in session to redirect after OAuth
    session['oauth_next'] = request.args.get('next') or url_for('index')

    # Generate redirect URI
    redirect_uri = url_for('apple_callback', _external=True)
    return apple.authorize_redirect(redirect_uri)


@app.route("/auth/apple/callback")
def apple_callback():
    """Handle Apple OAuth callback"""
    if not APPLE_OAUTH_CONFIGURED:
        flash('Apple Sign In is not configured.', 'error')
        return redirect(url_for('login'))

    try:
        # Get OAuth token
        token = apple.authorize_access_token()

        # Get user info from Apple
        user_info = token.get('userinfo')
        if not user_info:
            # Apple doesn't provide a userinfo endpoint, we get data from ID token
            id_token = token.get('id_token')
            user_info = apple.parse_id_token(token)

        email = user_info.get('email')
        apple_id = user_info.get('sub')  # Apple's unique user ID

        # Apple may not provide name on subsequent logins, only on first authorization
        full_name = None
        if 'name' in user_info:
            name_dict = user_info.get('name', {})
            first_name = name_dict.get('firstName', '')
            last_name = name_dict.get('lastName', '')
            full_name = f"{first_name} {last_name}".strip() if first_name or last_name else None

        if not email or not apple_id:
            flash('Failed to get user information from Apple. Please try again.', 'error')
            return redirect(url_for('login'))

        # Check if user exists by OAuth provider
        user_data = database.get_user_by_oauth('apple', apple_id)

        if user_data:
            # Existing OAuth user - log them in
            user = User(
                id=user_data['id'],
                email=user_data['email'],
                full_name=user_data['full_name'],
                is_verified=user_data['is_verified'],
                subscription_tier=user_data['subscription_tier']
            )
            database.update_user_login(user.id)
            login_user(user, remember=True)
            flash(f'Welcome back, {user.display_name}!', 'success')

        else:
            # Check if user exists by email (account linking)
            existing_user = database.get_user_by_email(email)

            if existing_user:
                # Link OAuth to existing account
                database.link_oauth_to_existing_user(existing_user['id'], 'apple', apple_id)
                user = User(
                    id=existing_user['id'],
                    email=existing_user['email'],
                    full_name=existing_user['full_name'],
                    is_verified=True,  # OAuth users are auto-verified
                    subscription_tier=existing_user['subscription_tier']
                )
                database.update_user_login(user.id)
                login_user(user, remember=True)
                flash(f'Apple account linked successfully! Welcome back, {user.display_name}!', 'success')
            else:
                # Create new user via OAuth
                user_id = database.create_oauth_user(email, full_name, 'apple', apple_id)

                if user_id:
                    user = User(
                        id=user_id,
                        email=email,
                        full_name=full_name,
                        is_verified=True,
                        subscription_tier='free'
                    )
                    database.update_user_login(user.id)
                    login_user(user, remember=True)
                    flash(f'Account created successfully! Welcome, {user.display_name}!', 'success')
                else:
                    flash('Failed to create account. Please try again.', 'error')
                    return redirect(url_for('register'))

        # Redirect to the page they were trying to access, or home
        next_page = session.pop('oauth_next', url_for('index'))
        return redirect(next_page)

    except Exception as e:
        logger.error(f"Apple OAuth error: {e}")
        flash('An error occurred during Apple Sign In. Please try again.', 'error')
        return redirect(url_for('login'))


@app.route("/verify/<token>")
def verify_email(token):
    """Verify user email with token"""
    if current_user.is_authenticated:
        flash('Your account is already verified', 'info')
        return redirect(url_for('index'))

    # Verify the token
    if database.verify_user_email(token):
        flash('Email verified successfully! You can now log in.', 'success')
        return redirect(url_for('login'))
    else:
        flash('Invalid or expired verification link. Please request a new one.', 'error')
        return redirect(url_for('login'))


@app.route("/resend-verification", methods=["GET", "POST"])
def resend_verification():
    """Resend verification email"""
    # If user is authenticated and already verified, redirect to index
    if current_user.is_authenticated and current_user.is_verified:
        flash('Your email is already verified!', 'info')
        return redirect(url_for('index'))

    if request.method == "POST":
        # If authenticated user, use their email; otherwise get from form
        if current_user.is_authenticated:
            email = current_user.email
        else:
            email = request.form.get('email', '').strip()

        if not email:
            flash('Email is required', 'error')
            return redirect(url_for('resend_verification'))

        # Get user from database
        user_data = database.get_user_by_email(email)
        if not user_data:
            # Don't reveal if email exists or not
            flash('If an unverified account exists with this email, a new verification link has been sent.', 'info')
            return redirect(url_for('login'))

        # Check if already verified
        if user_data.get('is_verified', False):
            flash('This email is already verified. You can log in.', 'info')
            return redirect(url_for('login'))

        # Generate new verification token
        new_token = secrets.token_urlsafe(32)

        # Update user with new token
        try:
            with database.get_db_connection() as conn:
                conn.execute("""
                    UPDATE users
                    SET verification_token = ?
                    WHERE id = ?
                """, (new_token, user_data['id']))
        except Exception as e:
            logger.error(f"Failed to update verification token: {e}")
            flash('Failed to send verification email. Please try again.', 'error')
            return redirect(url_for('resend_verification'))

        # Send new verification email
        if EMAIL_CONFIGURED:
            email_sent = send_verification_email(
                user_data['email'],
                user_data.get('full_name'),
                new_token
            )
            if email_sent:
                flash('A new verification link has been sent to your email.', 'success')
            else:
                flash('Failed to send verification email. Please contact support.', 'error')
        else:
            flash('Email verification is not configured. Please contact support.', 'error')

        # Redirect to index if authenticated, otherwise to login
        return redirect(url_for('index' if current_user.is_authenticated else 'login'))

    # GET request - show resend form
    return render_template_string(RESEND_VERIFICATION_HTML)


@app.route("/admin")
@login_required
def admin_dashboard():
    """Admin dashboard for user monitoring"""
    # Check if user is admin (email in ADMIN_EMAILS environment variable)
    admin_emails = os.getenv('ADMIN_EMAILS', '').split(',')
    admin_emails = [email.strip().lower() for email in admin_emails if email.strip()]

    if not current_user.email.lower() in admin_emails:
        flash('Access denied. Admin privileges required.', 'error')
        return redirect(url_for('index'))

    # Get search query from URL parameters
    search_query = request.args.get('search', '').strip()
    page = int(request.args.get('page', 1))
    per_page = 20

    # Get admin statistics
    stats = database.get_admin_statistics()

    # Get users list
    offset = (page - 1) * per_page
    users = database.get_all_users(limit=per_page, offset=offset, search_query=search_query if search_query else None)

    return render_template_string(ADMIN_DASHBOARD_HTML, stats=stats, users=users, search_query=search_query, page=page)


@app.route("/admin/verify-user/<user_id>", methods=["POST"])
@login_required
def admin_verify_user(user_id):
    """Manually verify a user (admin action)"""
    # Check if user is admin
    admin_emails = os.getenv('ADMIN_EMAILS', '').split(',')
    admin_emails = [email.strip().lower() for email in admin_emails if email.strip()]

    if not current_user.email.lower() in admin_emails:
        return jsonify({'success': False, 'message': 'Access denied'}), 403

    # Verify user
    success = database.manually_verify_user(user_id)

    if success:
        return jsonify({'success': True, 'message': 'User verified successfully'})
    else:
        return jsonify({'success': False, 'message': 'Failed to verify user'}), 500


@app.route("/pricing")
def pricing():
    """Pricing page with subscription tiers"""
    return render_template_string(PRICING_HTML)


@app.route("/health")
@csrf.exempt  # Health checks don't need CSRF protection
def health_check():
    """Health check endpoint for deployment monitoring"""
    import sys
    health_status = {
        "status": "healthy",
        "service": "gasconsult.ai",
        "version": "1.0.0",
        "python_version": f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}",
        "checks": {
            "openai": bool(os.getenv("OPENAI_API_KEY")),
            "entrez_email": bool(os.getenv("ENTREZ_EMAIL")),
            "entrez_api_key": bool(os.getenv("ENTREZ_API_KEY")),
            "secret_key": bool(app.secret_key)
        }
    }

    # Check if any critical service is missing
    if not all(health_status["checks"].values()):
        health_status["status"] = "degraded"
        return jsonify(health_status), 503

    return jsonify(health_status), 200

@app.route("/api/status")
@csrf.exempt  # Status endpoint doesn't need CSRF protection
def api_status():
    """API status endpoint with basic metrics"""
    return jsonify({
        "status": "operational",
        "endpoints": {
            "chat": "/",
            "preop": "/preop",
            "hypotension": "/hypotension",
            "quick_dose": "/quick-dose",
            "health": "/health",
            "library": "/library",
            "share": "/share"
        },
        "rate_limit": os.getenv("RATE_LIMIT", "60 per minute")
    }), 200

# ====== Chat History API (Phase 3) ======

@app.route("/api/conversations")
@csrf.exempt  # GET endpoint, no state changes
def api_conversations():
    """
    Get list of user's conversations.
    Returns conversations ordered by most recently updated.
    """
    if not DATABASE_INITIALIZED:
        return jsonify({
            'enabled': False,
            'conversations': [],
            'message': 'Database not initialized'
        }), 200

    try:
        # Get pagination parameters
        limit = request.args.get('limit', 50, type=int)
        offset = request.args.get('offset', 0, type=int)

        # Get user's persistent session ID
        user_session_id = session.get('persistent_session_id', 'anonymous')

        # Fetch conversations from database
        conversations = database.get_conversations(
            user_session_id=user_session_id,
            limit=min(limit, 100),  # Cap at 100 for safety
            offset=offset
        )

        # Format timestamps for display
        for conv in conversations:
            # Convert to human-readable format if needed
            if 'updated_at' in conv:
                conv['updated_at_display'] = conv['updated_at']

        return jsonify({
            'enabled': True,
            'conversations': conversations,
            'current_conversation_id': session.get('conversation_id'),
            'count': len(conversations)
        }), 200

    except Exception as e:
        logger.info(f"Error fetching conversations: {e}")
        return jsonify({
            'enabled': True,
            'conversations': [],
            'error': 'Failed to fetch conversations'
        }), 500

@app.route("/load-conversation/<conversation_id>")
def load_conversation(conversation_id):
    """
    Load a previous conversation from database (Phase 4).
    Clears current session and loads messages from database.
    """
    if not DATABASE_INITIALIZED:
        return jsonify({
            'error': 'Database not initialized'
        }), 403

    try:
        # Get conversation from database
        conversation = database.get_conversation(conversation_id)

        if not conversation:
            return jsonify({
                'error': 'Conversation not found'
            }), 404

        # Verify ownership (basic check - will be enhanced with user accounts)
        user_session_id = session.get('persistent_session_id', 'anonymous')
        if conversation.get('user_session_id') != user_session_id:
            return jsonify({
                'error': 'Unauthorized access to conversation'
            }), 403

        # Clear current session safely
        keys_to_clear = [
            'messages',
            'conversation_topic',
            'chat_active',
            'conversation_id'
        ]
        for key in keys_to_clear:
            session.pop(key, None)

        # Clear any stream data keys
        stream_keys = [k for k in session.keys() if k.startswith('stream_data_')]
        for key in stream_keys:
            session.pop(key, None)

        # Load messages from database into session
        messages = conversation.get('messages', [])
        session['messages'] = messages
        session['conversation_id'] = conversation_id
        session['chat_active'] = True
        session.modified = True

        logger.info(f"Loaded conversation {conversation_id} with {len(messages)} messages")

        # Redirect to homepage (will show chat interface with loaded messages)
        return redirect(url_for('index'))

    except Exception as e:
        logger.info(f"Error loading conversation: {e}")
        return jsonify({
            'error': f'Failed to load conversation: {str(e)}'
        }), 500

@app.route("/clear-history", methods=["POST"])
def clear_history():
    """
    Clear all chat history for the current user.
    Deletes all conversations from database and clears session.
    """
    if not DATABASE_INITIALIZED:
        return jsonify({
            'error': 'Database not initialized'
        }), 403

    try:
        # Get user's persistent session ID
        user_session_id = session.get('persistent_session_id', 'anonymous')

        # Get all conversations for this user
        conversations = database.get_conversations(user_session_id, limit=1000)

        # Delete each conversation (soft delete by default)
        deleted_count = 0
        for conv in conversations:
            if database.delete_conversation(conv['id'], hard_delete=False):
                deleted_count += 1

        # Clear current session
        keys_to_clear = [
            'messages',
            'conversation_topic',
            'chat_active',
            'conversation_id'
        ]
        for key in keys_to_clear:
            session.pop(key, None)

        # Clear any stream data keys
        stream_keys = [k for k in session.keys() if k.startswith('stream_data_')]
        for key in stream_keys:
            session.pop(key, None)

        session.modified = True

        logger.info(f"Cleared {deleted_count} conversations for user {user_session_id}")

        return jsonify({
            'success': True,
            'deleted_count': deleted_count,
            'message': f'Cleared {deleted_count} conversations'
        }), 200

    except Exception as e:
        logger.error(f"Error clearing history: {e}")
        return jsonify({
            'error': f'Failed to clear history: {str(e)}'
        }), 500

# ====== Premium Features Routes ======

@app.route("/bookmark", methods=["POST"])
def bookmark_response():
    """Add or remove a bookmark"""
    try:
        data = request.get_json()
        message_index = data.get('message_index')
        action = data.get('action', 'add')  # 'add' or 'remove'

        # Get user session ID
        user_id = session.get('user_id')
        if not user_id:
            user_id = str(uuid.uuid4())
            session['user_id'] = user_id
            session.modified = True

        if user_id not in BOOKMARKS_STORAGE:
            BOOKMARKS_STORAGE[user_id] = []

        messages = session.get('messages', [])

        if message_index < 0 or message_index >= len(messages):
            return jsonify({'error': 'Invalid message index'}), 400

        # Get the query (previous user message) and response (assistant message)
        query = messages[message_index - 1]['content'] if message_index > 0 else 'Direct query'
        response_msg = messages[message_index]

        if action == 'add':
            bookmark = {
                'id': str(uuid.uuid4()),
                'query': query,
                'answer': response_msg['content'],
                'references': response_msg.get('references', []),
                'num_papers': response_msg.get('num_papers', 0),
                'timestamp': datetime.now().isoformat(),
                'message_index': message_index
            }
            BOOKMARKS_STORAGE[user_id].append(bookmark)
            return jsonify({'success': True, 'action': 'added', 'bookmark_id': bookmark['id']})
        elif action == 'remove':
            bookmark_id = data.get('bookmark_id')
            BOOKMARKS_STORAGE[user_id] = [b for b in BOOKMARKS_STORAGE[user_id] if b['id'] != bookmark_id]
            return jsonify({'success': True, 'action': 'removed'})

    except Exception as e:
        logger.error(f"Bookmark error: {str(e)}")
        return jsonify({'error': str(e)}), 500

@app.route("/library")
@login_required
def library():
    """View all bookmarked responses"""
    # Use current_user.id for authenticated users
    user_id = current_user.id if current_user.is_authenticated else None

    if not user_id:
        flash('Please log in to view your library', 'info')
        return redirect(url_for('login'))

    bookmarks = BOOKMARKS_STORAGE.get(user_id, [])

    # Sort by timestamp (newest first)
    bookmarks = sorted(bookmarks, key=lambda x: x['timestamp'], reverse=True)

    return render_template_string(LIBRARY_HTML, bookmarks=bookmarks)

@app.route("/save-to-library", methods=["POST"])
def save_to_library():
    """Save a chat response to user's library"""
    try:
        # Check if user is authenticated
        if not current_user.is_authenticated:
            return jsonify({'error': 'You must be logged in to save to library'}), 401

        data = request.get_json()
        message_index = data.get('message_index')

        messages = session.get('messages', [])

        # Validate message index
        if message_index is None or message_index < 0 or message_index >= len(messages):
            return jsonify({'error': 'Invalid message index'}), 400

        # Get the AI message
        ai_message = messages[message_index]

        # Get the corresponding user query (previous message)
        query = messages[message_index - 1]['content'] if message_index > 0 else 'Direct query'

        # Generate unique bookmark ID
        bookmark_id = str(uuid.uuid4())

        # Create bookmark object
        bookmark = {
            'id': bookmark_id,
            'query': query,
            'answer': ai_message.get('content', ''),
            'references': ai_message.get('references', []),
            'num_papers': ai_message.get('num_papers', 0),
            'evidence_strength': ai_message.get('evidence_strength'),
            'timestamp': datetime.now().isoformat()
        }

        # Get user ID from current_user
        user_id = current_user.id

        if not user_id:
            return jsonify({'error': 'User not found'}), 401

        # Initialize user's bookmarks if not exists
        if user_id not in BOOKMARKS_STORAGE:
            BOOKMARKS_STORAGE[user_id] = []

        # Check if already saved (by comparing query and answer content)
        existing = any(
            b['query'] == query and b['answer'] == bookmark['answer']
            for b in BOOKMARKS_STORAGE[user_id]
        )

        if existing:
            return jsonify({
                'success': True,
                'message': 'Already saved to library',
                'already_saved': True
            })

        # Add to library
        BOOKMARKS_STORAGE[user_id].append(bookmark)

        logger.info(f"User {user_id} saved message to library: {bookmark_id}")

        return jsonify({
            'success': True,
            'message': 'Saved to library',
            'bookmark_id': bookmark_id
        })

    except Exception as e:
        logger.error(f"Error saving to library: {str(e)}")
        return jsonify({'error': f'Failed to save: {str(e)}'}), 500

@app.route("/share", methods=["POST"])
def create_share_link():
    """Create a shareable link for a response"""
    try:
        data = request.get_json()
        message_index = data.get('message_index')

        messages = session.get('messages', [])

        if message_index < 0 or message_index >= len(messages):
            return jsonify({'error': 'Invalid message index'}), 400

        query = messages[message_index - 1]['content'] if message_index > 0 else 'Direct query'
        response_msg = messages[message_index]

        # Generate unique share ID
        share_id = str(uuid.uuid4())[:8]

        # Store shared response (expires in 30 days)
        SHARED_LINKS_STORAGE[share_id] = {
            'query': query,
            'answer': response_msg['content'],
            'references': response_msg.get('references', []),
            'num_papers': response_msg.get('num_papers', 0),
            'timestamp': datetime.now().isoformat(),
            'expires': (datetime.now() + timedelta(days=30)).isoformat()
        }

        share_url = f"{request.host_url}r/{share_id}"
        return jsonify({'success': True, 'share_url': share_url, 'share_id': share_id})

    except Exception as e:
        logger.error(f"Share link error: {str(e)}")
        return jsonify({'error': str(e)}), 500

@app.route("/r/<share_id>")
@csrf.exempt
def view_shared_response(share_id):
    """View a shared response"""
    shared_data = SHARED_LINKS_STORAGE.get(share_id)

    if not shared_data:
        return "Shared link not found or expired", 404

    # Check if expired
    expires = datetime.fromisoformat(shared_data['expires'])
    if datetime.now() > expires:
        del SHARED_LINKS_STORAGE[share_id]
        return "Shared link has expired", 410

    return render_template_string(SHARED_RESPONSE_HTML, data=shared_data, share_id=share_id)

@app.route("/export-citations/<format_type>", methods=["POST"])
def export_citations(format_type):
    """Export citations in BibTeX or RIS format"""
    try:
        data = request.get_json()
        message_index = data.get('message_index')

        messages = session.get('messages', [])

        if message_index < 0 or message_index >= len(messages):
            return jsonify({'error': 'Invalid message index'}), 400

        response_msg = messages[message_index]
        references = response_msg.get('references', [])

        if not references:
            return jsonify({'error': 'No references to export'}), 400

        if format_type == 'bibtex':
            content = generate_bibtex(references)
            filename = 'gasconsult_citations.bib'
            mimetype = 'application/x-bibtex'
        elif format_type == 'ris':
            content = generate_ris(references)
            filename = 'gasconsult_citations.ris'
            mimetype = 'application/x-research-info-systems'
        else:
            return jsonify({'error': 'Invalid format'}), 400

        from flask import make_response
        response = make_response(content)
        response.headers['Content-Type'] = mimetype
        response.headers['Content-Disposition'] = f'attachment; filename={filename}'
        return response

    except Exception as e:
        logger.error(f"Export error: {str(e)}")
        return jsonify({'error': str(e)}), 500

@app.route("/generate-followups", methods=["POST"])
def generate_followup_questions():
    """Generate smart follow-up questions based on the current conversation"""
    try:
        data = request.get_json()
        message_index = data.get('message_index')

        messages = session.get('messages', [])

        if message_index < 0 or message_index >= len(messages):
            return jsonify({'error': 'Invalid message index'}), 400

        query = messages[message_index - 1]['content'] if message_index > 0 else ''
        response = messages[message_index]['content']

        # Use GPT to generate contextual follow-up questions
        prompt = f"""Based on this clinical question and answer, generate 3 smart follow-up questions that a clinician might want to ask next.

Question: {query}

Answer: {response[:500]}...

Generate exactly 3 concise follow-up questions (one per line, no numbering) that explore:
1. A related contraindication or safety concern
2. A comparison with an alternative approach
3. A practical implementation detail or dosing question

Keep each question under 60 characters."""

        completion = openai_client.chat.completions.create(
            model="gpt-4o",
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3,
            max_tokens=200
        )

        followups_text = completion.choices[0].message.content.strip()
        followups = [q.strip() for q in followups_text.split('\n') if q.strip() and not q.strip()[0].isdigit()][:3]

        return jsonify({'success': True, 'followups': followups})

    except Exception as e:
        logger.error(f"Generate followups error: {str(e)}")
        return jsonify({'error': str(e)}), 500

# ====== Authentication & Pricing Templates ======

LOGIN_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasConsult.ai - Login</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;

            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: rgba(37, 99, 235, 0.08);

            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;

            --input-bg: rgba(255, 255, 255, 0.7);
            --input-border: rgba(203, 213, 225, 0.8);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            background: linear-gradient(145deg, #f0f7ff 0%, #f8fafc 50%, #f0f4f8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .glow {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
        }

        .glow-1 {
            width: 500px;
            height: 500px;
            background: rgba(59, 130, 246, 0.25);
            top: -150px;
            right: -100px;
        }

        .glow-2 {
            width: 400px;
            height: 400px;
            background: rgba(37, 99, 235, 0.2);
            bottom: -100px;
            left: -50px;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            box-shadow:
                0 8px 32px var(--glass-shadow),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 36px 28px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .auth-card:hover {
            transform: translateY(-4px);
            box-shadow:
                0 16px 48px rgba(37, 99, 235, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .logo-dots {
            display: flex;
            align-items: center;
            position: relative;
            width: 48px;
            height: 20px;
        }

        .logo-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
        }

        .logo-dot-1 {
            background: #2563eb;
            left: 0;
            z-index: 3;
        }

        .logo-dot-2 {
            background: rgba(37, 99, 235, 0.5);
            left: 14px;
            z-index: 2;
        }

        .logo-dot-3 {
            background: rgba(37, 99, 235, 0.25);
            left: 28px;
            z-index: 1;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-title {
            font-family: 'Sora', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-subtitle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .auth-subtitle a:hover {
            color: var(--primary-dark);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 14px;
            outline: none;
            transition: all 0.25s ease;
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-light);
            box-shadow:
                0 0 0 4px rgba(37, 99, 235, 0.1),
                0 4px 12px rgba(37, 99, 235, 0.06);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper .form-input {
            padding-right: 48px;
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .toggle-password:hover {
            color: var(--text-secondary);
        }

        .forgot-link {
            text-align: right;
            margin-top: -8px;
        }

        .forgot-link a {
            font-size: 13px;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .forgot-link a:hover {
            color: var(--primary);
        }

        .submit-btn {
            width: 100%;
            padding: 16px 24px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: var(--primary);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.25);
            margin-top: 8px;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 8px 0;
        }

        .divider-line {
            flex: 1;
            height: 1px;
            background: var(--input-border);
        }

        .divider-text {
            font-size: 12px;
            color: var(--text-muted);
        }

        .social-buttons {
            display: flex;
            gap: 12px;
        }

        .social-btn {
            flex: 1;
            padding: 12px 16px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.25s ease;
        }

        .social-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--text-muted);
            transform: translateY(-2px);
        }

        .social-btn svg {
            width: 18px;
            height: 18px;
        }

        .back-link {
            text-align: center;
            margin-top: 24px;
        }

        .back-link a {
            font-size: 14px;
            color: var(--text-muted);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .back-link a:hover {
            color: var(--primary);
        }

        .back-link a svg {
            transition: transform 0.2s ease;
        }

        .back-link a:hover svg {
            transform: translateX(-4px);
        }

        .flash-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .flash-error {
            background: #FEF2F2;
            color: #B91C1C;
            border: 1px solid #FEE2E2;
        }

        .flash-success {
            background: #ECFDF5;
            color: #047857;
            border: 1px solid #D1FAE5;
        }

        .flash-info {
            background: #EFF6FF;
            color: #1E40AF;
            border: 1px solid #DBEAFE;
        }

        @media (min-width: 481px) {
            .auth-card {
                padding: 48px 40px;
                border-radius: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-glow">
        <div class="glow glow-1"></div>
        <div class="glow glow-2"></div>
    </div>

    <div class="auth-card">
        <div class="logo">
            <div class="logo-dots">
                <div class="logo-dot logo-dot-1"></div>
                <div class="logo-dot logo-dot-2"></div>
                <div class="logo-dot logo-dot-3"></div>
            </div>
        </div>

        <div class="auth-header">
            <h1 class="auth-title">Welcome back</h1>
            <p class="auth-subtitle">Don't have an account? <a href="/register">Sign up</a></p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form class="auth-form" method="POST" action="/login">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-input" placeholder="you@example.com" required autofocus>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="input-wrapper">
                    <input type="password" name="password" class="form-input" placeholder="••••••••" required>
                    <button type="button" class="toggle-password" onclick="togglePassword(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="forgot-link">
                <a href="#">Forgot password?</a>
            </div>

            <button type="submit" class="submit-btn">Log In</button>

            <div class="divider">
                <div class="divider-line"></div>
                <span class="divider-text">or</span>
                <div class="divider-line"></div>
            </div>

            <div class="social-buttons">
                <a href="/auth/google" class="social-btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google
                </a>
                <a href="/auth/apple" class="social-btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="#000">
                        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                    </svg>
                    Apple
                </a>
            </div>
        </form>

        <div class="back-link">
            <a href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back to Home
            </a>
        </div>
    </div>

    <script>
        function togglePassword(button) {
            const input = button.parentElement.querySelector('input');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);

            button.innerHTML = type === 'password'
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>`;
        }
    </script>
</body>
</html>
"""

REGISTER_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasConsult.ai - Sign Up</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;

            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: rgba(37, 99, 235, 0.08);

            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;

            --input-bg: rgba(255, 255, 255, 0.7);
            --input-border: rgba(203, 213, 225, 0.8);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            background: linear-gradient(145deg, #f0f7ff 0%, #f8fafc 50%, #f0f4f8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .glow {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
        }

        .glow-1 {
            width: 500px;
            height: 500px;
            background: rgba(59, 130, 246, 0.25);
            top: -150px;
            right: -100px;
        }

        .glow-2 {
            width: 400px;
            height: 400px;
            background: rgba(37, 99, 235, 0.2);
            bottom: -100px;
            left: -50px;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            box-shadow:
                0 8px 32px var(--glass-shadow),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 36px 28px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .auth-card:hover {
            transform: translateY(-4px);
            box-shadow:
                0 16px 48px rgba(37, 99, 235, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .logo-dots {
            display: flex;
            align-items: center;
            position: relative;
            width: 48px;
            height: 20px;
        }

        .logo-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
        }

        .logo-dot-1 {
            background: #2563eb;
            left: 0;
            z-index: 3;
        }

        .logo-dot-2 {
            background: rgba(37, 99, 235, 0.5);
            left: 14px;
            z-index: 2;
        }

        .logo-dot-3 {
            background: rgba(37, 99, 235, 0.25);
            left: 28px;
            z-index: 1;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-title {
            font-family: 'Sora', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-subtitle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .auth-subtitle a:hover {
            color: var(--primary-dark);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .optional-tag {
            font-size: 11px;
            font-weight: 400;
            color: var(--text-muted);
            background: rgba(148, 163, 184, 0.15);
            padding: 2px 8px;
            border-radius: 12px;
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 14px;
            outline: none;
            transition: all 0.25s ease;
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-light);
            box-shadow:
                0 0 0 4px rgba(37, 99, 235, 0.1),
                0 4px 12px rgba(37, 99, 235, 0.06);
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper .form-input {
            padding-right: 48px;
        }

        .toggle-password {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s ease;
        }

        .toggle-password:hover {
            color: var(--text-secondary);
        }

        .submit-btn {
            width: 100%;
            padding: 16px 24px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: var(--primary);
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.25);
            margin-top: 8px;
        }

        .submit-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 8px 0;
        }

        .divider-line {
            flex: 1;
            height: 1px;
            background: var(--input-border);
        }

        .divider-text {
            font-size: 12px;
            color: var(--text-muted);
        }

        .social-buttons {
            display: flex;
            gap: 12px;
        }

        .social-btn {
            flex: 1;
            padding: 12px 16px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.25s ease;
        }

        .social-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--text-muted);
            transform: translateY(-2px);
        }

        .social-btn svg {
            width: 18px;
            height: 18px;
        }

        .back-link {
            text-align: center;
            margin-top: 24px;
        }

        .back-link a {
            font-size: 14px;
            color: var(--text-muted);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .back-link a:hover {
            color: var(--primary);
        }

        .back-link a svg {
            transition: transform 0.2s ease;
        }

        .back-link a:hover svg {
            transform: translateX(-4px);
        }

        .flash-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .flash-error {
            background: #FEF2F2;
            color: #B91C1C;
            border: 1px solid #FEE2E2;
        }

        .flash-success {
            background: #ECFDF5;
            color: #047857;
            border: 1px solid #D1FAE5;
        }

        .flash-info {
            background: #EFF6FF;
            color: #1E40AF;
            border: 1px solid #DBEAFE;
        }

        @media (min-width: 481px) {
            .auth-card {
                padding: 48px 40px;
                border-radius: 32px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-glow">
        <div class="glow glow-1"></div>
        <div class="glow glow-2"></div>
    </div>

    <div class="auth-card">
        <div class="logo">
            <div class="logo-dots">
                <div class="logo-dot logo-dot-1"></div>
                <div class="logo-dot logo-dot-2"></div>
                <div class="logo-dot logo-dot-3"></div>
            </div>
        </div>

        <div class="auth-header">
            <h1 class="auth-title">Create Account</h1>
            <p class="auth-subtitle">Already have an account? <a href="/login">Log in</a></p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form class="auth-form" method="POST" action="/register">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label class="form-label">Full Name</label>
                <input type="text" name="full_name" class="form-input" placeholder="Dr. Jane Smith" required>
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-input" placeholder="you@example.com" required autofocus>
            </div>

            <div class="form-group">
                <label class="form-label">Password</label>
                <div class="input-wrapper">
                    <input type="password" name="password" class="form-input" placeholder="••••••••" required minlength="8">
                    <button type="button" class="toggle-password" onclick="togglePassword(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>
            </div>

            <button type="submit" class="submit-btn">Create Account</button>

            <div class="divider">
                <div class="divider-line"></div>
                <span class="divider-text">or</span>
                <div class="divider-line"></div>
            </div>

            <div class="social-buttons">
                <a href="/auth/google" class="social-btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google
                </a>
                <a href="/auth/apple" class="social-btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="#000">
                        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                    </svg>
                    Apple
                </a>
            </div>
        </form>

        <div class="back-link">
            <a href="/">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back to Home
            </a>
        </div>
    </div>

    <script>
        function togglePassword(button) {
            const input = button.parentElement.querySelector('input');
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);

            button.innerHTML = type === 'password'
                ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>`;
        }
    </script>
</body>
</html>
"""

RESEND_VERIFICATION_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasConsult.ai - Resend Verification</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --primary-dark: #1d4ed8;

            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: rgba(37, 99, 235, 0.08);

            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;

            --input-bg: rgba(255, 255, 255, 0.7);
            --input-border: rgba(203, 213, 225, 0.8);
        }

        body {
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            background: linear-gradient(145deg, #f0f7ff 0%, #f8fafc 50%, #f0f4f8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            position: relative;
            overflow-x: hidden;
        }

        .bg-glow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .glow {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.3;
        }

        .glow-1 {
            width: 500px;
            height: 500px;
            background: rgba(59, 130, 246, 0.25);
            top: -150px;
            right: -100px;
        }

        .glow-2 {
            width: 400px;
            height: 400px;
            background: rgba(37, 99, 235, 0.2);
            bottom: -100px;
            left: -50px;
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 32px;
            border: 1px solid var(--glass-border);
            box-shadow:
                0 8px 32px var(--glass-shadow),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            padding: 48px 40px;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .auth-card:hover {
            transform: translateY(-4px);
            box-shadow:
                0 16px 48px rgba(37, 99, 235, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .logo-dots {
            display: flex;
            align-items: center;
            position: relative;
            width: 48px;
            height: 20px;
        }

        .logo-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            position: absolute;
        }

        .logo-dot-1 {
            background: #2563eb;
            left: 0;
            z-index: 3;
        }

        .logo-dot-2 {
            background: rgba(37, 99, 235, 0.5);
            left: 14px;
            z-index: 2;
        }

        .logo-dot-3 {
            background: rgba(37, 99, 235, 0.25);
            left: 28px;
            z-index: 1;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-title {
            font-family: 'Sora', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .auth-subtitle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .auth-subtitle a:hover {
            color: var(--primary-dark);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 14px 18px;
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 14px;
            transition: all 0.25s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            font-family: 'Sora', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border: none;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .back-link {
            text-align: center;
            margin-top: 24px;
        }

        .back-link a {
            font-size: 14px;
            color: var(--text-muted);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s ease;
        }

        .back-link a:hover {
            color: var(--primary);
        }

        .back-link a svg {
            transition: transform 0.2s ease;
        }

        .back-link a:hover svg {
            transform: translateX(-4px);
        }

        .flash-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .flash-error {
            background: #FEF2F2;
            color: #B91C1C;
            border: 1px solid #FEE2E2;
        }

        .flash-success {
            background: #ECFDF5;
            color: #047857;
            border: 1px solid #D1FAE5;
        }

        .flash-info {
            background: #EFF6FF;
            color: #1E40AF;
            border: 1px solid #DBEAFE;
        }

        .flash-warning {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #FDE68A;
        }

        @media (max-width: 480px) {
            .auth-card {
                padding: 36px 28px;
                border-radius: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-glow">
        <div class="glow glow-1"></div>
        <div class="glow glow-2"></div>
    </div>

    <div class="auth-card">
        <div class="logo">
            <div class="logo-dots">
                <div class="logo-dot logo-dot-1"></div>
                <div class="logo-dot logo-dot-2"></div>
                <div class="logo-dot logo-dot-3"></div>
            </div>
        </div>

        <div class="auth-header">
            <h1 class="auth-title">Resend Verification</h1>
            <p class="auth-subtitle">Enter your email to receive a new verification link</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form class="auth-form" method="POST" action="/resend-verification">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-input" placeholder="you@example.com" required autofocus>
            </div>

            <button type="submit" class="btn-primary">Resend Verification Email</button>
        </form>

        <div class="back-link">
            <a href="/login">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Login
            </a>
        </div>
    </div>
</body>
</html>
"""

ADMIN_DASHBOARD_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GasConsult.ai</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
            --red-50: #FEF2F2;
            --red-500: #EF4444;
            --red-600: #DC2626;
            --green-50: #F0FDF4;
            --green-500: #10B981;
            --orange-50: #FFF7ED;
            --orange-500: #F59E0B;
            --purple-50: #FAF5FF;
            --purple-500: #A855F7;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.5;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.12) 0%, transparent 70%);
            top: -15%;
            right: -20%;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.15) 0%, transparent 70%);
            bottom: -10%;
            left: -15%;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 12px 16px;
            margin-bottom: 24px;
        }

        .header-inner {
            max-width: 1280px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: var(--gray-900); }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .admin-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: linear-gradient(135deg, var(--red-500), var(--red-600));
            color: white;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .btn-back {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .btn-back:hover {
            color: var(--gray-900);
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* Container */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 24px 80px;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.8px;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .page-subtitle {
            font-size: 15px;
            color: var(--gray-500);
            font-weight: 400;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 2px 8px rgba(0,0,0,0.03);
            transition: all 0.25s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.04);
        }

        .stat-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .stat-icon.blue { background: linear-gradient(135deg, var(--blue-500), var(--blue-600)); }
        .stat-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
        .stat-icon.orange { background: linear-gradient(135deg, var(--orange-500), #d97706); }
        .stat-icon.purple { background: linear-gradient(135deg, var(--purple-500), #9333ea); }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
            color: var(--gray-900);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-change {
            font-size: 13px;
            color: var(--gray-400);
            font-weight: 500;
        }

        /* Card */
        .card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 2px 8px rgba(0,0,0,0.03);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
            color: var(--gray-900);
        }

        /* Search */
        .search-box {
            position: relative;
            flex: 1;
            max-width: 320px;
            min-width: 240px;
        }

        .search-input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 400;
            color: var(--gray-900);
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            outline: none;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--blue-500);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.08);
        }

        .search-input::placeholder {
            color: var(--gray-400);
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--gray-400);
            pointer-events: none;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
        }

        thead {
            background: var(--gray-50);
        }

        th {
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-bottom: 1px solid var(--gray-200);
        }

        th:first-child { border-radius: 12px 0 0 0; }
        th:last-child { border-radius: 0 12px 0 0; }

        tbody tr {
            transition: background-color 0.15s ease;
        }

        tbody tr:hover {
            background: var(--gray-50);
        }

        tbody tr:last-child td:first-child { border-radius: 0 0 0 12px; }
        tbody tr:last-child td:last-child { border-radius: 0 0 12px 0; }

        td {
            padding: 14px 16px;
            font-size: 14px;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-100);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .user-email {
            font-weight: 600;
            color: var(--gray-900);
        }

        .user-name {
            font-size: 13px;
            color: var(--gray-500);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge svg {
            width: 12px;
            height: 12px;
        }

        .badge-verified {
            background: var(--green-50);
            color: #047857;
        }

        .badge-unverified {
            background: var(--red-50);
            color: #b91c1c;
        }

        .badge-free {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .badge-pro {
            background: var(--blue-50);
            color: var(--blue-700);
        }

        .badge-team {
            background: var(--purple-50);
            color: #7e22ce;
        }

        /* Buttons */
        .btn-action {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), var(--blue-700));
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-action:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
        }

        .btn-action:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-text {
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-500);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            width: 56px;
            height: 56px;
            margin: 0 auto 16px;
            color: var(--gray-300);
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .empty-state-text {
            font-size: 14px;
            color: var(--gray-500);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-inner {
                padding: 0 16px;
            }

            .container {
                padding: 0 16px 60px;
            }

            .page-title {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px 16px;
            }

            .card-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .table-wrapper {
                overflow-x: scroll;
            }

            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>
    <div class="grain"></div>

    <div class="page">
        <div class="header">
            <div class="header-inner">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <div class="logo-text">
                        <span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span>
                    </div>
                    <span class="admin-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" style="width: 12px; height: 12px;">
                            <path fill-rule="evenodd" d="M9.661 2.237a.531.531 0 01.678 0 11.947 11.947 0 007.078 2.749.5.5 0 01.479.425c.069.52.104 1.05.104 1.59 0 5.162-3.26 9.563-7.834 11.256a.48.48 0 01-.332 0C5.26 16.564 2 12.163 2 7c0-.538.035-1.069.104-1.589a.5.5 0 01.48-.425 11.947 11.947 0 007.077-2.75z" clip-rule="evenodd" />
                        </svg>
                        Admin
                    </span>
                </a>
                <a href="/" class="btn-back">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back
                </a>
            </div>
        </div>

        <div class="container">
            <div class="page-header">
                <h1 class="page-title">User Monitoring</h1>
                <p class="page-subtitle">Monitor registered users and platform activity</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon blue">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value">{{ stats.total_users }}</div>
                    <div class="stat-change">+{{ stats.new_users_24h }} in last 24 hours</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon green">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-label">Verified</div>
                    <div class="stat-value">{{ stats.verified_users }}</div>
                    <div class="stat-change">{{ ((stats.verified_users / stats.total_users * 100) if stats.total_users > 0 else 0)|round(1) }}% of total users</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon orange">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value">{{ stats.unverified_users }}</div>
                    <div class="stat-change">Awaiting verification</div>
                </div>

                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon purple">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                    </div>
                    <div class="stat-label">This Month</div>
                    <div class="stat-value">{{ stats.new_users_30d }}</div>
                    <div class="stat-change">+{{ stats.new_users_7d }} this week</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Users</h2>
                    <form class="search-box" method="GET" action="/admin">
                        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <input
                            type="text"
                            name="search"
                            class="search-input"
                            placeholder="Search by email or name..."
                            value="{{ search_query }}"
                        >
                    </form>
                </div>

                {% if users %}
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Plan</th>
                                <th>Registered</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}">
                                <td>
                                    <div class="user-info">
                                        <span class="user-email">{{ user.email }}</span>
                                        {% if user.full_name %}
                                        <span class="user-name">{{ user.full_name }}</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if user.is_verified %}
                                    <span class="badge badge-verified">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                        Verified
                                    </span>
                                    {% else %}
                                    <span class="badge badge-unverified">Unverified</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-{{ user.subscription_tier }}">{{ user.subscription_tier|capitalize }}</span>
                                </td>
                                <td>
                                    <span class="date-text">{{ user.created_at[:10] }}</span>
                                </td>
                                <td>
                                    <span class="date-text">{{ user.last_login[:10] if user.last_login else 'Never' }}</span>
                                </td>
                                <td>
                                    {% if not user.is_verified %}
                                    <button class="btn-action" onclick="verifyUser('{{ user.id }}')">
                                        Verify
                                    </button>
                                    {% else %}
                                    <span style="color: var(--gray-300); font-size: 13px;">—</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <div class="empty-state-title">No users found</div>
                    <div class="empty-state-text">{% if search_query %}Try a different search term{% else %}No registered users yet{% endif %}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        async function verifyUser(userId) {
            const row = document.querySelector(`tr[data-user-id="${userId}"]`);
            const btn = row.querySelector('.btn-action');
            const originalText = btn.textContent;

            btn.disabled = true;
            btn.textContent = 'Verifying...';

            try {
                const response = await fetch(`/admin/verify-user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    const statusCell = row.children[1];
                    statusCell.innerHTML = `
                        <span class="badge badge-verified">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            Verified
                        </span>
                    `;

                    const actionCell = row.children[5];
                    actionCell.innerHTML = '<span style="color: var(--gray-300); font-size: 13px;">—</span>';

                    alert('✓ User verified successfully');
                } else {
                    alert('Failed to verify user: ' + data.message);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                alert('Error verifying user: ' + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Debounced search
        let searchTimeout;
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.form.submit();
                }, 500);
            });
        }
    </script>
</body>
</html>
"""

PRICING_HTML = """<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing - GasConsult.ai</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg?v=6">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --white: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
            --blue-50: #EFF6FF;
            --blue-100: #DBEAFE;
            --blue-200: #BFDBFE;
            --blue-300: #93C5FD;
            --blue-400: #60A5FA;
            --blue-500: #3B82F6;
            --blue-600: #2563EB;
            --blue-700: #1D4ED8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Canvas */
        .bg-canvas {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: linear-gradient(180deg, #F0F7FF 0%, var(--gray-50) 50%, #FAFBFF 100%);
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.15) 0%, transparent 70%);
            top: -15%;
            left: -20%;
        }

        .orb-2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(147, 197, 253, 0.2) 0%, transparent 70%);
            top: 30%;
            right: -20%;
            animation-delay: -7s;
            animation-duration: 25s;
        }

        .orb-3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            bottom: -10%;
            left: 20%;
            animation-delay: -14s;
            animation-duration: 30s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -40px) scale(1.05); }
            50% { transform: translate(20px, 40px) scale(0.95); }
            75% { transform: translate(-40px, 20px) scale(1.02); }
        }

        .grain {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        .page {
            position: relative;
            z-index: 2;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Navigation */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 12px 16px;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            height: 56px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02), 0 4px 16px rgba(0,0,0,0.04), 0 12px 48px rgba(0,0,0,0.03);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
        }

        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg { width: 36px; height: 12px; }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .logo-text .gas { color: var(--blue-600); }
        .logo-text .consult { color: #0F172A; }
        .logo-text .ai { color: rgba(15, 23, 42, 0.4); }

        .nav-links {
            display: none;
            align-items: center;
            gap: 4px;
        }

        .nav-link {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-link.active {
            color: var(--blue-600);
            background: var(--blue-50);
        }

        .nav-dropdown {
            position: relative;
            display: inline-block;
        }

        .nav-dropdown-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-family: inherit;
        }

        .nav-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            margin-top: 4px;
            z-index: 1000;
            overflow: hidden;
        }

        .nav-dropdown-menu.show {
            display: block;
        }

        .nav-dropdown-link {
            display: block;
            padding: 12px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .nav-dropdown-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        .nav-btn-primary {
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .user-dropdown-menu {
            min-width: 240px;
        }

        .user-dropdown-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        .user-dropdown-email {
            font-size: 13px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .user-dropdown-tier {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--blue-600);
        }

        .nav-dropdown-divider {
            height: 1px;
            background: var(--gray-200);
            margin: 4px 0;
        }

        .nav-dropdown-link svg {
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .mobile-menu-btn {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
        }

        .mobile-menu-btn span {
            display: block;
            width: 22px;
            height: 2px;
            background: var(--gray-700);
            border-radius: 1px;
            transition: all 0.3s ease;
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 80px;
            left: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 12px 48px rgba(0,0,0,0.12);
            z-index: 99;
            flex-direction: column;
            gap: 4px;
        }

        .mobile-menu.active { display: flex; }

        .mobile-menu-link {
            padding: 14px 16px;
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-700);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .mobile-menu-link:hover {
            color: var(--gray-900);
            background: rgba(0,0,0,0.04);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 88px 16px 48px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Pricing Section */
        .pricing-header {
            text-align: center;
            margin-bottom: 56px;
        }

        .pricing-title {
            font-size: 42px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 16px;
            letter-spacing: -1px;
        }

        .pricing-subtitle {
            font-size: 18px;
            color: var(--gray-500);
            max-width: 600px;
            margin: 0 auto;
        }

        .pricing-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .pricing-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 24px;
            padding: 40px 32px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.04), 0 8px 32px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }

        .pricing-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.08), 0 16px 48px rgba(0,0,0,0.10);
        }

        .pricing-card.featured {
            border: 2px solid var(--blue-600);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.1), 0 8px 32px rgba(37, 99, 235, 0.15);
        }

        .pricing-card.featured:hover {
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.15), 0 16px 48px rgba(37, 99, 235, 0.20);
        }

        .pricing-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .pricing-tier {
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-500);
            margin-bottom: 12px;
        }

        .featured .pricing-tier {
            color: var(--blue-600);
        }

        .pricing-price {
            font-size: 56px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 8px;
            line-height: 1;
        }

        .pricing-price span {
            font-size: 20px;
            font-weight: 500;
            color: var(--gray-500);
        }

        .pricing-period {
            font-size: 14px;
            color: var(--gray-500);
            margin-bottom: 32px;
            min-height: 20px;
        }

        .pricing-features {
            list-style: none;
            margin-bottom: 32px;
        }

        .pricing-features li {
            padding: 12px 0;
            font-size: 15px;
            color: var(--gray-600);
            display: flex;
            align-items: start;
            gap: 12px;
        }

        .pricing-features li:before {
            content: '✓';
            color: #10B981;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .btn-pricing {
            width: 100%;
            padding: 16px 24px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s ease;
            text-decoration: none;
            display: block;
            text-align: center;
            border: none;
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-900);
            border: 1px solid var(--gray-200);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .btn-primary-pricing {
            background: linear-gradient(135deg, var(--blue-600), #1D4ED8);
            color: white;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.25);
        }

        .btn-primary-pricing:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.35);
        }

        /* Footer */
        .footer {
            padding: 32px 20px;
            border-top: 1px solid var(--gray-200);
            background: rgba(255,255,255,0.5);
        }

        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            text-align: center;
        }

        .footer-text {
            font-size: 13px;
            color: var(--gray-500);
        }

        .social-icons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .social-icon {
            color: var(--gray-500);
            transition: color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .social-icon:hover {
            color: var(--gray-700);
            transform: translateY(-2px);
        }

        .social-icon svg {
            width: 24px;
            height: 24px;
        }

        .footer-links {
            display: flex;
            gap: 24px;
        }

        .footer-link {
            font-size: 13px;
            color: var(--gray-500);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .footer-link:hover {
            color: var(--gray-700);
        }

        @media (min-width: 768px) {
            .nav { padding: 16px 32px; }
            .nav-inner { height: 64px; padding: 0 24px; border-radius: 20px; }
            .logo-icon svg { width: 42px; height: 15px; }
            .logo-text { font-size: 20px; }
            .nav-links { display: flex; }
            .mobile-menu-btn { display: none; }

            .main-content { padding: 108px 32px 48px; }
            .pricing-title { font-size: 52px; }
            .pricing-grid { grid-template-columns: repeat(3, 1fr); }

            .footer { padding: 40px 32px; }
            .footer-inner { flex-direction: row; justify-content: space-between; text-align: left; }
            .footer-text { font-size: 14px; }
            .footer-links { gap: 32px; }
            .footer-link { font-size: 14px; }
        }

        @media (min-width: 1024px) {
            .nav { padding: 16px 40px; }
            .main-content { max-width: 1200px; }
        }
    </style>
</head>
<body>
    <!-- Background Canvas -->
    <div class="bg-canvas">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>
    <div class="grain"></div>

    <!-- Page Content -->
    <div class="page">
        <nav class="nav" role="navigation" aria-label="Main navigation">
            <div class="nav-inner">
                <a href="/?clear=1" class="logo" aria-label="GasConsult.ai home">
                    <div class="logo-icon">
                        <svg width="36" height="12" viewBox="0 0 52 18" fill="none">
                            <circle cx="9" cy="9" r="9" fill="#2563EB"/>
                            <circle cx="21" cy="9" r="9" fill="#2563EB" fill-opacity="0.5"/>
                            <circle cx="33" cy="9" r="9" fill="#2563EB" fill-opacity="0.2"/>
                        </svg>
                    </div>
                    <span class="logo-text"><span class="gas">gas</span><span class="consult">consult</span><span class="ai">.ai</span></span>
                </a>
                <div class="nav-links">
                    <a href="/?clear=1" class="nav-link">Home</a>
                    <a href="/quick-dose" class="nav-link">Quick Dose</a>
                    <a href="/preop" class="nav-link">Pre-Op</a>
                    <a href="/calculators" class="nav-link">Clinical Calculators</a>
                    <div class="nav-dropdown">
                        <button class="nav-link nav-dropdown-toggle" onclick="toggleNavDropdown(event)">More ▼</button>
                        <div class="nav-dropdown-menu">
                            <a href="/crisis" class="nav-dropdown-link">Crisis Protocols</a>
                            <a href="/hypotension" class="nav-dropdown-link">IOH Predictor</a>
                            <a href="/difficult-airway" class="nav-dropdown-link">Difficult Airway</a>
                            <a href="/informed-consent" class="nav-dropdown-link">Informed Consent</a>
                        </div>
                    </div>
                    <a href="/pricing" class="nav-link active">Plans</a>
                    {{ generate_navbar_html()|safe }}
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
        <div class="mobile-menu" id="mobileMenu">
            <a href="/?clear=1" class="mobile-menu-link">Home</a>
            <a href="/quick-dose" class="mobile-menu-link">Quick Dose</a>
            <a href="/preop" class="mobile-menu-link">Pre-Op</a>
            <a href="/calculators" class="mobile-menu-link">Clinical Calculators</a>
            <a href="/crisis" class="mobile-menu-link">Crisis Protocols</a>
            <a href="/hypotension" class="mobile-menu-link">IOH Predictor</a>
            <a href="/difficult-airway" class="mobile-menu-link">Difficult Airway</a>
            <a href="/informed-consent" class="mobile-menu-link">Informed Consent</a>
            <!-- Soft Launch: Hiding Plans link -->
            <!-- <a href="/pricing" class="mobile-menu-link">Plans</a> -->
            {% if current_user.is_authenticated %}
                <a href="/library" class="mobile-menu-link">My Library</a>
                <a href="/logout" class="mobile-menu-link">Log Out ({{ current_user.display_name }})</a>
            {% else %}
                <a href="/login" class="mobile-menu-link">Log In</a>
                <a href="/register" class="mobile-menu-link" style="background:linear-gradient(135deg, var(--blue-600), #1D4ED8);color:white;font-weight:600;">Sign Up</a>
            {% endif %}
        </div>

        <div class="main-content">
            <div class="pricing-header">
                <h1 class="pricing-title">Choose Your Plan</h1>
                <p class="pricing-subtitle">Get started with evidence-based anesthesiology AI. Upgrade anytime.</p>
            </div>
            <div class="pricing-grid">
            <div class="pricing-card">
                <div class="pricing-tier">Free</div>
                <div class="pricing-price">$0<span>/month</span></div>
                <div class="pricing-period">Perfect for trying out</div>
                <ul class="pricing-features">
                    <li>10 queries per month</li>
                    <li>PubMed-backed answers</li>
                    <li>Basic clinical tools</li>
                    <li>Crisis protocols</li>
                </ul>
                <a href="/register" class="btn-pricing btn-secondary">Get Started</a>
            </div>
            <div class="pricing-card featured">
                <div class="pricing-badge">MOST POPULAR</div>
                <div class="pricing-tier">Pro</div>
                <div class="pricing-price">$19<span>/month</span></div>
                <div class="pricing-period">Billed monthly · $193/year (15% off)</div>
                <ul class="pricing-features">
                    <li>Unlimited queries</li>
                    <li>Advanced calculators</li>
                    <li>IOH predictor</li>
                    <li>Saved responses library</li>
                    <li>Priority support</li>
                </ul>
                <a href="/register" class="btn-pricing btn-primary-pricing">Upgrade to Pro</a>
            </div>
            <div class="pricing-card">
                <div class="pricing-tier">Team</div>
                <div class="pricing-price">$49<span>/month</span></div>
                <div class="pricing-period">Billed monthly · $500/year (15% off)</div>
                <ul class="pricing-features">
                    <li>Everything in Pro</li>
                    <li>Team collaboration</li>
                    <li>Shared library</li>
                    <li>Admin dashboard</li>
                    <li>Dedicated support</li>
                </ul>
                <a href="/register" class="btn-pricing btn-secondary">Contact Sales</a>
            </div>
        </div>
        </div>

        <footer class="footer">
            <div class="footer-inner">
                <span class="footer-text">© 2025 GasConsult.ai</span>
                <div class="social-icons">
                    <a href="https://x.com/GasConsultAI" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on X">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                    </a>
                    <a href="https://instagram.com/gasconsult.ai" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on Instagram">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </a>
                    <a href="https://www.linkedin.com/company/gasconsult-ai/" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Follow us on LinkedIn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                        </svg>
                    </a>
                </div>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link">Privacy</a>
                    <a href="/terms" class="footer-link">Terms</a>
                    <a href="mailto:contact@gasconsult.ai" class="footer-link">Contact</a>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (menu && btn) {
                menu.classList.toggle('active');
                btn.classList.toggle('active');
            }
        }

        function toggleNavDropdown(e) {
            e.preventDefault();
            e.stopPropagation();

            // Find the dropdown container and menu
            const dropdownContainer = e.target.closest('.nav-dropdown');
            if (dropdownContainer) {
                const menu = dropdownContainer.querySelector('.nav-dropdown-menu');
                if (menu) {
                    // Close other dropdowns first
                    document.querySelectorAll('.nav-dropdown-menu').forEach(m => {
                        if (m !== menu) {
                            m.classList.remove('show');
                        }
                    });
                    // Toggle this dropdown
                    menu.classList.toggle('show');
                }
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                document.querySelectorAll('.nav-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
    </script>
</body>
</html>
"""

if __name__ == "__main__":
    port = int(os.getenv("PORT", 5000))
    debug = os.getenv("FLASK_ENV") == "development"
    app.run(host="0.0.0.0", port=port, debug=debug)