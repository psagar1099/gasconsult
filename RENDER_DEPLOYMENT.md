# Render Deployment Guide for GasConsult.ai

This guide covers deploying gasconsult.ai to Render.com using the included `render.yaml` configuration.

## Quick Start

### 1. Prerequisites

- A Render account (sign up at https://render.com)
- Your API keys ready:
  - OpenAI API key (from https://platform.openai.com/api-keys)
  - NCBI Entrez email address
  - NCBI Entrez API key (from https://www.ncbi.nlm.nih.gov/account/settings/)

### 2. Deploy to Render

#### Option A: Using render.yaml (Recommended)

1. **Connect your GitHub repository to Render:**
   - Go to https://dashboard.render.com
   - Click "New +" → "Blueprint"
   - Connect your GitHub account if not already connected
   - Select the `gasconsult` repository
   - Render will automatically detect `render.yaml`

2. **Set Environment Variables:**

   Before deploying, you must set these secret environment variables in the Render dashboard:

   - `OPENAI_API_KEY` - Your OpenAI API key
   - `ENTREZ_EMAIL` - Your email for NCBI
   - `ENTREZ_API_KEY` - Your NCBI API key

   Navigate to your service → Environment → Add Environment Variable

3. **Deploy:**
   - Click "Apply" to create the service
   - Render will automatically build and deploy your application
   - The build takes 2-5 minutes

#### Option B: Manual Setup

1. **Create New Web Service:**
   - Go to https://dashboard.render.com
   - Click "New +" → "Web Service"
   - Connect your repository

2. **Configure Build Settings:**
   ```
   Name: gasconsult-ai
   Region: Oregon (or your preference)
   Branch: main
   Runtime: Python 3
   Build Command: pip install -r requirements.txt
   Start Command: gunicorn app:app --bind 0.0.0.0:$PORT --workers 4 --timeout 120
   ```

3. **Set Environment Variables:**
   ```
   FLASK_ENV=production
   FLASK_SECRET_KEY=[auto-generated by Render]
   LOG_LEVEL=INFO
   RATE_LIMIT=60 per minute
   OPENAI_API_KEY=[your-key]
   ENTREZ_EMAIL=[your-email]
   ENTREZ_API_KEY=[your-key]
   ```

4. **Configure Health Check:**
   - Health Check Path: `/health`
   - This endpoint returns JSON status and allows Render to monitor your app

5. **Deploy:**
   - Click "Create Web Service"
   - Wait for build to complete

## 3. Verify Deployment

Once deployed, verify everything works:

### Check Health Endpoint
```bash
curl https://your-app.onrender.com/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "gasconsult.ai",
  "version": "1.0.0",
  "python_version": "3.x.x",
  "checks": {
    "openai": true,
    "entrez_email": true,
    "entrez_api_key": true,
    "secret_key": true
  }
}
```

### Check API Status
```bash
curl https://your-app.onrender.com/api/status
```

### Manual Testing
1. Visit your app URL: `https://your-app.onrender.com`
2. Try a test query: "TXA in spine surgery"
3. Test the chat interface at `/chat`
4. Test the preop assessment at `/preop`
5. Test the hypotension predictor at `/hypotension`

## 4. Configure Custom Domain (Optional)

1. Go to your service settings in Render
2. Click "Custom Domains"
3. Add your domain (e.g., `gasconsult.ai`)
4. Update your DNS records as instructed by Render
5. Render automatically provisions SSL certificates

## 5. Post-Deployment

### Monitor Your Application

- **Logs:** View real-time logs in Render dashboard → Logs tab
- **Metrics:** Monitor CPU, memory, and bandwidth usage
- **Health Checks:** Render automatically monitors `/health` endpoint

### Set Up Alerts (Recommended)

Configure Render to notify you of:
- Deploy failures
- Service health check failures
- High error rates

Go to: Settings → Notifications

### Upgrade from Free Tier (When Ready)

Free tier limitations:
- Spins down after 15 minutes of inactivity (cold starts)
- 750 hours/month free
- Shared resources

For production, consider:
- **Starter ($7/month):** No spin down, always-on
- **Standard ($25/month):** More resources, better performance

## 6. Environment Variables Reference

| Variable | Required | Set Via | Description |
|----------|----------|---------|-------------|
| `FLASK_ENV` | Yes | render.yaml | `production` |
| `FLASK_SECRET_KEY` | Yes | Auto-generated | Session encryption |
| `OPENAI_API_KEY` | Yes | Manual | OpenAI GPT-4o access |
| `ENTREZ_EMAIL` | Yes | Manual | NCBI API email |
| `ENTREZ_API_KEY` | Recommended | Manual | NCBI API key (10 req/s) |
| `LOG_LEVEL` | Optional | render.yaml | `INFO` or `DEBUG` |
| `RATE_LIMIT` | Optional | render.yaml | `60 per minute` |
| `PORT` | Auto | Render | Automatically set by Render |

## 7. Troubleshooting

### Build Fails

**Error:** `pip install` fails
- Check `requirements.txt` is present and valid
- View build logs in Render dashboard
- Ensure Python version compatibility

**Error:** Module not found
- Verify all dependencies are in `requirements.txt`
- Check for typos in import statements

### Service Unhealthy

**Status 503 on /health**
- Check environment variables are set correctly
- View logs for missing API keys
- Verify `OPENAI_API_KEY` is valid

**Cold Start Issues (Free Tier)**
- First request after idle may take 30-60 seconds
- Upgrade to Starter plan for always-on service

### Rate Limiting

**Too many 429 errors**
- Increase `RATE_LIMIT` environment variable
- Consider implementing caching
- Monitor usage patterns

### OpenAI Errors

**401 Unauthorized**
- Verify `OPENAI_API_KEY` is correct
- Check API key has sufficient credits
- Ensure no extra spaces in environment variable

**429 Rate Limit**
- OpenAI API rate limit reached
- Check your OpenAI usage dashboard
- Consider upgrading OpenAI plan

### NCBI/PubMed Errors

**HTTP 429 from NCBI**
- Too many requests to PubMed
- Verify `ENTREZ_API_KEY` is set (increases limit to 10/s)
- Add delays between requests if needed

## 8. Updating Your Deployment

### Automatic Deploys

Render automatically deploys when you push to your configured branch:

```bash
git add .
git commit -m "Update feature"
git push origin main
```

Render will:
1. Detect the push
2. Run the build command
3. Deploy the new version
4. Route traffic to the new deployment

### Manual Deploys

In Render dashboard:
1. Go to your service
2. Click "Manual Deploy" → "Deploy latest commit"

### Rollback

If something goes wrong:
1. Go to Events tab in Render dashboard
2. Click "Rollback" on a previous successful deploy

## 9. Security Checklist

Before going public:

- [ ] All API keys set as environment variables (not in code)
- [ ] `FLASK_SECRET_KEY` is auto-generated and secure
- [ ] HTTPS enabled (automatic on Render)
- [ ] Rate limiting configured
- [ ] Health check endpoint working
- [ ] CSRF protection enabled
- [ ] Input sanitization active
- [ ] No sensitive data in logs

## 10. Cost Estimation

### Free Tier
- **Cost:** $0/month
- **Limitations:** Spins down after 15 min idle, 750 hours/month
- **Best for:** Testing, development, low-traffic apps

### Starter Plan
- **Cost:** $7/month
- **Benefits:** Always-on, no cold starts, 512 MB RAM
- **Best for:** Production apps with moderate traffic

### Standard Plan
- **Cost:** $25/month
- **Benefits:** More resources, better performance
- **Best for:** High-traffic production apps

**Additional Costs:**
- OpenAI API usage (pay-as-you-go)
- Custom domain (varies by registrar)

## 11. Performance Optimization

### Reduce Cold Starts (Free Tier)

1. Use a service like UptimeRobot to ping your app every 14 minutes
2. Upgrade to Starter plan ($7/month)

### Improve Response Times

1. Enable gzip compression (add to app.py)
2. Implement Redis caching for PubMed queries
3. Use CDN for static assets
4. Increase Gunicorn workers (if on higher tier)

### Monitor Performance

- Use Render metrics dashboard
- Set up external monitoring (UptimeRobot, Pingdom)
- Review logs for slow queries
- Monitor OpenAI API response times

## 12. Support Resources

- **Render Documentation:** https://render.com/docs
- **Render Community:** https://community.render.com
- **Flask Documentation:** https://flask.palletsprojects.com
- **Gunicorn Documentation:** https://docs.gunicorn.org

## 13. Next Steps After Deployment

1. **Test thoroughly:**
   - All forms and features
   - Error handling
   - Rate limiting
   - Security features

2. **Set up monitoring:**
   - Health check alerts
   - Error tracking (Sentry)
   - Usage analytics

3. **Configure custom domain:**
   - Purchase domain
   - Configure DNS
   - Verify SSL

4. **Plan for scale:**
   - Monitor usage patterns
   - Plan upgrade path
   - Consider caching strategy

---

## Quick Commands Reference

```bash
# Test health endpoint
curl https://your-app.onrender.com/health

# View logs
# (Use Render dashboard → Logs tab)

# Deploy latest changes
git push origin main

# Check API status
curl https://your-app.onrender.com/api/status
```

---

**Last Updated:** November 27, 2025
**Render Version:** Current
**App Version:** 1.0.0
